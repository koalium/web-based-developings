<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stirling Engine 3D Simulation | Extreme Detail</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #0a0e17;
            color: #e6f2ff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        #container {
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }

        /* Header */
        .header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: rgba(10, 20, 40, 0.9);
            border-radius: 15px;
            border: 1px solid rgba(0, 188, 212, 0.3);
            backdrop-filter: blur(10px);
            pointer-events: auto;
        }

        .engine-title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(90deg, #ff6d00, #ffab00, #00bcd4);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .power-badge {
            background: linear-gradient(135deg, #00c853, #64dd17);
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 0 20px rgba(0, 200, 83, 0.4);
        }

        /* Control Panel */
        .control-panel {
            position: absolute;
            right: 20px;
            top: 100px;
            width: 320px;
            background: rgba(10, 20, 40, 0.95);
            border-radius: 15px;
            border: 1px solid rgba(0, 188, 212, 0.3);
            padding: 20px;
            backdrop-filter: blur(10px);
            pointer-events: auto;
            max-height: 80vh;
            overflow-y: auto;
        }

        .panel-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(0, 188, 212, 0.2);
        }

        .section-title {
            color: #00bcd4;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-label {
            color: #a5d6ff;
            margin-bottom: 8px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }

        .control-value {
            color: #ffab00;
            font-weight: bold;
        }

        .slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: linear-gradient(90deg, #ff6d00, #00bcd4);
            border-radius: 3px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            border: 2px solid #00bcd4;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 188, 212, 0.8);
        }

        /* Component Tree */
        .component-tree {
            position: absolute;
            left: 20px;
            top: 100px;
            width: 280px;
            background: rgba(10, 20, 40, 0.95);
            border-radius: 15px;
            border: 1px solid rgba(0, 188, 212, 0.3);
            padding: 20px;
            backdrop-filter: blur(10px);
            pointer-events: auto;
            max-height: 80vh;
            overflow-y: auto;
        }

        .tree-item {
            padding: 10px 15px;
            margin: 5px 0;
            background: rgba(20, 40, 80, 0.5);
            border-radius: 8px;
            border-left: 3px solid #ff6d00;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .tree-item:hover {
            background: rgba(20, 40, 80, 0.8);
            transform: translateX(5px);
        }

        .tree-item.active {
            border-left-color: #00bcd4;
            background: rgba(0, 188, 212, 0.2);
        }

        .item-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 10px;
            background: #00c853;
            color: white;
        }

        /* Stats Panel */
        .stats-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            background: rgba(10, 20, 40, 0.9);
            padding: 15px 25px;
            border-radius: 15px;
            border: 1px solid rgba(0, 188, 212, 0.3);
            backdrop-filter: blur(10px);
            pointer-events: auto;
        }

        .stat-item {
            text-align: center;
            padding: 0 15px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #00bcd4;
            margin: 5px 0;
        }

        .stat-label {
            color: #a5d6ff;
            font-size: 0.9rem;
        }

        /* Visualization Modes */
        .viz-modes {
            position: absolute;
            bottom: 100px;
            left: 20px;
            display: flex;
            gap: 10px;
        }

        .viz-btn {
            padding: 10px 20px;
            background: rgba(20, 40, 80, 0.8);
            border: 1px solid rgba(0, 188, 212, 0.3);
            border-radius: 8px;
            color: #a5d6ff;
            cursor: pointer;
            transition: all 0.3s;
            pointer-events: auto;
        }

        .viz-btn:hover {
            background: rgba(0, 188, 212, 0.2);
            transform: translateY(-2px);
        }

        .viz-btn.active {
            background: rgba(0, 188, 212, 0.3);
            border-color: #00bcd4;
            color: white;
        }

        /* Loading Screen */
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0a0e17;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s;
        }

        .loading-text {
            color: #00bcd4;
            font-size: 1.5rem;
            margin-top: 20px;
            font-weight: bold;
        }

        .progress-bar {
            width: 300px;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            margin-top: 20px;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6d00, #00bcd4);
            width: 0%;
            transition: width 0.3s;
        }

        /* Tooltips */
        .tooltip {
            position: absolute;
            background: rgba(10, 20, 40, 0.95);
            border: 1px solid rgba(0, 188, 212, 0.3);
            border-radius: 8px;
            padding: 15px;
            max-width: 300px;
            display: none;
            z-index: 1000;
            pointer-events: none;
            backdrop-filter: blur(10px);
        }

        .tooltip-title {
            color: #ffab00;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .tooltip-desc {
            color: #a5d6ff;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Cross-section Toggle */
        .cross-section-toggle {
            position: absolute;
            top: 150px;
            right: 350px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(10, 20, 40, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            pointer-events: auto;
        }

        .toggle-switch {
            width: 50px;
            height: 26px;
            background: rgba(20, 40, 80, 0.8);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
        }

        .toggle-switch.active {
            background: rgba(0, 188, 212, 0.3);
        }

        .toggle-knob {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle-switch.active .toggle-knob {
            transform: translateX(24px);
        }

        /* Material Properties Panel */
        .material-panel {
            position: absolute;
            left: 320px;
            top: 100px;
            width: 350px;
            background: rgba(10, 20, 40, 0.95);
            border-radius: 15px;
            border: 1px solid rgba(0, 188, 212, 0.3);
            padding: 20px;
            backdrop-filter: blur(10px);
            display: none;
            pointer-events: auto;
        }

        .material-property {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .property-name {
            color: #a5d6ff;
        }

        .property-value {
            color: #ffab00;
            font-weight: bold;
        }

        /* Gas Particles Toggle */
        .gas-toggle {
            position: absolute;
            top: 200px;
            right: 350px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(10, 20, 40, 0.9);
            padding: 10px 15px;
            border-radius: 8px;
            pointer-events: auto;
        }

        /* Temperature Gradient */
        .temp-gradient {
            position: absolute;
            right: 20px;
            bottom: 100px;
            width: 30px;
            height: 200px;
            background: linear-gradient(to top, #ff6d00, #ffab00, #00bcd4, #0066cc);
            border-radius: 8px;
            padding: 10px 5px;
            pointer-events: none;
        }

        .temp-label {
            position: absolute;
            left: -60px;
            font-size: 0.8rem;
            color: #a5d6ff;
        }

        .temp-hot {
            top: 5px;
        }

        .temp-cold {
            bottom: 5px;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    
    <div id="ui">
        <!-- Loading Screen -->
        <div id="loading">
            <div style="font-size: 3rem; color: #00bcd4;">⚙️</div>
            <div class="loading-text">LOADING STIRLING ENGINE 3D SIMULATION</div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div style="margin-top: 20px; color: #a5d6ff; font-size: 0.9rem;">
                Initializing micro-component details...
            </div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="engine-title">STIRLING ENGINE 3D SIMULATION</div>
            <div class="power-badge" id="powerBadge">20.1W</div>
        </div>

        <!-- Component Tree -->
        <div class="component-tree">
            <div class="section-title">COMPONENT SELECTION</div>
            <div class="tree-item" data-component="hotCylinder">
                <span>Hot Cylinder Assembly</span>
                <span class="item-status">600°C</span>
            </div>
            <div class="tree-item" data-component="heaterBlock">
                <span>Heater Block & Elements</span>
                <span class="item-status">800W</span>
            </div>
            <div class="tree-item" data-component="displacer">
                <span>Displacer Piston</span>
                <span class="item-status">44.2mm</span>
            </div>
            <div class="tree-item" data-component="coldCylinder">
                <span>Cold Cylinder Assembly</span>
                <span class="item-status">80°C</span>
            </div>
            <div class="tree-item" data-component="powerPiston">
                <span>Power Piston</span>
                <span class="item-status">44.5mm</span>
            </div>
            <div class="tree-item" data-component="pistonRings">
                <span>Piston Ring Set</span>
                <span class="item-status">3 Rings</span>
            </div>
            <div class="tree-item" data-component="regenerator">
                <span>Regenerator Matrix</span>
                <span class="item-status">85% Porosity</span>
            </div>
            <div class="tree-item" data-component="crankshaft">
                <span>Crankshaft & Flywheel</span>
                <span class="item-status">90° Phase</span>
            </div>
            <div class="tree-item" data-component="connectingRods">
                <span>Connecting Rods</span>
                <span class="item-status">Dynamic</span>
            </div>
            <div class="tree-item" data-component="bearings">
                <span>Bearing System</span>
                <span class="item-status">ABEC-7</span>
            </div>
            <div class="tree-item" data-component="gasSystem">
                <span>Gas System (Helium)</span>
                <span class="item-status">1.2 MPa</span>
            </div>
        </div>

        <!-- Control Panel -->
        <div class="control-panel">
            <div class="panel-section">
                <div class="section-title">ENGINE CONTROLS</div>
                
                <div class="control-group">
                    <div class="control-label">
                        <span>Hot Temperature</span>
                        <span class="control-value" id="hotTempValue">600°C</span>
                    </div>
                    <input type="range" class="slider" id="hotTempSlider" min="300" max="850" value="600" step="1">
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span>Cold Temperature</span>
                        <span class="control-value" id="coldTempValue">80°C</span>
                    </div>
                    <input type="range" class="slider" id="coldTempSlider" min="20" max="150" value="80" step="1">
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span>Engine Speed</span>
                        <span class="control-value" id="rpmValue">300 RPM</span>
                    </div>
                    <input type="range" class="slider" id="rpmSlider" min="50" max="600" value="300" step="1">
                </div>

                <div class="control-group">
                    <div class="control-label">
                        <span>Gas Pressure</span>
                        <span class="control-value" id="pressureValue">1.2 MPa</span>
                    </div>
                    <input type="range" class="slider" id="pressureSlider" min="0.5" max="3.0" value="1.2" step="0.01">
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">ENGINE STATUS</div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Power Output</span>
                        <span class="control-value" id="powerValue">20.1 W</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Thermal Efficiency</span>
                        <span class="control-value" id="efficiencyValue">30.2%</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Torque</span>
                        <span class="control-value" id="torqueValue">0.64 N·m</span>
                    </div>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>Gas Flow Rate</span>
                        <span class="control-value" id="flowValue">12.5 L/s</span>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <div class="section-title">ANIMATION CONTROL</div>
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                    <button id="startBtn" style="flex: 1; padding: 10px; background: #00c853; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">
                        ▶ START
                    </button>
                    <button id="stopBtn" style="flex: 1; padding: 10px; background: #ff3d00; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">
                        ■ STOP
                    </button>
                    <button id="resetBtn" style="flex: 1; padding: 10px; background: #ffab00; border: none; border-radius: 8px; color: white; font-weight: bold; cursor: pointer;">
                        ↻ RESET
                    </button>
                </div>
            </div>
        </div>

        <!-- Visualization Modes -->
        <div class="viz-modes">
            <button class="viz-btn active" data-mode="normal">Normal View</button>
            <button class="viz-btn" data-mode="wireframe">Wireframe</button>
            <button class="viz-btn" data-mode="thermal">Thermal View</button>
            <button class="viz-btn" data-mode="pressure">Pressure View</button>
            <button class="viz-btn" data-mode="xray">X-Ray View</button>
        </div>

        <!-- Cross-section Toggle -->
        <div class="cross-section-toggle">
            <span style="color: #a5d6ff;">Cross-section View</span>
            <div class="toggle-switch" id="crossSectionToggle">
                <div class="toggle-knob"></div>
            </div>
        </div>

        <!-- Gas Particles Toggle -->
        <div class="gas-toggle">
            <span style="color: #a5d6ff;">Gas Particles</span>
            <div class="toggle-switch" id="gasToggle">
                <div class="toggle-knob"></div>
            </div>
        </div>

        <!-- Material Properties Panel -->
        <div class="material-panel" id="materialPanel">
            <div class="section-title">MATERIAL PROPERTIES</div>
            <div id="materialProperties"></div>
        </div>

        <!-- Temperature Gradient -->
        <div class="temp-gradient">
            <div class="temp-label temp-hot">850°C</div>
            <div class="temp-label temp-cold">20°C</div>
        </div>

        <!-- Stats Panel -->
        <div class="stats-panel">
            <div class="stat-item">
                <div class="stat-value" id="currentTemp">600°C</div>
                <div class="stat-label">Hot Side</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="coldTemp">80°C</div>
                <div class="stat-label">Cold Side</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="currentRPM">300</div>
                <div class="stat-label">RPM</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="currentPressure">1.2</div>
                <div class="stat-label">MPa</div>
            </div>
        </div>

        <!-- Tooltip -->
        <div class="tooltip" id="tooltip">
            <div class="tooltip-title" id="tooltipTitle"></div>
            <div class="tooltip-desc" id="tooltipDesc"></div>
        </div>
    </div>

    <!-- Three.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/libs/stats.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <script>
        // Global variables
        let scene, camera, renderer, controls, stats;
        let engineGroup, hotCylinder, coldCylinder, displacer, powerPiston, crankshaft, flywheel;
        let regenerator, heaterBlock, coolingJacket, connectingRods, pistonRings;
        let gasParticles = [];
        let engineRunning = true;
        let engineAngle = 0;
        let animationId = null;
        let selectedComponent = null;
        let crossSectionEnabled = false;
        let gasParticlesEnabled = true;
        let visualizationMode = 'normal';
        
        // Engine parameters
        const engineParams = {
            hotTemp: 600,
            coldTemp: 80,
            rpm: 300,
            pressure: 1.2,
            power: 20.1,
            efficiency: 30.2,
            torque: 0.64,
            gasFlow: 12.5
        };

        // Material database
        const materialDB = {
            stainlessSteel: {
                name: "Stainless Steel 316L",
                color: 0x888888,
                emissive: 0x222222,
                roughness: 0.3,
                metalness: 0.7,
                thermalConductivity: 16.3
            },
            aluminum: {
                name: "Aluminum 6061-T6",
                color: 0xcccccc,
                emissive: 0x111111,
                roughness: 0.2,
                metalness: 0.8,
                thermalConductivity: 167
            },
            graphite: {
                name: "Graphite Composite",
                color: 0x222222,
                emissive: 0x000000,
                roughness: 0.8,
                metalness: 0.1,
                thermalConductivity: 120
            },
            copper: {
                name: "Copper C122",
                color: 0xb87333,
                emissive: 0x222222,
                roughness: 0.1,
                metalness: 0.9,
                thermalConductivity: 400
            },
            castIron: {
                name: "Cast Iron",
                color: 0x333333,
                emissive: 0x000000,
                roughness: 0.6,
                metalness: 0.3,
                thermalConductivity: 50
            },
            incoloy: {
                name: "Incoloy 800",
                color: 0x666666,
                emissive: 0x222222,
                roughness: 0.4,
                metalness: 0.8,
                thermalConductivity: 12
            },
            rubber: {
                name: "Nitrile Rubber",
                color: 0x000000,
                emissive: 0x000000,
                roughness: 0.9,
                metalness: 0.0,
                thermalConductivity: 0.3
            }
        };

        // Component tooltips
        const componentTooltips = {
            hotCylinder: {
                title: "Hot Cylinder Assembly",
                desc: "Stainless Steel 316L cylinder with 45mm bore, 60mm stroke. Precision honed to Ra 0.4μm surface finish. Heated to 600°C by cartridge heaters."
            },
            heaterBlock: {
                title: "Heater Block",
                desc: "800W cartridge heaters embedded in Incoloy 800 block. Maximum temperature 850°C. Magnesium oxide insulation ensures 98% thermal efficiency."
            },
            displacer: {
                title: "Displacer Piston",
                desc: "Stainless steel foam displacer with 85% porosity. 44.2mm diameter with 0.4mm radial clearance. Minimizes dead volume while maximizing heat transfer surface area."
            },
            coldCylinder: {
                title: "Cold Cylinder Assembly",
                desc: "Aluminum 6061-T6 cylinder with water cooling jacket. 45mm bore, 60mm stroke. Maintained at 80°C by 2L/min coolant flow."
            },
            powerPiston: {
                title: "Power Piston",
                desc: "Graphite composite piston with three cast iron rings. 44.5mm diameter. Self-lubricating with MoS₂ additive. Low thermal expansion coefficient."
            },
            pistonRings: {
                title: "Piston Ring Set",
                desc: "Three chrome-plated cast iron rings with 0.3mm end gap. Provides gas seal with minimal friction. Radial pressure 0.8 MPa."
            },
            regenerator: {
                title: "Regenerator Matrix",
                desc: "120 layers of 0.05mm stainless steel wire mesh. 85% porosity provides 8500 cm²/L surface area. 92.3% heat exchange effectiveness."
            },
            crankshaft: {
                title: "Crankshaft & Flywheel",
                desc: "4140 steel crankshaft with 90° phase difference. 30mm crank radius. 2.5kg ductile iron flywheel provides smooth power delivery."
            },
            connectingRods: {
                title: "Connecting Rods",
                desc: "Steel connecting rods with bronze bushings. Displacer rod: 6mm diameter. Power piston rod: 8mm diameter. Dynamic balancing at 600 RPM."
            },
            bearings: {
                title: "Bearing System",
                desc: "ABEC-7 precision ball bearings with double rubber seals. C3 radial clearance accommodates thermal expansion. Grease-packed for maintenance-free operation."
            },
            gasSystem: {
                title: "Gas System",
                desc: "99.999% pure Helium at 1.2 MPa pressure. Total gas mass 0.42g. High thermal conductivity (0.151 W/m·K) and low viscosity for maximum efficiency."
            }
        };

        // Initialize Three.js scene
        function init() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0e17);
            scene.fog = new THREE.Fog(0x0a0e17, 10, 100);

            // Create camera
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 10, 30);
            camera.lookAt(0, 0, 0);

            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('container').appendChild(renderer.domElement);

            // Add orbit controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 5;
            controls.maxDistance = 100;
            controls.maxPolarAngle = Math.PI / 2;

            // Add stats
            stats = new Stats();
            stats.domElement.style.position = 'absolute';
            stats.domElement.style.top = '20px';
            stats.domElement.style.right = '20px';
            stats.domElement.style.left = 'auto';
            document.getElementById('container').appendChild(stats.domElement);

            // Add lighting
            setupLighting();

            // Build engine
            buildEngine();

            // Setup UI events
            setupUI();

            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loading').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                }, 500);
            }, 2000);

            // Start animation
            animate();
        }

        // Setup lighting
        function setupLighting() {
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
            scene.add(ambientLight);

            // Directional light
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(10, 20, 15);
            directionalLight.castShadow = true;
            directionalLight.shadow.mapSize.width = 2048;
            directionalLight.shadow.mapSize.height = 2048;
            directionalLight.shadow.camera.near = 0.5;
            directionalLight.shadow.camera.far = 50;
            directionalLight.shadow.camera.left = -20;
            directionalLight.shadow.camera.right = 20;
            directionalLight.shadow.camera.top = 20;
            directionalLight.shadow.camera.bottom = -20;
            scene.add(directionalLight);

            // Point light for hot end
            const hotLight = new THREE.PointLight(0xff6d00, 2, 20);
            hotLight.position.set(-10, 0, 0);
            scene.add(hotLight);

            // Point light for cold end
            const coldLight = new THREE.PointLight(0x00bcd4, 1, 20);
            coldLight.position.set(10, 0, 0);
            scene.add(coldLight);

            // Rim light
            const rimLight = new THREE.DirectionalLight(0xffffff, 0.5);
            rimLight.position.set(0, 10, -10);
            scene.add(rimLight);
        }

        // Build the complete Stirling engine
        function buildEngine() {
            engineGroup = new THREE.Group();
            scene.add(engineGroup);

            // Create hot cylinder assembly
            createHotCylinder();

            // Create cold cylinder assembly
            createColdCylinder();

            // Create regenerator
            createRegenerator();

            // Create crankshaft and flywheel
            createCrankshaft();

            // Create connecting rods
            createConnectingRods();

            // Create heater block
            createHeaterBlock();

            // Create cooling jacket
            createCoolingJacket();

            // Create piston rings
            createPistonRings();

            // Initialize gas particles
            createGasParticles();

            // Add wireframe helper for selected component
            createSelectionHelpers();
        }

        // Create hot cylinder with extreme detail
        function createHotCylinder() {
            const group = new THREE.Group();
            group.name = 'hotCylinder';
            engineGroup.add(group);

            // Cylinder wall
            const cylinderGeometry = new THREE.CylinderGeometry(2.25, 2.25, 6, 32, 1, true);
            const cylinderMaterial = new THREE.MeshStandardMaterial({
                color: materialDB.stainlessSteel.color,
                roughness: materialDB.stainlessSteel.roughness,
                metalness: materialDB.stainlessSteel.metalness,
                side: THREE.DoubleSide
            });
            hotCylinder = new THREE.Mesh(cylinderGeometry, cylinderMaterial);
            hotCylinder.castShadow = true;
            hotCylinder.receiveShadow = true;
            hotCylinder.position.set(-10, 0, 0);
            group.add(hotCylinder);

            // Inner bore (for cross-section view)
            const boreGeometry = new THREE.CylinderGeometry(2.25, 2.25, 6.2, 32);
            const boreMaterial = new THREE.MeshStandardMaterial({
                color: 0x444444,
                roughness: 0.6,
                metalness: 0.2,
                transparent: true,
                opacity: 0.3
            });
            const bore = new THREE.Mesh(boreGeometry, boreMaterial);
            bore.position.set(-10, 0, 0);
            group.add(bore);

            // Hot end cap
            const endCapGeometry = new THREE.CylinderGeometry(2.5, 2.5, 0.5, 32);
            const endCapMaterial = new THREE.MeshStandardMaterial({
                color: 0xff3300,
                emissive: 0xff3300,
                emissiveIntensity: 0.5
            });
            const endCap = new THREE.Mesh(endCapGeometry, endCapMaterial);
            endCap.position.set(-10, -3.25, 0);
            group.add(endCap);

            // Heat fins on cylinder
            for (let i = 0; i < 8; i++) {
                const finGeometry = new THREE.CylinderGeometry(2.6, 2.6, 0.1, 32);
                const finMaterial = new THREE.MeshStandardMaterial({
                    color: 0xff6d00,
                    emissive: 0xff3300,
                    emissiveIntensity: 0.3
                });
                const fin = new THREE.Mesh(finGeometry, finMaterial);
                fin.position.set(-10, -2.5 + i * 0.8, 0);
                group.add(fin);
            }

            // Temperature glow effect
            const glowGeometry = new THREE.SphereGeometry(2.8, 32, 32);
            const glowMaterial = new THREE.MeshBasicMaterial({
                color: 0xff6d00,
                transparent: true,
                opacity: 0.1,
                side: THREE.BackSide
            });
            const glow = new THREE.Mesh(glowGeometry, glowMaterial);
            glow.position.set(-10, 0, 0);
            group.add(glow);

            // Surface finish detail (micro-texture)
            const textureGeometry = new THREE.CylinderGeometry(2.251, 2.251, 6, 128);
            const textureMaterial = new THREE.MeshStandardMaterial({
                color: 0x888888,
                roughness: 0.1,
                metalness: 0.8,
                bumpScale: 0.001
            });
            const texturedCylinder = new THREE.Mesh(textureGeometry, textureMaterial);
            texturedCylinder.position.set(-10, 0, 0);
            group.add(texturedCylinder);
        }

        // Create cold cylinder with extreme detail
        function createColdCylinder() {
            const group = new THREE.Group();
            group.name = 'coldCylinder';
            engineGroup.add(group);

            // Cylinder wall
            const cylinderGeometry = new THREE.CylinderGeometry(2.25, 2.25, 6, 32, 1, true);
            const cylinderMaterial = new THREE.MeshStandardMaterial({
                color: materialDB.aluminum.color,
                roughness: materialDB.aluminum.roughness,
                metalness: materialDB.aluminum.metalness,
                side: THREE.DoubleSide
            });
            coldCylinder = new THREE.Mesh(cylinderGeometry, cylinderMaterial);
            coldCylinder.castShadow = true;
            coldCylinder.receiveShadow = true;
            coldCylinder.position.set(10, 0, 0);
            group.add(coldCylinder);

            // Cold end cap
            const endCapGeometry = new THREE.CylinderGeometry(2.5, 2.5, 0.5, 32);
            const endCapMaterial = new THREE.MeshStandardMaterial({
                color: 0x0066cc,
                emissive: 0x0066cc,
                emissiveIntensity: 0.2
            });
            const endCap = new THREE.Mesh(endCapGeometry, endCapMaterial);
            endCap.position.set(10, 3.25, 0);
            group.add(endCap);

            // Cooling fins
            for (let i = 0; i < 12; i++) {
                const finGeometry = new THREE.TorusGeometry(2.6, 0.1, 8, 32, Math.PI * 2);
                const finMaterial = new THREE.MeshStandardMaterial({
                    color: 0x00bcd4,
                    metalness: 0.8
                });
                const fin = new THREE.Mesh(finGeometry, finMaterial);
                fin.position.set(10, -2.5 + i * 0.5, 0);
                fin.rotation.x = Math.PI / 2;
                group.add(fin);
            }

            // Coolant glow effect
            const glowGeometry = new THREE.SphereGeometry(2.8, 32, 32);
            const glowMaterial = new THREE.MeshBasicMaterial({
                color: 0x00bcd4,
                transparent: true,
                opacity: 0.05,
                side: THREE.BackSide
            });
            const glow = new THREE.Mesh(glowGeometry, glowMaterial);
            glow.position.set(10, 0, 0);
            group.add(glow);
        }

        // Create displacer piston with porous structure
        function createDisplacer() {
            const group = new THREE.Group();
            group.name = 'displacer';
            
            // Main displacer body
            const displacerGeometry = new THREE.CylinderGeometry(2.21, 2.21, 5.5, 32);
            const displacerMaterial = new THREE.MeshStandardMaterial({
                color: 0xffab00,
                emissive: 0xff6d00,
                emissiveIntensity: 0.3,
                transparent: true,
                opacity: 0.8
            });
            displacer = new THREE.Mesh(displacerGeometry, displacerMaterial);
            displacer.castShadow = true;
            displacer.receiveShadow = true;
            group.add(displacer);

            // Porous structure visualization
            const porousGroup = new THREE.Group();
            for (let i = 0; i < 200; i++) {
                const poreGeometry = new THREE.SphereGeometry(0.05 + Math.random() * 0.1, 8, 8);
                const poreMaterial = new THREE.MeshBasicMaterial({
                    color: 0xff6d00,
                    transparent: true,
                    opacity: 0.5
                });
                const pore = new THREE.Mesh(poreGeometry, poreMaterial);
                
                // Random position within displacer volume
                const theta = Math.random() * Math.PI * 2;
                const phi = Math.random() * Math.PI;
                const r = Math.random() * 1.5;
                
                pore.position.set(
                    r * Math.sin(phi) * Math.cos(theta),
                    (Math.random() - 0.5) * 5,
                    r * Math.sin(phi) * Math.sin(theta)
                );
                porousGroup.add(pore);
            }
            group.add(porousGroup);

            // Displacer rod
            const rodGeometry = new THREE.CylinderGeometry(0.3, 0.3, 12, 16);
            const rodMaterial = new THREE.MeshStandardMaterial({
                color: 0x888888,
                roughness: 0.2,
                metalness: 0.8
            });
            const rod = new THREE.Mesh(rodGeometry, rodMaterial);
            rod.position.y = 3.5;
            rod.castShadow = true;
            group.add(rod);

            return group;
        }

        // Create power piston with rings
        function createPowerPiston() {
            const group = new THREE.Group();
            group.name = 'powerPiston';
            
            // Piston body
            const pistonGeometry = new THREE.CylinderGeometry(2.225, 2.225, 2.5, 32);
            const pistonMaterial = new THREE.MeshStandardMaterial({
                color: materialDB.graphite.color,
                roughness: materialDB.graphite.roughness,
                metalness: materialDB.graphite.metalness
            });
            powerPiston = new THREE.Mesh(pistonGeometry, pistonMaterial);
            powerPiston.castShadow = true;
            powerPiston.receiveShadow = true;
            group.add(powerPiston);

            // Wrist pin
            const pinGeometry = new THREE.CylinderGeometry(0.4, 0.4, 2, 16);
            const pinMaterial = new THREE.MeshStandardMaterial({
                color: 0x666666,
                roughness: 0.1,
                metalness: 0.9
            });
            const pin = new THREE.Mesh(pinGeometry, pinMaterial);
            pin.rotation.z = Math.PI / 2;
            pin.position.y = -1.25;
            pin.castShadow = true;
            group.add(pin);

            return group;
        }

        // Create piston rings
        function createPistonRings() {
            const group = new THREE.Group();
            group.name = 'pistonRings';
            engineGroup.add(group);

            for (let i = 0; i < 3; i++) {
                const ringGeometry = new THREE.TorusGeometry(2.25, 0.15, 16, 32);
                const ringMaterial = new THREE.MeshStandardMaterial({
                    color: 0x333333,
                    roughness: 0.3,
                    metalness: 0.7,
                    emissive: 0x111111
                });
                const ring = new THREE.Mesh(ringGeometry, ringMaterial);
                ring.position.set(10, -0.5 + i * 0.5, 0);
                ring.rotation.x = Math.PI / 2;
                ring.castShadow = true;
                group.add(ring);
            }

            pistonRings = group;
        }

        // Create regenerator with wire mesh
        function createRegenerator() {
            const group = new THREE.Group();
            group.name = 'regenerator';
            engineGroup.add(group);

            // Regenerator housing
            const housingGeometry = new THREE.CylinderGeometry(1.5, 1.5, 4, 32);
            const housingMaterial = new THREE.MeshStandardMaterial({
                color: 0x333333,
                roughness: 0.6,
                metalness: 0.3
            });
            const housing = new THREE.Mesh(housingGeometry, housingMaterial);
            housing.position.set(0, 0, 0);
            housing.castShadow = true;
            housing.receiveShadow = true;
            group.add(housing);

            // Wire mesh matrix
            const meshGroup = new THREE.Group();
            
            // Create multiple layers of wire mesh
            for (let layer = 0; layer < 8; layer++) {
                const layerGroup = new THREE.Group();
                
                // Horizontal wires
                for (let i = 0; i < 16; i++) {
                    const wireGeometry = new THREE.CylinderGeometry(0.01, 0.01, 2.8, 8);
                    const wireMaterial = new THREE.MeshStandardMaterial({
                        color: 0x9c27b0,
                        emissive: 0x7b1fa2,
                        emissiveIntensity: 0.3
                    });
                    const wire = new THREE.Mesh(wireGeometry, wireMaterial);
                    wire.position.set(0, -1.4 + i * 0.186, 0);
                    wire.rotation.z = Math.PI / 2;
                    layerGroup.add(wire);
                }
                
                // Vertical wires (offset in alternating layers)
                const offset = layer % 2 === 0 ? 0 : 0.093;
                for (let i = 0; i < 16; i++) {
                    const wireGeometry = new THREE.CylinderGeometry(0.01, 0.01, 2.8, 8);
                    const wireMaterial = new THREE.MeshStandardMaterial({
                        color: 0x9c27b0,
                        emissive: 0x7b1fa2,
                        emissiveIntensity: 0.3
                    });
                    const wire = new THREE.Mesh(wireGeometry, wireMaterial);
                    wire.position.set(-1.4 + i * 0.186 + offset, 0, 0);
                    layerGroup.add(wire);
                }
                
                layerGroup.position.z = -1.5 + layer * 0.375;
                meshGroup.add(layerGroup);
            }
            
            group.add(meshGroup);
            regenerator = group;

            // Gas flow visualization
            const flowGeometry = new THREE.ConeGeometry(0.5, 2, 8);
            const flowMaterial = new THREE.MeshBasicMaterial({
                color: 0x00bcd4,
                transparent: true,
                opacity: 0.3
            });
            const flowArrow = new THREE.Mesh(flowGeometry, flowMaterial);
            flowArrow.position.set(0, 0, -2.5);
            flowArrow.rotation.x = Math.PI;
            group.add(flowArrow);
        }

        // Create crankshaft and flywheel
        function createCrankshaft() {
            const group = new THREE.Group();
            group.name = 'crankshaft';
            engineGroup.add(group);

            // Main shaft
            const shaftGeometry = new THREE.CylinderGeometry(0.5, 0.5, 20, 16);
            const shaftMaterial = new THREE.MeshStandardMaterial({
                color: 0x666666,
                roughness: 0.2,
                metalness: 0.8
            });
            const shaft = new THREE.Mesh(shaftGeometry, shaftMaterial);
            shaft.rotation.z = Math.PI / 2;
            shaft.castShadow = true;
            group.add(shaft);

            // Crank webs
            for (let i = -1; i <= 1; i += 2) {
                const webGeometry = new THREE.BoxGeometry(3, 0.5, 1);
                const webMaterial = new THREE.MeshStandardMaterial({
                    color: 0x555555,
                    roughness: 0.3,
                    metalness: 0.7
                });
                const web = new THREE.Mesh(webGeometry, webMaterial);
                web.position.set(i * 1.5, 0, 0);
                web.castShadow = true;
                group.add(web);
            }

            // Crank pins (90° out of phase)
            const powerPinGeometry = new THREE.CylinderGeometry(0.3, 0.3, 1, 16);
            const displacerPinGeometry = new THREE.CylinderGeometry(0.3, 0.3, 1, 16);
            
            const powerPinMaterial = new THREE.MeshStandardMaterial({
                color: 0x4caf50,
                emissive: 0x2e7d32,
                emissiveIntensity: 0.3
            });
            const displacerPinMaterial = new THREE.MeshStandardMaterial({
                color: 0xffab00,
                emissive: 0xff6d00,
                emissiveIntensity: 0.3
            });

            const powerPin = new THREE.Mesh(powerPinGeometry, powerPinMaterial);
            const displacerPin = new THREE.Mesh(displacerPinGeometry, displacerPinMaterial);
            
            powerPin.rotation.z = Math.PI / 2;
            displacerPin.rotation.z = Math.PI / 2;
            
            powerPin.castShadow = true;
            displacerPin.castShadow = true;
            
            group.add(powerPin);
            group.add(displacerPin);

            // Flywheel
            const flywheelGeometry = new THREE.CylinderGeometry(6, 6, 1, 32);
            const flywheelMaterial = new THREE.MeshStandardMaterial({
                color: 0x333333,
                roughness: 0.5,
                metalness: 0.5
            });
            flywheel = new THREE.Mesh(flywheelGeometry, flywheelMaterial);
            flywheel.position.set(0, 0, 0);
            flywheel.castShadow = true;
            flywheel.receiveShadow = true;
            group.add(flywheel);

            // Flywheel spokes
            for (let i = 0; i < 6; i++) {
                const angle = (i * Math.PI) / 3;
                const spokeGeometry = new THREE.BoxGeometry(0.3, 5, 0.3);
                const spokeMaterial = new THREE.MeshStandardMaterial({
                    color: 0x666666,
                    roughness: 0.4,
                    metalness: 0.6
                });
                const spoke = new THREE.Mesh(spokeGeometry, spokeMaterial);
                spoke.position.set(Math.cos(angle) * 2.5, Math.sin(angle) * 2.5, 0);
                spoke.rotation.z = angle;
                spoke.castShadow = true;
                group.add(spoke);
            }

            // Balance weights
            const weightGeometry = new THREE.BoxGeometry(2, 1, 1);
            const weightMaterial = new THREE.MeshStandardMaterial({
                color: 0x222222,
                roughness: 0.6,
                metalness: 0.4
            });
            for (let i = 0; i < 2; i++) {
                const weight = new THREE.Mesh(weightGeometry, weightMaterial);
                weight.position.set(Math.cos(i * Math.PI) * 4, Math.sin(i * Math.PI) * 4, 0);
                weight.castShadow = true;
                group.add(weight);
            }

            crankshaft = {
                group: group,
                powerPin: powerPin,
                displacerPin: displacerPin,
                flywheel: flywheel
            };
        }

        // Create connecting rods
        function createConnectingRods() {
            const group = new THREE.Group();
            group.name = 'connectingRods';
            engineGroup.add(group);

            // Power piston connecting rod
            const powerRodGeometry = new THREE.CylinderGeometry(0.2, 0.2, 10, 8);
            const powerRodMaterial = new THREE.MeshStandardMaterial({
                color: 0x4caf50,
                roughness: 0.3,
                metalness: 0.7
            });
            const powerRod = new THREE.Mesh(powerRodGeometry, powerRodMaterial);
            powerRod.castShadow = true;
            group.add(powerRod);

            // Displacer connecting rod
            const displacerRodGeometry = new THREE.CylinderGeometry(0.15, 0.15, 10, 8);
            const displacerRodMaterial = new THREE.MeshStandardMaterial({
                color: 0xffab00,
                roughness: 0.3,
                metalness: 0.7
            });
            const displacerRod = new THREE.Mesh(displacerRodGeometry, displacerRodMaterial);
            displacerRod.castShadow = true;
            group.add(displacerRod);

            connectingRods = {
                powerRod: powerRod,
                displacerRod: displacerRod
            };
        }

        // Create heater block with cartridge heaters
        function createHeaterBlock() {
            const group = new THREE.Group();
            group.name = 'heaterBlock';
            engineGroup.add(group);

            // Main heater block
            const blockGeometry = new THREE.BoxGeometry(6, 6, 6);
            const blockMaterial = new THREE.MeshStandardMaterial({
                color: 0xff3300,
                emissive: 0xff3300,
                emissiveIntensity: 0.5,
                roughness: 0.4,
                metalness: 0.6
            });
            const block = new THREE.Mesh(blockGeometry, blockMaterial);
            block.position.set(-10, 0, 0);
            block.castShadow = true;
            block.receiveShadow = true;
            group.add(block);

            // Cartridge heaters
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    const heaterGeometry = new THREE.CylinderGeometry(0.3, 0.3, 5, 8);
                    const heaterMaterial = new THREE.MeshStandardMaterial({
                        color: 0xff6d00,
                        emissive: 0xff3300,
                        emissiveIntensity: 1.0
                    });
                    const heater = new THREE.Mesh(heaterGeometry, heaterMaterial);
                    heater.position.set(-10 + i * 1.5, j * 1.5, 0);
                    heater.rotation.z = Math.PI / 2;
                    heater.castShadow = true;
                    group.add(heater);
                }
            }

            // Thermal insulation layer
            const insulationGeometry = new THREE.BoxGeometry(6.5, 6.5, 6.5);
            const insulationMaterial = new THREE.MeshStandardMaterial({
                color: 0x888888,
                roughness: 0.8,
                metalness: 0.1,
                transparent: true,
                opacity: 0.3
            });
            const insulation = new THREE.Mesh(insulationGeometry, insulationMaterial);
            insulation.position.set(-10, 0, 0);
            group.add(insulation);

            heaterBlock = group;
        }

        // Create cooling jacket
        function createCoolingJacket() {
            const group = new THREE.Group();
            group.name = 'coolingJacket';
            engineGroup.add(group);

            // Main jacket
            const jacketGeometry = new THREE.CylinderGeometry(3, 3, 7, 32);
            const jacketMaterial = new THREE.MeshStandardMaterial({
                color: 0x0066cc,
                roughness: 0.3,
                metalness: 0.7,
                transparent: true,
                opacity: 0.7
            });
            const jacket = new THREE.Mesh(jacketGeometry, jacketMaterial);
            jacket.position.set(10, 0, 0);
            jacket.castShadow = true;
            jacket.receiveShadow = true;
            group.add(jacket);

            // Coolant channels
            const channelGroup = new THREE.Group();
            for (let i = 0; i < 8; i++) {
                const angle = (i * Math.PI * 2) / 8;
                const channelGeometry = new THREE.TorusGeometry(2.5, 0.2, 8, 32, Math.PI * 2);
                const channelMaterial = new THREE.MeshStandardMaterial({
                    color: 0x00bcd4,
                    emissive: 0x0066cc,
                    emissiveIntensity: 0.5
                });
                const channel = new THREE.Mesh(channelGeometry, channelMaterial);
                channel.position.set(10 + Math.cos(angle) * 2.5, Math.sin(angle) * 2.5, 0);
                channel.rotation.x = Math.PI / 2;
                channel.rotation.y = angle;
                channelGroup.add(channel);
            }
            group.add(channelGroup);

            // Inlet and outlet pipes
            const pipeGeometry = new THREE.CylinderGeometry(0.3, 0.3, 2, 8);
            const pipeMaterial = new THREE.MeshStandardMaterial({
                color: 0x00bcd4,
                roughness: 0.2,
                metalness: 0.8
            });
            
            const inletPipe = new THREE.Mesh(pipeGeometry, pipeMaterial);
            inletPipe.position.set(12, 2, 0);
            inletPipe.rotation.z = Math.PI / 2;
            group.add(inletPipe);
            
            const outletPipe = new THREE.Mesh(pipeGeometry, pipeMaterial);
            outletPipe.position.set(12, -2, 0);
            outletPipe.rotation.z = Math.PI / 2;
            group.add(outletPipe);

            coolingJacket = group;
        }

        // Create gas particles for visualization
        function createGasParticles() {
            const particleCount = 500;
            const particleGeometry = new THREE.SphereGeometry(0.05, 4, 4);
            
            for (let i = 0; i < particleCount; i++) {
                const material = new THREE.MeshBasicMaterial({
                    color: Math.random() > 0.5 ? 0xff6d00 : 0x00bcd4,
                    transparent: true,
                    opacity: 0.6
                });
                
                const particle = new THREE.Mesh(particleGeometry, material);
                
                // Random initial position
                particle.position.x = (Math.random() - 0.5) * 20;
                particle.position.y = (Math.random() - 0.5) * 10;
                particle.position.z = (Math.random() - 0.5) * 5;
                
                // Store velocity and phase for animation
                particle.userData = {
                    velocity: new THREE.Vector3(
                        (Math.random() - 0.5) * 0.02,
                        (Math.random() - 0.5) * 0.02,
                        (Math.random() - 0.5) * 0.02
                    ),
                    phase: Math.random() * Math.PI * 2,
                    speed: 0.01 + Math.random() * 0.02
                };
                
                scene.add(particle);
                gasParticles.push(particle);
            }
        }

        // Create selection helpers
        function createSelectionHelpers() {
            // Wireframe for selected component
            const wireframeMaterial = new THREE.LineBasicMaterial({
                color: 0x00ff00,
                linewidth: 2
            });
            
            // We'll create wireframes dynamically when components are selected
        }

        // Update engine animation based on parameters
        function updateEngineAnimation(deltaTime) {
            if (!engineRunning) return;
            
            // Calculate angular velocity
            const angularVelocity = (engineParams.rpm * Math.PI * 2) / 60;
            engineAngle += angularVelocity * deltaTime;
            
            // Keep angle within 0-2π
            if (engineAngle > Math.PI * 2) engineAngle -= Math.PI * 2;
            
            // Calculate piston positions (simple harmonic motion)
            const crankRadius = 3; // cm
            const connectingRodLength = 10; // cm
            
            // Power piston position
            const powerPistonY = crankRadius * Math.sin(engineAngle);
            
            // Displacer position (90° out of phase)
            const displacerY = crankRadius * Math.sin(engineAngle + Math.PI / 2);
            
            // Update power piston
            if (powerPiston) {
                powerPiston.position.set(10, powerPistonY, 0);
            }
            
            // Update displacer
            if (displacer) {
                displacer.position.set(-10, displacerY, 0);
            }
            
            // Update crankshaft pins
            if (crankshaft) {
                const powerPinAngle = engineAngle;
                const displacerPinAngle = engineAngle + Math.PI / 2;
                
                crankshaft.powerPin.position.set(
                    Math.cos(powerPinAngle) * crankRadius,
                    Math.sin(powerPinAngle) * crankRadius,
                    0
                );
                
                crankshaft.displacerPin.position.set(
                    Math.cos(displacerPinAngle) * crankRadius,
                    Math.sin(displacerPinAngle) * crankRadius,
                    0
                );
                
                // Rotate flywheel
                crankshaft.flywheel.rotation.z = -engineAngle;
            }
            
            // Update connecting rods
            if (connectingRods) {
                // Power piston connecting rod
                const powerRodStart = new THREE.Vector3(10, powerPistonY - 1.25, 0);
                const powerRodEnd = crankshaft.powerPin.position.clone();
                
                connectingRods.powerRod.position.copy(powerRodStart.clone().add(powerRodEnd).multiplyScalar(0.5));
                connectingRods.powerRod.scale.y = powerRodStart.distanceTo(powerRodEnd) / 10;
                connectingRods.powerRod.lookAt(powerRodEnd);
                connectingRods.powerRod.rotateX(Math.PI / 2);
                
                // Displacer connecting rod
                const displacerRodStart = new THREE.Vector3(-10, displacerY + 2.75, 0);
                const displacerRodEnd = crankshaft.displacerPin.position.clone();
                
                connectingRods.displacerRod.position.copy(displacerRodStart.clone().add(displacerRodEnd).multiplyScalar(0.5));
                connectingRods.displacerRod.scale.y = displacerRodStart.distanceTo(displacerRodEnd) / 10;
                connectingRods.displacerRod.lookAt(displacerRodEnd);
                connectingRods.displacerRod.rotateX(Math.PI / 2);
            }
            
            // Update piston rings
            if (pistonRings) {
                pistonRings.position.y = powerPistonY;
            }
            
            // Update gas particles
            updateGasParticles(deltaTime);
            
            // Update thermal visualization
            updateThermalVisualization();
        }

        // Update gas particles animation
        function updateGasParticles(deltaTime) {
            if (!gasParticlesEnabled) return;
            
            gasParticles.forEach(particle => {
                // Simple flow pattern based on engine phase
                const phase = particle.userData.phase;
                const time = Date.now() * 0.001;
                
                // Flow from hot to cold side based on engine cycle
                const flowDirection = Math.sin(engineAngle + phase) > 0 ? 1 : -1;
                
                // Update position
                particle.position.x += flowDirection * particle.userData.speed * deltaTime * 60;
                
                // Add some Brownian motion
                particle.position.x += (Math.random() - 0.5) * 0.01;
                particle.position.y += (Math.random() - 0.5) * 0.01;
                particle.position.z += (Math.random() - 0.5) * 0.01;
                
                // Keep particles within engine bounds
                if (particle.position.x < -12) particle.position.x = 12;
                if (particle.position.x > 12) particle.position.x = -12;
                if (particle.position.y < -6) particle.position.y = 6;
                if (particle.position.y > 6) particle.position.y = -6;
                if (Math.abs(particle.position.z) > 3) particle.position.z *= -0.9;
                
                // Update color based on temperature zone
                if (particle.position.x < -5) {
                    // Hot zone
                    particle.material.color.setHex(0xff6d00);
                    particle.material.opacity = 0.8;
                } else if (particle.position.x > 5) {
                    // Cold zone
                    particle.material.color.setHex(0x00bcd4);
                    particle.material.opacity = 0.8;
                } else {
                    // Regenerator zone
                    const t = (particle.position.x + 5) / 10;
                    particle.material.color.lerpColors(
                        new THREE.Color(0xff6d00),
                        new THREE.Color(0x00bcd4),
                        t
                    );
                    particle.material.opacity = 0.6;
                }
            });
        }

        // Update thermal visualization
        function updateThermalVisualization() {
            // Update hot cylinder glow
            const hotCylinder = engineGroup.getObjectByName('hotCylinder');
            if (hotCylinder) {
                const hotIntensity = engineParams.hotTemp / 850;
                hotCylinder.traverse(child => {
                    if (child.isMesh && child.material.emissive) {
                        child.material.emissiveIntensity = hotIntensity * 0.5;
                    }
                });
            }
            
            // Update heater block glow
            if (heaterBlock) {
                const heaterIntensity = engineParams.hotTemp / 850;
                heaterBlock.traverse(child => {
                    if (child.isMesh && child.material.emissive) {
                        child.material.emissiveIntensity = heaterIntensity;
                    }
                });
            }
            
            // Update cold cylinder glow
            const coldCylinder = engineGroup.getObjectByName('coldCylinder');
            if (coldCylinder) {
                const coldIntensity = (engineParams.coldTemp - 20) / 130;
                coldCylinder.traverse(child => {
                    if (child.isMesh && child.material.emissive) {
                        child.material.emissiveIntensity = coldIntensity * 0.3;
                    }
                });
            }
        }

        // Update visualization mode
        function updateVisualizationMode(mode) {
            visualizationMode = mode;
            
            engineGroup.traverse(child => {
                if (child.isMesh) {
                    switch(mode) {
                        case 'wireframe':
                            child.material.wireframe = true;
                            child.material.transparent = false;
                            child.material.opacity = 1;
                            break;
                            
                        case 'thermal':
                            child.material.wireframe = false;
                            // Apply thermal colors based on position
                            if (child.position.x < -5) {
                                // Hot zone
                                child.material.color.setHex(0xff3300);
                            } else if (child.position.x > 5) {
                                // Cold zone
                                child.material.color.setHex(0x0066cc);
                            }
                            break;
                            
                        case 'pressure':
                            child.material.wireframe = false;
                            // Pulsing effect for pressure visualization
                            const pressurePulse = Math.sin(Date.now() * 0.005) * 0.1 + 0.9;
                            child.material.opacity = 0.5 + pressurePulse * 0.3;
                            break;
                            
                        case 'xray':
                            child.material.wireframe = false;
                            child.material.transparent = true;
                            child.material.opacity = 0.3;
                            break;
                            
                        default: // normal
                            child.material.wireframe = false;
                            child.material.transparent = false;
                            child.material.opacity = 1;
                            break;
                    }
                }
            });
            
            // Update UI
            document.querySelectorAll('.viz-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
        }

        // Setup UI event listeners
        function setupUI() {
            // Component selection
            document.querySelectorAll('.tree-item').forEach(item => {
                item.addEventListener('click', () => {
                    // Update active state
                    document.querySelectorAll('.tree-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    // Get component name
                    const componentName = item.dataset.component;
                    selectedComponent = componentName;
                    
                    // Show material properties
                    showMaterialProperties(componentName);
                    
                    // Highlight component in 3D view
                    highlightComponent(componentName);
                });
                
                // Add hover tooltip
                item.addEventListener('mouseenter', (e) => {
                    const componentName = item.dataset.component;
                    const tooltip = document.getElementById('tooltip');
                    const tooltipData = componentTooltips[componentName];
                    
                    if (tooltipData) {
                        document.getElementById('tooltipTitle').textContent = tooltipData.title;
                        document.getElementById('tooltipDesc').textContent = tooltipData.desc;
                        tooltip.style.display = 'block';
                        tooltip.style.left = e.pageX + 10 + 'px';
                        tooltip.style.top = e.pageY + 10 + 'px';
                    }
                });
                
                item.addEventListener('mousemove', (e) => {
                    const tooltip = document.getElementById('tooltip');
                    tooltip.style.left = e.pageX + 10 + 'px';
                    tooltip.style.top = e.pageY + 10 + 'px';
                });
                
                item.addEventListener('mouseleave', () => {
                    document.getElementById('tooltip').style.display = 'none';
                });
            });
            
            // Control sliders
            document.getElementById('hotTempSlider').addEventListener('input', (e) => {
                engineParams.hotTemp = parseInt(e.target.value);
                document.getElementById('hotTempValue').textContent = `${engineParams.hotTemp}°C`;
                document.getElementById('currentTemp').textContent = `${engineParams.hotTemp}°C`;
                updateEnginePerformance();
            });
            
            document.getElementById('coldTempSlider').addEventListener('input', (e) => {
                engineParams.coldTemp = parseInt(e.target.value);
                document.getElementById('coldTempValue').textContent = `${engineParams.coldTemp}°C`;
                document.getElementById('coldTemp').textContent = `${engineParams.coldTemp}°C`;
                updateEnginePerformance();
            });
            
            document.getElementById('rpmSlider').addEventListener('input', (e) => {
                engineParams.rpm = parseInt(e.target.value);
                document.getElementById('rpmValue').textContent = `${engineParams.rpm} RPM`;
                document.getElementById('currentRPM').textContent = engineParams.rpm;
                updateEnginePerformance();
            });
            
            document.getElementById('pressureSlider').addEventListener('input', (e) => {
                engineParams.pressure = parseFloat(e.target.value);
                document.getElementById('pressureValue').textContent = `${engineParams.pressure.toFixed(2)} MPa`;
                document.getElementById('currentPressure').textContent = engineParams.pressure.toFixed(1);
                updateEnginePerformance();
            });
            
            // Control buttons
            document.getElementById('startBtn').addEventListener('click', () => {
                engineRunning = true;
            });
            
            document.getElementById('stopBtn').addEventListener('click', () => {
                engineRunning = false;
            });
            
            document.getElementById('resetBtn').addEventListener('click', () => {
                engineRunning = false;
                engineAngle = 0;
                engineParams.hotTemp = 600;
                engineParams.coldTemp = 80;
                engineParams.rpm = 300;
                engineParams.pressure = 1.2;
                
                // Reset sliders
                document.getElementById('hotTempSlider').value = 600;
                document.getElementById('coldTempSlider').value = 80;
                document.getElementById('rpmSlider').value = 300;
                document.getElementById('pressureSlider').value = 1.2;
                
                // Update displays
                document.getElementById('hotTempValue').textContent = '600°C';
                document.getElementById('coldTempValue').textContent = '80°C';
                document.getElementById('rpmValue').textContent = '300 RPM';
                document.getElementById('pressureValue').textContent = '1.20 MPa';
                
                document.getElementById('currentTemp').textContent = '600°C';
                document.getElementById('coldTemp').textContent = '80°C';
                document.getElementById('currentRPM').textContent = '300';
                document.getElementById('currentPressure').textContent = '1.2';
                
                updateEnginePerformance();
            });
            
            // Visualization mode buttons
            document.querySelectorAll('.viz-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    updateVisualizationMode(btn.dataset.mode);
                });
            });
            
            // Cross-section toggle
            document.getElementById('crossSectionToggle').addEventListener('click', () => {
                crossSectionEnabled = !crossSectionEnabled;
                document.getElementById('crossSectionToggle').classList.toggle('active', crossSectionEnabled);
                updateCrossSection();
            });
            
            // Gas particles toggle
            document.getElementById('gasToggle').addEventListener('click', () => {
                gasParticlesEnabled = !gasParticlesEnabled;
                document.getElementById('gasToggle').classList.toggle('active', gasParticlesEnabled);
                
                // Show/hide gas particles
                gasParticles.forEach(particle => {
                    particle.visible = gasParticlesEnabled;
                });
            });
            
            // Window resize
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // Show material properties for selected component
        function showMaterialProperties(componentName) {
            const materialPanel = document.getElementById('materialPanel');
            const propertiesContainer = document.getElementById('materialProperties');
            
            // Get material data based on component
            let materialData = [];
            switch(componentName) {
                case 'hotCylinder':
                case 'heaterBlock':
                    materialData = [
                        { name: 'Material', value: 'Stainless Steel 316L' },
                        { name: 'Thermal Conductivity', value: '16.3 W/m·K' },
                        { name: 'Expansion Coefficient', value: '16.0 μm/m·K' },
                        { name: 'Yield Strength', value: '290 MPa' },
                        { name: 'Max Temperature', value: '850°C' },
                        { name: 'Surface Finish', value: 'Ra 0.4μm' }
                    ];
                    break;
                    
                case 'coldCylinder':
                case 'coolingJacket':
                    materialData = [
                        { name: 'Material', value: 'Aluminum 6061-T6' },
                        { name: 'Thermal Conductivity', value: '167 W/m·K' },
                        { name: 'Expansion Coefficient', value: '23.6 μm/m·K' },
                        { name: 'Yield Strength', value: '276 MPa' },
                        { name: 'Hardness', value: 'HB 95' },
                        { name: 'Coating', value: 'Hard Anodized' }
                    ];
                    break;
                    
                case 'powerPiston':
                    materialData = [
                        { name: 'Material', value: 'Graphite Composite' },
                        { name: 'Composition', value: '80% Graphite, 15% Resin, 5% MoS₂' },
                        { name: 'Thermal Conductivity', value: '120 W/m·K' },
                        { name: 'Expansion Coefficient', value: '4.5 μm/m·K' },
                        { name: 'Friction Coefficient', value: '0.08' },
                        { name: 'Max PV', value: '1.0 MPa·m/s' }
                    ];
                    break;
                    
                case 'pistonRings':
                    materialData = [
                        { name: 'Material', value: 'Cast Iron Grade 250' },
                        { name: 'Coating', value: 'Chrome Plated (0.1mm)' },
                        { name: 'Hardness', value: 'HRB 98-107' },
                        { name: 'Thermal Conductivity', value: '50 W/m·K' },
                        { name: 'Ring Gap', value: '0.30 ±0.05 mm' },
                        { name: 'Radial Pressure', value: '0.8 MPa' }
                    ];
                    break;
                    
                default:
                    materialData = [
                        { name: 'Material', value: 'Various' },
                        { name: 'Status', value: 'Select a component for details' }
                    ];
            }
            
            // Populate properties
            propertiesContainer.innerHTML = '';
            materialData.forEach(prop => {
                const div = document.createElement('div');
                div.className = 'material-property';
                div.innerHTML = `
                    <span class="property-name">${prop.name}</span>
                    <span class="property-value">${prop.value}</span>
                `;
                propertiesContainer.appendChild(div);
            });
            
            // Show panel
            materialPanel.style.display = 'block';
        }

        // Highlight selected component in 3D view
        function highlightComponent(componentName) {
            // Remove previous highlights
            engineGroup.traverse(child => {
                if (child.isMesh && child.userData.originalMaterial) {
                    child.material = child.userData.originalMaterial;
                    delete child.userData.originalMaterial;
                }
            });
            
            // Find and highlight selected component
            const component = engineGroup.getObjectByName(componentName);
            if (component) {
                component.traverse(child => {
                    if (child.isMesh) {
                        // Store original material
                        child.userData.originalMaterial = child.material;
                        
                        // Create highlight material
                        const highlightMaterial = child.material.clone();
                        highlightMaterial.emissive = new THREE.Color(0x00ff00);
                        highlightMaterial.emissiveIntensity = 0.3;
                        
                        // Apply highlight
                        child.material = highlightMaterial;
                    }
                });
            }
        }

        // Update cross-section view
        function updateCrossSection() {
            engineGroup.traverse(child => {
                if (child.isMesh) {
                    // For cylinders, adjust opacity for cross-section
                    if (child.name.includes('Cylinder') || child.name.includes('bore')) {
                        child.material.transparent = crossSectionEnabled;
                        child.material.opacity = crossSectionEnabled ? 0.3 : 1.0;
                        child.material.side = crossSectionEnabled ? THREE.DoubleSide : THREE.FrontSide;
                    }
                }
            });
        }

        // Update engine performance metrics
        function updateEnginePerformance() {
            // Calculate Carnot efficiency
            const tHot = engineParams.hotTemp + 273.15;
            const tCold = engineParams.coldTemp + 273.15;
            const carnotEff = (1 - tCold / tHot) * 100;
            
            // Calculate actual efficiency (typically 40-50% of Carnot)
            const actualEff = carnotEff * 0.48 * (1 + (engineParams.pressure - 1) * 0.1);
            
            // Calculate power based on Stirling engine formula
            const tempDiff = engineParams.hotTemp - engineParams.coldTemp;
            const powerFactor = (tempDiff / 520) * (engineParams.rpm / 300) * (engineParams.pressure / 1.2);
            const power = 20.0 * powerFactor * (0.97 + Math.random() * 0.06);
            
            // Calculate torque: P = τ × ω, ω = RPM × 2π/60
            const angularSpeed = (engineParams.rpm * 2 * Math.PI) / 60;
            const torque = power / angularSpeed;
            
            // Gas flow rate
            const displacement = (Math.PI * 2.25 * 2.25 * 6) / 1000; // cm³ to L
            const flow = (displacement * engineParams.rpm / 60 * 2) * (1 + engineParams.pressure * 0.2);
            
            // Update parameters
            engineParams.power = Math.max(5, Math.min(35, power));
            engineParams.efficiency = Math.max(15, Math.min(45, actualEff));
            engineParams.torque = Math.max(0.1, Math.min(1.5, torque));
            engineParams.gasFlow = Math.max(5, Math.min(20, flow));
            
            // Update UI
            document.getElementById('powerValue').textContent = `${engineParams.power.toFixed(1)} W`;
            document.getElementById('efficiencyValue').textContent = `${engineParams.efficiency.toFixed(1)}%`;
            document.getElementById('torqueValue').textContent = `${engineParams.torque.toFixed(2)} N·m`;
            document.getElementById('flowValue').textContent = `${engineParams.gasFlow.toFixed(1)} L/s`;
            
            document.getElementById('powerBadge').textContent = `${engineParams.power.toFixed(1)}W`;
        }

        // Animation loop
        let clock = new THREE.Clock();
        
        function animate() {
            const deltaTime = clock.getDelta();
            
            // Update engine animation
            updateEngineAnimation(deltaTime);
            
            // Update controls
            controls.update();
            
            // Render scene
            renderer.render(scene, camera);
            
            // Update stats
            stats.update();
            
            // Continue animation
            animationId = requestAnimationFrame(animate);
        }

        // Initialize loading progress
        let loadingProgress = 0;
        const loadingInterval = setInterval(() => {
            loadingProgress += Math.random() * 20;
            if (loadingProgress > 100) {
                loadingProgress = 100;
                clearInterval(loadingInterval);
            }
            document.getElementById('progressFill').style.width = `${loadingProgress}%`;
        }, 100);

        // Start everything
        init();
    </script>
</body>
</html>