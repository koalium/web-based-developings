<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Passive Wi-Fi Radar Medical Monitoring</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #7c3aed;
            --danger: #dc2626;
            --success: #16a34a;
            --warning: #d97706;
            --info: #0ea5e9;
            --bg: #0f172a;
            --card-bg: #1e293b;
            --text: #f8fafc;
            --grid: rgba(255, 255, 255, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, #1e1b4b 100%);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        /* Header Styles */
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 30px;
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--grid);
        }
        
        h1 {
            font-size: 3rem;
            margin-bottom: 15px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--info));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: titleGlow 3s ease-in-out infinite alternate;
        }
        
        @keyframes titleGlow {
            from { filter: drop-shadow(0 0 10px rgba(37, 99, 235, 0.5)); }
            to { filter: drop-shadow(0 0 20px rgba(124, 58, 237, 0.5)); }
        }
        
        /* Mathematical Model Panel */
        .math-panel {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 1px solid var(--grid);
            font-family: 'Cambria Math', serif;
        }
        
        .math-equation {
            text-align: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border-left: 4px solid var(--primary);
        }
        
        /* 3D Visualization */
        .visualization-3d {
            width: 100%;
            height: 400px;
            background: 
                radial-gradient(circle at 20% 80%, rgba(37, 99, 235, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(124, 58, 237, 0.1) 0%, transparent 50%);
            border-radius: 15px;
            position: relative;
            overflow: hidden;
            border: 1px solid var(--grid);
        }
        
        .room-grid {
            position: absolute;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(var(--grid) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid) 1px, transparent 1px);
            background-size: 50px 50px;
            opacity: 0.3;
        }
        
        .antenna-array-3d {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            border: 1px solid var(--primary);
        }
        
        .antenna-3d {
            width: 12px;
            height: 12px;
            background: var(--primary);
            border-radius: 50%;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px var(--primary);
        }
        
        .antenna-active {
            background: var(--success);
            box-shadow: 0 0 15px var(--success);
            animation: pulse 2s infinite;
        }
        
        .patient-marker {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            transition: all 0.5s ease;
            border: 2px solid;
        }
        
        .vital-waves {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .wave-circle {
            position: absolute;
            border-radius: 50%;
            border: 1px solid;
            opacity: 0;
            animation: waveExpand 3s linear infinite;
        }
        
        @keyframes waveExpand {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        /* Enhanced Cards */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 25px;
            margin-bottom: 25px;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--grid);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.4);
        }
        
        /* Signal Processing Pipeline */
        .processing-pipeline {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin: 25px 0;
        }
        
        .pipeline-step {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid var(--grid);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .pipeline-step::after {
            content: 'â†’';
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        .pipeline-step:last-child::after {
            display: none;
        }
        
        .step-active {
            border-color: var(--primary);
            box-shadow: 0 0 25px rgba(37, 99, 235, 0.3);
            background: rgba(37, 99, 235, 0.1);
        }
        
        .step-completed {
            border-color: var(--success);
            background: rgba(22, 163, 74, 0.1);
        }
        
        /* Advanced Controls */
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 25px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            border: 1px solid var(--grid);
        }
        
        .param-slider {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .slider-label {
            display: flex;
            justify-content: between;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Matrix Visualization */
        .matrix-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 3px;
            margin: 15px 0;
            max-width: 400px;
        }
        
        .matrix-cell {
            width: 25px;
            height: 25px;
            background: var(--primary);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            color: white;
            transition: all 0.3s ease;
        }
        
        /* Enhanced Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .floating {
            animation: float 3s ease-in-out infinite;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .processing-pipeline {
                grid-template-columns: 1fr;
            }
            
            .pipeline-step::after {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container" x-data="advancedRadarSystem()">
        <!-- Header with Mathematical Model -->
        <header>
            <h1>Advanced Passive Wi-Fi Radar Medical Monitoring</h1>
            <p class="subtitle">Real-time Non-contact Patient Monitoring Using 8Ã—8 Phased Array & MUSIC Algorithm</p>
            
            <div class="math-panel">
                <div class="math-equation">
                    <h3>Signal Model</h3>
                    <p>\[r_{mn}(t) = \sum_{k=1}^{K} \alpha_k(t)s(t - \tau_k(t))e^{-j2\pi f_c\tau_k(t)}e^{-j\mathbf{k}\cdot\mathbf{d}_{mn}} + n_{mn}(t)\]</p>
                </div>
                <div class="math-equation">
                    <h3>MUSIC Spectrum</h3>
                    <p>\[P_{\text{MUSIC}}(\theta,\phi) = \frac{1}{\mathbf{a}^H(\theta,\phi)\mathbf{E}_n\mathbf{E}_n^H\mathbf{a}(\theta,\phi)}\]</p>
                </div>
            </div>
        </header>

        <!-- 3D Visualization -->
        <div class="card">
            <div class="card-header">
                <h2>3D Environment & Signal Propagation</h2>
                <div class="status-indicator">
                    <div class="status-dot" :class="systemStatus.color"></div>
                    <span x-text="systemStatus.text"></span>
                </div>
            </div>
            <div class="visualization-3d">
                <div class="room-grid"></div>
                <div class="antenna-array-3d">
                    <template x-for="(row, i) in antennaArray" :key="i">
                        <template x-for="(antenna, j) in row" :key="j">
                            <div class="antenna-3d" :class="{'antenna-active': antenna.active}"></div>
                        </template>
                    </template>
                </div>
                
                <template x-for="patient in patients" :key="patient.id">
                    <div class="patient-marker floating" 
                         :style="`left: ${patient.position.x}%; top: ${patient.position.y}%; background: ${patient.color}; border-color: ${patient.color}`">
                        <span x-text="patient.name"></span>
                        <div class="vital-waves">
                            <div class="wave-circle" :style="`border-color: ${patient.color}; animation-delay: ${patient.id * 0.5}s`"></div>
                            <div class="wave-circle" :style="`border-color: ${patient.color}; animation-delay: ${patient.id * 0.5 + 1}s`"></div>
                            <div class="wave-circle" :style="`border-color: ${patient.color}; animation-delay: ${patient.id * 0.5 + 2}s`"></div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <!-- Signal Processing Pipeline -->
        <div class="card">
            <div class="card-header">
                <h2>Advanced Signal Processing Pipeline</h2>
            </div>
            <div class="processing-pipeline">
                <div class="pipeline-step" :class="{'step-active': currentStep === 0, 'step-completed': currentStep > 0}">
                    <h4>Signal Acquisition</h4>
                    <p>64-channel RF Sampling</p>
                    <div class="matrix-grid">
                        <template x-for="i in 64" :key="i">
                            <div class="matrix-cell" :style="`background: ${getSignalColor(i)}`"></div>
                        </template>
                    </div>
                </div>
                <div class="pipeline-step" :class="{'step-active': currentStep === 1, 'step-completed': currentStep > 1}">
                    <h4>Direct Path Cancellation</h4>
                    <p>RLS Adaptive Filtering</p>
                    <p>\[w_{opt} = \frac{E\{r_{mn}(t)d^*(t)\}}{E\{|d(t)|^2\}}\]</p>
                </div>
                <div class="pipeline-step" :class="{'step-active': currentStep === 2, 'step-completed': currentStep > 2}">
                    <h4>Covariance Matrix</h4>
                    <p>64Ã—64 Spatial Processing</p>
                    <p>\[\mathbf{R}_{xx} = \frac{1}{N}\sum \mathbf{x}[n]\mathbf{x}^H[n]\]</p>
                </div>
                <div class="pipeline-step" :class="{'step-active': currentStep === 3, 'step-completed': currentStep > 3}">
                    <h4>DOA Estimation</h4>
                    <p>2D MUSIC Algorithm</p>
                    <p>\[\theta_{est} = \arg\max P_{MUSIC}(\theta,\phi)\]</p>
                </div>
                <div class="pipeline-step" :class="{'step-active': currentStep === 4, 'step-completed': currentStep > 4}">
                    <h4>MVDR Beamforming</h4>
                    <p>Adaptive Spatial Filtering</p>
                    <p>\[\mathbf{w}_{MVDR} = \frac{\mathbf{R}_{xx}^{-1}\mathbf{a}(\theta)}{\mathbf{a}^H(\theta)\mathbf{R}_{xx}^{-1}\mathbf{a}(\theta)}\]</p>
                </div>
                <div class="pipeline-step" :class="{'step-active': currentStep === 5, 'step-completed': currentStep > 5}">
                    <h4>Vital Signs Extraction</h4>
                    <p>EMD & Wavelet Analysis</p>
                    <p>\[x(t) = A_r\cos(2\pi f_r t) + A_h\cos(2\pi f_h t)\]</p>
                </div>
            </div>
        </div>

        <!-- Enhanced Control Panel -->
        <div class="card">
            <div class="card-header">
                <h2>System Parameters & Controls</h2>
            </div>
            <div class="control-panel">
                <div class="param-slider">
                    <div class="slider-label">
                        <span>Wi-Fi Frequency</span>
                        <span x-text="`${wifiFrequency} GHz`"></span>
                    </div>
                    <input type="range" min="2.4" max="5.8" step="0.1" x-model="wifiFrequency" class="slider">
                </div>
                <div class="param-slider">
                    <div class="slider-label">
                        <span>SNR Threshold</span>
                        <span x-text="`${snrThreshold} dB`"></span>
                    </div>
                    <input type="range" min="0" max="30" step="1" x-model="snrThreshold" class="slider">
                </div>
                <div class="param-slider">
                    <div class="slider-label">
                        <span>Beamforming Gain</span>
                        <span x-text="`${beamformingGain} dB`"></span>
                    </div>
                    <input type="range" min="10" max="30" step="1" x-model="beamformingGain" class="slider">
                </div>
                <button class="btn" @click="startSimulation">Start Simulation</button>
                <button class="btn btn-secondary" @click="stopSimulation">Stop</button>
                <button class="btn btn-success" @click="addPatient">Add Patient</button>
                <button class="btn btn-danger" @click="triggerEmergency">Test Alert</button>
            </div>
        </div>

        <!-- Advanced Visualizations -->
        <div class="dashboard">
            <!-- Spatial Spectrum -->
            <div class="card">
                <div class="card-header">
                    <h2>Spatial Spectrum (MUSIC Algorithm)</h2>
                </div>
                <div class="visualization-area">
                    <canvas id="spatialSpectrumChart"></canvas>
                </div>
            </div>

            <!-- Covariance Matrix -->
            <div class="card">
                <div class="card-header">
                    <h2>Covariance Matrix Visualization</h2>
                </div>
                <div class="visualization-area">
                    <canvas id="covarianceMatrixChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Advanced Patient Monitoring -->
        <div class="card">
            <div class="card-header">
                <h2>Advanced Patient Analytics</h2>
            </div>
            <div class="dashboard">
                <div class="card">
                    <h3>Heart Rate Variability (HRV)</h3>
                    <div class="visualization-area">
                        <canvas id="hrvChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3>Respiratory Pattern Analysis</h3>
                    <div class="visualization-area">
                        <canvas id="respirationChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emergency Alert System -->
        <template x-if="emergencyAlert">
            <div class="alert-banner">
                <div class="alert-icon">ðŸš¨</div>
                <div class="alert-content">
                    <strong x-text="emergencyAlert.type"></strong>
                    <span x-text="emergencyAlert.message"></span>
                    <em x-text="`Patient: ${emergencyAlert.patient}`"></em>
                </div>
                <button @click="emergencyAlert = null" class="btn btn-danger">Acknowledge</button>
            </div>
        </template>
    </div>

    <script>
        function advancedRadarSystem() {
            return {
                // System State
                systemStatus: { text: 'Initializing', color: 'status-warning' },
                isRunning: false,
                currentStep: 0,
                simulationInterval: null,
                
                // System Parameters
                wifiFrequency: 5.8,
                snrThreshold: 15,
                beamformingGain: 20,
                
                // Antenna Array
                antennaArray: [],
                
                // Patients Data with advanced metrics
                patients: [
                    { 
                        id: 1, 
                        name: 'P1', 
                        heartRate: 72, 
                        respirationRate: 16, 
                        distance: 2.5, 
                        status: 'Stable', 
                        signalQuality: 92, 
                        color: '#3b82f6',
                        position: { x: 30, y: 40 },
                        hrv: 45,
                        respiratoryPattern: 'Normal'
                    },
                    { 
                        id: 2, 
                        name: 'P2', 
                        heartRate: 68, 
                        respirationRate: 14, 
                        distance: 3.2, 
                        status: 'Stable', 
                        signalQuality: 88, 
                        color: '#8b5cf6',
                        position: { x: 60, y: 30 },
                        hrv: 52,
                        respiratoryPattern: 'Normal'
                    },
                    { 
                        id: 3, 
                        name: 'P3', 
                        heartRate: 85, 
                        respirationRate: 18, 
                        distance: 4.1, 
                        status: 'Elevated', 
                        signalQuality: 79, 
                        color: '#10b981',
                        position: { x: 45, y: 60 },
                        hrv: 28,
                        respiratoryPattern: 'Rapid'
                    }
                ],
                
                // Emergency Alert
                emergencyAlert: null,
                
                // Charts
                charts: {},
                
                init() {
                    this.initializeAntennaArray();
                    this.initializeAdvancedCharts();
                    this.updateSystemStatus('Operational', 'status-active');
                    this.startSimulation();
                },
                
                initializeAntennaArray() {
                    let id = 1;
                    for (let i = 0; i < 8; i++) {
                        let row = [];
                        for (let j = 0; j < 8; j++) {
                            row.push({
                                id: id++,
                                active: Math.random() > 0.2,
                                phase: Math.random() * Math.PI * 2,
                                amplitude: 0.8 + Math.random() * 0.2
                            });
                        }
                        this.antennaArray.push(row);
                    }
                },
                
                initializeAdvancedCharts() {
                    // Spatial Spectrum Chart
                    const spatialCtx = document.getElementById('spatialSpectrumChart').getContext('2d');
                    this.charts.spatialSpectrum = new Chart(spatialCtx, {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 180}, (_, i) => i - 90),
                            datasets: [{
                                label: 'MUSIC Spectrum',
                                data: Array.from({length: 180}, (_, i) => {
                                    const theta = (i - 90) * Math.PI / 180;
                                    return Math.exp(-Math.pow(theta - 0.3, 2) * 50) + 
                                           Math.exp(-Math.pow(theta + 0.2, 2) * 60) +
                                           Math.exp(-Math.pow(theta - 0.8, 2) * 40) +
                                           Math.random() * 0.1;
                                }),
                                borderColor: '#3b82f6',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                borderWidth: 2,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    title: { display: true, text: 'Angle (degrees)' }
                                },
                                y: {
                                    title: { display: true, text: 'Spectral Power' },
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    
                    // Covariance Matrix Heatmap
                    const covCtx = document.getElementById('covarianceMatrixChart').getContext('2d');
                    this.charts.covarianceMatrix = new Chart(covCtx, {
                        type: 'matrix',
                        data: {
                            datasets: [{
                                label: 'Covariance Matrix',
                                data: this.generateCovarianceMatrix(),
                                backgroundColor: (context) => {
                                    const value = context.dataset.data[context.dataIndex].v;
                                    const alpha = Math.abs(value);
                                    return `rgba(59, 130, 246, ${alpha})`;
                                },
                                width: ({chart}) => (chart.chartArea || {}).width / 8 - 1,
                                height: ({chart}) => (chart.chartArea || {}).height / 8 - 1,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => {
                                            return `Cov[${context.row},${context.column}] = ${context.dataset.data[context.dataIndex].v.toFixed(3)}`;
                                        }
                                    }
                                }
                            }
                        }
                    });
                    
                    // HRV Chart
                    const hrvCtx = document.getElementById('hrvChart').getContext('2d');
                    this.charts.hrv = new Chart(hrvCtx, {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 50}, (_, i) => i),
                            datasets: [{
                                label: 'RR Intervals',
                                data: Array.from({length: 50}, () => 800 + Math.random() * 200),
                                borderColor: '#ef4444',
                                borderWidth: 2,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { title: { display: true, text: 'RR Interval (ms)' } }
                            }
                        }
                    });
                    
                    // Respiration Chart
                    const respCtx = document.getElementById('respirationChart').getContext('2d');
                    this.charts.respiration = new Chart(respCtx, {
                        type: 'line',
                        data: {
                            labels: Array.from({length: 100}, (_, i) => i),
                            datasets: [{
                                label: 'Chest Movement',
                                data: Array.from({length: 100}, (_, i) => 
                                    Math.sin(i * 0.2) * 10 + Math.random() * 2
                                ),
                                borderColor: '#10b981',
                                borderWidth: 2,
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: { title: { display: true, text: 'Displacement (mm)' } }
                            }
                        }
                    });
                },
                
                generateCovarianceMatrix() {
                    const data = [];
                    for (let i = 0; i < 8; i++) {
                        for (let j = 0; j < 8; j++) {
                            const distance = Math.sqrt(Math.pow(i-3.5, 2) + Math.pow(j-3.5, 2));
                            const value = Math.exp(-distance / 2) * (Math.random() * 0.2 + 0.8);
                            data.push({
                                x: i, y: j, v: value
                            });
                        }
                    }
                    return data;
                },
                
                startSimulation() {
                    this.isRunning = true;
                    this.updateSystemStatus('Active Monitoring', 'status-active');
                    
                    this.simulationInterval = setInterval(() => {
                        // Update processing pipeline
                        this.currentStep = (this.currentStep + 1) % 6;
                        
                        // Update antenna phases
                        this.updateAntennaPhases();
                        
                        // Update patient data with advanced metrics
                        this.updatePatientData();
                        
                        // Update all charts
                        this.updateAllCharts();
                        
                        // Random emergency trigger
                        if (Math.random() < 0.003) {
                            this.triggerRandomEmergency();
                        }
                    }, 1500);
                },
                
                updateAntennaPhases() {
                    this.antennaArray.forEach(row => {
                        row.forEach(antenna => {
                            antenna.phase += (Math.random() - 0.5) * 0.5;
                            antenna.active = Math.random() > 0.1;
                        });
                    });
                },
                
                updatePatientData() {
                    this.patients.forEach(patient => {
                        // Update vital signs with realistic variations
                        patient.heartRate = Math.max(40, Math.min(120, 
                            patient.heartRate + (Math.random() - 0.5) * 3));
                        
                        patient.respirationRate = Math.max(8, Math.min(25,
                            patient.respirationRate + (Math.random() - 0.5) * 1.5));
                        
                        // Update HRV
                        patient.hrv = Math.max(20, Math.min(100,
                            patient.hrv + (Math.random() - 0.5) * 5));
                        
                        // Update position slightly
                        patient.position.x += (Math.random() - 0.5) * 0.5;
                        patient.position.y += (Math.random() - 0.5) * 0.5;
                        
                        // Keep within bounds
                        patient.position.x = Math.max(10, Math.min(90, patient.position.x));
                        patient.position.y = Math.max(10, Math.min(90, patient.position.y));
                    });
                },
                
                updateAllCharts() {
                    // Update spatial spectrum
                    const time = Date.now() / 1000;
                    this.charts.spatialSpectrum.data.datasets[0].data = 
                        Array.from({length: 180}, (_, i) => {
                            const theta = (i - 90) * Math.PI / 180;
                            return Math.exp(-Math.pow(theta - Math.sin(time)*0.5, 2) * 50) + 
                                   Math.exp(-Math.pow(theta + Math.cos(time)*0.3, 2) * 60) +
                                   Math.random() * 0.1;
                        });
                    this.charts.spatialSpectrum.update('none');
                    
                    // Update HRV chart
                    this.charts.hrv.data.datasets[0].data.push(800 + Math.random() * 200);
                    this.charts.hrv.data.datasets[0].data.shift();
                    this.charts.hrv.update('none');
                    
                    // Update respiration chart
                    this.charts.respiration.data.datasets[0].data.push(
                        Math.sin(time * 2) * 10 + Math.random() * 2
                    );
                    this.charts.respiration.data.datasets[0].data.shift();
                    this.charts.respiration.update('none');
                },
                
                getSignalColor(index) {
                    const intensity = Math.sin(Date.now() / 1000 + index * 0.1) * 0.5 + 0.5;
                    return `rgba(59, 130, 246, ${intensity})`;
                },
                
                // ... (other methods remain similar but enhanced)
                addPatient() {
                    const newId = this.patients.length + 1;
                    const colors = ['#3b82f6', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#ec4899'];
                    const color = colors[this.patients.length % colors.length];
                    
                    this.patients.push({
                        id: newId,
                        name: `P${newId}`,
                        heartRate: Math.floor(Math.random() * 40) + 60,
                        respirationRate: Math.floor(Math.random() * 10) + 12,
                        distance: (Math.random() * 3 + 2).toFixed(1),
                        status: 'Stable',
                        signalQuality: Math.floor(Math.random() * 20) + 80,
                        color: color,
                        position: {
                            x: Math.random() * 60 + 20,
                            y: Math.random() * 60 + 20
                        },
                        hrv: Math.floor(Math.random() * 50) + 30,
                        respiratoryPattern: 'Normal'
                    });
                },
                
                triggerEmergency() {
                    const emergencies = [
                        { type: 'Cardiac Arrest', message: 'No heartbeat detected' },
                        { type: 'Respiratory Arrest', message: 'No breathing detected' },
                        { type: 'Tachycardia', message: 'Heart rate > 120 BPM' },
                        { type: 'Bradycardia', message: 'Heart rate < 40 BPM' }
                    ];
                    
                    const emergency = emergencies[Math.floor(Math.random() * emergencies.length)];
                    const patient = this.patients[Math.floor(Math.random() * this.patients.length)];
                    emergency.patient = patient.name;
                    
                    this.emergencyAlert = emergency;
                    patient.status = 'Critical';
                },
                
                triggerRandomEmergency() {
                    this.triggerEmergency();
                },
                
                stopSimulation() {
                    this.isRunning = false;
                    this.updateSystemStatus('Paused', 'status-warning');
                    clearInterval(this.simulationInterval);
                },
                
                updateSystemStatus(text, colorClass) {
                    this.systemStatus.text = text;
                    this.systemStatus.color = colorClass;
                }
            }
        }
        
        // Register matrix chart type
        Chart.register({
            id: 'matrix',
            beforeDraw: (chart) => {
                const ctx = chart.ctx;
                ctx.save();
                ctx.globalCompositeOperation = 'destination-over';
                ctx.fillStyle = 'rgba(255, 255, 255, 0.1)';
                ctx.fillRect(0, 0, chart.width, chart.height);
                ctx.restore();
            }
        });
    </script>
</body>
</html>