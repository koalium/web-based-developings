<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>تقویم ایرانی پیشرفته — مدیریت رویداد و تسک</title>
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fontsource/vazirmatn@5.0.8/index.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #071428;
      --card: #0f1a2a;
      --accent: #ff7a59;
      --accent-2: #5eead4;
      --muted: #9fb0c8;
      --glass: rgba(255,255,255,0.03);
      --success: #4ade80;
      --danger: #ff6b6b;
      --warning: #fbbf24;
      --info: #60a5fa;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Vazirmatn', sans-serif;
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #041028 0%, #061b2b 100%);
      color: #e6eef8;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 28px;
      position: relative;
      overflow-x: hidden;
    }
    
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 20% 80%, rgba(255, 122, 89, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(94, 234, 212, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }
    
    .calendar-container {
      width: 1200px;
      max-width: 98%;
      display: grid;
      grid-template-columns: 380px 1fr;
      gap: 24px;
      position: relative;
      z-index: 1;
    }
    
    .card {
      background: var(--card);
      border-radius: 18px;
      padding: 20px;
      box-shadow: 0 16px 40px rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.05);
      overflow: hidden;
      position: relative;
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 20px 50px rgba(0,0,0,0.7);
    }
    
    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      border-radius: 18px 18px 0 0;
    }
    
    /* Left Panel */
    .clock {
      background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      padding: 18px;
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      border: 1px solid rgba(255,255,255,0.05);
      position: relative;
      overflow: hidden;
    }
    
    .clock::after {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.05) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    
    .clock:hover::after {
      opacity: 1;
    }
    
    .time-container {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: flex-end;
      width: 100%;
    }
    
    .time {
      font-size: 38px;
      font-weight: 800;
      background: linear-gradient(90deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 2px 10px rgba(255, 122, 89, 0.3);
    }
    
    .seconds {
      font-size: 14px;
      opacity: 0.8;
      color: var(--accent-2);
    }
    
    .date-full {
      margin-top: 12px;
      font-size: 15px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .date-full i {
      color: var(--accent);
    }
    
    .navigate {
      display: flex;
      gap: 12px;
      margin-top: 18px;
    }
    
    .btn {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.07);
      color: var(--muted);
      padding: 10px 16px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Vazirmatn', sans-serif;
      flex: 1;
      justify-content: center;
    }
    
    .btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      border-color: rgba(255,255,255,0.1);
    }
    
    .btn.primary {
      background: linear-gradient(90deg, var(--accent), #ffd36b);
      color: #07101a;
      border: none;
      font-weight: 700;
    }
    
    .btn.primary:hover {
      box-shadow: 0 5px 20px rgba(255, 122, 89, 0.4);
    }
    
    .events-list {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 400px;
      overflow: auto;
      padding-right: 6px;
    }
    
    .events-list::-webkit-scrollbar {
      width: 6px;
    }
    
    .events-list::-webkit-scrollbar-track {
      background: rgba(255,255,255,0.05);
      border-radius: 10px;
    }
    
    .events-list::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 10px;
    }
    
    .evt {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005));
      border: 1px solid rgba(255,255,255,0.05);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .evt::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 4px;
      height: 100%;
      background: var(--evt-color, var(--accent));
    }
    
    .evt:hover {
      transform: translateX(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    
    .evt .meta {
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 4px;
    }
    
    .badge-type {
      padding: 6px 10px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 12px;
      background: var(--badge-bg, var(--accent));
      color: #07101a;
    }
    
    /* Right Calendar */
    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .month-title {
      font-size: 26px;
      font-weight: 800;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .year-span {
      color: var(--muted);
      font-size: 16px;
    }
    
    .calendar-controls {
      display: flex;
      gap: 10px;
    }
    
    .view-toggle {
      display: flex;
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      padding: 4px;
    }
    
    .view-toggle button {
      background: transparent;
      border: none;
      color: var(--muted);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .view-toggle button.active {
      background: var(--accent);
      color: #07101a;
    }
    
    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
      margin-top: 20px;
    }
    
    .weekdays .wd {
      padding: 12px 0;
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      border-radius: 10px;
      background: rgba(255,255,255,0.03);
    }
    
    .grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 12px;
      margin-top: 15px;
    }
    
    .cell {
      min-height: 110px;
      padding: 12px;
      border-radius: 14px;
      background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.005));
      border: 1px solid rgba(255,255,255,0.05);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .cell::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(circle at center, rgba(255,255,255,0.05) 0%, transparent 70%);
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .cell:hover {
      transform: translateY(-8px);
      box-shadow: 0 15px 30px rgba(3,8,18,0.7);
    }
    
    .cell:hover::before {
      opacity: 1;
    }
    
    .cell.today {
      background: linear-gradient(135deg, rgba(255,122,89,0.15), rgba(255,122,89,0.05));
      border: 1px solid rgba(255,122,89,0.2);
      box-shadow: 0 5px 15px rgba(255,122,89,0.2);
    }
    
    .cell.other-month {
      opacity: 0.4;
    }
    
    .cell.holiday {
      background: linear-gradient(135deg, rgba(255,107,107,0.1), rgba(255,107,107,0.03));
    }
    
    .day-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .daynum {
      font-weight: 800;
      font-size: 18px;
    }
    
    .gday {
      font-size: 12px;
      color: var(--muted);
    }
    
    .event-pill {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 6px;
      padding: 6px 8px;
      border-radius: 10px;
      font-size: 12px;
      background: rgba(0,0,0,0.3);
      border: 1px solid rgba(255,255,255,0.05);
      transition: all 0.3s ease;
    }
    
    .event-pill:hover {
      transform: translateX(3px);
    }
    
    .event-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    
    .events-count {
      margin-top: 8px;
      display: flex;
      justify-content: center;
    }
    
    .pill {
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(255,255,255,0.05);
      font-weight: 700;
      font-size: 12px;
      color: var(--muted);
    }
    
    /* Drawer / Day Detail */
    .drawer {
      position: fixed;
      right: 24px;
      bottom: 24px;
      width: 420px;
      max-width: 92%;
      background: linear-gradient(135deg, #071425, #071019);
      border-radius: 16px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,0.07);
      box-shadow: 0 20px 70px rgba(0,0,0,0.8);
      transform: translateY(30px) scale(0.95);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      pointer-events: none;
      z-index: 100;
    }
    
    .drawer.open {
      transform: translateY(0) scale(1);
      opacity: 1;
      pointer-events: auto;
    }
    
    .drawer .hdr {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .drawer .list {
      margin-top: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 350px;
      overflow: auto;
      padding-right: 5px;
    }
    
    .drawer .empty {
      color: var(--muted);
      font-size: 14px;
      text-align: center;
      padding: 20px;
    }
    
    /* Modal */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(3,6,12,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
    }
    
    .overlay.show {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal {
      width: 560px;
      max-width: 96%;
      background: linear-gradient(135deg, #081425, #041227);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.07);
      box-shadow: 0 25px 80px rgba(0,0,0,0.8);
      transform: scale(0.9);
      transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    
    .overlay.show .modal {
      transform: scale(1);
    }
    
    .row {
      display: flex;
      gap: 10px;
      margin-top: 12px;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.07);
      background: rgba(255,255,255,0.05);
      color: #e6eef8;
      font-family: 'Vazirmatn', sans-serif;
      transition: all 0.3s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(255, 122, 89, 0.2);
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }
    
    .muted {
      color: var(--muted);
    }
    
    /* Stats Section */
    .stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 20px;
    }
    
    .stat-card {
      background: rgba(255,255,255,0.03);
      border-radius: 12px;
      padding: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.05);
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 800;
      margin: 8px 0 4px;
    }
    
    .stat-label {
      font-size: 12px;
      color: var(--muted);
    }
    
    /* Search and Filter */
    .search-box {
      position: relative;
      margin-top: 15px;
    }
    
    .search-box input {
      padding-right: 40px;
    }
    
    .search-box i {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--muted);
    }
    
    /* Animations */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    /* Responsive */
    @media (max-width: 1000px) {
      .calendar-container {
        grid-template-columns: 1fr;
      }
      
      .drawer {
        right: 12px;
        left: 12px;
        width: auto;
      }
    }
    
    @media (max-width: 600px) {
      .navigate {
        flex-direction: column;
      }
      
      .calendar-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
      }
      
      .calendar-controls {
        width: 100%;
        justify-content: space-between;
      }
      
      .stats {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div x-data="persianCalendar()" x-init="init()" class="calendar-container">
    <!-- Left Panel -->
    <div class="card left">
      <div class="clock">
        <div class="time-container">
          <div class="time" x-text="currentTime"></div>
          <div class="seconds" x-text="currentSeconds"></div>
        </div>
        <div class="date-full">
          <i class="fas fa-calendar-alt"></i>
          <span x-text="currentDate"></span>
        </div>
      </div>

      <div class="navigate">
        <button class="btn" @click="previousMonth()">
          <i class="fas fa-chevron-right"></i>
          <span>ماه قبل</span>
        </button>
        <button class="btn primary" @click="openTodayDrawer()">
          <i class="fas fa-calendar-day"></i>
          <span>رویدادهای امروز</span>
        </button>
        <button class="btn" @click="nextMonth()">
          <span>ماه بعد</span>
          <i class="fas fa-chevron-left"></i>
        </button>
      </div>

      <div class="search-box">
        <input type="text" placeholder="جستجوی رویدادها..." x-model="searchQuery" @input="filterEvents()">
        <i class="fas fa-search"></i>
      </div>

      <div style="margin-top:20px;font-weight:800;display:flex;align-items:center;gap:10px">
        <i class="fas fa-tasks"></i>
        <span>تسک‌ها و رویدادهای آینده</span>
      </div>
      
      <div class="events-list">
        <template x-for="event in filteredEvents" :key="event.id">
          <div class="evt" :style="'--evt-color: ' + event.color">
            <div>
              <div style="font-weight:800" x-text="event.title"></div>
              <div class="meta">
                <i class="far fa-clock"></i>
                <span x-text="`${event.date} ${event.time || ''}`"></span>
                <span>—</span>
                <span x-text="event.type"></span>
              </div>
            </div>
            <div>
              <span class="badge-type" :style="'--badge-bg: ' + event.color" x-text="event.type"></span>
            </div>
          </div>
        </template>
        <div x-show="filteredEvents.length === 0" class="muted" style="text-align:center;padding:20px">
          <i class="far fa-calendar-times" style="font-size:24px;margin-bottom:10px;display:block"></i>
          <span>رویدادی یافت نشد</span>
        </div>
      </div>
      
      <div class="stats">
        <div class="stat-card">
          <i class="fas fa-calendar-check" style="color:var(--success)"></i>
          <div class="stat-value" x-text="stats.completed"></div>
          <div class="stat-label">تکمیل شده</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-hourglass-half" style="color:var(--warning)"></i>
          <div class="stat-value" x-text="stats.pending"></div>
          <div class="stat-label">در انتظار</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-bell" style="color:var(--accent)"></i>
          <div class="stat-value" x-text="stats.upcoming"></div>
          <div class="stat-label">آینده</div>
        </div>
        <div class="stat-card">
          <i class="fas fa-tasks" style="color:var(--info)"></i>
          <div class="stat-value" x-text="stats.total"></div>
          <div class="stat-label">کل رویدادها</div>
        </div>
      </div>
    </div>

    <!-- Right Calendar -->
    <div class="card right">
      <div class="calendar-header">
        <div>
          <div class="month-title">
            <i class="far fa-calendar-alt"></i>
            <span x-text="currentMonth + ' ماه'"></span>
          </div>
          <div class="year-span" x-text="'سال ' + toPersianDigits(currentYear)"></div>
        </div>
        <div style="text-align:left">
          <div style="font-weight:700;font-size:18px" x-text="todayWeekday"></div>
          <div style="color:var(--muted);margin-top:4px" x-text="todayGregorian"></div>
        </div>
      </div>
      
      <div class="calendar-controls">
        <div class="view-toggle">
          <button :class="{active: viewMode === 'month'}" @click="viewMode = 'month'">ماهانه</button>
          <button :class="{active: viewMode === 'week'}" @click="viewMode = 'week'">هفتگی</button>
        </div>
        <button class="btn" @click="goToToday()">
          <i class="fas fa-home"></i>
          <span>امروز</span>
        </button>
      </div>

      <div class="weekdays">
        <template x-for="weekday in weekdays" :key="weekday">
          <div class="wd" x-text="weekday"></div>
        </template>
      </div>
      
      <div class="grid">
        <template x-for="(cell, index) in calendarGrid" :key="cell.uniqueKey">
          <div 
            class="cell" 
            :class="{ 
              'today': cell.isToday, 
              'holiday': cell.isHoliday,
              'other-month': cell.otherMonth
            }"
            @click="openDrawerForDay(cell.gDate)"
          >
            <div class="day-row">
              <div class="gday" x-text="'میلادی: ' + toPersianDigits(cell.gDay)"></div>
              <div class="daynum" x-text="toPersianDigits(cell.pDay)"></div>
            </div>
            <template x-for="event in cell.events.slice(0, 3)" :key="event.id">
              <div class="event-pill">
                <span class="event-dot" :style="`background: ${event.color}`"></span>
                <div style="font-weight:700;font-size:12px" x-text="event.title"></div>
              </div>
            </template>
            <div x-show="cell.events.length > 0" class="events-count">
              <span class="pill" x-text="`${cell.events.length} رویداد`"></span>
            </div>
          </div>
        </template>
      </div>
    </div>

    <!-- Drawer: day details -->
    <div class="drawer" :class="{ 'open': drawerOpen }">
      <div class="hdr">
        <div style="font-weight:800;font-size:18px" x-text="drawerDateText"></div>
        <div>
          <button class="btn" @click="openModal()">
            <i class="fas fa-plus"></i>
            <span>افزودن</span>
          </button>
          <button class="btn" @click="closeDrawer()">
            <i class="fas fa-times"></i>
            <span>بستن</span>
          </button>
        </div>
      </div>
      <div class="muted" style="margin-top:6px" x-text="`${drawerEvents.length} رویداد`"></div>
      <div class="list">
        <template x-for="event in drawerEvents" :key="event.id">
          <div class="evt" :style="'--evt-color: ' + event.color">
            <div>
              <div style="font-weight:800" x-text="event.title"></div>
              <div class="meta">
                <i class="far fa-clock"></i>
                <span x-text="event.time || 'تمام روز'"></span>
                <span>—</span>
                <span x-text="event.type"></span>
              </div>
            </div>
            <div>
              <button class="btn" @click="openModal(event)">
                <i class="fas fa-edit"></i>
              </button>
              <button class="btn" style="margin-right:6px" @click="deleteEvent(event)">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
        </template>
        <div x-show="drawerEvents.length === 0" class="empty">
          <i class="far fa-calendar-plus" style="font-size:32px;margin-bottom:10px;display:block"></i>
          <span>رویدادی برای این روز ثبت نشده است.</span>
        </div>
      </div>
    </div>

    <!-- Modal: add/edit event -->
    <div class="overlay" :class="{ 'show': modalOpen }" @click.self="closeModal()">
      <div class="modal" role="dialog" aria-modal="true">
        <h3 style="display:flex;align-items:center;gap:10px">
          <i class="fas" :class="editingEvent ? 'fa-edit' : 'fa-plus'"></i>
          <span x-text="editingEvent ? 'ویرایش رویداد' : 'افزودن رویداد / تسک'"></span>
        </h3>
        <div class="row"><input x-model="modalData.title" placeholder="عنوان رویداد"></div>
        <div class="row">
          <input x-model="modalData.date" type="date">
          <input x-model="modalData.time" type="time">
        </div>
        <div class="row">
          <select x-model="modalData.type">
            <option value="task">تسک</option>
            <option value="meeting">جلسه</option>
            <option value="birthday">تولد</option>
            <option value="reminder">یادآور</option>
            <option value="deadline">ددلاین</option>
          </select>
        </div>
        <div class="row">
          <select x-model="modalData.priority">
            <option value="low">اولویت کم</option>
            <option value="medium">اولویت متوسط</option>
            <option value="high">اولویت بالا</option>
          </select>
          <input x-model="modalData.remBeforeMin" type="number" min="0" placeholder="یادآور (دقیقه قبل)">
        </div>
        <div class="row"><textarea x-model="modalData.note" placeholder="توضیحات رویداد"></textarea></div>
        <div class="modal-actions">
          <button x-show="editingEvent" class="btn" @click="deleteEvent(editingEvent)">
            <i class="fas fa-trash"></i>
            <span>حذف</span>
          </button>
          <button class="btn" @click="closeModal()">
            <i class="fas fa-times"></i>
            <span>لغو</span>
          </button>
          <button class="btn primary" @click="saveEvent()">
            <i class="fas fa-save"></i>
            <span>ذخیره</span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('persianCalendar', () => ({
        // State
        viewDate: new Date(),
        events: [],
        currentTime: '--:--',
        currentSeconds: '--',
        currentDate: 'در حال بارگذاری...',
        drawerOpen: false,
        modalOpen: false,
        editingEvent: null,
        activeDay: null,
        scheduledNotifications: {},
        searchQuery: '',
        filteredEvents: [],
        viewMode: 'month',
        
        // Constants
        typeColors: {
          task: '#ffd36b',
          meeting: '#7dd3fc', 
          birthday: '#fda4af',
          reminder: '#86efac',
          deadline: '#ff6b6b'
        },
        priorityColors: {
          low: '#4ade80',
          medium: '#fbbf24',
          high: '#ff6b6b'
        },
        weekdays: ['شنبه', 'یکشنبه', 'دوشنبه', 'سه‌شنبه', 'چهارشنبه', 'پنجشنبه', 'جمعه'],
        
        // Formatters
        persianFormatter: new Intl.DateTimeFormat('fa-IR-u-ca-persian', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        }),
        partsFormatter: new Intl.DateTimeFormat('fa-IR-u-ca-persian', {
          day: 'numeric',
          month: 'numeric',
          year: 'numeric',
          weekday: 'long'
        }),
        
        // Computed properties
        get currentMonth() {
          return this.getPersianParts(this.viewDate).month;
        },
        
        get currentYear() {
          return this.getPersianParts(this.viewDate).year;
        },
        
        get todayWeekday() {
          return this.getPersianParts(new Date()).weekday;
        },
        
        get todayGregorian() {
          return new Date().toLocaleDateString('en-GB');
        },
        
        get stats() {
          const now = new Date();
          const completed = this.events.filter(e => e.done).length;
          const pending = this.events.filter(e => !e.done && new Date(e.date + 'T' + (e.time || '00:00')) < now).length;
          const upcoming = this.events.filter(e => !e.done && new Date(e.date + 'T' + (e.time || '00:00')) >= now).length;
          const total = this.events.length;
          
          return { completed, pending, upcoming, total };
        },
        
        get drawerDateText() {
          if (!this.activeDay) return '-';
          const parts = this.getPersianParts(this.activeDay);
          return `${parts.weekday} — ${parts.day} ${parts.month} ${parts.year}`;
        },
        
        get drawerEvents() {
          if (!this.activeDay) return [];
          const key = this.toYMD(this.activeDay);
          return this.events
            .filter(ev => ev.date === key)
            .sort((a, b) => (a.time || '00:00') > (b.time || '00:00') ? 1 : -1);
        },
        
        get calendarGrid() {
          if (this.viewMode === 'week') {
            return this.generateWeekGrid();
          }
          
          // Month view
          const centerDate = this.viewDate;
          const p = this.getPersianParts(centerDate);
          const found = [];
          
          // Find all days in the current Persian month
          for (let offset = -90; offset <= 90; offset++) {
            const d = new Date(centerDate.getFullYear(), centerDate.getMonth(), centerDate.getDate() + offset);
            const pp = this.getPersianParts(d);
            if (pp.year === p.year && pp.month === p.month) {
              found.push({
                gDate: d,
                pDay: pp.day,
                pWeekday: pp.weekday,
                gDay: d.getDate(),
                key: this.toYMD(d),
                uniqueKey: `cell-${this.toYMD(d)}-${offset}`, // Fix for duplicate key issue
                isToday: d.toDateString() === new Date().toDateString(),
                isHoliday: pp.weekday === 'جمعه',
                otherMonth: false,
                events: this.events.filter(ev => ev.date === this.toYMD(d))
              });
            }
          }
          
          found.sort((a, b) => a.gDate - b.gDate);
          
          // Add empty cells for days before the first day of the month
          const mapWeek = {
            'شنبه': 0, 'یکشنبه': 1, 'دوشنبه': 2, 'سه‌شنبه': 3, 
            'چهارشنبه': 4, 'پنجشنبه': 5, 'جمعه': 6
          };
          
          const firstIdx = mapWeek[found[0]?.pWeekday] || 0;
          const grid = [];
          
          // Add placeholder cells with unique keys
          for (let i = 0; i < firstIdx; i++) {
            grid.push({ 
              isPlaceholder: true,
              uniqueKey: `placeholder-${i}-${Date.now()}` // Fix for duplicate key issue
            });
          }
          
          // Add actual day cells
          return grid.concat(found);
        },
        
        // Modal data
        modalData: {
          title: '',
          date: '',
          time: '09:00',
          type: 'task',
          priority: 'medium',
          remBeforeMin: 10,
          note: ''
        },
        
        // Methods
        init() {
          this.updateClock();
          setInterval(() => this.updateClock(), 1000);
          this.loadEvents();
          this.filterEvents();
          
          // Request notification permission
          if ('Notification' in window && Notification.permission !== 'granted' && Notification.permission !== 'denied') {
            Notification.requestPermission();
          }
          
          // Add sample events if empty
          if (this.events.length === 0) {
            this.addSampleEvents();
          }
        },
        
        updateClock() {
          const now = new Date();
          const h = String(now.getHours()).padStart(2, '0');
          const m = String(now.getMinutes()).padStart(2, '0');
          const s = String(now.getSeconds()).padStart(2, '0');
          
          this.currentTime = this.toPersianDigits(h + ':' + m);
          this.currentSeconds = this.toPersianDigits(s);
          this.currentDate = this.persianFormatter.format(now);
        },
        
        toPersianDigits(s) {
          return String(s).replace(/\d/g, d => '۰۱۲۳۴۵۶۷۸۹'[d]);
        },
        
        getPersianParts(d) {
          try {
            const parts = this.partsFormatter.formatToParts(d);
            const obj = {};
            for (const p of parts) {
              if (p.type !== 'literal') obj[p.type] = p.value;
            }
            return obj;
          } catch (error) {
            console.error('Error in getPersianParts:', error);
            return { day: '?', month: '?', year: '?', weekday: '?' };
          }
        },
        
        toYMD(d) {
          const y = d.getFullYear();
          const m = String(d.getMonth() + 1).padStart(2, '0');
          const dd = String(d.getDate()).padStart(2, '0');
          return `${y}-${m}-${dd}`;
        },
        
        openDrawerForDay(gDate) {
          this.activeDay = new Date(gDate.getFullYear(), gDate.getMonth(), gDate.getDate());
          this.drawerOpen = true;
        },
        
        closeDrawer() {
          this.drawerOpen = false;
          this.activeDay = null;
        },
        
        openTodayDrawer() {
          this.openDrawerForDay(new Date());
        },
        
        openModal(event = null) {
          this.editingEvent = event;
          
          if (event) {
            // Editing existing event
            this.modalData = { ...event };
          } else {
            // Adding new event
            this.modalData = {
              title: '',
              date: this.activeDay ? this.toYMD(this.activeDay) : this.toYMD(new Date()),
              time: '09:00',
              type: 'task',
              priority: 'medium',
              remBeforeMin: 10,
              note: ''
            };
          }
          
          this.modalOpen = true;
        },
        
        closeModal() {
          this.modalOpen = false;
          this.editingEvent = null;
          this.modalData = {
            title: '',
            date: '',
            time: '09:00',
            type: 'task',
            priority: 'medium',
            remBeforeMin: 10,
            note: ''
          };
        },
        
        saveEvent() {
          const { title, date, time, type, priority, remBeforeMin, note } = this.modalData;
          
          if (!title || !date) {
            alert('عنوان و تاریخ را وارد کنید');
            return;
          }
          
          if (this.editingEvent) {
            // Update existing event
            const index = this.events.findIndex(e => e.id === this.editingEvent.id);
            if (index >= 0) {
              this.events[index] = {
                ...this.events[index],
                title,
                date,
                time,
                type,
                priority,
                remBeforeMin,
                note,
                color: this.typeColors[type] || this.typeColors.task
              };
            }
          } else {
            // Add new event
            const newEvent = {
              id: 'e' + Math.random().toString(36).slice(2, 9),
              title,
              date,
              time,
              type,
              priority,
              remBeforeMin,
              note,
              color: this.typeColors[type] || this.typeColors.task,
              done: false
            };
            this.events.push(newEvent);
          }
          
          this.saveEvents();
          this.filterEvents();
          this.closeModal();
          this.scheduleAllNotifications();
        },
        
        deleteEvent(event) {
          if (confirm('آیا حذف شود؟')) {
            this.events = this.events.filter(e => e.id !== event.id);
            this.saveEvents();
            this.filterEvents();
            
            if (this.drawerOpen) {
              // Refresh drawer if open
              this.openDrawerForDay(this.activeDay);
            }
            
            this.closeModal();
          }
        },
        
        previousMonth() {
          this.viewDate = new Date(this.viewDate.getFullYear(), this.viewDate.getMonth(), this.viewDate.getDate() - 30);
        },
        
        nextMonth() {
          this.viewDate = new Date(this.viewDate.getFullYear(), this.viewDate.getMonth(), this.viewDate.getDate() + 30);
        },
        
        goToToday() {
          this.viewDate = new Date();
        },
        
        filterEvents() {
          if (!this.searchQuery) {
            const now = new Date();
            this.filteredEvents = this.events
              .filter(e => new Date(e.date + 'T' + (e.time || '00:00')) >= now)
              .sort((a, b) => (a.date + a.time) > (b.date + b.time) ? 1 : -1)
              .slice(0, 10);
          } else {
            const query = this.searchQuery.toLowerCase();
            this.filteredEvents = this.events
              .filter(e => 
                e.title.toLowerCase().includes(query) || 
                (e.note && e.note.toLowerCase().includes(query)) ||
                e.type.toLowerCase().includes(query)
              )
              .sort((a, b) => (a.date + a.time) > (b.date + b.time) ? 1 : -1);
          }
        },
        
        generateWeekGrid() {
          const today = new Date();
          const startOfWeek = new Date(today);
          startOfWeek.setDate(today.getDate() - today.getDay());
          
          const weekDays = [];
          for (let i = 0; i < 7; i++) {
            const day = new Date(startOfWeek);
            day.setDate(startOfWeek.getDate() + i);
            const pp = this.getPersianParts(day);
            
            weekDays.push({
              gDate: day,
              pDay: pp.day,
              pWeekday: pp.weekday,
              gDay: day.getDate(),
              key: this.toYMD(day),
              uniqueKey: `week-${this.toYMD(day)}-${i}`, // Fix for duplicate key issue
              isToday: day.toDateString() === today.toDateString(),
              isHoliday: pp.weekday === 'جمعه',
              otherMonth: false,
              events: this.events.filter(ev => ev.date === this.toYMD(day))
            });
          }
          
          return weekDays;
        },
        
        // Persistence
        saveEvents() {
          localStorage.setItem('calendar_events_v3', JSON.stringify(this.events));
          // Remove server sync to prevent CORS errors
        },
        
        loadEvents() {
          try {
            const stored = localStorage.getItem('calendar_events_v3');
            if (stored) {
              this.events = JSON.parse(stored);
            }
            this.scheduleAllNotifications();
          } catch (error) {
            console.error('Error loading events:', error);
            this.events = [];
          }
        },
        
        // Notifications
        clearSchedules() {
          for (const k in this.scheduledNotifications) {
            clearTimeout(this.scheduledNotifications[k]);
          }
          this.scheduledNotifications = {};
        },
        
        scheduleAllNotifications() {
          this.clearSchedules();
          
          if (!('Notification' in window)) return;
          
          for (const ev of this.events) {
            try {
              const dt = new Date(ev.date + 'T' + (ev.time || '00:00') + ':00');
              const remMs = (ev.remBeforeMin || 0) * 60 * 1000;
              const notifyAt = dt.getTime() - remMs;
              const diff = notifyAt - Date.now();
              
              if (diff > 0 && diff < 1000 * 60 * 60 * 24 * 365) {
                const tid = setTimeout(() => {
                  this.fireNotification(ev);
                }, diff);
                
                this.scheduledNotifications[ev.id] = tid;
              }
            } catch (error) {
              console.error('Error scheduling notification:', error);
            }
          }
        },
        
        fireNotification(ev) {
          if (Notification.permission === 'granted') {
            new Notification(ev.title, {
              body: ev.note || (`رویداد: ${ev.type} ساعت ${ev.time || ''}`),
              tag: ev.id,
              icon: '/calendar-icon.png'
            });
          }
        },
        
        addSampleEvents() {
          const today = new Date();
          const tomorrow = new Date(today);
          tomorrow.setDate(today.getDate() + 1);
          
          const nextWeek = new Date(today);
          nextWeek.setDate(today.getDate() + 7);
          
          this.events = [
            {
              id: 'sample1',
              title: 'جلسه تیم توسعه',
              date: this.toYMD(today),
              time: '10:00',
              type: 'meeting',
              priority: 'high',
              remBeforeMin: 15,
              note: 'بررسی پیشرفت پروژه جدید',
              color: this.typeColors.meeting,
              done: false
            },
            {
              id: 'sample2',
              title: 'تکمیل گزارش مالی',
              date: this.toYMD(tomorrow),
              time: '14:00',
              type: 'task',
              priority: 'medium',
              remBeforeMin: 30,
              note: 'ارسال گزارش به مدیریت',
              color: this.typeColors.task,
              done: false
            },
            {
              id: 'sample3',
              title: 'تولد سارا',
              date: this.toYMD(nextWeek),
              time: '',
              type: 'birthday',
              priority: 'low',
              remBeforeMin: 60,
              note: 'خرید هدیه و کارت تبریک',
              color: this.typeColors.birthday,
              done: false
            }
          ];
          
          this.saveEvents();
          this.filterEvents();
        }
      }));
    });
  </script>
</body>
</html>