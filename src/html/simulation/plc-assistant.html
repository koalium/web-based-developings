<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLC Design Assistant - طراحی تابلو برق تهویه نساجی</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Vazirmatn', sans-serif;
        }
        .component-card {
            transition: all 0.3s ease;
        }
        .component-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        .bom-item {
            border-right: 3px solid #3b82f6;
        }
        .grid-cell {
            width: 60px;
            height: 60px;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .grid-cell.occupied {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        .grid-cell:hover {
            background-color: #f3f4f6;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800" x-data="plcDesigner()" x-init="initApp()">
    <!-- هدر برنامه -->
    <header class="bg-gradient-to-r from-blue-700 to-indigo-800 text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="flex items-center mb-4 md:mb-0">
                    <i class="fas fa-industry text-3xl mr-3"></i>
                    <div>
                        <h1 class="text-2xl font-bold">طراحی تابلو برق PLC - تهویه تبخیری نساجی</h1>
                        <p class="text-blue-100 mt-1">طراحی و محاسبات دقیق قطعات و تجهیزات تابلو برق</p>
                    </div>
                </div>
                <div class="flex space-x-4 space-x-reverse">
                    <button @click="saveProject()" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-save ml-2"></i> ذخیره پروژه
                    </button>
                    <button @click="loadProject()" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-folder-open ml-2"></i> بارگذاری پروژه
                    </button>
                    <button @click="printBOM()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-print ml-2"></i> چاپ BOM
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- بخش کنترل‌های اصلی -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- ستون سمت راست: پنل ورودی داده -->
            <div class="lg:col-span-2 space-y-6">
                <!-- موتورهای سه فاز -->
                <div class="bg-white rounded-xl shadow-md p-5 component-card">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-cogs text-2xl text-blue-600 ml-3"></i>
                        <h2 class="text-xl font-bold">موتورهای سه فاز</h2>
                        <span class="mr-auto bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full">
                            <span x-text="getTotalMotorsCount()"></span> موتور
                        </span>
                    </div>
                    
                    <div class="space-y-4">
                        <template x-for="(motor, index) in motors" :key="motor.id">
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-blue-50">
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center">
                                        <div class="bg-blue-100 text-blue-800 rounded-lg p-2 ml-3">
                                            <i class="fas fa-motorcycle"></i>
                                        </div>
                                        <div>
                                            <h3 class="font-semibold" x-text="motor.name"></h3>
                                            <p class="text-sm text-gray-600" x-text="motor.description"></p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-4 space-x-reverse">
                                        <div>
                                            <label class="block text-sm text-gray-600 mb-1">توان (کیلووات)</label>
                                            <input type="number" x-model="motor.power" min="0.1" max="60" step="0.1" 
                                                   class="w-24 border border-gray-300 rounded-lg px-3 py-1 text-center">
                                        </div>
                                        <div>
                                            <label class="block text-sm text-gray-600 mb-1">تعداد</label>
                                            <div class="flex items-center">
                                                <button @click="decrementMotor(index)" 
                                                        class="bg-gray-200 hover:bg-gray-300 w-8 h-8 rounded-r-lg flex items-center justify-center">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input type="number" x-model="motor.quantity" min="0" 
                                                       class="w-16 border-y border-gray-300 text-center py-1">
                                                <button @click="incrementMotor(index)" 
                                                        class="bg-gray-200 hover:bg-gray-300 w-8 h-8 rounded-l-lg flex items-center justify-center">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-lg font-bold text-blue-700" x-text="formatNumber(motor.totalPower)"></div>
                                            <div class="text-sm text-gray-600">کیلووات کل</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- اکچویتورها -->
                <div class="bg-white rounded-xl shadow-md p-5 component-card">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-sliders-h text-2xl text-green-600 ml-3"></i>
                        <h2 class="text-xl font-bold">اکچویتورها</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <template x-for="(actuator, index) in actuators" :key="actuator.id">
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-green-50">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-semibold" x-text="actuator.name"></h3>
                                        <p class="text-sm text-gray-600 mb-3" x-text="actuator.description"></p>
                                        <div class="flex items-center space-x-4 space-x-reverse">
                                            <div>
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" x-model="actuator.hasPositioner" class="sr-only peer">
                                                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                                    <span class="mr-3 text-sm font-medium">پوزیشنر</span>
                                                </label>
                                            </div>
                                            <div>
                                                <label class="inline-flex items-center cursor-pointer">
                                                    <input type="checkbox" x-model="actuator.hasInput" class="sr-only peer">
                                                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                                    <span class="mr-3 text-sm font-medium">ورودی</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-left">
                                        <div class="mb-2">
                                            <label class="block text-sm text-gray-600 mb-1">تعداد</label>
                                            <div class="flex items-center">
                                                <button @click="decrementActuator(index)" 
                                                        class="bg-gray-200 hover:bg-gray-300 w-8 h-8 rounded-r-lg flex items-center justify-center">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input type="number" x-model="actuator.quantity" min="0" 
                                                       class="w-16 border-y border-gray-300 text-center py-1">
                                                <button @click="incrementActuator(index)" 
                                                        class="bg-gray-200 hover:bg-gray-300 w-8 h-8 rounded-l-lg flex items-center justify-center">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="text-sm">
                                            <span class="font-medium">ولتاژ:</span>
                                            <span x-text="actuator.voltage" class="text-gray-700"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- سنسورها -->
                <div class="bg-white rounded-xl shadow-md p-5 component-card">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-thermometer-half text-2xl text-red-600 ml-3"></i>
                        <h2 class="text-xl font-bold">سنسورها</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <template x-for="(sensor, index) in sensors" :key="sensor.id">
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-red-50">
                                <h3 class="font-semibold mb-2" x-text="sensor.name"></h3>
                                <p class="text-sm text-gray-600 mb-3" x-text="sensor.description"></p>
                                <div class="flex justify-between items-center">
                                    <div>
                                        <label class="block text-sm text-gray-600 mb-1">تعداد</label>
                                        <div class="flex items-center">
                                            <button @click="decrementSensor(index)" 
                                                    class="bg-gray-200 hover:bg-gray-300 w-8 h-8 rounded-r-lg flex items-center justify-center">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <input type="number" x-model="sensor.quantity" min="0" 
                                                   class="w-16 border-y border-gray-300 text-center py-1">
                                            <button @click="incrementSensor(index)" 
                                                    class="bg-gray-200 hover:bg-gray-300 w-8 h-8 rounded-l-lg flex items-center justify-center">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="text-sm">
                                        <span class="font-medium">نوع:</span>
                                        <span x-text="sensor.type" class="text-gray-700"></span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- تجهیزات اختیاری -->
                <div class="bg-white rounded-xl shadow-md p-5 component-card">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-list-alt text-2xl text-purple-600 ml-3"></i>
                        <h2 class="text-xl font-bold">تجهیزات اختیاری</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <template x-for="(optional, index) in optionalEquipment" :key="optional.id">
                            <div class="border border-gray-200 rounded-lg p-4 hover:bg-purple-50">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="font-semibold" x-text="optional.name"></h3>
                                        <p class="text-sm text-gray-600 mb-3" x-text="optional.description"></p>
                                        <div x-show="optional.id === 'vfd' || optional.id === 'soft_start'" class="mb-2">
                                            <label class="block text-sm text-gray-600 mb-1">توان (کیلووات)</label>
                                            <input type="number" x-model="optional.power" min="0" max="60" step="0.1" 
                                                   class="w-32 border border-gray-300 rounded-lg px-3 py-1">
                                        </div>
                                        <div x-show="optional.id === 'heat_sensor'">
                                            <label class="inline-flex items-center cursor-pointer">
                                                <input type="checkbox" x-model="optional.quantity" :value="1" class="sr-only peer">
                                                <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                                                <span class="mr-3 text-sm font-medium">فعال</span>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="text-left">
                                        <div x-show="optional.id !== 'heat_sensor'" class="mb-2">
                                            <label class="block text-sm text-gray-600 mb-1">تعداد</label>
                                            <div class="flex items-center">
                                                <button @click="decrementOptional(index)" 
                                                        class="bg-gray-200 hover:bg-gray-300 w-8 h-8 rounded-r-lg flex items-center justify-center">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <input type="number" x-model="optional.quantity" min="0" 
                                                       class="w-16 border-y border-gray-300 text-center py-1">
                                                <button @click="incrementOptional(index)" 
                                                        class="bg-gray-200 hover:bg-gray-300 w-8 h-8 rounded-l-lg flex items-center justify-center">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="text-sm" x-show="optional.id === 'hmi'">
                                            <span class="font-medium">اندازه:</span>
                                            <select x-model="optional.size" class="border border-gray-300 rounded-lg px-2 py-1 mr-2">
                                                <option value="7">۷ اینچ</option>
                                                <option value="10">۱۰ اینچ</option>
                                                <option value="12">۱۲ اینچ</option>
                                                <option value="15">۱۵ اینچ</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>

                <!-- تنظیمات پی ال سی -->
                <div class="bg-white rounded-xl shadow-md p-5 component-card">
                    <div class="flex items-center mb-4">
                        <i class="fas fa-microchip text-2xl text-indigo-600 ml-3"></i>
                        <h2 class="text-xl font-bold">تنظیمات PLC و تابلو</h2>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="font-semibold mb-3">انتخاب PLC</h3>
                            <div class="space-y-3">
                                <label class="flex items-center">
                                    <input type="radio" name="plcType" value="s7-1200" x-model="plcSettings.type" class="ml-3">
                                    <span class="text-gray-700">Siemens S7-1200 (پیشنهادی)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="plcType" value="s7-1500" x-model="plcSettings.type" class="ml-3">
                                    <span class="text-gray-700">Siemens S7-1500 (پیشرفته)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="plcType" value="logo" x-model="plcSettings.type" class="ml-3">
                                    <span class="text-gray-700">Siemens LOGO (ساده)</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="plcType" value="micrologix" x-model="plcSettings.type" class="ml-3">
                                    <span class="text-gray-700">Allen Bradley MicroLogix</span>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="font-semibold mb-3">تنظیمات تابلو</h3>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">اندازه تابلو (میلیمتر)</label>
                                    <div class="flex space-x-2 space-x-reverse">
                                        <input type="number" x-model="cabinetSettings.width" placeholder="عرض" 
                                               class="w-1/3 border border-gray-300 rounded-lg px-3 py-1">
                                        <input type="number" x-model="cabinetSettings.height" placeholder="ارتفاع" 
                                               class="w-1/3 border border-gray-300 rounded-lg px-3 py-1">
                                        <input type="number" x-model="cabinetSettings.depth" placeholder="عمق" 
                                               class="w-1/3 border border-gray-300 rounded-lg px-3 py-1">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-1">IP Rating</label>
                                    <select x-model="cabinetSettings.ipRating" class="w-full border border-gray-300 rounded-lg px-3 py-2">
                                        <option value="IP54">IP54 (حفاظت در برابر گرد و غبار و پاشش آب)</option>
                                        <option value="IP55">IP55 (حفاظت در برابر گرد و غبار و جریان آب)</option>
                                        <option value="IP65">IP65 (حفاظت کامل در برابر گرد و غبار و جریان آب)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="inline-flex items-center cursor-pointer">
                                        <input type="checkbox" x-model="cabinetSettings.hasCooling" class="sr-only peer">
                                        <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:right-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                                        <span class="mr-3 text-sm font-medium">سیستم خنک‌کننده داخلی</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ستون سمت چپ: خلاصه و BOM -->
            <div class="lg:col-span-1 space-y-6">
                <!-- خلاصه پروژه -->
                <div class="bg-white rounded-xl shadow-md p-5 sticky top-6">
                    <h2 class="text-xl font-bold mb-4 border-b pb-3">خلاصه پروژه</h2>
                    
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">کل موتورها:</span>
                            <span class="font-bold text-blue-700" x-text="getTotalMotorsCount()"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">توان کل موتورها:</span>
                            <span class="font-bold text-blue-700" x-text="formatNumber(getTotalMotorsPower()) + ' کیلووات'"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">اکچویتورها:</span>
                            <span class="font-bold text-green-700" x-text="getTotalActuatorsCount()"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">سنسورها:</span>
                            <span class="font-bold text-red-700" x-text="getTotalSensorsCount()"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">ورودی‌های دیجیتال:</span>
                            <span class="font-bold" x-text="calculateDigitalInputs()"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">خروجی‌های دیجیتال:</span>
                            <span class="font-bold" x-text="calculateDigitalOutputs()"></span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-700">ورودی‌های آنالوگ:</span>
                            <span class="font-bold" x-text="calculateAnalogInputs()"></span>
                        </div>
                        <div class="pt-4 border-t">
                            <div class="flex justify-between items-center text-lg">
                                <span class="text-gray-800 font-semibold">تعداد کل قطعات:</span>
                                <span class="font-bold text-purple-700" x-text="getTotalComponentsCount()"></span>
                            </div>
                        </div>
                    </div>

                    <button @click="showBOM = true" 
                            class="mt-6 w-full bg-gradient-to-r from-blue-600 to-indigo-700 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-indigo-800 transition-all flex items-center justify-center">
                        <i class="fas fa-list-ul ml-2"></i>
                        نمایش لیست کامل قطعات (BOM)
                    </button>
                    
                    <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
                        <h3 class="font-semibold text-blue-800 mb-2">نکات طراحی</h3>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-500 ml-2 mt-0.5"></i>
                                <span>سافت استارتر برای موتورهای بالای ۵ کیلووات</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-500 ml-2 mt-0.5"></i>
                                <span>هر موتور بالای ۵ کیلووات دو کنتاکتور نیاز دارد</span>
                            </li>
                            <li class="flex items-start">
                                <i class="fas fa-check-circle text-green-500 ml-2 mt-0.5"></i>
                                <span>محاسبه خودکار رله‌های کمکی</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- چینش تابلو -->
                <div class="bg-white rounded-xl shadow-md p-5">
                    <h2 class="text-xl font-bold mb-4">چینش تابلو</h2>
                    <div class="mb-4">
                        <label class="block text-sm text-gray-600 mb-2">ابعاد شبکه چینش</label>
                        <div class="flex space-x-4 space-x-reverse">
                            <div>
                                <label class="text-xs text-gray-500">ردیف</label>
                                <input type="number" x-model="gridRows" min="5" max="20" 
                                       class="w-16 border border-gray-300 rounded-lg px-2 py-1 text-center">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500">ستون</label>
                                <input type="number" x-model="gridCols" min="5" max="20" 
                                       class="w-16 border border-gray-300 rounded-lg px-2 py-1 text-center">
                            </div>
                            <button @click="generateLayout()" class="bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-lg text-sm">
                                ایجاد چینش
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-auto max-h-80 border border-gray-300 rounded-lg p-2">
                        <div class="inline-block">
                            <template x-for="(row, rowIndex) in cabinetLayout" :key="rowIndex">
                                <div class="flex">
                                    <template x-for="(cell, colIndex) in row" :key="colIndex">
                                        <div class="grid-cell" 
                                             :class="{'occupied': cell.component, 'bg-blue-100': cell.component}"
                                             :title="cell.component ? cell.component.name : 'خالی'"
                                             @click="toggleCell(rowIndex, colIndex)">
                                            <template x-if="cell.component">
                                                <div class="text-xs text-center">
                                                    <i :class="cell.component.icon" class="text-blue-700"></i>
                                                </div>
                                            </template>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <p class="text-sm text-gray-600 mt-3">برای قرار دادن قطعه روی سلول کلیک کنید</p>
                </div>
            </div>
        </div>

        <!-- سیستم کنترل -->
        <div class="bg-white rounded-xl shadow-md p-5 mb-8 component-card">
            <div class="flex items-center mb-4">
                <i class="fas fa-code text-2xl text-orange-600 ml-3"></i>
                <h2 class="text-xl font-bold">الگوریتم کنترل سیستم</h2>
            </div>
            
            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                <pre class="text-sm text-gray-800 overflow-auto" x-text="controlAlgorithm"></pre>
            </div>
            
            <div class="mt-4 text-sm text-gray-600">
                <p>دمای سالن: rt | رطوبت سالن: rh | دمای بیرون: ot | رطوبت بیرون: oh</p>
                <p>دمای هوای سیرکوله: ct | رطوبت هوای سیرکوله: ch | دمای هوای مخلوط: mt | رطوبت هوای مخلوط: mh</p>
            </div>
        </div>
    </main>

    <!-- مودال BOM -->
    <div x-show="showBOM" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-6xl max-h-[90vh] overflow-hidden" 
             @click.away="showBOM = false">
            <div class="bg-gradient-to-r from-blue-700 to-indigo-800 text-white p-6 flex justify-between items-center">
                <h2 class="text-2xl font-bold">لیست مواد و قطعات (BOM)</h2>
                <div class="flex space-x-3 space-x-reverse">
                    <button @click="exportBOM('json')" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-download ml-2"></i> JSON
                    </button>
                    <button @click="exportBOM('csv')" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-file-csv ml-2"></i> CSV
                    </button>
                    <button @click="printBOM()" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg flex items-center">
                        <i class="fas fa-print ml-2"></i> چاپ
                    </button>
                    <button @click="showBOM = false" class="bg-red-600 hover:bg-red-700 w-10 h-10 rounded-lg flex items-center justify-center">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6 overflow-auto max-h-[70vh]">
                <!-- اطلاعات پروژه -->
                <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <p class="text-sm text-gray-600">تاریخ ایجاد</p>
                            <p class="font-semibold" x-text="new Date().toLocaleDateString('fa-IR')"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">PLC انتخاب شده</p>
                            <p class="font-semibold" x-text="plcSettings.type === 's7-1200' ? 'Siemens S7-1200' : plcSettings.type === 's7-1500' ? 'Siemens S7-1500' : plcSettings.type === 'logo' ? 'Siemens LOGO' : 'Allen Bradley MicroLogix'"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">اندازه تابلو</p>
                            <p class="font-semibold" x-text="cabinetSettings.width + '×' + cabinetSettings.height + '×' + cabinetSettings.depth + ' mm'"></p>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600">IP Rating</p>
                            <p class="font-semibold" x-text="cabinetSettings.ipRating"></p>
                        </div>
                    </div>
                </div>
                
                <!-- لیست BOM -->
                <div class="space-y-6">
                    <!-- موتورها و کنتاکتورها -->
                    <div class="fade-in">
                        <h3 class="text-lg font-bold mb-3 pb-2 border-b">موتورها و کنتاکتورها</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3">ردیف</th>
                                        <th class="p-3">نام قطعه</th>
                                        <th class="p-3">تعداد</th>
                                        <th class="p-3">مشخصات فنی</th>
                                        <th class="p-3">توضیحات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(item, index) in bomList.motors" :key="item.id">
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="p-3" x-text="index + 1"></td>
                                            <td class="p-3 font-semibold" x-text="item.name"></td>
                                            <td class="p-3" x-text="item.quantity"></td>
                                            <td class="p-3" x-text="item.specs"></td>
                                            <td class="p-3" x-text="item.description"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- تجهیزات کنترل -->
                    <div class="fade-in">
                        <h3 class="text-lg font-bold mb-3 pb-2 border-b">تجهیزات کنترل و اتوماسیون</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3">ردیف</th>
                                        <th class="p-3">نام قطعه</th>
                                        <th class="p-3">تعداد</th>
                                        <th class="p-3">مشخصات فنی</th>
                                        <th class="p-3">توضیحات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(item, index) in bomList.control" :key="item.id">
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="p-3" x-text="index + 1"></td>
                                            <td class="p-3 font-semibold" x-text="item.name"></td>
                                            <td class="p-3" x-text="item.quantity"></td>
                                            <td class="p-3" x-text="item.specs"></td>
                                            <td class="p-3" x-text="item.description"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- تجهیزات حفاظتی -->
                    <div class="fade-in">
                        <h3 class="text-lg font-bold mb-3 pb-2 border-b">تجهیزات حفاظتی و تغذیه</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3">ردیف</th>
                                        <th class="p-3">نام قطعه</th>
                                        <th class="p-3">تعداد</th>
                                        <th class="p-3">مشخصات فنی</th>
                                        <th class="p-3">توضیحات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(item, index) in bomList.protection" :key="item.id">
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="p-3" x-text="index + 1"></td>
                                            <td class="p-3 font-semibold" x-text="item.name"></td>
                                            <td class="p-3" x-text="item.quantity"></td>
                                            <td class="p-3" x-text="item.specs"></td>
                                            <td class="p-3" x-text="item.description"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- تابلو و اتصالات -->
                    <div class="fade-in">
                        <h3 class="text-lg font-bold mb-3 pb-2 border-b">تابلو، اتصالات و مواد مصرفی</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-right">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="p-3">ردیف</th>
                                        <th class="p-3">نام قطعه</th>
                                        <th class="p-3">تعداد/مقدار</th>
                                        <th class="p-3">مشخصات فنی</th>
                                        <th class="p-3">توضیحات</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(item, index) in bomList.cabinet" :key="item.id">
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="p-3" x-text="index + 1"></td>
                                            <td class="p-3 font-semibold" x-text="item.name"></td>
                                            <td class="p-3" x-text="item.quantity"></td>
                                            <td class="p-3" x-text="item.specs"></td>
                                            <td class="p-3" x-text="item.description"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- خلاصه مالی -->
                    <div class="fade-in mt-8 p-4 bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg border">
                        <h3 class="text-lg font-bold mb-3">خلاصه برآورد هزینه (یورو)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="bg-white p-4 rounded-lg shadow text-center">
                                <p class="text-gray-600 text-sm">تجهیزات کنترل</p>
                                <p class="text-2xl font-bold text-blue-700" x-text="'€' + bomSummary.control"></p>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow text-center">
                                <p class="text-gray-600 text-sm">تجهیزات قدرت</p>
                                <p class="text-2xl font-bold text-green-700" x-text="'€' + bomSummary.power"></p>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow text-center">
                                <p class="text-gray-600 text-sm">کل برآورد</p>
                                <p class="text-2xl font-bold text-purple-700" x-text="'€' + bomSummary.total"></p>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600 mt-4 text-center">تمامی قیمت‌ها به یورو و به صورت تخمینی می‌باشند</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- فوتو -->
    <footer class="bg-gray-800 text-white py-6 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-4 md:mb-0">
                    <h3 class="text-xl font-bold">PLC Design Assistant</h3>
                    <p class="text-gray-400 mt-1">طراحی تابلو برق تهویه تبخیری نساجی</p>
                </div>
                <div class="text-gray-400 text-sm">
                    <p>تمامی محاسبات بر اساس استانداردهای IEC انجام می‌شود</p>
                    <p class="mt-1">نسخه ۱.۰ | طراحی شده با Alpine.js و Tailwind CSS</p>
                </div>
            </div>
        </div>
    </footer>

    <script>
        function plcDesigner() {
            return {
                // داده‌های پایه
                motors: [
                    { id: 1, name: 'فن رفت (Fan feed)', description: 'فن رفت با موتور در رنج تا ۶۰ کیلووات', quantity: 2, power: 22, totalPower: 44 },
                    { id: 2, name: 'فن برگشت (Fan return)', description: 'فن برگشت با موتور تا رنج ۶۰ کیلووات', quantity: 2, power: 30, totalPower: 60 },
                    { id: 3, name: 'فن غبار (Dust Fan)', description: 'هر روتاری فیلتر دارای دو عدد فن', quantity: 4, power: 3.3, totalPower: 13.2 },
                    { id: 4, name: 'موتور روتاری (Rotary motor)', description: 'هر روتاری فیلتر دارای یک روتاری موتور', quantity: 2, power: 1, totalPower: 2 },
                    { id: 5, name: 'موتور مکانیزم (Mechanism motor)', description: 'هر روتاری فیلتر دارای یک مکانیزم موتور', quantity: 2, power: 0.25, totalPower: 0.5 },
                    { id: 6, name: 'پمپ آب (Pump water motor)', description: 'پمپ آب سانتریفیوژ با موتور تا رنج ۵۰ کیلووات', quantity: 1, power: 30, totalPower: 30 }
                ],
                
                actuators: [
                    { id: 1, name: 'دمپر هوای تازه (Damper fresh)', description: 'هر دمپر دارای پوزیشنر خودش برای خواندن', quantity: 2, voltage: '24VDC', hasPositioner: true, hasInput: true },
                    { id: 2, name: 'دمپر تخلیه (Damper exhaust)', description: 'هر دمپر پوزیشنر خود را دارد', quantity: 2, voltage: '24VDC', hasPositioner: true, hasInput: true },
                    { id: 3, name: 'دمپر برگشت (Damper return)', description: 'هر دمپر پوزیشنر خود را دارد', quantity: 2, voltage: '24VDC', hasPositioner: true, hasInput: true },
                    { id: 4, name: 'شیر بخار (Steam valve)', description: 'در صورت کنترل دار بودن امکان خواندن پوزیشنر', quantity: 1, voltage: '24VDC', hasPositioner: true, hasInput: false }
                ],
                
                sensors: [
                    { id: 1, name: 'دماسنج (Temperature)', description: 'سنسور دمای بیرون و داخل', quantity: 2, type: 'آنالوگ ۴-۲۰mA' },
                    { id: 2, name: 'رطوبت‌سنج (Humidity)', description: 'سنسور رطوبت بیرون و داخل', quantity: 2, type: 'آنالوگ ۴-۲۰mA' },
                    { id: 3, name: 'میکروسوییچ (Micro switch)', description: 'به ازای هر درب یک سوییچ', quantity: 5, type: 'ON/OFF دیجیتال' }
                ],
                
                optionalEquipment: [
                    { id: 'vfd', name: 'اینورتر (VFD)', description: 'کنترل موتور سه فاز با توان به اندازه بزرگترین موتور', quantity: 0, power: 30 },
                    { id: 'soft_start', name: 'سافت استارتر (Soft starter)', description: 'با اندازه بزرگترین موتور', quantity: 1, power: 30 },
                    { id: 'hmi', name: 'صفحه نمایش (HMI)', description: 'واسط کاربری اپراتور', quantity: 1, size: 7 },
                    { id: 'heat_sensor', name: 'سنسور تشخیص حرارت داخل تابلو', description: 'سنسور تشخیص حرارت داخل تابلو', quantity: 0 }
                ],
                
                plcSettings: {
                    type: 's7-1200',
                    digitalInputs: 16,
                    digitalOutputs: 16,
                    analogInputs: 8,
                    analogOutputs: 4
                },
                
                cabinetSettings: {
                    width: 800,
                    height: 1800,
                    depth: 400,
                    ipRating: 'IP54',
                    hasCooling: true
                },
                
                // داده‌های مربوط به چینش تابلو
                gridRows: 10,
                gridCols: 8,
                cabinetLayout: [],
                layoutComponents: [
                    { id: 'plc', name: 'PLC', icon: 'fas fa-microchip', width: 2, height: 3 },
                    { id: 'hmi', name: 'HMI', icon: 'fas fa-tv', width: 2, height: 2 },
                    { id: 'contactor', name: 'کنتاکتور', icon: 'fas fa-bolt', width: 1, height: 1 },
                    { id: 'breaker', name: 'بریکر', icon: 'fas fa-power-off', width: 1, height: 1 },
                    { id: 'relay', name: 'رله', icon: 'fas fa-exchange-alt', width: 1, height: 1 },
                    { id: 'terminal', name: 'ترمینال', icon: 'fas fa-plug', width: 2, height: 1 }
                ],
                
                // داده‌های نمایشی
                showBOM: false,
                bomList: {
                    motors: [],
                    control: [],
                    protection: [],
                    cabinet: []
                },
                bomSummary: {
                    control: 0,
                    power: 0,
                    total: 0
                },
                
                // الگوریتم کنترل
                controlAlgorithm: `// الگوریتم کنترل سیستم تهویه تبخیری نساجی
// پارامترهای ورودی:
// rt: دمای سالن, rh: رطوبت سالن
// ot: دمای بیرون, oh: رطوبت بیرون
// ct: دمای هوای سیرکوله, ch: رطوبت هوای سیرکوله

// محاسبه درصد هوای تازه و سیرکوله
fresh_percentage = exhaust_percentage;
cycle_percentage = 100 - fresh_percentage;

// محاسبه هوای مخلوط (ترکیب هوای تازه و سیرکوله)
if (heater_valve_on) {
    // گرمایش هوای سیرکوله با کویل
    ct = calculate_heated_air(ct, heater_power);
}

// محاسبه خواص هوای مخلوط با استفاده از سایکرومتریک
mt = (fresh_percentage * ot + cycle_percentage * ct) / 100;
mh = (fresh_percentage * oh + cycle_percentage * ch) / 100;

// کنترل رطوبت‌دهی هوای تغذیه
if (rh < setpoint_humidity) {
    enable_humidification = true;
    water_pump_speed = calculate_pump_speed(rh, setpoint_humidity);
} else {
    enable_humidification = false;
    water_pump_speed = 0;
}

// کنترل دمپرها
damper_fresh_position = calculate_damper_position(fresh_percentage);
damper_exhaust_position = calculate_damper_position(exhaust_percentage);
damper_return_position = calculate_damper_position(cycle_percentage);

// کنترل فن‌ها
fan_feed_speed = calculate_fan_speed(rt, setpoint_temperature);
fan_return_speed = calculate_fan_speed(rt, setpoint_temperature);

// کنترل حلقه بسته
if (abs(rt - setpoint_temperature) > tolerance_temp) {
    adjust_dampers(rt, setpoint_temperature);
}

if (abs(rh - setpoint_humidity) > tolerance_hum) {
    adjust_humidification(rh, setpoint_humidity);
}`,
                
                // توابع اولیه
                initApp() {
                    this.calculateMotorTotals();
                    this.generateLayout();
                    this.generateBOM();
                },
                
                // توابع موتورها
                incrementMotor(index) {
                    this.motors[index].quantity++;
                    this.calculateMotorTotals();
                },
                
                decrementMotor(index) {
                    if (this.motors[index].quantity > 0) {
                        this.motors[index].quantity--;
                        this.calculateMotorTotals();
                    }
                },
                
                calculateMotorTotals() {
                    this.motors.forEach(motor => {
                        motor.totalPower = motor.quantity * motor.power;
                    });
                },
                
                getTotalMotorsCount() {
                    return this.motors.reduce((total, motor) => total + motor.quantity, 0);
                },
                
                getTotalMotorsPower() {
                    return this.motors.reduce((total, motor) => total + motor.totalPower, 0);
                },
                
                // توابع اکچویتورها
                incrementActuator(index) {
                    this.actuators[index].quantity++;
                },
                
                decrementActuator(index) {
                    if (this.actuators[index].quantity > 0) {
                        this.actuators[index].quantity--;
                    }
                },
                
                getTotalActuatorsCount() {
                    return this.actuators.reduce((total, actuator) => total + actuator.quantity, 0);
                },
                
                // توابع سنسورها
                incrementSensor(index) {
                    this.sensors[index].quantity++;
                },
                
                decrementSensor(index) {
                    if (this.sensors[index].quantity > 0) {
                        this.sensors[index].quantity--;
                    }
                },
                
                getTotalSensorsCount() {
                    return this.sensors.reduce((total, sensor) => total + sensor.quantity, 0);
                },
                
                // توابع تجهیزات اختیاری
                incrementOptional(index) {
                    this.optionalEquipment[index].quantity++;
                },
                
                decrementOptional(index) {
                    if (this.optionalEquipment[index].quantity > 0) {
                        this.optionalEquipment[index].quantity--;
                    }
                },
                
                // توابع محاسبات PLC
                calculateDigitalInputs() {
                    let digitalInputs = 0;
                    
                    // میکروسوییچ‌ها
                    const microSwitch = this.sensors.find(s => s.name.includes('میکروسوییچ'));
                    if (microSwitch) digitalInputs += microSwitch.quantity;
                    
                    // ورودی‌های اکچویتورها
                    this.actuators.forEach(actuator => {
                        if (actuator.hasInput) digitalInputs += actuator.quantity;
                    });
                    
                    // سایر موارد
                    digitalInputs += 3; // برای استارت، استاپ و حالت دستی/اتوماتیک
                    
                    return digitalInputs;
                },
                
                calculateDigitalOutputs() {
                    let digitalOutputs = 0;
                    
                    // خروجی برای اکچویتورها
                    digitalOutputs += this.getTotalActuatorsCount();
                    
                    // خروجی برای موتورها
                    digitalOutputs += this.getTotalMotorsCount();
                    
                    // رله‌های کنترلی
                    digitalOutputs += Math.ceil(this.getTotalMotorsCount() / 2);
                    
                    return digitalOutputs;
                },
                
                calculateAnalogInputs() {
                    let analogInputs = 0;
                    
                    // سنسورهای دما و رطوبت
                    analogInputs += this.sensors.reduce((total, sensor) => {
                        if (sensor.type.includes('آنالوگ')) {
                            return total + sensor.quantity;
                        }
                        return total;
                    }, 0);
                    
                    // پوزیشنرهای اکچویتورها
                    this.actuators.forEach(actuator => {
                        if (actuator.hasPositioner) analogInputs += actuator.quantity;
                    });
                    
                    return analogInputs;
                },
                
                getTotalComponentsCount() {
                    let total = 0;
                    total += this.getTotalMotorsCount();
                    total += this.getTotalActuatorsCount();
                    total += this.getTotalSensorsCount();
                    total += this.optionalEquipment.reduce((sum, item) => sum + item.quantity, 0);
                    
                    // اضافه کردن قطعات محاسبه شده
                    total += this.calculateContactors();
                    total += this.calculateRelays();
                    total += 10; // ترمینال‌ها، فیوزها و ...
                    
                    return total;
                },
                
                // توابع چینش تابلو
                generateLayout() {
                    this.cabinetLayout = [];
                    for (let i = 0; i < this.gridRows; i++) {
                        this.cabinetLayout[i] = [];
                        for (let j = 0; j < this.gridCols; j++) {
                            this.cabinetLayout[i][j] = {
                                component: null,
                                row: i,
                                col: j
                            };
                        }
                    }
                    
                    // قرار دادن PLC در موقعیت پیش‌فرض
                    if (this.gridRows >= 3 && this.gridCols >= 2) {
                        this.cabinetLayout[0][0].component = this.layoutComponents[0]; // PLC
                    }
                    
                    // قرار دادن HMI در صورت وجود
                    const hmi = this.optionalEquipment.find(item => item.id === 'hmi');
                    if (hmi && hmi.quantity > 0 && this.gridRows >= 2 && this.gridCols >= 4) {
                        this.cabinetLayout[0][3].component = this.layoutComponents[1]; // HMI
                    }
                },
                
                toggleCell(row, col) {
                    if (this.cabinetLayout[row][col].component) {
                        this.cabinetLayout[row][col].component = null;
                    } else {
                        // در این مثال ساده، اولین قطعه از لیست را قرار می‌دهیم
                        // در نسخه کامل می‌توان از یک مودال برای انتخاب قطعه استفاده کرد
                        this.cabinetLayout[row][col].component = this.layoutComponents[2]; // کنتاکتور
                    }
                },
                
                // توابع BOM
                generateBOM() {
                    // محاسبه کنتاکتورها
                    const contactorCount = this.calculateContactors();
                    const highPowerMotorCount = this.motors.filter(m => m.power > 5).reduce((sum, m) => sum + m.quantity, 0);
                    
                    // محاسبه رله‌ها
                    const relayCount = this.calculateRelays();
                    
                    // لیست موتورها و کنتاکتورها
                    this.bomList.motors = [
                        ...this.motors.filter(m => m.quantity > 0).map(m => ({
                            id: m.id,
                            name: m.name,
                            quantity: m.quantity,
                            specs: `${m.power} کیلووات، ۳ فاز، ۴۰۰V`,
                            description: m.description
                        })),
                        {
                            id: 100,
                            name: 'کنتاکتور موتور',
                            quantity: contactorCount,
                            specs: 'AC-3، ۴۰۰V، بر اساس توان موتور',
                            description: highPowerMotorCount > 0 ? 
                                `${highPowerMotorCount} موتور بالای ۵ کیلووات نیاز به ۲ کنتاکتور دارند` : 
                                'همه موتورها زیر ۵ کیلووات هستند'
                        }
                    ];
                    
                    // لیست تجهیزات کنترل
                    const vfd = this.optionalEquipment.find(item => item.id === 'vfd');
                    const softStarter = this.optionalEquipment.find(item => item.id === 'soft_start');
                    const hmi = this.optionalEquipment.find(item => item.id === 'hmi');
                    
                    this.bomList.control = [
                        {
                            id: 200,
                            name: 'PLC ' + (this.plcSettings.type === 's7-1200' ? 'Siemens S7-1200' : 
                                    this.plcSettings.type === 's7-1500' ? 'Siemens S7-1500' : 
                                    this.plcSettings.type === 'logo' ? 'Siemens LOGO' : 'Allen Bradley MicroLogix'),
                            quantity: 1,
                            specs: `${this.calculateDigitalInputs()} DI, ${this.calculateDigitalOutputs()} DO, ${this.calculateAnalogInputs()} AI`,
                            description: 'واحد پردازش مرکزی'
                        },
                        {
                            id: 201,
                            name: 'ماژول تغذیه PLC',
                            quantity: 1,
                            specs: '24VDC، ۳-۵A',
                            description: 'منبع تغذیه برای PLC و ماژول‌ها'
                        },
                        {
                            id: 202,
                            name: 'رله کمکی',
                            quantity: relayCount,
                            specs: '24VDC، ۱۰A، ۲ کنتاکت',
                            description: 'برای مدارهای فرمان و کنترل'
                        }
                    ];
                    
                    if (vfd && vfd.quantity > 0) {
                        this.bomList.control.push({
                            id: 203,
                            name: 'اینورتر (VFD)',
                            quantity: vfd.quantity,
                            specs: `${vfd.power} کیلووات، ۳ فاز، ۴۰۰V`,
                            description: 'کنترل سرعت موتور'
                        });
                    }
                    
                    if (softStarter && softStarter.quantity > 0) {
                        this.bomList.control.push({
                            id: 204,
                            name: 'سافت استارتر',
                            quantity: softStarter.quantity,
                            specs: `${softStarter.power} کیلووات، ۳ فاز، ۴۰۰V`,
                            description: 'راه‌اندازی نرم موتورهای بالای ۵ کیلووات'
                        });
                    }
                    
                    if (hmi && hmi.quantity > 0) {
                        this.bomList.control.push({
                            id: 205,
                            name: 'صفحه نمایش اپراتور (HMI)',
                            quantity: hmi.quantity,
                            specs: `${hmi.size} اینچ، تاچ اسکرین، اترنت`,
                            description: 'واسط کاربری اپراتور'
                        });
                    }
                    
                    // اضافه کردن اکچویتورها و سنسورها
                    this.actuators.filter(a => a.quantity > 0).forEach(a => {
                        this.bomList.control.push({
                            id: 300 + a.id,
                            name: a.name,
                            quantity: a.quantity,
                            specs: `${a.voltage}${a.hasPositioner ? '، با پوزیشنر' : ''}`,
                            description: a.description
                        });
                    });
                    
                    this.sensors.filter(s => s.quantity > 0).forEach(s => {
                        this.bomList.control.push({
                            id: 400 + s.id,
                            name: s.name,
                            quantity: s.quantity,
                            specs: s.type,
                            description: s.description
                        });
                    });
                    
                    // لیست تجهیزات حفاظتی
                    this.bomList.protection = [
                        {
                            id: 500,
                            name: 'بریکر اصلی',
                            quantity: 1,
                            specs: `۳P، ${this.calculateMainBreakerRating()}A، تیپ C`,
                            description: 'حفاظت اصلی تابلو'
                        },
                        {
                            id: 501,
                            name: 'بریکر موتور',
                            quantity: this.getTotalMotorsCount(),
                            specs: '۳P، تیپ D، بر اساس توان موتور',
                            description: 'حفاظت هر موتور به صورت جداگانه'
                        },
                        {
                            id: 502,
                            name: 'فیوز کنترل',
                            quantity: 4,
                            specs: '۱۰A، ۲P، ۲۴VDC',
                            description: 'حفاظت مدارهای کنترل'
                        },
                        {
                            id: 503,
                            name: 'فیوز تغذیه سنسورها',
                            quantity: 2,
                            specs: '۲A، ۲۴VDC',
                            description: 'حفاظت مدارهای سنسورها'
                        },
                        {
                            id: 504,
                            name: 'محافظ ولتاژ (Surge protector)',
                            quantity: 1,
                            specs: '۳P+N، ۴۰۰V',
                            description: 'حفاظت در برابر نوسانات ولتاژ'
                        }
                    ];
                    
                    // لیست تابلو و اتصالات
                    this.bomList.cabinet = [
                        {
                            id: 600,
                            name: 'تابلو برق',
                            quantity: 1,
                            specs: `${this.cabinetSettings.width}×${this.cabinetSettings.height}×${this.cabinetSettings.depth}mm، ${this.cabinetSettings.ipRating}`,
                            description: `بدنه فلزی با رنگ الکترواستاتیک${this.cabinetSettings.hasCooling ? '، با سیستم خنک‌کننده' : ''}`
                        },
                        {
                            id: 601,
                            name: 'شینه زمین',
                            quantity: 1,
                            specs: 'مسی، ۳۰×۵mm، با کاور عایق',
                            description: 'اتصال زمین تجهیزات'
                        },
                        {
                            id: 602,
                            name: 'شینه نول',
                            quantity: 1,
                            specs: 'مسی، ۳۰×۵mm',
                            description: 'اتصال نول'
                        },
                        {
                            id: 603,
                            name: 'ترمینال‌بلاک',
                            quantity: this.calculateTerminalBlocks(),
                            specs: 'فنری/پیچی، ۲۴VDC و ۴۰۰V',
                            description: 'برای اتصالات داخلی تابلو'
                        },
                        {
                            id: 604,
                            name: 'سیم مسی نمره ۱.۵',
                            quantity: this.calculateWireLength(1.5),
                            specs: '۱.۵mm²، عایق PVC',
                            description: 'سیم‌کشی مدارهای کنترل'
                        },
                        {
                            id: 605,
                            name: 'سیم مسی نمره ۴',
                            quantity: this.calculateWireLength(4),
                            specs: '۴mm²، عایق PVC',
                            description: 'سیم‌کشی مدارهای قدرت (موتورهای کوچک)'
                        },
                        {
                            id: 606,
                            name: 'سیم مسی نمره ۱۰',
                            quantity: this.calculateWireLength(10),
                            specs: '۱۰mm²، عایق PVC',
                            description: 'سیم‌کشی مدارهای قدرت (موتورهای متوسط)'
                        },
                        {
                            id: 607,
                            name: 'سیم ارت',
                            quantity: 10,
                            specs: 'نمره ۱۶mm²، زرد-سبز',
                            description: 'اتصال زمین'
                        },
                        {
                            id: 608,
                            name: 'کابلشو و نایلون',
                            quantity: this.calculateCableLugs(),
                            specs: 'مسی قلع اندود',
                            description: 'اتصال سیم به ترمینال'
                        },
                        {
                            id: 609,
                            name: 'چراغ سیگنال',
                            quantity: 4,
                            specs: 'LED، ۲۴VDC، قرمز/سبز/زرد',
                            description: 'نشان‌دهنده وضعیت سیستم'
                        },
                        {
                            id: 610,
                            name: 'کلید انتخابگر',
                            quantity: 2,
                            specs: '۲-۳ پوزیشن، ۲۴VDC',
                            description: 'انتخاب حالت دستی/اتوماتیک'
                        },
                        {
                            id: 611,
                            name: 'دکمه فشاری',
                            quantity: 4,
                            specs: 'NO/NC، ۲۴VDC',
                            description: 'استارت، استاپ، ریست'
                        }
                    ];
                    
                    // محاسبه خلاصه هزینه
                    this.calculateBOMCost();
                },
                
                calculateContactors() {
                    let contactorCount = 0;
                    this.motors.forEach(motor => {
                        if (motor.quantity > 0) {
                            // موتورهای بالای ۵ کیلووات نیاز به ۲ کنتاکتور دارند
                            if (motor.power > 5) {
                                contactorCount += motor.quantity * 2;
                            } else {
                                contactorCount += motor.quantity;
                            }
                        }
                    });
                    return contactorCount;
                },
                
                calculateRelays() {
                    let relayCount = 0;
                    
                    // رله برای هر موتور
                    relayCount += this.getTotalMotorsCount();
                    
                    // رله برای مدارهای کنترل
                    relayCount += 4;
                    
                    // رله برای هشدارها
                    relayCount += 3;
                    
                    return relayCount;
                },
                
                calculateMainBreakerRating() {
                    const totalPower = this.getTotalMotorsPower();
                    // فرض: توان کل به آمپر با ضریب ۲ (برای ۴۰۰V سه فاز)
                    const totalCurrent = Math.ceil((totalPower * 1000) / (400 * Math.sqrt(3) * 0.8));
                    // اضافه کردن ۲۰٪ حاشیه ایمنی
                    return Math.ceil(totalCurrent * 1.2 / 10) * 10;
                },
                
                calculateTerminalBlocks() {
                    let terminalCount = 0;
                    
                    // ترمینال برای هر موتور: ۴ عدد (۳ فاز + زمین)
                    terminalCount += this.getTotalMotorsCount() * 4;
                    
                    // ترمینال برای سنسورها و اکچویتورها
                    terminalCount += this.getTotalSensorsCount() + this.getTotalActuatorsCount();
                    
                    // ترمینال برای PLC
                    terminalCount += this.calculateDigitalInputs() + this.calculateDigitalOutputs() + this.calculateAnalogInputs() + 10;
                    
                    // تقسیم بر تعداد پورت هر ترمینال‌بلاک (فرض: ۱۲ پورت)
                    return Math.ceil(terminalCount / 12);
                },
                
                calculateWireLength(crossSection) {
                    // محاسبه تقریبی طول سیم بر اساس ابعاد تابلو و تعداد قطعات
                    const baseLength = 50; // متر پایه
                    
                    if (crossSection === 1.5) {
                        // سیم کنترل
                        return baseLength + (this.getTotalComponentsCount() * 5);
                    } else if (crossSection === 4) {
                        // سیم قدرت موتورهای کوچک
                        const smallMotors = this.motors.filter(m => m.power <= 5).reduce((sum, m) => sum + m.quantity, 0);
                        return baseLength * 0.5 + (smallMotors * 10);
                    } else if (crossSection === 10) {
                        // سیم قدرت موتورهای بزرگ
                        const largeMotors = this.motors.filter(m => m.power > 5).reduce((sum, m) => sum + m.quantity, 0);
                        return baseLength * 0.3 + (largeMotors * 15);
                    }
                    
                    return 0;
                },
                
                calculateCableLugs() {
                    return this.calculateWireLength(1.5) / 2 + 
                           this.calculateWireLength(4) / 3 + 
                           this.calculateWireLength(10) / 5;
                },
                
                calculateBOMCost() {
                    // محاسبه تقریبی هزینه‌ها به یورو
                    let controlCost = 0;
                    let powerCost = 0;
                    
                    // هزینه PLC
                    if (this.plcSettings.type === 's7-1200') controlCost += 1200;
                    else if (this.plcSettings.type === 's7-1500') controlCost += 2500;
                    else if (this.plcSettings.type === 'logo') controlCost += 400;
                    else controlCost += 1800;
                    
                    // هزینه HMI
                    const hmi = this.optionalEquipment.find(item => item.id === 'hmi');
                    if (hmi && hmi.quantity > 0) {
                        if (hmi.size == 7) controlCost += 800;
                        else if (hmi.size == 10) controlCost += 1200;
                        else if (hmi.size == 12) controlCost += 1800;
                        else controlCost += 2500;
                    }
                    
                    // هزینه سنسورها و اکچویتورها
                    controlCost += this.getTotalSensorsCount() * 150;
                    controlCost += this.getTotalActuatorsCount() * 300;
                    
                    // هزینه موتورها و کنتاکتورها
                    this.motors.forEach(motor => {
                        if (motor.quantity > 0) {
                            powerCost += motor.quantity * motor.power * 80; // فرض: ۸۰ یورو به ازای هر کیلووات
                        }
                    });
                    
                    // هزینه کنتاکتورها
                    powerCost += this.calculateContactors() * 120;
                    
                    // هزینه اینورتر/سافت استارتر
                    const vfd = this.optionalEquipment.find(item => item.id === 'vfd');
                    const softStarter = this.optionalEquipment.find(item => item.id === 'soft_start');
                    
                    if (vfd && vfd.quantity > 0) {
                        powerCost += vfd.quantity * vfd.power * 60;
                    }
                    
                    if (softStarter && softStarter.quantity > 0) {
                        powerCost += softStarter.quantity * softStarter.power * 40;
                    }
                    
                    // هزینه تابلو و اتصالات
                    const cabinetCost = 800 + (this.cabinetSettings.hasCooling ? 300 : 0);
                    const wiringCost = 500;
                    
                    this.bomSummary.control = Math.round(controlCost);
                    this.bomSummary.power = Math.round(powerCost);
                    this.bomSummary.total = Math.round(controlCost + powerCost + cabinetCost + wiringCost);
                },
                
                // توابع فرمت‌بندی
                formatNumber(num) {
                    return num.toLocaleString('fa-IR');
                },
                
                // توابع ذخیره و بارگذاری
                saveProject() {
                    const projectData = {
                        motors: this.motors,
                        actuators: this.actuators,
                        sensors: this.sensors,
                        optionalEquipment: this.optionalEquipment,
                        plcSettings: this.plcSettings,
                        cabinetSettings: this.cabinetSettings,
                        timestamp: new Date().toISOString()
                    };
                    
                    const dataStr = JSON.stringify(projectData);
                    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                    
                    const exportFileDefaultName = `plc-design-${new Date().toISOString().slice(0,10)}.json`;
                    
                    const linkElement = document.createElement('a');
                    linkElement.setAttribute('href', dataUri);
                    linkElement.setAttribute('download', exportFileDefaultName);
                    linkElement.click();
                    
                    alert('پروژه با موفقیت ذخیره شد.');
                },
                
                loadProject() {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    
                    input.onchange = e => {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        
                        reader.onload = event => {
                            try {
                                const projectData = JSON.parse(event.target.result);
                                
                                // بارگذاری داده‌ها
                                this.motors = projectData.motors || this.motors;
                                this.actuators = projectData.actuators || this.actuators;
                                this.sensors = projectData.sensors || this.sensors;
                                this.optionalEquipment = projectData.optionalEquipment || this.optionalEquipment;
                                this.plcSettings = projectData.plcSettings || this.plcSettings;
                                this.cabinetSettings = projectData.cabinetSettings || this.cabinetSettings;
                                
                                // محاسبات مجدد
                                this.calculateMotorTotals();
                                this.generateBOM();
                                
                                alert('پروژه با موفقیت بارگذاری شد.');
                            } catch (error) {
                                alert('خطا در بارگذاری فایل. لطفاً از صحت فایل اطمینان حاصل کنید.');
                            }
                        };
                        
                        reader.readAsText(file);
                    };
                    
                    input.click();
                },
                
                // توابع خروجی
                exportBOM(format) {
                    if (format === 'json') {
                        const bomData = {
                            project: 'PLC Design - تهویه تبخیری نساجی',
                            date: new Date().toISOString(),
                            bom: this.bomList,
                            summary: this.bomSummary
                        };
                        
                        const dataStr = JSON.stringify(bomData, null, 2);
                        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                        
                        const linkElement = document.createElement('a');
                        linkElement.setAttribute('href', dataUri);
                        linkElement.setAttribute('download', `bom-${new Date().toISOString().slice(0,10)}.json`);
                        linkElement.click();
                    } else if (format === 'csv') {
                        // ایجاد CSV ساده
                        let csvContent = "نام قطعه,تعداد,مشخصات فنی,توضیحات\n";
                        
                        // اضافه کردن موتورها
                        this.bomList.motors.forEach(item => {
                            csvContent += `"${item.name}",${item.quantity},"${item.specs}","${item.description}"\n`;
                        });
                        
                        // اضافه کردن تجهیزات کنترل
                        this.bomList.control.forEach(item => {
                            csvContent += `"${item.name}",${item.quantity},"${item.specs}","${item.description}"\n`;
                        });
                        
                        // اضافه کردن تجهیزات حفاظتی
                        this.bomList.protection.forEach(item => {
                            csvContent += `"${item.name}",${item.quantity},"${item.specs}","${item.description}"\n`;
                        });
                        
                        // اضافه کردن تابلو و اتصالات
                        this.bomList.cabinet.forEach(item => {
                            csvContent += `"${item.name}",${item.quantity},"${item.specs}","${item.description}"\n`;
                        });
                        
                        const dataUri = 'data:text/csv;charset=utf-8,'+ encodeURIComponent(csvContent);
                        const linkElement = document.createElement('a');
                        linkElement.setAttribute('href', dataUri);
                        linkElement.setAttribute('download', `bom-${new Date().toISOString().slice(0,10)}.csv`);
                        linkElement.click();
                    }
                },
                
                printBOM() {
                    this.showBOM = true;
                    setTimeout(() => {
                        window.print();
                    }, 500);
                }
            }
        }
    </script>
</body>
</html>