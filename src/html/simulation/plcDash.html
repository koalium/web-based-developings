<!DOCTYPE html>
<html lang="en" class="dark-theme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLC Panel Designer | Evaporative Ventilation System</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ===== CSS RESET & VARIABLES ===== */
        :root {
            /* Primary Colors */
            --primary-50: #e3f2fd;
            --primary-100: #bbdefb;
            --primary-200: #90caf9;
            --primary-300: #64b5f6;
            --primary-400: #42a5f5;
            --primary-500: #2196f3;
            --primary-600: #1e88e5;
            --primary-700: #1976d2;
            --primary-800: #1565c0;
            --primary-900: #0d47a1;
            
            /* Secondary Colors */
            --secondary-50: #e8f5e9;
            --secondary-100: #c8e6c9;
            --secondary-200: #a5d6a7;
            --secondary-300: #81c784;
            --secondary-400: #66bb6a;
            --secondary-500: #4caf50;
            --secondary-600: #43a047;
            --secondary-700: #388e3c;
            --secondary-800: #2e7d32;
            --secondary-900: #1b5e20;
            
            /* Neutral Colors */
            --neutral-50: #fafafa;
            --neutral-100: #f5f5f5;
            --neutral-200: #eeeeee;
            --neutral-300: #e0e0e0;
            --neutral-400: #bdbdbd;
            --neutral-500: #9e9e9e;
            --neutral-600: #757575;
            --neutral-700: #616161;
            --neutral-800: #424242;
            --neutral-900: #212121;
            
            /* Status Colors */
            --success: #00c853;
            --warning: #ff9100;
            --error: #ff1744;
            --info: #00b0ff;
            
            /* Component Colors */
            --plc-color: #2196f3;
            --psu-color: #9c27b0;
            --breaker-color: #f44336;
            --contactor-color: #4caf50;
            --relay-color: #ff9800;
            --inverter-color: #00bcd4;
            --softstarter-color: #795548;
            --hmi-color: #607d8b;
            --terminal-color: #9e9e9e;
            
            /* Shadows */
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
            --shadow-xl: 0 20px 40px rgba(0,0,0,0.2);
            
            /* Border Radius */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 300ms ease;
            --transition-slow: 500ms ease;
            
            /* Layout */
            --header-height: 70px;
            --sidebar-width: 280px;
            --sidebar-collapsed: 70px;
        }
        
        .dark-theme {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border-color: #475569;
        }
        
        .light-theme {
            --bg-primary: #ffffff;
            --bg-secondary: #f1f5f9;
            --bg-tertiary: #e2e8f0;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --border-color: #cbd5e1;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html {
            scroll-behavior: smooth;
            font-size: 16px;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            transition: background-color var(--transition-normal), color var(--transition-normal);
        }
        
        /* ===== TYPOGRAPHY ===== */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 600;
            line-height: 1.3;
            margin-bottom: 0.5rem;
        }
        
        h1 { font-size: 2.5rem; }
        h2 { font-size: 2rem; }
        h3 { font-size: 1.75rem; }
        h4 { font-size: 1.5rem; }
        h5 { font-size: 1.25rem; }
        h6 { font-size: 1rem; }
        
        p {
            margin-bottom: 1rem;
        }
        
        a {
            color: var(--primary-500);
            text-decoration: none;
            transition: color var(--transition-fast);
        }
        
        a:hover {
            color: var(--primary-700);
        }
        
        /* ===== LAYOUT CONTAINER ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
            position: relative;
        }
        
        /* ===== SIDEBAR ===== */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            transition: width var(--transition-normal);
            position: sticky;
            top: 0;
            height: 100vh;
            z-index: 50;
        }
        
        .sidebar.collapsed {
            width: var(--sidebar-collapsed);
        }
        
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .sidebar-header .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
        
        .logo-text {
            font-size: 1.25rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .sidebar-nav {
            flex: 1;
            padding: 1rem 0;
            overflow-y: auto;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.875rem 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            border-left: 3px solid transparent;
        }
        
        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: linear-gradient(90deg, rgba(33, 150, 243, 0.1), transparent);
            color: var(--primary-500);
            border-left-color: var(--primary-500);
        }
        
        .nav-icon {
            font-size: 1.25rem;
            width: 24px;
            text-align: center;
        }
        
        .nav-text {
            font-size: 0.95rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sidebar.collapsed .nav-text {
            display: none;
        }
        
        .sidebar-footer {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        /* ===== MAIN CONTENT ===== */
        .main-content {
            flex: 1;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* ===== HEADER ===== */
        .header {
            height: var(--header-height);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            position: sticky;
            top: 0;
            z-index: 40;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .sidebar-toggle {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all var(--transition-fast);
        }
        
        .sidebar-toggle:hover {
            background: var(--primary-500);
            color: white;
            border-color: var(--primary-500);
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        /* ===== ACTION BUTTONS ===== */
        .action-buttons {
            display: flex;
            gap: 0.75rem;
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: var(--radius-md);
            border: none;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--border-color);
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--secondary-500), var(--secondary-700));
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #ff6d00);
            color: white;
        }
        
        .btn-error {
            background: linear-gradient(135deg, var(--error), #d50000);
            color: white;
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--info), #0091ea);
            color: white;
        }
        
        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
        }
        
        .btn-lg {
            padding: 0.875rem 1.75rem;
            font-size: 1rem;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: var(--radius-full);
        }
        
        /* ===== CONTENT AREA ===== */
        .content-area {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        
        /* ===== DASHBOARD GRID ===== */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: transform var(--transition-normal), box-shadow var(--transition-normal);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary-500), var(--primary-700));
            color: white;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .stat-change {
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .stat-change.positive {
            color: var(--success);
        }
        
        .stat-change.negative {
            color: var(--error);
        }
        
        /* ===== SECTION CARDS ===== */
        .section-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            overflow: hidden;
            margin-bottom: 2rem;
            transition: transform var(--transition-normal);
        }
        
        .section-card:hover {
            transform: translateY(-2px);
        }
        
        .section-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(90deg, rgba(33, 150, 243, 0.05), transparent);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.25rem;
            font-weight: 600;
        }
        
        .section-icon {
            color: var(--primary-500);
            font-size: 1.5rem;
        }
        
        .section-content {
            padding: 1.5rem;
        }
        
        /* ===== COMPONENT CARDS ===== */
        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
        }
        
        .component-card {
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }
        
        .component-card:hover {
            border-color: var(--primary-500);
            box-shadow: var(--shadow-md);
        }
        
        .component-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary-500);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .component-card:hover::before {
            opacity: 1;
        }
        
        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .component-name {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .component-badge {
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--primary-500);
            color: white;
        }
        
        .component-controls {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: var(--bg-secondary);
            padding: 0.5rem;
            border-radius: var(--radius-full);
            border: 1px solid var(--border-color);
        }
        
        .qty-btn {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-full);
            border: none;
            background: var(--primary-500);
            color: white;
            font-size: 1.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .qty-btn:hover {
            background: var(--primary-700);
            transform: scale(1.1);
        }
        
        .qty-display {
            min-width: 40px;
            text-align: center;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .component-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .detail-input {
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 0.95rem;
            transition: all var(--transition-fast);
        }
        
        .detail-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
        }
        
        .component-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .checkbox-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }
        
        /* ===== SWITCH ===== */
        .switch {
            position: relative;
            display: inline-block;
            width: 52px;
            height: 28px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--border-color);
            transition: var(--transition-fast);
            border-radius: 34px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: var(--transition-fast);
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: var(--primary-500);
        }
        
        input:checked + .slider:before {
            transform: translateX(24px);
        }
        
        /* ===== CABINET LAYOUT ===== */
        .cabinet-container {
            background: var(--neutral-900);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }
        
        .cabinet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .cabinet-title {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: white;
        }
        
        .cabinet-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .cabinet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            grid-auto-rows: 100px;
            gap: 0.5rem;
            background: var(--neutral-800);
            padding: 1rem;
            border-radius: var(--radius-md);
            min-height: 600px;
        }
        
        .cabinet-item {
            border-radius: var(--radius-sm);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.75rem;
            text-align: center;
            padding: 0.5rem;
            overflow: hidden;
            border: 2px solid transparent;
            transition: all var(--transition-fast);
            cursor: pointer;
            position: relative;
        }
        
        .cabinet-item:hover {
            transform: scale(1.05);
            border-color: white;
            z-index: 10;
        }
        
        .cabinet-item.plc { background-color: var(--plc-color); }
        .cabinet-item.psu { background-color: var(--psu-color); }
        .cabinet-item.breaker { background-color: var(--breaker-color); }
        .cabinet-item.contactor { background-color: var(--contactor-color); }
        .cabinet-item.relay { background-color: var(--relay-color); }
        .cabinet-item.inverter { background-color: var(--inverter-color); }
        .cabinet-item.soft-starter { background-color: var(--softstarter-color); }
        .cabinet-item.hmi { background-color: var(--hmi-color); }
        .cabinet-item.terminal { background-color: var(--terminal-color); }
        
        .cabinet-item-details {
            font-size: 0.6rem;
            margin-top: 0.25rem;
            opacity: 0.9;
        }
        
        /* ===== BOM TABLE ===== */
        .bom-container {
            overflow-x: auto;
        }
        
        .bom-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .bom-table th {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-weight: 600;
            text-align: left;
            padding: 1rem;
            border-bottom: 2px solid var(--border-color);
            position: sticky;
            top: 0;
        }
        
        .bom-table td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
        }
        
        .bom-table tr:hover {
            background: var(--bg-tertiary);
        }
        
        .bom-table tr.selected {
            background: linear-gradient(90deg, rgba(33, 150, 243, 0.1), transparent);
        }
        
        .tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 500;
            margin: 0.125rem;
        }
        
        /* ===== CONTROL SCENARIO ===== */
        .scenario-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
        }
        
        .scenario-visualization {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            min-height: 400px;
            position: relative;
            overflow: hidden;
        }
        
        .scenario-controls {
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
        }
        
        .control-parameter {
            margin-bottom: 1.5rem;
        }
        
        .parameter-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }
        
        .parameter-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .parameter-value {
            font-weight: 700;
            color: var(--primary-500);
        }
        
        .parameter-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            background: var(--bg-secondary);
            border-radius: var(--radius-full);
            outline: none;
        }
        
        .parameter-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            background: var(--primary-500);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: var(--shadow-md);
        }
        
        /* ===== MODALS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            overflow: hidden;
            transform: translateY(20px);
            transition: transform var(--transition-normal);
            border: 1px solid var(--border-color);
        }
        
        .modal-overlay.active .modal-container {
            transform: translateY(0);
        }
        
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-tertiary);
        }
        
        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-full);
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }
        
        .modal-close:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }
        
        .modal-content {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(90vh - 100px);
        }
        
        /* ===== TABS ===== */
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }
        
        .tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            position: relative;
            transition: color var(--transition-fast);
        }
        
        .tab:hover {
            color: var(--text-primary);
        }
        
        .tab.active {
            color: var(--primary-500);
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-500);
            border-radius: var(--radius-full);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn var(--transition-normal);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* ===== CODE EDITOR ===== */
        .code-editor {
            background: #1e1e1e;
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        .code-header {
            background: #252526;
            padding: 0.75rem 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3e3e42;
        }
        
        .code-title {
            color: #cccccc;
            font-family: 'Consolas', monospace;
            font-size: 0.875rem;
        }
        
        .code-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .code-body {
            padding: 1rem;
            font-family: 'Consolas', monospace;
            color: #d4d4d4;
            font-size: 0.875rem;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .toast {
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 1rem;
            transform: translateX(100%);
            opacity: 0;
            transition: all var(--transition-normal);
        }
        
        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast-icon {
            font-size: 1.25rem;
        }
        
        .toast-success .toast-icon {
            color: var(--success);
        }
        
        .toast-error .toast-icon {
            color: var(--error);
        }
        
        .toast-warning .toast-icon {
            color: var(--warning);
        }
        
        .toast-info .toast-icon {
            color: var(--info);
        }
        
        .toast-message {
            flex: 1;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 1.25rem;
        }
        
        /* ===== LOADING STATES ===== */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-500);
            border-radius: var(--radius-full);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1200px) {
            .dashboard-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .component-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .scenario-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            :root {
                --header-height: 60px;
                --sidebar-width: 100%;
            }
            
            .sidebar {
                position: fixed;
                left: -100%;
                z-index: 100;
                transition: left var(--transition-normal);
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .component-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 0 1rem;
            }
            
            .content-area {
                padding: 1rem;
            }
            
            .action-buttons {
                display: none;
            }
            
            .mobile-actions {
                display: flex;
                gap: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            .section-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .component-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .component-details {
                grid-template-columns: 1fr;
            }
            
            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.75rem;
            }
        }
        
        /* ===== UTILITY CLASSES ===== */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-4 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .p-4 { padding: 1rem; }
        .text-center { text-align: center; }
        .text-sm { font-size: 0.875rem; }
        .text-lg { font-size: 1.125rem; }
        .font-bold { font-weight: 700; }
        .rounded { border-radius: var(--radius-md); }
        .shadow { box-shadow: var(--shadow-md); }
        
        /* ===== CUSTOM SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: var(--radius-full);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: var(--radius-full);
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-tertiary);
        }
        
        /* ===== ANIMATIONS ===== */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-10px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div x-data="plcDesigner()" x-init="init()" class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" :class="{ 'collapsed': sidebarCollapsed }" x-transition>
            <div class="sidebar-header">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-industry"></i>
                    </div>
                    <span class="logo-text" x-show="!sidebarCollapsed">PLC Designer</span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-item" :class="{ 'active': activeSection === 'dashboard' }" @click="activeSection = 'dashboard'">
                    <div class="nav-icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <span class="nav-text" x-show="!sidebarCollapsed">Dashboard</span>
                </div>
                
                <div class="nav-item" :class="{ 'active': activeSection === 'components' }" @click="activeSection = 'components'">
                    <div class="nav-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <span class="nav-text" x-show="!sidebarCollapsed">Components</span>
                </div>
                
                <div class="nav-item" :class="{ 'active': activeSection === 'layout' }" @click="activeSection = 'layout'">
                    <div class="nav-icon">
                        <i class="fas fa-th-large"></i>
                    </div>
                    <span class="nav-text" x-show="!sidebarCollapsed">Cabinet Layout</span>
                </div>
                
                <div class="nav-item" :class="{ 'active': activeSection === 'bom' }" @click="activeSection = 'bom'">
                    <div class="nav-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                    <span class="nav-text" x-show="!sidebarCollapsed">Bill of Materials</span>
                </div>
                
                <div class="nav-item" :class="{ 'active': activeSection === 'scenario' }" @click="activeSection = 'scenario'">
                    <div class="nav-icon">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                    <span class="nav-text" x-show="!sidebarCollapsed">Control Scenario</span>
                </div>
                
                <div class="nav-item" :class="{ 'active': activeSection === 'wiring' }" @click="activeSection = 'wiring'">
                    <div class="nav-icon">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <span class="nav-text" x-show="!sidebarCollapsed">Wiring Diagram</span>
                </div>
                
                <div class="nav-item" :class="{ 'active': activeSection === 'code' }" @click="activeSection = 'code'">
                    <div class="nav-icon">
                        <i class="fas fa-code"></i>
                    </div>
                    <span class="nav-text" x-show="!sidebarCollapsed">Code Generator</span>
                </div>
            </nav>
            
            <div class="sidebar-footer">
                <button class="btn btn-secondary btn-sm" @click="toggleSidebar">
                    <i class="fas" :class="sidebarCollapsed ? 'fa-chevron-right' : 'fa-chevron-left'"></i>
                    <span x-show="!sidebarCollapsed">Collapse</span>
                </button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <button class="sidebar-toggle" @click="toggleSidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" x-text="getPageTitle()"></h1>
                </div>
                
                <div class="header-right">
                    <div class="action-buttons">
                        <button class="btn btn-primary" @click="saveProject">
                            <i class="fas fa-save"></i> Save Project
                        </button>
                        <button class="btn btn-secondary" @click="loadProject">
                            <i class="fas fa-folder-open"></i> Load
                        </button>
                        <button class="btn btn-success" @click="exportBOM">
                            <i class="fas fa-file-export"></i> Export BOM
                        </button>
                        <button class="btn btn-warning" @click="showModal('scenarios')">
                            <i class="fas fa-cogs"></i> Scenarios
                        </button>
                        <button class="btn btn-info" @click="showModal('code')">
                            <i class="fas fa-code"></i> Code
                        </button>
                    </div>
                    
                    <div class="mobile-actions hidden">
                        <button class="btn btn-icon btn-primary" @click="saveProject">
                            <i class="fas fa-save"></i>
                        </button>
                        <button class="btn btn-icon btn-secondary" @click="showModal('menu')">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Content Area -->
            <main class="content-area" @scroll="handleScroll">
                <!-- Dashboard Section -->
                <section x-show="activeSection === 'dashboard'" x-transition>
                    <div class="dashboard-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-value" x-text="stats.totalComponents"></div>
                                    <div class="stat-label">Total Components</div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-cube"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-arrow-up"></i> 12% from last design
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-value" x-text="stats.totalCost + ' â‚¬'"></div>
                                    <div class="stat-label">Estimated Cost</div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-euro-sign"></i>
                                </div>
                            </div>
                            <div class="stat-change negative">
                                <i class="fas fa-arrow-down"></i> 8% under budget
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-value" x-text="stats.ioPoints"></div>
                                    <div class="stat-label">I/O Points</div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-microchip"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-check"></i> PLC compatible
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-header">
                                <div>
                                    <div class="stat-value" x-text="stats.energySavings + '%'"></div>
                                    <div class="stat-label">Energy Savings</div>
                                </div>
                                <div class="stat-icon">
                                    <i class="fas fa-leaf"></i>
                                </div>
                            </div>
                            <div class="stat-change positive">
                                <i class="fas fa-bolt"></i> Optimized
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="section-card">
                        <div class="section-header">
                            <h3 class="section-title">
                                <i class="fas fa-bolt section-icon"></i>
                                Quick Actions
                            </h3>
                        </div>
                        <div class="section-content">
                            <div class="flex gap-4 mb-4">
                                <button class="btn btn-primary" @click="activeSection = 'components'">
                                    <i class="fas fa-plus"></i> Add Components
                                </button>
                                <button class="btn btn-secondary" @click="generateLayout">
                                    <i class="fas fa-sync-alt"></i> Regenerate Layout
                                </button>
                                <button class="btn btn-success" @click="calculateBOM">
                                    <i class="fas fa-calculator"></i> Calculate BOM
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recent Projects -->
                    <div class="section-card">
                        <div class="section-header">
                            <h3 class="section-title">
                                <i class="fas fa-history section-icon"></i>
                                Recent Projects
                            </h3>
                        </div>
                        <div class="section-content">
                            <div class="bom-table">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Project Name</th>
                                            <th>Last Modified</th>
                                            <th>Components</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="project in recentProjects" :key="project.id">
                                            <tr>
                                                <td x-text="project.name"></td>
                                                <td x-text="formatDate(project.modified)"></td>
                                                <td x-text="project.components"></td>
                                                <td>
                                                    <span class="tag" :class="{
                                                        'bg-green-100 text-green-800': project.status === 'complete',
                                                        'bg-yellow-100 text-yellow-800': project.status === 'in-progress',
                                                        'bg-blue-100 text-blue-800': project.status === 'draft'
                                                    }" x-text="project.status"></span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-secondary" @click="loadProjectFromList(project)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Components Section -->
                <section x-show="activeSection === 'components'" x-transition>
                    <!-- Motors Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <h3 class="section-title">
                                <i class="fas fa-cogs section-icon"></i>
                                3-Phase Motors
                            </h3>
                            <div class="flex gap-2">
                                <button class="btn btn-sm btn-secondary" @click="resetMotors">
                                    <i class="fas fa-undo"></i> Reset
                                </button>
                                <button class="btn btn-sm btn-primary" @click="addMotor">
                                    <i class="fas fa-plus"></i> Add Motor
                                </button>
                            </div>
                        </div>
                        <div class="section-content">
                            <div class="component-grid">
                                <template x-for="(motor, index) in motors" :key="motor.id">
                                    <div class="component-card">
                                        <div class="component-header">
                                            <h4 class="component-name" x-text="motor.name"></h4>
                                            <span class="component-badge" :class="{
                                                'bg-red-500': parseFloat(motor.power) > 5,
                                                'bg-blue-500': parseFloat(motor.power) <= 5
                                            }" x-text="motor.power + 'kW'"></span>
                                        </div>
                                        
                                        <div class="component-controls">
                                            <div class="quantity-control">
                                                <button class="qty-btn" @click="decrementQuantity(motor)">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <span class="qty-display" x-text="motor.quantity"></span>
                                                <button class="qty-btn" @click="incrementQuantity(motor)">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                            <span class="text-sm text-gray-500">
                                                Default: <span x-text="motor.defaultQuantity"></span>
                                            </span>
                                        </div>
                                        
                                        <div class="component-details">
                                            <div class="detail-item">
                                                <span class="detail-label">Power Rating</span>
                                                <input type="text" class="detail-input" 
                                                       x-model="motor.power" 
                                                       @change="calculateBOM"
                                                       placeholder="kW">
                                            </div>
                                            <div class="detail-item">
                                                <span class="detail-label">Voltage</span>
                                                <div class="detail-value" x-text="motor.voltage"></div>
                                            </div>
                                            <div class="detail-item">
                                                <span class="detail-label">Current</span>
                                                <div class="detail-value" x-text="calculateMotorCurrent(motor) + 'A'"></div>
                                            </div>
                                        </div>
                                        
                                        <div class="component-options" x-show="motor.hasOver5kw">
                                            <div class="checkbox-group">
                                                <label class="switch">
                                                    <input type="checkbox" x-model="useSoftStarter">
                                                    <span class="slider"></span>
                                                </label>
                                                <span class="checkbox-label">Use Soft Starter</span>
                                            </div>
                                        </div>
                                        
                                        <button class="btn btn-sm btn-error w-full mt-4" @click="removeMotor(index)">
                                            <i class="fas fa-trash"></i> Remove
                                        </button>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actuators Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <h3 class="section-title">
                                <i class="fas fa-sliders-h section-icon"></i>
                                Actuators
                            </h3>
                        </div>
                        <div class="section-content">
                            <div class="component-grid">
                                <template x-for="(actuator, index) in actuators" :key="actuator.id">
                                    <div class="component-card">
                                        <div class="component-header">
                                            <h4 class="component-name" x-text="actuator.name"></h4>
                                            <span class="component-badge bg-purple-500" x-text="actuator.voltage"></span>
                                        </div>
                                        
                                        <div class="component-controls">
                                            <div class="quantity-control">
                                                <button class="qty-btn" @click="decrementQuantity(actuator)">
                                                    <i class="fas fa-minus"></i>
                                                </button>
                                                <span class="qty-display" x-text="actuator.quantity"></span>
                                                <button class="qty-btn" @click="incrementQuantity(actuator)">
                                                    <i class="fas fa-plus"></i>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div class="component-details">
                                            <div class="detail-item">
                                                <span class="detail-label">Voltage</span>
                                                <input type="text" class="detail-input" 
                                                       x-model="actuator.voltage"
                                                       @change="calculateBOM">
                                            </div>
                                            <div class="detail-item">
                                                <span class="detail-label">Positioner</span>
                                                <div class="checkbox-group">
                                                    <label class="switch">
                                                        <input type="checkbox" x-model="actuator.hasPositioner">
                                                        <span class="slider"></span>
                                                    </label>
                                                    <span class="checkbox-label">Has Positioner</span>
                                                </div>
                                            </div>
                                            <div class="detail-item" x-show="actuator.hasPositioner">
                                                <span class="detail-label">Position Feedback</span>
                                                <div class="checkbox-group">
                                                    <label class="switch">
                                                        <input type="checkbox" x-model="actuator.readPosition">
                                                        <span class="slider"></span>
                                                    </label>
                                                    <span class="checkbox-label">Read Position</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Cabinet Layout Section -->
                <section x-show="activeSection === 'layout'" x-transition>
                    <div class="section-card">
                        <div class="section-header">
                            <h3 class="section-title">
                                <i class="fas fa-th-large section-icon"></i>
                                Cabinet Layout
                            </h3>
                            <div class="cabinet-actions">
                                <button class="btn btn-sm btn-secondary" @click="generateLayout">
                                    <i class="fas fa-sync-alt"></i> Regenerate
                                </button>
                                <button class="btn btn-sm btn-primary" @click="exportLayoutImage">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                        <div class="section-content">
                            <!-- Color Legend -->
                            <div class="flex flex-wrap gap-4 mb-6 p-4 bg-gray-800 rounded-lg">
                                <template x-for="legend in colorLegends" :key="legend.type">
                                    <div class="flex items-center gap-2">
                                        <div class="w-4 h-4 rounded" :style="`background-color: ${legend.color};`"></div>
                                        <span class="text-sm text-white" x-text="legend.label"></span>
                                    </div>
                                </template>
                            </div>
                            
                            <!-- Cabinet Grid -->
                            <div class="cabinet-container">
                                <div class="cabinet-grid" id="cabinetGrid">
                                    <template x-for="(component, index) in layoutComponents" :key="index">
                                        <div class="cabinet-item" 
                                             :class="component.type"
                                             :style="`grid-column: span ${Math.ceil(component.width / 16)}; grid-row: span ${Math.ceil(component.height / 20)};`"
                                             @click="selectLayoutComponent(component)"
                                             :title="component.tag">
                                            <div x-text="component.tag"></div>
                                            <div class="cabinet-item-details" x-text="component.details"></div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                            
                            <!-- Layout Statistics -->
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                                <div class="stat-card">
                                    <div class="stat-header">
                                        <div>
                                            <div class="stat-value" x-text="cabinetStats.totalComponents"></div>
                                            <div class="stat-label">Total Components</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-header">
                                        <div>
                                            <div class="stat-value" x-text="cabinetStats.cabinetSize"></div>
                                            <div class="stat-label">Cabinet Size</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-header">
                                        <div>
                                            <div class="stat-value" x-text="cabinetStats.utilization + '%'"></div>
                                            <div class="stat-label">Utilization</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-header">
                                        <div>
                                            <div class="stat-value" x-text="cabinetStats.wireLength + 'm'"></div>
                                            <div class="stat-label">Wire Length</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- BOM Section -->
                <section x-show="activeSection === 'bom'" x-transition>
                    <div class="section-card">
                        <div class="section-header">
                            <h3 class="section-title">
                                <i class="fas fa-clipboard-list section-icon"></i>
                                Bill of Materials
                            </h3>
                            <div class="flex gap-2">
                                <button class="btn btn-sm btn-secondary" @click="calculateBOM">
                                    <i class="fas fa-calculator"></i> Calculate
                                </button>
                                <button class="btn btn-sm btn-primary" @click="exportBOM">
                                    <i class="fas fa-file-export"></i> Export
                                </button>
                                <button class="btn btn-sm btn-success" @click="showModal('cost')">
                                    <i class="fas fa-euro-sign"></i> Cost Analysis
                                </button>
                            </div>
                        </div>
                        <div class="section-content">
                            <div class="bom-container">
                                <table class="bom-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Component</th>
                                            <th>Quantity</th>
                                            <th>Specifications</th>
                                            <th>Standards</th>
                                            <th>Unit Cost (â‚¬)</th>
                                            <th>Total Cost (â‚¬)</th>
                                            <th>Tags</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <template x-for="(item, index) in bom" :key="item.id">
                                            <tr @click="selectBOMItem(item)" 
                                                :class="{ 'selected': selectedBOMItem === item.id }">
                                                <td x-text="index + 1"></td>
                                                <td x-text="item.name"></td>
                                                <td>
                                                    <div class="flex items-center gap-2">
                                                        <span x-text="item.quantity"></span>
                                                        <button class="btn btn-sm btn-secondary" @click="editBOMQuantity(item)">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                                <td x-text="item.specifications"></td>
                                                <td x-text="item.standards"></td>
                                                <td x-text="formatCurrency(item.unitCost)"></td>
                                                <td x-text="formatCurrency(item.totalCost)"></td>
                                                <td>
                                                    <template x-for="tag in item.tags" :key="tag">
                                                        <span class="tag" x-text="tag"></span>
                                                    </template>
                                                </td>
                                            </tr>
                                        </template>
                                    </tbody>
                                    <tfoot>
                                        <tr class="font-bold">
                                            <td colspan="5">Total</td>
                                            <td x-text="formatCurrency(bomTotal)"></td>
                                            <td x-text="formatCurrency(bomTotalCost)"></td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </section>
                
                <!-- Control Scenario Section -->
                <section x-show="activeSection === 'scenario'" x-transition>
                    <div class="section-card">
                        <div class="section-header">
                            <h3 class="section-title">
                                <i class="fas fa-project-diagram section-icon"></i>
                                Control Scenario Visualization
                            </h3>
                            <div class="flex gap-2">
                                <button class="btn btn-sm btn-primary" @click="runSimulation">
                                    <i class="fas fa-play"></i> Run Simulation
                                </button>
                                <button class="btn btn-sm btn-secondary" @click="resetScenario">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </div>
                        <div class="section-content">
                            <div class="scenario-container">
                                <!-- Visualization Canvas -->
                                <div class="scenario-visualization" id="scenarioCanvas">
                                    <!-- This will be populated dynamically -->
                                </div>
                                
                                <!-- Control Panel -->
                                <div class="scenario-controls">
                                    <h4 class="font-bold mb-4">Control Parameters</h4>
                                    
                                    <div class="control-parameter">
                                        <div class="parameter-label">
                                            <span class="parameter-name">Fresh Air %</span>
                                            <span class="parameter-value" x-text="scenario.freshAirPercent + '%'"></span>
                                        </div>
                                        <input type="range" class="parameter-slider" 
                                               min="0" max="100" 
                                               x-model="scenario.freshAirPercent"
                                               @input="updateScenario">
                                    </div>
                                    
                                    <div class="control-parameter">
                                        <div class="parameter-label">
                                            <span class="parameter-name">Target Temperature</span>
                                            <span class="parameter-value" x-text="scenario.targetTemp + 'Â°C'"></span>
                                        </div>
                                        <input type="range" class="parameter-slider" 
                                               min="15" max="35" step="0.5"
                                               x-model="scenario.targetTemp"
                                               @input="updateScenario">
                                    </div>
                                    
                                    <div class="control-parameter">
                                        <div class="parameter-label">
                                            <span class="parameter-name">Target Humidity</span>
                                            <span class="parameter-value" x-text="scenario.targetHumidity + '%'"></span>
                                        </div>
                                        <input type="range" class="parameter-slider" 
                                               min="30" max="80"
                                               x-model="scenario.targetHumidity"
                                               @input="updateScenario">
                                    </div>
                                    
                                    <div class="control-parameter">
                                        <div class="checkbox-group">
                                            <label class="switch">
                                                <input type="checkbox" x-model="scenario.heatingEnabled">
                                                <span class="slider"></span>
                                            </label>
                                            <span class="checkbox-label">Enable Heating</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-6 p-4 bg-gray-800 rounded-lg">
                                        <h5 class="font-bold text-white mb-2">Current Status</h5>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div class="text-sm">
                                                <div class="text-gray-400">Outside Temp</div>
                                                <div class="text-white font-bold" x-text="scenario.outsideTemp + 'Â°C'"></div>
                                            </div>
                                            <div class="text-sm">
                                                <div class="text-gray-400">Outside Humidity</div>
                                                <div class="text-white font-bold" x-text="scenario.outsideHumidity + '%'"></div>
                                            </div>
                                            <div class="text-sm">
                                                <div class="text-gray-400">Inside Temp</div>
                                                <div class="text-white font-bold" x-text="scenario.insideTemp + 'Â°C'"></div>
                                            </div>
                                            <div class="text-sm">
                                                <div class="text-gray-400">Inside Humidity</div>
                                                <div class="text-white font-bold" x-text="scenario.insideHumidity + '%'"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </main>
        </div>
        
        <!-- Toast Notifications -->
        <div class="toast-container">
            <template x-for="toast in toasts" :key="toast.id">
                <div class="toast" :class="'toast-' + toast.type" x-show="toast.visible" x-transition>
                    <div class="toast-icon">
                        <i class="fas" :class="{
                            'fa-check-circle': toast.type === 'success',
                            'fa-exclamation-circle': toast.type === 'error',
                            'fa-exclamation-triangle': toast.type === 'warning',
                            'fa-info-circle': toast.type === 'info'
                        }"></i>
                    </div>
                    <div class="toast-message" x-text="toast.message"></div>
                    <button class="toast-close" @click="hideToast(toast.id)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </template>
        </div>
        
        <!-- Modals -->
        <div class="modal-overlay" :class="{ 'active': activeModal }" @click.self="closeModal">
            <!-- Code Generator Modal -->
            <div class="modal-container" x-show="activeModal === 'code'">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-code"></i>
                        PLC Code Generator
                    </h3>
                    <button class="modal-close" @click="closeModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="tabs">
                        <button class="tab" :class="{ 'active': activeCodeTab === 'ladder' }" 
                                @click="activeCodeTab = 'ladder'">
                            Ladder Logic
                        </button>
                        <button class="tab" :class="{ 'active': activeCodeTab === 'st' }" 
                                @click="activeCodeTab = 'st'">
                            Structured Text
                        </button>
                        <button class="tab" :class="{ 'active': activeCodeTab === 'fbd' }" 
                                @click="activeCodeTab = 'fbd'">
                            Function Block
                        </button>
                        <button class="tab" :class="{ 'active': activeCodeTab === 'python' }" 
                                @click="activeCodeTab = 'python'">
                            Python Simulation
                        </button>
                    </div>
                    
                    <div class="tab-content" :class="{ 'active': activeCodeTab === 'ladder' }">
                        <div class="code-editor">
                            <div class="code-header">
                                <div class="code-title">Ladder Logic (IEC 61131-3)</div>
                                <div class="code-actions">
                                    <button class="btn btn-sm btn-primary" @click="copyCode('ladder')">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                    <button class="btn btn-sm btn-secondary" @click="downloadCode('ladder')">
                                        <i class="fas fa-download"></i> Download
                                    </button>
                                </div>
                            </div>
                            <div class="code-body">
                                <pre x-text="generatedCode.ladder"></pre>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" :class="{ 'active': activeCodeTab === 'st' }">
                        <div class="code-editor">
                            <div class="code-header">
                                <div class="code-title">Structured Text Program</div>
                                <div class="code-actions">
                                    <button class="btn btn-sm btn-primary" @click="copyCode('st')">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                    <button class="btn btn-sm btn-secondary" @click="downloadCode('st')">
                                        <i class="fas fa-download"></i> Download
                                    </button>
                                </div>
                            </div>
                            <div class="code-body">
                                <pre x-text="generatedCode.st"></pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scenarios Modal -->
            <div class="modal-container" x-show="activeModal === 'scenarios'">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-cogs"></i>
                        Control Scenarios
                    </h3>
                    <button class="modal-close" @click="closeModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-content">
                    <div class="tabs">
                        <button class="tab" :class="{ 'active': activeScenarioTab === 'modes' }" 
                                @click="activeScenarioTab = 'modes'">
                            Operating Modes
                        </button>
                        <button class="tab" :class="{ 'active': activeScenarioTab === 'sequences' }" 
                                @click="activeScenarioTab = 'sequences'">
                            Sequences
                        </button>
                        <button class="tab" :class="{ 'active': activeScenarioTab === 'faults' }" 
                                @click="activeScenarioTab = 'faults'">
                            Fault Handling
                        </button>
                    </div>
                    
                    <div class="tab-content" :class="{ 'active': activeScenarioTab === 'modes' }">
                        <div class="space-y-4">
                            <div class="p-4 bg-gray-800 rounded-lg">
                                <h4 class="font-bold text-white mb-2">Select Operating Mode</h4>
                                <select class="w-full p-2 rounded bg-gray-700 text-white" 
                                        x-model="selectedMode"
                                        @change="loadScenarioMode">
                                    <option value="auto">Automatic Mode</option>
                                    <option value="manual">Manual Mode</option>
                                    <option value="economy">Economy Mode</option>
                                    <option value="summer">Summer Mode</option>
                                    <option value="winter">Winter Mode</option>
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <template x-for="param in modeParameters" :key="param.id">
                                    <div class="p-4 bg-gray-800 rounded-lg">
                                        <div class="parameter-label mb-2">
                                            <span class="parameter-name text-white" x-text="param.label"></span>
                                            <span class="parameter-value" x-text="param.value + (param.unit || '')"></span>
                                        </div>
                                        <input type="range" class="parameter-slider" 
                                               :min="param.min" :max="param.max" :step="param.step"
                                               x-model="param.value"
                                               @input="updateModeParameters">
                                    </div>
                                </template>
                            </div>
                            
                            <button class="btn btn-primary w-full" @click="applyScenarioMode">
                                <i class="fas fa-play-circle"></i> Apply Selected Mode
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- File Input (Hidden) -->
        <input type="file" id="fileInput" accept=".json" style="display: none;" @change="loadProjectFromFile($event)">
    </div>

    <script>
        // Main Application Controller
        function plcDesigner() {
            return {
                // Application State
                activeSection: 'dashboard',
                activeModal: null,
                activeCodeTab: 'ladder',
                activeScenarioTab: 'modes',
                sidebarCollapsed: false,
                
                // Data Models
                motors: [
                    { 
                        id: 1, 
                        name: 'Fan Feed Motor', 
                        quantity: 2, 
                        defaultQuantity: 2, 
                        power: '22', 
                        voltage: '400V AC',
                        hasOver5kw: true 
                    },
                    { 
                        id: 2, 
                        name: 'Fan Return Motor', 
                        quantity: 2, 
                        defaultQuantity: 2, 
                        power: '30', 
                        voltage: '400V AC',
                        hasOver5kw: true 
                    },
                    { 
                        id: 3, 
                        name: 'Dust Fan Motor', 
                        quantity: 4, 
                        defaultQuantity: 4, 
                        power: '3.3', 
                        voltage: '400V AC',
                        hasOver5kw: false 
                    }
                ],
                
                actuators: [
                    {
                        id: 1,
                        name: 'Damper Fresh',
                        quantity: 2,
                        defaultQuantity: 2,
                        voltage: '24V DC',
                        hasPositioner: true,
                        readPosition: true
                    },
                    {
                        id: 2,
                        name: 'Damper Exhaust',
                        quantity: 2,
                        defaultQuantity: 2,
                        voltage: '24V DC',
                        hasPositioner: true,
                        readPosition: true
                    }
                ],
                
                sensors: [
                    {
                        id: 1,
                        name: 'Temperature Sensor',
                        quantity: 2,
                        defaultQuantity: 2,
                        type: 'Analog 4-20mA'
                    },
                    {
                        id: 2,
                        name: 'Humidity Sensor',
                        quantity: 2,
                        defaultQuantity: 2,
                        type: 'Analog 4-20mA'
                    }
                ],
                
                // Configuration
                useSoftStarter: true,
                useInverter: false,
                
                // Scenario Data
                scenario: {
                    freshAirPercent: 30,
                    targetTemp: 24,
                    targetHumidity: 55,
                    heatingEnabled: true,
                    outsideTemp: 28,
                    outsideHumidity: 40,
                    insideTemp: 26,
                    insideHumidity: 60,
                    pidKp: 1.5,
                    pidKi: 0.1,
                    pidKd: 0.05
                },
                
                selectedMode: 'auto',
                selectedFault: '',
                
                modeParameters: [
                    { id: 1, label: 'Temperature Setpoint', min: 18, max: 30, step: 0.5, value: 24, unit: 'Â°C' },
                    { id: 2, label: 'Humidity Setpoint', min: 30, max: 70, step: 1, value: 55, unit: '%' },
                    { id: 3, label: 'Fresh Air Minimum', min: 10, max: 100, step: 5, value: 20, unit: '%' }
                ],
                
                // Generated Data
                generatedCode: {
                    ladder: '',
                    st: '',
                    fbd: '',
                    python: ''
                },
                
                bom: [],
                layoutComponents: [],
                
                // Statistics
                stats: {
                    totalComponents: 0,
                    totalCost: 0,
                    ioPoints: 0,
                    energySavings: 0
                },
                
                cabinetStats: {
                    totalComponents: 0,
                    cabinetSize: '800x600x200mm',
                    utilization: 0,
                    wireLength: 0
                },
                
                // UI State
                toasts: [],
                selectedBOMItem: null,
                recentProjects: [],
                
                // Color Legends for Layout
                colorLegends: [
                    { type: 'plc', label: 'PLC & Modules', color: '#2196f3' },
                    { type: 'psu', label: 'Power Supply', color: '#9c27b0' },
                    { type: 'breaker', label: 'Breakers', color: '#f44336' },
                    { type: 'contactor', label: 'Contactors', color: '#4caf50' },
                    { type: 'relay', label: 'Relays', color: '#ff9800' },
                    { type: 'inverter', label: 'VFD Inverter', color: '#00bcd4' },
                    { type: 'soft-starter', label: 'Soft Starter', color: '#795548' },
                    { type: 'hmi', label: 'HMI Panel', color: '#607d8b' },
                    { type: 'terminal', label: 'Terminal Blocks', color: '#9e9e9e' }
                ],
                
                // Computed Properties
                get bomTotal() {
                    return this.bom.reduce((sum, item) => sum + item.quantity, 0);
                },
                
                get bomTotalCost() {
                    return this.bom.reduce((sum, item) => sum + (item.totalCost || 0), 0);
                },
                
                getPageTitle() {
                    const titles = {
                        'dashboard': 'Dashboard',
                        'components': 'Component Configuration',
                        'layout': 'Cabinet Layout',
                        'bom': 'Bill of Materials',
                        'scenario': 'Control Scenario',
                        'wiring': 'Wiring Diagram',
                        'code': 'Code Generator'
                    };
                    return titles[this.activeSection] || 'PLC Panel Designer';
                },
                
                // Initialization
                init() {
                    this.calculateBOM();
                    this.generateLayout();
                    this.generateAllCode();
                    this.loadRecentProjects();
                    this.showToast('Welcome to PLC Panel Designer!', 'success');
                    
                    // Initialize scenario visualization
                    this.$nextTick(() => {
                        this.initScenarioVisualization();
                    });
                },
                
                // Component Management
                incrementQuantity(component) {
                    component.quantity++;
                    this.calculateBOM();
                    this.generateLayout();
                    this.showToast(`${component.name} quantity increased to ${component.quantity}`, 'info');
                },
                
                decrementQuantity(component) {
                    if (component.quantity > 0) {
                        component.quantity--;
                        this.calculateBOM();
                        this.generateLayout();
                        this.showToast(`${component.name} quantity decreased to ${component.quantity}`, 'info');
                    }
                },
                
                addMotor() {
                    const newId = Math.max(...this.motors.map(m => m.id)) + 1;
                    this.motors.push({
                        id: newId,
                        name: 'New Motor',
                        quantity: 1,
                        defaultQuantity: 1,
                        power: '5',
                        voltage: '400V AC',
                        hasOver5kw: false
                    });
                    this.showToast('New motor added', 'success');
                },
                
                removeMotor(index) {
                    const motor = this.motors[index];
                    this.motors.splice(index, 1);
                    this.calculateBOM();
                    this.generateLayout();
                    this.showToast(`${motor.name} removed`, 'warning');
                },
                
                resetMotors() {
                    this.motors.forEach(motor => {
                        motor.quantity = motor.defaultQuantity;
                        motor.power = motor.power.includes('.') ? parseFloat(motor.power).toString() : motor.power;
                    });
                    this.calculateBOM();
                    this.generateLayout();
                    this.showToast('Motors reset to default values', 'info');
                },
                
                calculateMotorCurrent(motor) {
                    const power = parseFloat(motor.power) || 0;
                    // Simplified calculation: I = P / (âˆš3 * V * pf)
                    const current = power * 1000 / (1.732 * 400 * 0.85);
                    return Math.round(current);
                },
                
                // BOM Calculation
                calculateBOM() {
                    console.log('Calculating BOM...');
                    const bom = [];
                    
                    // Calculate total motor power
                    let totalMotorPower = 0;
                    let largestMotorPower = 0;
                    
                    this.motors.forEach(motor => {
                        const power = parseFloat(motor.power) || 0;
                        totalMotorPower += power * motor.quantity;
                        if (power > largestMotorPower) largestMotorPower = power;
                    });
                    
                    // Add motors to BOM
                    this.motors.forEach(motor => {
                        if (motor.quantity > 0) {
                            const power = parseFloat(motor.power) || 0;
                            
                            bom.push({
                                id: `motor-${motor.id}`,
                                name: motor.name,
                                quantity: motor.quantity,
                                specifications: `${motor.power}kW, ${motor.voltage}`,
                                standards: 'IEC 60034, IP55',
                                unitCost: power * 150, // Simplified cost calculation
                                totalCost: power * 150 * motor.quantity,
                                tags: [`M${motor.id}`, `${motor.power}kW`]
                            });
                            
                            // Add contactors for motors
                            let contactorCost = 0;
                            if (power > 15) contactorCost = 250;
                            else if (power > 5) contactorCost = 150;
                            else contactorCost = 80;
                            
                            bom.push({
                                id: `contactor-${motor.id}`,
                                name: 'Contactor',
                                quantity: motor.quantity,
                                specifications: `For ${motor.power}kW motor, 400V AC`,
                                standards: 'IEC 60947-4-1',
                                unitCost: contactorCost,
                                totalCost: contactorCost * motor.quantity,
                                tags: [`KM${motor.id}`]
                            });
                            
                            // Add overload protection for motors > 5kW
                            if (power > 5) {
                                bom.push({
                                    id: `overload-${motor.id}`,
                                    name: 'Overload Relay',
                                    quantity: motor.quantity,
                                    specifications: `For ${motor.power}kW motor`,
                                    standards: 'IEC 60947-4-1',
                                    unitCost: 120,
                                    totalCost: 120 * motor.quantity,
                                    tags: [`F${motor.id}`]
                                });
                            }
                        }
                    });
                    
                    // Add PLC system
                    bom.push({
                        id: 'plc-cpu',
                        name: 'PLC CPU',
                        quantity: 1,
                        specifications: 'Siemens S7-1200, 24DI/16DO/4AI',
                        standards: 'IEC 61131',
                        unitCost: 850,
                        totalCost: 850,
                        tags: ['CPU1214C']
                    });
                    
                    // Add power supply
                    bom.push({
                        id: 'psu',
                        name: 'Power Supply',
                        quantity: 1,
                        specifications: '24V DC, 5A',
                        standards: 'IEC 61010',
                        unitCost: 120,
                        totalCost: 120,
                        tags: ['PS1']
                    });
                    
                    // Add main circuit breaker
                    bom.push({
                        id: 'main-breaker',
                        name: 'Main Circuit Breaker',
                        quantity: 1,
                        specifications: '100A, 4P',
                        standards: 'IEC 60947-2',
                        unitCost: 180,
                        totalCost: 180,
                        tags: ['Q0']
                    });
                    
                    // Update statistics
                    this.stats.totalComponents = bom.reduce((sum, item) => sum + item.quantity, 0);
                    this.stats.totalCost = bom.reduce((sum, item) => sum + item.totalCost, 0);
                    this.stats.ioPoints = 24 + 16 + 4; // Based on PLC specs
                    this.stats.energySavings = Math.round((largestMotorPower / totalMotorPower) * 30); // Simplified calculation
                    
                    this.bom = bom;
                    this.showToast('BOM calculated successfully', 'success');
                },
                
                // Layout Generation
                generateLayout() {
                    console.log('Generating layout...');
                    const layout = [];
                    let x = 1, y = 1;
                    
                    // Add PLC (2x2 grid cells)
                    layout.push({
                        type: 'plc',
                        tag: 'PLC',
                        details: 'S7-1200',
                        width: 32,
                        height: 40,
                        x: x,
                        y: y
                    });
                    
                    x += 2;
                    
                    // Add Power Supply
                    layout.push({
                        type: 'psu',
                        tag: 'PSU',
                        details: '24V/5A',
                        width: 32,
                        height: 40,
                        x: x,
                        y: y
                    });
                    
                    x = 1;
                    y += 2;
                    
                    // Add Main Breaker
                    layout.push({
                        type: 'breaker',
                        tag: 'Q0',
                        details: '100A',
                        width: 32,
                        height: 40,
                        x: x,
                        y: y
                    });
                    
                    x += 2;
                    
                    // Add Contactors for each motor
                    let contactorIndex = 1;
                    this.motors.forEach(motor => {
                        for (let i = 0; i < motor.quantity; i++) {
                            layout.push({
                                type: 'contactor',
                                tag: `KM${contactorIndex}`,
                                details: `${motor.power}kW`,
                                width: 32,
                                height: 40,
                                x: x,
                                y: y
                            });
                            
                            x += 2;
                            if (x > 10) {
                                x = 1;
                                y += 2;
                            }
                            contactorIndex++;
                        }
                    });
                    
                    // Add relays for actuators
                    let relayIndex = 1;
                    this.actuators.forEach(actuator => {
                        for (let i = 0; i < actuator.quantity; i++) {
                            layout.push({
                                type: 'relay',
                                tag: `K${relayIndex}`,
                                details: actuator.voltage,
                                width: 16,
                                height: 20,
                                x: x,
                                y: y
                            });
                            
                            x += 1;
                            if (x > 12) {
                                x = 1;
                                y += 1;
                            }
                            relayIndex++;
                        }
                    });
                    
                    // Update cabinet statistics
                    this.cabinetStats.totalComponents = layout.length;
                    this.cabinetStats.utilization = Math.round((layout.length / 48) * 100);
                    this.cabinetStats.wireLength = Math.round(layout.length * 2.5);
                    
                    this.layoutComponents = layout;
                    this.showToast('Layout generated successfully', 'success');
                },
                
                // Code Generation
                generateAllCode() {
                    this.generateLadderLogic();
                    this.generateStructuredText();
                    this.generateFunctionBlock();
                    this.generatePythonCode();
                },
                
                generateLadderLogic() {
                    this.generatedCode.ladder = `// PLC Ladder Logic - Evaporative Ventilation System
// Generated: ${new Date().toISOString().split('T')[0]}
// Project: Textile Evaporative Cooling

NETWORK 1: System Enable Circuit
|   I0.0         I0.1         I0.2         Q0.0
|----| |---------| |----------|/|----------( )----|
|   START       STOP        EMERGENCY    SYS_ENABLE
|
|   Q0.0
|----| |----------------------------------( )----|
| SYS_ENABLE                            SYS_ENABLE

NETWORK 2: Main Fan Control
|   Q0.0         I0.3         I0.4         Q0.1
|----| |---------| |----------|/|----------( )----|
| SYS_ENABLE   TEMP_OK     OVERLOAD    FAN_FEED
|
|   Q0.1         T0
|----| |----------------------------------(TON)----|
| FAN_FEED                                 T#5s

NETWORK 3: Temperature Control
|   Q0.0        AIW2        MD0         PID0
|----| |---------[SUB_R]-----[PID]-------( )----|
| SYS_ENABLE   ACT_TEMP   SET_TEMP    TEMP_CTRL
|
|   PID0        AQW0
|----| |---------[MOV_R]----------------------|
| TEMP_CTRL    HEAT_VALVE

NETWORK 4: Humidity Control
|   Q0.0        AIW4        MD4         PID1
|----| |---------[SUB_R]-----[PID]-------( )----|
| SYS_ENABLE   ACT_HUM    SET_HUM     HUM_CTRL
|
|   PID1        AQW2
|----| |---------[MOV_R]----------------------|
| HUM_CTRL     STEAM_VALVE

NETWORK 5: Damper Control
|   Q0.0         I1.0         Q1.0
|----| |---------| |----------( )----|
| SYS_ENABLE   AUTO_MODE   DMP_FRESH
|
|   Q1.0        AIW0        MW0         Q1.1
|----| |---------[>=R]-------[MOV_R]------( )----|
| DMP_FRESH     ACT_POS    SET_POS      DMP_CTRL

// I/O Address Mapping:
// I0.0 - Start Button
// I0.1 - Stop Button
// I0.2 - Emergency Stop
// I0.3 - Temperature OK
// I0.4 - Motor Overload
// I1.0 - Auto Mode Selector
// Q0.0 - System Enable
// Q0.1 - Fan Feed Motor
// Q1.0 - Fresh Damper Enable
// Q1.1 - Damper Control Output
// AIW0 - Damper Position Feedback
// AIW2 - Actual Temperature (4-20mA)
// AIW4 - Actual Humidity (4-20mA)
// AQW0 - Heating Valve Output (0-100%)
// AQW2 - Steam Valve Output (0-100%)
// MD0 - Temperature Setpoint
// MD4 - Humidity Setpoint`;
                },
                
                generateStructuredText() {
                    this.generatedCode.st = `(*
    Structured Text Program
    Evaporative Ventilation Control System
    IEC 61131-3 Standard
*)

PROGRAM MainControl
VAR
    // System States
    bSystemEnable : BOOL := FALSE;
    bAutoMode : BOOL := TRUE;
    bManualMode : BOOL := FALSE;
    bEmergencyStop : BOOL := FALSE;
    
    // Motor Controls
    bFanFeedMotor : BOOL := FALSE;
    bFanReturnMotor : BOOL := FALSE;
    bPumpMotor : BOOL := FALSE;
    
    // Damper Positions (0-100%)
    rFreshDamper : REAL := 0.0;
    rReturnDamper : REAL := 0.0;
    rExhaustDamper : REAL := 0.0;
    
    // Process Values
    rOutsideTemp : REAL := 25.0;
    rOutsideHumidity : REAL := 40.0;
    rReturnTemp : REAL := 26.0;
    rReturnHumidity : REAL := 60.0;
    rFeedTemp : REAL := 0.0;
    rFeedHumidity : REAL := 0.0;
    
    // Setpoints
    rTempSetpoint : REAL := 24.0;
    rHumSetpoint : REAL := 55.0;
    rFreshAirPercentage : REAL := 30.0;
    
    // PID Controllers
    stTempPID : PID_Controller;
    stHumPID : PID_Controller;
    
    // Timers
    tStartupTimer : TON;
    tMotorRampTimer : TON;
    
    // Alarms
    bHighTempAlarm : BOOL := FALSE;
    bLowHumAlarm : BOOL := FALSE;
    bMotorFault : BOOL := FALSE;
END_VAR

// Main Control Logic
IF NOT bEmergencyStop THEN
    bSystemEnable := xStartButton AND NOT xStopButton;
    
    IF bSystemEnable THEN
        // Calculate air mixing based on fresh air percentage
        rFreshAirPercentage := LIMIT(0.0, rFreshAirPercentage, 100.0);
        
        // Calculate mixed air properties
        rFeedTemp := (rOutsideTemp * rFreshAirPercentage/100.0) + 
                     (rReturnTemp * (100.0 - rFreshAirPercentage)/100.0);
        
        rFeedHumidity := (rOutsideHumidity * rFreshAirPercentage/100.0) + 
                         (rReturnHumidity * (100.0 - rFreshAirPercentage)/100.0);
        
        // Apply evaporative cooling effect
        IF rFeedHumidity < 70.0 THEN
            rFeedTemp := rFeedTemp - 2.0;
            rFeedHumidity := rFeedHumidity + 15.0;
        END_IF;
        
        // Temperature Control Loop
        stTempPID.Setpoint := rTempSetpoint;
        stTempPID.ProcessValue := rReturnTemp;
        stTempPID.Execute();
        
        // Humidity Control Loop
        stHumPID.Setpoint := rHumSetpoint;
        stHumPID.ProcessValue := rReturnHumidity;
        stHumPID.Execute();
        
        // Damper Control
        rFreshDamper := rFreshAirPercentage;
        rExhaustDamper := rFreshAirPercentage;
        rReturnDamper := 100.0 - rFreshAirPercentage;
        
        // Motor Control with Soft Start
        IF tStartupTimer(IN:=TRUE, PT:=T#10s).Q THEN
            bFanFeedMotor := xTempOK AND NOT xMotorOverload;
            bFanReturnMotor := xTempOK AND NOT xMotorOverload;
        END_IF;
        
        // Pump Control based on humidity requirement
        bPumpMotor := stHumPID.Output > 20.0;
        
        // Alarm Monitoring
        bHighTempAlarm := rReturnTemp > (rTempSetpoint + 5.0);
        bLowHumAlarm := rReturnHumidity < (rHumSetpoint - 15.0);
        
    ELSE
        // System Shutdown Sequence
        bFanFeedMotor := FALSE;
        bFanReturnMotor := FALSE;
        bPumpMotor := FALSE;
        rFreshDamper := 0.0;
        rReturnDamper := 0.0;
        rExhaustDamper := 0.0;
    END_IF;
END_IF;

// PID Controller Function Block
FUNCTION_BLOCK PID_Controller
VAR_INPUT
    Setpoint : REAL;
    ProcessValue : REAL;
    Kp : REAL := 1.5;
    Ki : REAL := 0.1;
    Kd : REAL := 0.05;
    ManualMode : BOOL := FALSE;
    ManualOutput : REAL := 0.0;
END_VAR
VAR_OUTPUT
    Output : REAL;
    Error : REAL;
END_VAR
VAR
    PreviousError : REAL := 0.0;
    Integral : REAL := 0.0;
    Derivative : REAL := 0.0;
    SampleTime : TIME := T#100ms;
    LastTime : TIME;
END_VAR

IF NOT ManualMode THEN
    Error := Setpoint - ProcessValue;
    Integral := Integral + (Error * Ki);
    Integral := LIMIT(-100.0, Integral, 100.0); // Anti-windup
    Derivative := (Error - PreviousError) / TIME_TO_REAL(SampleTime);
    Output := (Error * Kp) + Integral + (Derivative * Kd);
    Output := LIMIT(0.0, Output, 100.0);
    PreviousError := Error;
ELSE
    Output := ManualOutput;
END_IF;
END_FUNCTION_BLOCK`;
                },
                
                generateFunctionBlock() {
                    // Simplified FBD representation
                    this.generatedCode.fbd = `FUNCTION_BLOCK_DIAGRAM`;
                },
                
                generatePythonCode() {
                    this.generatedCode.python = `#!/usr/bin/env python3
"""
PLC Simulation for Evaporative Ventilation System
Python-based simulation of control logic
"""

import time
import random
import math
from datetime import datetime

class PIDController:
    """Simple PID controller implementation"""
    def __init__(self, kp=1.0, ki=0.0, kd=0.0):
        self.kp = kp
        self.ki = ki
        self.kd = kd
        self.previous_error = 0.0
        self.integral = 0.0
        self.output = 0.0
        
    def update(self, error, dt=1.0):
        """Update PID controller with new error value"""
        self.integral += error * dt
        self.integral = max(-100.0, min(100.0, self.integral))
        
        derivative = (error - self.previous_error) / dt if dt > 0 else 0.0
        
        self.output = (self.kp * error) + (self.ki * self.integral) + (self.kd * derivative)
        self.output = max(0.0, min(100.0, self.output))
        
        self.previous_error = error
        return self.output

class EvaporativeVentilationSystem:
    def __init__(self):
        # System states
        self.system_enable = False
        self.auto_mode = True
        self.emergency_stop = False
        
        # Process variables
        self.outside_temp = 28.0
        self.outside_humidity = 40.0
        self.return_temp = 26.0
        self.return_humidity = 60.0
        self.feed_temp = 0.0
        self.feed_humidity = 0.0
        
        # Setpoints
        self.temp_setpoint = 24.0
        self.hum_setpoint = 55.0
        self.fresh_air_percentage = 30.0
        
        # Control outputs
        self.fan_speed = 0.0
        self.fresh_damper = 0.0
        self.return_damper = 0.0
        self.exhaust_damper = 0.0
        self.heating_valve = 0.0
        self.steam_valve = 0.0
        
        # PID controllers
        self.temp_pid = PIDController(kp=1.5, ki=0.1, kd=0.05)
        self.hum_pid = PIDController(kp=2.0, ki=0.05, kd=0.02)
        
    def calculate_mixing(self):
        """Calculate mixed air properties"""
        fresh_ratio = self.fresh_air_percentage / 100.0
        cycle_ratio = 1.0 - fresh_ratio
        
        self.feed_temp = (self.outside_temp * fresh_ratio) + \\
                         (self.return_temp * cycle_ratio)
        
        self.feed_humidity = (self.outside_humidity * fresh_ratio) + \\
                             (self.return_humidity * cycle_ratio)
        
        # Apply evaporative cooling
        if self.feed_humidity < 70:
            self.feed_temp -= 2.0
            self.feed_humidity += 15.0
            
        return self.feed_temp, self.feed_humidity
    
    def control_loop(self):
        """Main control loop execution"""
        if not self.system_enable or self.emergency_stop:
            return
        
        # Calculate mixed air
        self.calculate_mixing()
        
        # Temperature control
        temp_error = self.temp_setpoint - self.return_temp
        self.temp_pid.update(temp_error)
        self.heating_valve = self.temp_pid.output
        
        # Humidity control
        hum_error = self.hum_setpoint - self.return_humidity
        self.hum_pid.update(hum_error)
        self.steam_valve = self.hum_pid.output
        
        # Damper control
        self.fresh_damper = self.fresh_air_percentage
        self.exhaust_damper = self.fresh_air_percentage
        self.return_damper = 100.0 - self.fresh_air_percentage
        
        # Fan control
        self.fan_speed = 75.0  # Base speed
        
    def print_status(self):
        """Print current system status"""
        print(f"Outside: {self.outside_temp:.1f}Â°C, {self.outside_humidity:.1f}%")
        print(f"Return: {self.return_temp:.1f}Â°C, {self.return_humidity:.1f}%")
        print(f"Feed: {self.feed_temp:.1f}Â°C, {self.feed_humidity:.1f}%")
        print(f"Fresh Air: {self.fresh_air_percentage:.1f}%")
        print(f"Heating: {self.heating_valve:.1f}%, Humidification: {self.steam_valve:.1f}%")

# Example usage
if __name__ == "__main__":
    system = EvaporativeVentilationSystem()
    system.system_enable = True
    
    print("Starting simulation...")
    for i in range(10):
        print(f"\\nCycle {i+1}:")
        system.control_loop()
        system.print_status()
        time.sleep(1)`;
                },
                
                // UI Methods
                toggleSidebar() {
                    this.sidebarCollapsed = !this.sidebarCollapsed;
                },
                
                showModal(modal) {
                    this.activeModal = modal;
                },
                
                closeModal() {
                    this.activeModal = null;
                },
                
                showToast(message, type = 'info') {
                    const toast = {
                        id: Date.now(),
                        message,
                        type,
                        visible: true
                    };
                    
                    this.toasts.push(toast);
                    
                    // Auto-hide after 5 seconds
                    setTimeout(() => {
                        this.hideToast(toast.id);
                    }, 5000);
                },
                
                hideToast(id) {
                    const index = this.toasts.findIndex(t => t.id === id);
                    if (index !== -1) {
                        this.toasts.splice(index, 1);
                    }
                },
                
                // Project Management
                saveProject() {
                    const project = {
                        name: `PLC Design ${new Date().toISOString().split('T')[0]}`,
                        data: {
                            motors: this.motors,
                            actuators: this.actuators,
                            sensors: this.sensors,
                            configuration: {
                                useSoftStarter: this.useSoftStarter,
                                useInverter: this.useInverter
                            },
                            scenario: this.scenario,
                            bom: this.bom,
                            layout: this.layoutComponents
                        },
                        timestamp: Date.now(),
                        version: '1.0'
                    };
                    
                    const json = JSON.stringify(project, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `plc-design-${Date.now()}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showToast('Project saved successfully', 'success');
                },
                
                loadProject() {
                    document.getElementById('fileInput').click();
                },
                
                loadProjectFromFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const project = JSON.parse(e.target.result);
                            
                            if (project.data) {
                                this.motors = project.data.motors || this.motors;
                                this.actuators = project.data.actuators || this.actuators;
                                this.sensors = project.data.sensors || this.sensors;
                                this.useSoftStarter = project.data.configuration?.useSoftStarter ?? this.useSoftStarter;
                                this.useInverter = project.data.configuration?.useInverter ?? this.useInverter;
                                this.scenario = project.data.scenario || this.scenario;
                                
                                this.calculateBOM();
                                this.generateLayout();
                                this.generateAllCode();
                                
                                this.showToast('Project loaded successfully', 'success');
                            }
                        } catch (error) {
                            this.showToast('Error loading project: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = '';
                },
                
                loadRecentProjects() {
                    // This would typically load from localStorage or API
                    this.recentProjects = [
                        { id: 1, name: 'Textile Plant #1', modified: Date.now() - 86400000, components: 24, status: 'complete' },
                        { id: 2, name: 'Warehouse Cooling', modified: Date.now() - 172800000, components: 18, status: 'in-progress' },
                        { id: 3, name: 'Factory Ventilation', modified: Date.now() - 259200000, components: 32, status: 'draft' }
                    ];
                },
                
                loadProjectFromList(project) {
                    this.showToast(`Loading project: ${project.name}`, 'info');
                },
                
                // Export Methods
                exportBOM() {
                    const csv = this.convertBOMToCSV();
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `bom-${Date.now()}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showToast('BOM exported as CSV', 'success');
                },
                
                exportLayoutImage() {
                    const element = document.getElementById('cabinetGrid');
                    if (!element) return;
                    
                    html2canvas(element).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `cabinet-layout-${Date.now()}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    });
                    
                    this.showToast('Layout exported as PNG', 'success');
                },
                
                convertBOMToCSV() {
                    const headers = ['Component', 'Quantity', 'Specifications', 'Standards', 'Unit Cost (â‚¬)', 'Total Cost (â‚¬)', 'Tags'];
                    const rows = this.bom.map(item => [
                        `"${item.name}"`,
                        item.quantity,
                        `"${item.specifications}"`,
                        `"${item.standards}"`,
                        item.unitCost,
                        item.totalCost,
                        `"${item.tags.join(', ')}"`
                    ]);
                    
                    return [headers, ...rows].map(row => row.join(',')).join('\\n');
                },
                
                // Scenario Methods
                initScenarioVisualization() {
                    // This would initialize the canvas visualization
                    console.log('Initializing scenario visualization');
                },
                
                updateScenario() {
                    // Update scenario calculations
                    console.log('Scenario updated:', this.scenario);
                },
                
                resetScenario() {
                    this.scenario = {
                        freshAirPercent: 30,
                        targetTemp: 24,
                        targetHumidity: 55,
                        heatingEnabled: true,
                        outsideTemp: 28,
                        outsideHumidity: 40,
                        insideTemp: 26,
                        insideHumidity: 60
                    };
                    this.showToast('Scenario reset to defaults', 'info');
                },
                
                runSimulation() {
                    this.showToast('Running control simulation...', 'info');
                    // Simulation logic would go here
                },
                
                loadScenarioMode() {
                    const modes = {
                        auto: { freshAirPercent: 30, targetTemp: 24, targetHumidity: 55 },
                        manual: { freshAirPercent: 50, targetTemp: 22, targetHumidity: 50 },
                        economy: { freshAirPercent: 20, targetTemp: 25, targetHumidity: 60 },
                        summer: { freshAirPercent: 40, targetTemp: 26, targetHumidity: 50 },
                        winter: { freshAirPercent: 10, targetTemp: 22, targetHumidity: 40 }
                    };
                    
                    const mode = modes[this.selectedMode];
                    if (mode) {
                        Object.assign(this.scenario, mode);
                        this.showToast(`Loaded ${this.selectedMode} mode`, 'success');
                    }
                },
                
                updateModeParameters() {
                    // Update scenario with mode parameters
                    if (this.modeParameters[0]) this.scenario.targetTemp = this.modeParameters[0].value;
                    if (this.modeParameters[1]) this.scenario.targetHumidity = this.modeParameters[1].value;
                    if (this.modeParameters[2]) this.scenario.freshAirPercent = this.modeParameters[2].value;
                },
                
                applyScenarioMode() {
                    this.showToast(`Applied ${this.selectedMode} mode`, 'success');
                },
                
                // Utility Methods
                formatCurrency(value) {
                    return new Intl.NumberFormat('de-DE', { 
                        style: 'currency', 
                        currency: 'EUR',
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2 
                    }).format(value);
                },
                
                formatDate(timestamp) {
                    return new Date(timestamp).toLocaleDateString();
                },
                
                copyCode(type) {
                    const code = this.generatedCode[type];
                    navigator.clipboard.writeText(code).then(() => {
                        this.showToast('Code copied to clipboard', 'success');
                    }).catch(err => {
                        this.showToast('Failed to copy code', 'error');
                    });
                },
                
                downloadCode(type) {
                    const code = this.generatedCode[type];
                    const extension = type === 'python' ? 'py' : type === 'st' ? 'st' : 'ld';
                    const blob = new Blob([code], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `plc-code-${type}-${Date.now()}.${extension}`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    this.showToast(`Code downloaded as .${extension}`, 'success');
                },
                
                selectLayoutComponent(component) {
                    this.showToast(`Selected ${component.tag} - ${component.details}`, 'info');
                },
                
                selectBOMItem(item) {
                    this.selectedBOMItem = item.id;
                },
                
                editBOMQuantity(item) {
                    const newQty = prompt(`Enter new quantity for ${item.name}:`, item.quantity);
                    if (newQty !== null && !isNaN(newQty)) {
                        item.quantity = parseInt(newQty);
                        this.calculateBOM();
                        this.showToast(`Updated ${item.name} quantity to ${newQty}`, 'info');
                    }
                },
                
                handleScroll(event) {
                    // Handle scroll events if needed
                }
            };
        }
    </script>
</body>
</html>