<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLC Control Panel Designer</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #7f8c8d;
            --plc-color: #3498db;
            --psu-color: #9b59b6;
            --contactor-color: #2ecc71;
            --relay-color: #f39c12;
            --breaker-color: #e74c3c;
            --inverter-color: #1abc9c;
            --softstarter-color: #d35400;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, #4a6491 100%);
            color: white;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 5px solid var(--secondary);
        }
        
        .header-left h1 {
            font-size: 2.2rem;
            margin-bottom: 8px;
        }
        
        .header-left .subtitle {
            opacity: 0.85;
            font-size: 1.1rem;
        }
        
        .header-right {
            display: flex;
            gap: 15px;
        }
        
        /* Navigation */
        .app-nav {
            background: var(--light);
            padding: 15px 40px;
            border-bottom: 1px solid #ddd;
        }
        
        .nav-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray);
            transition: all 0.3s;
            border: 1px solid #ddd;
            border-bottom: none;
        }
        
        .nav-tab.active {
            background: var(--secondary);
            color: white;
            border-color: var(--secondary);
        }
        
        .nav-tab:hover:not(.active) {
            background: #f8f9fa;
        }
        
        /* Main Content */
        .app-main {
            padding: 30px 40px;
            min-height: 600px;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Card Components */
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            border: 1px solid #eee;
        }
        
        .card-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .card-title i {
            color: var(--secondary);
        }
        
        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: var(--secondary);
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            background: #219653;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }
        
        .btn-warning {
            background: var(--warning);
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(243, 156, 18, 0.4);
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .btn-light {
            background: var(--light);
            color: var(--dark);
        }
        
        .btn-light:hover {
            background: #d5dbdb;
            transform: translateY(-2px);
        }
        
        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        /* Component Items */
        .component-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .component-item {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid var(--secondary);
            transition: all 0.3s;
            border: 1px solid #e2e8f0;
        }
        
        .component-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            border-left-color: var(--success);
        }
        
        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .component-name {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
        }
        
        .component-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            padding: 5px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }
        
        .qty-btn {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            border: none;
            background: var(--light);
            color: var(--dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        
        .qty-btn:hover {
            background: var(--secondary);
            color: white;
        }
        
        .qty-display {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .component-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .detail-label {
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .detail-value {
            font-weight: 500;
        }
        
        /* Layout Grid */
        .layout-container {
            background: linear-gradient(45deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 10px;
            padding: 20px;
            min-height: 600px;
            overflow: auto;
        }
        
        .layout-grid {
            display: grid;
            grid-template-columns: repeat(12, 80px);
            grid-auto-rows: 100px;
            gap: 5px;
            min-height: 600px;
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            position: relative;
        }
        
        .layout-component {
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            text-align: center;
            padding: 10px 5px;
            overflow: hidden;
            position: relative;
            color: white;
            font-weight: 500;
            word-break: break-word;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        
        .layout-component:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }
        
        .layout-component.plc {
            background: linear-gradient(135deg, var(--plc-color) 0%, #2980b9 100%);
        }
        
        .layout-component.psu {
            background: linear-gradient(135deg, var(--psu-color) 0%, #8e44ad 100%);
        }
        
        .layout-component.breaker {
            background: linear-gradient(135deg, var(--breaker-color) 0%, #c0392b 100%);
        }
        
        .layout-component.contactor {
            background: linear-gradient(135deg, var(--contactor-color) 0%, #27ae60 100%);
        }
        
        .layout-component.relay {
            background: linear-gradient(135deg, var(--relay-color) 0%, #e67e22 100%);
        }
        
        .layout-component.inverter {
            background: linear-gradient(135deg, var(--inverter-color) 0%, #16a085 100%);
        }
        
        .layout-component.soft-starter {
            background: linear-gradient(135deg, var(--softstarter-color) 0%, #a84300 100%);
        }
        
        .layout-component.hmi {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
        }
        
        .layout-component.terminal {
            background: linear-gradient(135deg, #7f8c8d 0%, #616a6b 100%);
        }
        
        /* BOM Table */
        .bom-table-container {
            overflow-x: auto;
            margin-top: 20px;
        }
        
        .bom-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }
        
        .bom-table th {
            background: linear-gradient(135deg, var(--primary) 0%, #34495e 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        .bom-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .bom-table tr:hover {
            background-color: #f8f9fa;
        }
        
        .bom-table tr:nth-child(even) {
            background-color: #f8fafc;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.4s;
        }
        
        @keyframes modalIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }
        
        .modal-header {
            padding: 25px 30px;
            border-bottom: 2px solid var(--light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.8rem;
            color: var(--primary);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--gray);
            transition: all 0.3s;
        }
        
        .close-modal:hover {
            color: var(--danger);
            transform: rotate(90deg);
        }
        
        .modal-body {
            padding: 30px;
        }
        
        /* Status Bar */
        .status-bar {
            background: var(--light);
            padding: 20px 40px;
            border-top: 2px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--primary);
        }
        
        .status-value {
            background: white;
            padding: 8px 15px;
            border-radius: 20px;
            border: 2px solid var(--secondary);
            min-width: 60px;
            text-align: center;
        }
        
        /* Template Cards */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
        }
        
        .template-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            border: 2px solid #e2e8f0;
            transition: all 0.3s;
            cursor: pointer;
            text-align: center;
        }
        
        .template-card:hover {
            border-color: var(--secondary);
            transform: translateY(-10px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .template-icon {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 15px;
        }
        
        .template-title {
            font-size: 1.4rem;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .template-desc {
            color: var(--gray);
            line-height: 1.6;
        }
        
        /* Color Legend */
        .color-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 20px;
            background: var(--light);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .legend-color {
            width: 25px;
            height: 25px;
            border-radius: 6px;
            border: 2px solid white;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }
        
        /* Connection List */
        .connection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .connection-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border-left: 5px solid var(--secondary);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .connection-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .connection-title {
            font-weight: 700;
            color: var(--primary);
        }
        
        .connection-tag {
            background: var(--light);
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            color: var(--dark);
        }
        
        /* Alert Messages */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 5px solid;
        }
        
        .alert-success {
            background: rgba(39, 174, 96, 0.1);
            border-left-color: var(--success);
            color: #155724;
        }
        
        .alert-info {
            background: rgba(52, 152, 219, 0.1);
            border-left-color: var(--secondary);
            color: #0c5460;
        }
        
        .alert-warning {
            background: rgba(243, 156, 18, 0.1);
            border-left-color: var(--warning);
            color: #856404;
        }
        
        /* Responsive */
        @media (max-width: 1200px) {
            .component-list {
                grid-template-columns: 1fr;
            }
            
            .layout-grid {
                grid-template-columns: repeat(8, 60px);
                grid-auto-rows: 75px;
            }
        }
        
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }
            
            .header-right {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-tabs {
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .status-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .layout-grid {
                grid-template-columns: repeat(6, 50px);
                grid-auto-rows: 60px;
                font-size: 0.7rem;
            }
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--secondary);
            border-radius: 10px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #2980b9;
        }
        
        /* Print Styles */
        @media print {
            .no-print, .app-header, .app-nav, .status-bar, .btn {
                display: none !important;
            }
            
            .app-main {
                padding: 0;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
                break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div x-data="plcDesignerApp()" x-init="init()">
        <div class="app-container">
            <!-- Header -->
            <header class="app-header">
                <div class="header-left">
                    <h1><i class="fas fa-industry"></i> PLC Control Panel Designer</h1>
                    <div class="subtitle">Professional Design Tool for Industrial Automation Systems</div>
                </div>
                <div class="header-right">
                    <button class="btn btn-primary" @click="saveProject()">
                        <i class="fas fa-save"></i> Save Project
                    </button>
                    <button class="btn btn-success" @click="loadProject()">
                        <i class="fas fa-folder-open"></i> Load Project
                    </button>
                    <button class="btn btn-warning" @click="showModal = 'export'">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                    <button class="btn btn-danger" @click="showModal = 'print'">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </header>
            
            <!-- Navigation -->
            <nav class="app-nav">
                <div class="nav-tabs">
                    <button class="nav-tab" :class="{ active: activeTab === 'design' }" @click="activeTab = 'design'">
                        <i class="fas fa-cogs"></i> Design
                    </button>
                    <button class="nav-tab" :class="{ active: activeTab === 'layout' }" @click="activeTab = 'layout'">
                        <i class="fas fa-th-large"></i> Layout
                    </button>
                    <button class="nav-tab" :class="{ active: activeTab === 'bom' }" @click="activeTab = 'bom'">
                        <i class="fas fa-clipboard-list"></i> BOM
                    </button>
                    <button class="nav-tab" :class="{ active: activeTab === 'wiring' }" @click="activeTab = 'wiring'">
                        <i class="fas fa-network-wired"></i> Wiring
                    </button>
                    <button class="nav-tab" :class="{ active: activeTab === 'scenario' }" @click="activeTab = 'scenario'">
                        <i class="fas fa-code"></i> Control Scenario
                    </button>
                    <button class="nav-tab" :class="{ active: activeTab === 'templates' }" @click="activeTab = 'templates'">
                        <i class="fas fa-layer-group"></i> Templates
                    </button>
                    <button class="nav-tab" :class="{ active: activeTab === 'database' }" @click="activeTab = 'database'">
                        <i class="fas fa-database"></i> Database
                    </button>
                </div>
            </nav>
            
            <!-- Main Content -->
            <main class="app-main">
                <!-- Design Tab -->
                <div class="tab-content" :class="{ active: activeTab === 'design' }">
                    <!-- Template Selection -->
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-vector-square"></i> Select Template</h2>
                        <div class="form-group">
                            <label class="form-label">Project Template</label>
                            <select class="form-control" x-model="selectedTemplate" @change="loadTemplate()">
                                <option value="evap_vent">Evaporative Ventilation Station</option>
                                <option value="filter_plant">Filter Plant</option>
                                <option value="custom">Custom Design</option>
                            </select>
                        </div>
                        
                        <!-- Starter Type -->
                        <div class="form-group">
                            <label class="form-label">Starter Type</label>
                            <div style="display: flex; gap: 20px; margin-top: 10px;">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="starterType" value="soft" x-model="starterType">
                                    <span>Soft Starter (Default)</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="starterType" value="inverter" x-model="starterType">
                                    <span>VFD Inverter</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="starterType" value="direct" x-model="starterType">
                                    <span>Direct Online</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 3-Phase Motors -->
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-cogs"></i> 3-Phase Motors</h2>
                        <div class="component-list">
                            <template x-for="(motor, index) in motors" :key="index">
                                <div class="component-item">
                                    <div class="component-header">
                                        <div class="component-name" x-text="motor.name"></div>
                                        <div class="component-controls">
                                            <div class="quantity-control">
                                                <button class="qty-btn" @click="motor.quantity = Math.max(0, motor.quantity - 1); calculateBOM();">-</button>
                                                <div class="qty-display" x-text="motor.quantity"></div>
                                                <button class="qty-btn" @click="motor.quantity++; calculateBOM();">+</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="component-details">
                                        <div class="detail-item">
                                            <div class="detail-label">Power (kW)</div>
                                            <input type="text" class="form-control" x-model="motor.power" @change="calculateBOM()">
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Contactor(s)</div>
                                            <div class="detail-value" x-text="motor.contactors"></div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Overload</div>
                                            <div class="detail-value" x-text="motor.hasOverload ? 'Yes' : 'No'"></div>
                                        </div>
                                    </div>
                                    <div class="form-group" style="margin-top: 10px;">
                                        <label style="display: flex; align-items: center; gap: 8px;">
                                            <input type="checkbox" x-model="motor.hasOverload">
                                            <span>Include Overload Protection</span>
                                        </label>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- Actuators -->
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-sliders-h"></i> Actuators</h2>
                        <div class="component-list">
                            <template x-for="(actuator, index) in actuators" :key="index">
                                <div class="component-item">
                                    <div class="component-header">
                                        <div class="component-name" x-text="actuator.name"></div>
                                        <div class="component-controls">
                                            <div class="quantity-control">
                                                <button class="qty-btn" @click="actuator.quantity = Math.max(0, actuator.quantity - 1); calculateBOM();">-</button>
                                                <div class="qty-display" x-text="actuator.quantity"></div>
                                                <button class="qty-btn" @click="actuator.quantity++; calculateBOM();">+</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="component-details">
                                        <div class="detail-item">
                                            <div class="detail-label">Voltage</div>
                                            <input type="text" class="form-control" x-model="actuator.voltage" @change="calculateBOM()">
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Positioner</div>
                                            <div class="detail-value" x-text="actuator.hasPositioner ? 'Yes' : 'No'"></div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">Feedback</div>
                                            <div class="detail-value" x-text="actuator.readPosition ? 'Analog' : 'Digital'"></div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 15px; margin-top: 10px;">
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" x-model="actuator.hasPositioner">
                                            <span>Positioner</span>
                                        </label>
                                        <label style="display: flex; align-items: center; gap: 5px;">
                                            <input type="checkbox" x-model="actuator.readPosition" :disabled="!actuator.hasPositioner">
                                            <span>Read Position</span>
                                        </label>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                
                <!-- Layout Tab -->
                <div class="tab-content" :class="{ active: activeTab === 'layout' }">
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-th-large"></i> Panel Layout</h2>
                        
                        <!-- Color Legend -->
                        <div class="color-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--plc-color);"></div>
                                <span>PLC & Modules</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--psu-color);"></div>
                                <span>Power Supply</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--breaker-color);"></div>
                                <span>Breakers</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--contactor-color);"></div>
                                <span>Contactors</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--relay-color);"></div>
                                <span>Relays</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--inverter-color);"></div>
                                <span>VFD Inverter</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background: var(--softstarter-color);"></div>
                                <span>Soft Starter</span>
                            </div>
                        </div>
                        
                        <!-- Layout Grid -->
                        <div class="layout-container">
                            <div class="layout-grid">
                                <template x-for="(component, index) in layoutComponents" :key="index">
                                    <div class="layout-component" 
                                         :class="component.type"
                                         :style="getLayoutStyle(component)">
                                        <div x-text="component.tag"></div>
                                        <div style="font-size: 0.7rem; margin-top: 3px;" x-text="component.details"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- BOM Tab -->
                <div class="tab-content" :class="{ active: activeTab === 'bom' }">
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-clipboard-list"></i> Bill of Materials</h2>
                        
                        <!-- Summary -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px;">
                                <div style="font-size: 2rem; font-weight: bold;" x-text="bom.length"></div>
                                <div>Total Items</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px;">
                                <div style="font-size: 2rem; font-weight: bold;" x-text="totalCost + ' €'"></div>
                                <div>Estimated Cost</div>
                            </div>
                            <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px; border-radius: 10px;">
                                <div style="font-size: 2rem; font-weight: bold;" x-text="cabinetSize"></div>
                                <div>Cabinet Size</div>
                            </div>
                        </div>
                        
                        <!-- BOM Table -->
                        <div class="bom-table-container">
                            <table class="bom-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Component</th>
                                        <th>Quantity</th>
                                        <th>Specifications</th>
                                        <th>Standards</th>
                                        <th>Unit Price (€)</th>
                                        <th>Total (€)</th>
                                        <th>Tags</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(item, index) in bom" :key="index">
                                        <tr>
                                            <td x-text="index + 1"></td>
                                            <td x-text="item.name"></td>
                                            <td x-text="item.quantity"></td>
                                            <td x-text="item.specifications"></td>
                                            <td x-text="item.standards"></td>
                                            <td x-text="item.unitPrice"></td>
                                            <td x-text="(item.unitPrice * item.quantity).toFixed(2)"></td>
                                            <td>
                                                <template x-for="tag in item.tags" :key="tag">
                                                    <span style="display: inline-block; background: #e2e8f0; padding: 2px 8px; border-radius: 4px; margin: 2px; font-size: 0.8rem;" x-text="tag"></span>
                                                </template>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Wiring Tab -->
                <div class="tab-content" :class="{ active: activeTab === 'wiring' }">
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-network-wired"></i> Wiring & Connections</h2>
                        
                        <!-- PLC I/O Summary -->
                        <div class="alert alert-info">
                            <h4><i class="fas fa-microchip"></i> PLC I/O Requirements</h4>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px;">
                                <div>
                                    <h5>Digital Inputs</h5>
                                    <div style="font-size: 2rem; font-weight: bold; color: var(--primary);" x-text="digitalInputs.length"></div>
                                </div>
                                <div>
                                    <h5>Digital Outputs</h5>
                                    <div style="font-size: 2rem; font-weight: bold; color: var(--primary);" x-text="digitalOutputs.length"></div>
                                </div>
                                <div>
                                    <h5>Analog Inputs</h5>
                                    <div style="font-size: 2rem; font-weight: bold; color: var(--primary);" x-text="analogInputs.length"></div>
                                </div>
                                <div>
                                    <h5>Analog Outputs</h5>
                                    <div style="font-size: 2rem; font-weight: bold; color: var(--primary);" x-text="analogOutputs.length"></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Connection List -->
                        <div class="connection-grid">
                            <template x-for="(connection, index) in connections" :key="index">
                                <div class="connection-card">
                                    <div class="connection-header">
                                        <div class="connection-title" x-text="connection.from + ' → ' + connection.to"></div>
                                        <div class="connection-tag" x-text="connection.type"></div>
                                    </div>
                                    <div style="margin-bottom: 10px;">
                                        <div><strong>Wire:</strong> <span x-text="connection.wireSize"></span></div>
                                        <div><strong>Length:</strong> <span x-text="connection.length"></span> m</div>
                                        <div><strong>Terminal:</strong> <span x-text="connection.terminal"></span></div>
                                    </div>
                                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                        <span style="background: #e8f4fc; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;" x-text="connection.color"></span>
                                        <span style="background: #f0f8e8; padding: 3px 8px; border-radius: 4px; font-size: 0.8rem;" x-text="connection.voltage"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                
                <!-- Control Scenario Tab -->
                <div class="tab-content" :class="{ active: activeTab === 'scenario' }">
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-code"></i> Control Scenario & Algorithm</h2>
                        
                        <!-- Algorithm Visualization -->
                        <div class="alert alert-success">
                            <h4><i class="fas fa-calculator"></i> Control Algorithm</h4>
                            <pre style="background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; margin-top: 10px; font-family: monospace; line-height: 1.6;">
// Air Flow Calculation Algorithm
return_air = saloon_air;
exhaust_air = exhaust_damper_percentage * return_air * edeff;
remain_air = return_air - exhaust_air;
remain_percentage = 1 - exhaust_percentage;

// Cycle Air Calculation
if (heater_valve_open) {
    cycle_air = remain_air + heating_constant_wet_bulb;
} else {
    cycle_air = remain_air;
}

// Mixing Air Calculation
mixing_air = psychometric_mix(cycle_air, outdoor_air);

// Feed Air Calculation
if (pump_off) {
    feed_air = mixing_air;
} else {
    feed_air = evaporative_cooling(mixing_air, target_humidity = 85%);
}

// Control Logic
fresh_percentage = exhaust_percentage;
cycle_percentage = 100 - fresh_percentage;
                            </pre>
                        </div>
                        
                        <!-- PLC Code Suggestion -->
                        <div class="alert alert-info">
                            <h4><i class="fas fa-laptop-code"></i> PLC Code Suggestion (Siemens S7-1200)</h4>
                            <pre style="background: rgba(0,0,0,0.05); padding: 15px; border-radius: 8px; margin-top: 10px; font-family: monospace; line-height: 1.6; font-size: 0.9rem;">
FUNCTION_BLOCK "Ventilation_Control"
VAR_INPUT
    ST: REAL; (* Saloon Temperature *)
    SH: REAL; (* Saloon Humidity *)
    OT: REAL; (* Outdoor Temperature *)
    OH: REAL; (* Outdoor Humidity *)
    Exhaust_Setpoint: REAL; (* 0-100% *)
    Temp_Setpoint: REAL;
    Humidity_Setpoint: REAL;
END_VAR

VAR_OUTPUT
    Fan_Feed_Speed: REAL;
    Fan_Return_Speed: REAL;
    Damper_Fresh_Pos: REAL;
    Damper_Exhaust_Pos: REAL;
    Damper_Return_Pos: REAL;
    Heater_Valve: BOOL;
    Water_Pump: BOOL;
    Alarm: BOOL;
END_VAR

VAR
    // Internal variables
    Cycle_Air_Temp: REAL;
    Mixed_Air_Temp: REAL;
    Feed_Air_Temp: REAL;
END_VAR

BEGIN
    // Damper Control
    Damper_Exhaust_Pos := Exhaust_Setpoint;
    Damper_Fresh_Pos := Exhaust_Setpoint + 0.05; // Pressure correction
    Damper_Return_Pos := 100 - Exhaust_Setpoint;
    
    // Fan Control based on temperature difference
    Fan_Feed_Speed := LIMIT(0.0, 100.0, (Temp_Setpoint - ST) * 10.0);
    Fan_Return_Speed := Fan_Feed_Speed * 0.9;
    
    // Heater Control
    Heater_Valve := ST < (Temp_Setpoint - 2.0);
    
    // Humidity Control
    Water_Pump := SH < (Humidity_Setpoint - 5.0);
    
    // Alarm Logic
    Alarm := ST > 40.0 OR ST < 10.0 OR SH > 90.0;
END_FUNCTION_BLOCK
                            </pre>
                        </div>
                    </div>
                </div>
                
                <!-- Templates Tab -->
                <div class="tab-content" :class="{ active: activeTab === 'templates' }">
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-layer-group"></i> Project Templates</h2>
                        <div class="template-grid">
                            <!-- Evaporative Ventilation Template -->
                            <div class="template-card" @click="loadEvapVentTemplate()">
                                <div class="template-icon">
                                    <i class="fas fa-wind"></i>
                                </div>
                                <h3 class="template-title">Evaporative Ventilation Station</h3>
                                <p class="template-desc">
                                    Complete PLC control system for textile industry evaporative ventilation
                                    with multiple motors, dampers, and sensors.
                                </p>
                                <div style="margin-top: 15px; display: flex; justify-content: space-between; color: var(--gray);">
                                    <span><i class="fas fa-motorcycle"></i> 6 Motors</span>
                                    <span><i class="fas fa-sliders-h"></i> 4 Actuators</span>
                                    <span><i class="fas fa-thermometer-half"></i> 3 Sensors</span>
                                </div>
                            </div>
                            
                            <!-- Filter Plant Template -->
                            <div class="template-card" @click="loadFilterPlantTemplate()">
                                <div class="template-icon">
                                    <i class="fas fa-filter"></i>
                                </div>
                                <h3 class="template-title">Filter Plant</h3>
                                <p class="template-desc">
                                    Multi-room filter plant control system with main fans, filter motors,
                                    and dust collection system.
                                </p>
                                <div style="margin-top: 15px; display: flex; justify-content: space-between; color: var(--gray);">
                                    <span><i class="fas fa-door-closed"></i> 3 Rooms</span>
                                    <span><i class="fas fa-fan"></i> 5 Motors</span>
                                    <span><i class="fas fa-compress-arrows-alt"></i> 2 Sensors</span>
                                </div>
                            </div>
                            
                            <!-- Custom Template -->
                            <div class="template-card" @click="loadCustomTemplate()">
                                <div class="template-icon">
                                    <i class="fas fa-plus-circle"></i>
                                </div>
                                <h3 class="template-title">Custom Design</h3>
                                <p class="template-desc">
                                    Start from scratch and design your own PLC control system
                                    with custom components and configuration.
                                </p>
                                <div style="margin-top: 15px; color: var(--secondary);">
                                    <i class="fas fa-cogs"></i> Fully Configurable
                                </div>
                            </div>
                            
                            <!-- Save Current as Template -->
                            <div class="template-card" @click="showModal = 'saveTemplate'">
                                <div class="template-icon">
                                    <i class="fas fa-save"></i>
                                </div>
                                <h3 class="template-title">Save Current as Template</h3>
                                <p class="template-desc">
                                    Save your current design as a reusable template for future projects.
                                </p>
                                <div style="margin-top: 15px; color: var(--success);">
                                    <i class="fas fa-download"></i> Export Template
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Database Tab -->
                <div class="tab-content" :class="{ active: activeTab === 'database' }">
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-database"></i> Database Configuration</h2>
                        
                        <!-- Connection Status -->
                        <div class="alert" :class="dbConnected ? 'alert-success' : 'alert-warning'">
                            <h4><i class="fas fa-plug"></i> Database Connection</h4>
                            <p x-text="dbConnected ? 'Connected to database successfully' : 'Not connected to database. Using local storage.'"></p>
                        </div>
                        
                        <!-- Database Configuration -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                            <div>
                                <h3 style="margin-bottom: 20px; color: var(--primary);">Database Settings</h3>
                                <div class="form-group">
                                    <label class="form-label">Host</label>
                                    <input type="text" class="form-control" x-model="dbConfig.host" placeholder="localhost">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Database Name</label>
                                    <input type="text" class="form-control" x-model="dbConfig.database" value="esmartis_plc">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" x-model="dbConfig.username" value="esmartis_user">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" x-model="dbConfig.password" value="esmartis1364">
                                </div>
                                <button class="btn btn-primary" @click="testConnection()">
                                    <i class="fas fa-plug"></i> Test Connection
                                </button>
                            </div>
                            
                            <div>
                                <h3 style="margin-bottom: 20px; color: var(--primary);">Database Operations</h3>
                                <div style="display: flex; flex-direction: column; gap: 15px;">
                                    <button class="btn btn-success" @click="saveToDatabase()">
                                        <i class="fas fa-save"></i> Save Project to DB
                                    </button>
                                    <button class="btn btn-warning" @click="loadFromDatabase()">
                                        <i class="fas fa-folder-open"></i> Load Project from DB
                                    </button>
                                    <button class="btn btn-primary" @click="installDatabase()">
                                        <i class="fas fa-database"></i> Install Database Tables
                                    </button>
                                    <button class="btn btn-light" @click="exportDatabaseSchema()">
                                        <i class="fas fa-file-code"></i> Export SQL Schema
                                    </button>
                                </div>
                                
                                <!-- Projects in Database -->
                                <div style="margin-top: 30px;">
                                    <h4 style="margin-bottom: 15px; color: var(--primary);">Saved Projects</h4>
                                    <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 15px;">
                                        <template x-for="project in dbProjects" :key="project.id">
                                            <div style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <div style="font-weight: 600;" x-text="project.name"></div>
                                                    <div style="font-size: 0.8rem; color: var(--gray);" x-text="project.created_at"></div>
                                                </div>
                                                <div style="display: flex; gap: 5px;">
                                                    <button class="btn btn-light" style="padding: 5px 10px;" @click="loadProjectFromDB(project.id)">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn btn-danger" style="padding: 5px 10px;" @click="deleteProjectFromDB(project.id)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
            
            <!-- Status Bar -->
            <div class="status-bar">
                <div class="status-item">
                    <span>Total Components:</span>
                    <div class="status-value" x-text="bom.length"></div>
                </div>
                <div class="status-item">
                    <span>Estimated Cost:</span>
                    <div class="status-value" x-text="totalCost + ' €'"></div>
                </div>
                <div class="status-item">
                    <span>Relays:</span>
                    <div class="status-value" x-text="relayCount"></div>
                </div>
                <div class="status-item">
                    <span>Contactors:</span>
                    <div class="status-value" x-text="contactorCount"></div>
                </div>
                <div class="status-item">
                    <span>Terminals:</span>
                    <div class="status-value" x-text="terminalCount"></div>
                </div>
            </div>
        </div>
        
        <!-- Export Modal -->
        <template x-if="showModal === 'export'">
            <div class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-file-export"></i> Export Options</h3>
                        <button class="close-modal" @click="showModal = null">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <button class="btn btn-primary" style="flex-direction: column; height: auto; padding: 30px;" @click="exportBOM()">
                                <i class="fas fa-file-csv fa-3x"></i>
                                <span style="margin-top: 15px; font-size: 1.1rem;">Export BOM as CSV</span>
                            </button>
                            <button class="btn btn-success" style="flex-direction: column; height: auto; padding: 30px;" @click="exportJSON()">
                                <i class="fas fa-file-code fa-3x"></i>
                                <span style="margin-top: 15px; font-size: 1.1rem;">Export as JSON</span>
                            </button>
                            <button class="btn btn-warning" style="flex-direction: column; height: auto; padding: 30px;" @click="exportPDF()">
                                <i class="fas fa-file-pdf fa-3x"></i>
                                <span style="margin-top: 15px; font-size: 1.1rem;">Export as PDF</span>
                            </button>
                            <button class="btn btn-danger" style="flex-direction: column; height: auto; padding: 30px;" @click="exportImage()">
                                <i class="fas fa-image fa-3x"></i>
                                <span style="margin-top: 15px; font-size: 1.1rem;">Export Layout as Image</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- Print Modal -->
        <template x-if="showModal === 'print'">
            <div class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-print"></i> Print Options</h3>
                        <button class="close-modal" @click="showModal = null">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
                            <button class="btn btn-primary" style="flex-direction: column; height: auto; padding: 30px;" @click="printBOM()">
                                <i class="fas fa-clipboard-list fa-3x"></i>
                                <span style="margin-top: 15px; font-size: 1.1rem;">Print BOM</span>
                            </button>
                            <button class="btn btn-success" style="flex-direction: column; height: auto; padding: 30px;" @click="printLayout()">
                                <i class="fas fa-th-large fa-3x"></i>
                                <span style="margin-top: 15px; font-size: 1.1rem;">Print Layout</span>
                            </button>
                            <button class="btn btn-warning" style="flex-direction: column; height: auto; padding: 30px;" @click="printFullReport()">
                                <i class="fas fa-print fa-3x"></i>
                                <span style="margin-top: 15px; font-size: 1.1rem;">Print Full Report</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- Save Template Modal -->
        <template x-if="showModal === 'saveTemplate'">
            <div class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title"><i class="fas fa-save"></i> Save as Template</h3>
                        <button class="close-modal" @click="showModal = null">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Template Name</label>
                            <input type="text" class="form-control" x-model="newTemplateName" placeholder="My Custom Template">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" rows="3" x-model="newTemplateDescription"></textarea>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-control" x-model="newTemplateCategory">
                                <option value="ventilation">Ventilation Systems</option>
                                <option value="filtration">Filtration Systems</option>
                                <option value="pumping">Pumping Systems</option>
                                <option value="conveying">Conveying Systems</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>
                        <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px;">
                            <button class="btn btn-light" @click="showModal = null">Cancel</button>
                            <button class="btn btn-primary" @click="saveCurrentAsTemplate()">Save Template</button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- Hidden file input -->
        <input type="file" id="fileInput" accept=".json" style="display: none;" @change="loadProjectFromFile($event)">
    </div>

    <script>
        function plcDesignerApp() {
            return {
                // Application state
                activeTab: 'design',
                showModal: null,
                selectedTemplate: 'evap_vent',
                starterType: 'soft',
                
                // Database configuration
                dbConnected: false,
                dbConfig: {
                    host: 'localhost',
                    database: 'esmartis_plc',
                    username: 'esmartis_user',
                    password: 'esmartis1364'
                },
                dbProjects: [],
                
                // Template data
                newTemplateName: '',
                newTemplateDescription: '',
                newTemplateCategory: 'custom',
                
                // Component arrays
                motors: [],
                actuators: [],
                sensors: [],
                optionalComponents: [],
                
                // Calculated data
                bom: [],
                layoutComponents: [],
                connections: [],
                digitalInputs: [],
                digitalOutputs: [],
                analogInputs: [],
                analogOutputs: [],
                
                // Counters
                relayCount: 0,
                contactorCount: 0,
                terminalCount: 0,
                totalCost: 0,
                cabinetSize: '800x600x200mm',
                
                // Initialize application
                init() {
                    this.loadEvapVentTemplate();
                    this.calculateBOM();
                    this.generateLayout();
                    this.generateConnections();
                    this.generateIOLists();
                    this.loadProjectsFromLocalStorage();
                },
                
                // Template loading functions
                loadTemplate() {
                    if (this.selectedTemplate === 'evap_vent') {
                        this.loadEvapVentTemplate();
                    } else if (this.selectedTemplate === 'filter_plant') {
                        this.loadFilterPlantTemplate();
                    } else {
                        this.loadCustomTemplate();
                    }
                    this.calculateBOM();
                },
                
                loadEvapVentTemplate() {
                    // 3-Phase Motors for Evaporative Ventilation
                    this.motors = [
                        { 
                            id: 1, 
                            name: 'Fan Feed Motor', 
                            quantity: 2, 
                            power: '22', 
                            contactors: 2,
                            hasOverload: true,
                            voltage: '400V',
                            description: 'فن رفت با موتور در رنج تا ۶۰ کیلو'
                        },
                        { 
                            id: 2, 
                            name: 'Fan Return Motor', 
                            quantity: 2, 
                            power: '30', 
                            contactors: 2,
                            hasOverload: true,
                            voltage: '400V',
                            description: 'فن برگشت با موتور تا رنگ ۶۰ کیلو'
                        },
                        { 
                            id: 3, 
                            name: 'Dust Fan Motor', 
                            quantity: 4, 
                            power: '3.3', 
                            contactors: 1,
                            hasOverload: true,
                            voltage: '400V',
                            description: 'هر روتاری فیلتر دارای دو داست فن'
                        },
                        { 
                            id: 4, 
                            name: 'Rotary Motor', 
                            quantity: 2, 
                            power: '1', 
                            contactors: 1,
                            hasOverload: true,
                            voltage: '400V',
                            description: 'هر روتاری فیلتر دارای یک روتاری موتور'
                        },
                        { 
                            id: 5, 
                            name: 'Mechanism Motor', 
                            quantity: 2, 
                            power: '0.25', 
                            contactors: 1,
                            hasOverload: true,
                            voltage: '400V',
                            description: 'هر روتاری فیلتر دارای یک مکانیزم موتور'
                        },
                        { 
                            id: 6, 
                            name: 'Pump Water Motor', 
                            quantity: 1, 
                            power: '30', 
                            contactors: 2,
                            hasOverload: true,
                            voltage: '400V',
                            description: 'پمپ آب سانتریفیوژ با موتور تا رنگ ۵۰ کیلو'
                        }
                    ];
                    
                    // Actuators
                    this.actuators = [
                        {
                            id: 1,
                            name: 'Damper Fresh',
                            quantity: 2,
                            voltage: '24V DC',
                            hasPositioner: true,
                            readPosition: true,
                            description: 'هر دمپر دارای پوزیشنر خودش برای خواندن'
                        },
                        {
                            id: 2,
                            name: 'Damper Exhaust',
                            quantity: 2,
                            voltage: '24V DC',
                            hasPositioner: true,
                            readPosition: true,
                            description: 'هر دمپر پوزیشنر خود را دارد'
                        },
                        {
                            id: 3,
                            name: 'Damper Return',
                            quantity: 2,
                            voltage: '24V DC',
                            hasPositioner: false,
                            readPosition: false,
                            description: 'هر دمپر پوزیشنر خود را دارد'
                        },
                        {
                            id: 4,
                            name: 'Steam Valve',
                            quantity: 1,
                            voltage: '24V DC',
                            hasPositioner: true,
                            readPosition: false,
                            description: 'در صورت کنترل دار بودن امکان خواندن پوزیشنر'
                        }
                    ];
                    
                    // Sensors
                    this.sensors = [
                        {
                            id: 1,
                            name: 'Temperature Sensor',
                            quantity: 2,
                            type: 'Analog 4-20mA',
                            description: 'سنسور دمای بیرون و داخل'
                        },
                        {
                            id: 2,
                            name: 'Humidity Sensor',
                            quantity: 2,
                            type: 'Analog 4-20mA',
                            description: 'سنسور رطوبت بیرون و داخل'
                        },
                        {
                            id: 3,
                            name: 'Micro Switch',
                            quantity: 5,
                            type: 'Digital ON/OFF',
                            description: 'به ازای هر درب یک سوییچ'
                        }
                    ];
                    
                    // Optional Components
                    this.optionalComponents = [
                        {
                            id: 1,
                            name: 'VFD Inverter',
                            quantity: 0,
                            spec: '30kW',
                            description: 'کنترل موتور سه فاز با توان به اندازه بزرگترین موتور'
                        },
                        {
                            id: 2,
                            name: 'Soft Starter',
                            quantity: 1,
                            spec: '30kW',
                            description: 'با اندازه بزرگترین موتور'
                        },
                        {
                            id: 3,
                            name: 'HMI Panel',
                            quantity: 1,
                            spec: '7 inch',
                            description: 'Human Machine Interface'
                        },
                        {
                            id: 4,
                            name: 'Cabinet Heat Sensor',
                            quantity: 0,
                            spec: 'Thermal Switch',
                            description: 'سنسور تشخیص حرارت داخل تابلو'
                        }
                    ];
                    
                    this.starterType = 'soft';
                },
                
                loadFilterPlantTemplate() {
                    // Filter Plant Template
                    this.motors = [
                        { 
                            id: 1, 
                            name: 'Main Fan Motor', 
                            quantity: 3, 
                            power: '120', 
                            contactors: 2,
                            hasOverload: true,
                            voltage: '400V',
                            description: 'Main fan for filter room'
                        },
                        { 
                            id: 2, 
                            name: 'Filter Disk Motor', 
                            quantity: 3, 
                            power: '1', 
                            contactors: 1,
                            hasOverload: true,
                            voltage: '400V',
                            description: 'Filter disk rotation motor'
                        },
                        { 
                            id: 3, 
                            name: 'Rotary Filter Motor', 
                            quantity: 3, 
                            power: '1', 
                            contactors: 1,
                            hasOverload: true,
                            voltage: '400V',
                            description: 'Rotary filter motor'
                        },
                        { 
                            id: 4, 
                            name: 'Mechanism Motor', 
                            quantity: 3, 
                            power: '0.3', 
                            contactors: 1,
                            hasOverload: true,
                            voltage: '400V',
                            description: 'Mechanism motor'
                        },
                        { 
                            id: 5, 
                            name: 'Dust Collector Fan', 
                            quantity: 6, 
                            power: '5', 
                            contactors: 1,
                            hasOverload: true,
                            voltage: '400V',
                            description: 'Dust collector fan motor'
                        }
                    ];
                    
                    this.actuators = [
                        {
                            id: 1,
                            name: 'Dampers',
                            quantity: 6,
                            voltage: '24V DC',
                            hasPositioner: true,
                            readPosition: true,
                            description: 'Air control dampers'
                        }
                    ];
                    
                    this.sensors = [
                        {
                            id: 1,
                            name: 'Pressure Sensor',
                            quantity: 3,
                            type: 'Analog 4-20mA',
                            description: 'Differential pressure sensor'
                        },
                        {
                            id: 2,
                            name: 'Door Switch',
                            quantity: 6,
                            type: 'Digital ON/OFF',
                            description: 'Door safety switches'
                        }
                    ];
                    
                    this.optionalComponents = [
                        {
                            id: 1,
                            name: 'VFD Inverter',
                            quantity: 1,
                            spec: '132kW',
                            description: 'For main fan control'
                        },
                        {
                            id: 2,
                            name: 'HMI Panel',
                            quantity: 1,
                            spec: '10 inch',
                            description: 'Touch screen interface'
                        },
                        {
                            id: 3,
                            name: 'Emergency Stop',
                            quantity: 3,
                            spec: 'Red Mushroom',
                            description: 'Emergency stop buttons'
                        }
                    ];
                },
                
                loadCustomTemplate() {
                    this.motors = [];
                    this.actuators = [];
                    this.sensors = [];
                    this.optionalComponents = [];
                },
                
                // Calculate Bill of Materials
                calculateBOM() {
                    let bom = [];
                    let totalCost = 0;
                    
                    // Calculate largest motor power
                    let largestMotorPower = 0;
                    this.motors.forEach(motor => {
                        let power = parseFloat(motor.power) || 0;
                        if (power > largestMotorPower) largestMotorPower = power;
                    });
                    
                    // Add motors and related components
                    this.motors.forEach(motor => {
                        if (motor.quantity > 0) {
                            let power = parseFloat(motor.power) || 0;
                            
                            // Motor itself
                            let motorCost = power * 150; // Estimated cost in €
                            bom.push({
                                name: motor.name,
                                quantity: motor.quantity,
                                specifications: `${motor.power}kW, ${motor.voltage}, 3-Phase`,
                                standards: 'IEC 60034-1, IP55',
                                unitPrice: motorCost,
                                tags: [`M${motor.id}`, `${motor.power}kW`]
                            });
                            totalCost += motorCost * motor.quantity;
                            
                            // Contactors for motor
                            for (let i = 0; i < motor.contactors; i++) {
                                let contactorSize = this.getContactorSize(power);
                                let contactorCost = this.getContactorCost(contactorSize);
                                bom.push({
                                    name: `Contactor for ${motor.name}`,
                                    quantity: motor.quantity,
                                    specifications: `${contactorSize}, ${motor.power}kW, 400V AC`,
                                    standards: 'IEC 60947-4-1',
                                    unitPrice: contactorCost,
                                    tags: [`KM${motor.id}`, contactorSize]
                                });
                                totalCost += contactorCost * motor.quantity;
                            }
                            
                            // Overload relay if needed
                            if (motor.hasOverload && power > 0.75) {
                                let olCost = power * 25;
                                bom.push({
                                    name: `Overload Relay for ${motor.name}`,
                                    quantity: motor.quantity,
                                    specifications: `For ${motor.power}kW motor, Adjustable`,
                                    standards: 'IEC 60947-4-1',
                                    unitPrice: olCost,
                                    tags: [`F${motor.id}`, 'OL']
                                });
                                totalCost += olCost * motor.quantity;
                            }
                            
                            // Circuit breaker
                            let breakerSize = this.getBreakerSize(power);
                            let breakerCost = breakerSize * 10;
                            bom.push({
                                name: `Circuit Breaker for ${motor.name}`,
                                quantity: motor.quantity,
                                specifications: `MCB ${breakerSize}A, 3P, Thermal-Magnetic`,
                                standards: 'IEC 60898',
                                unitPrice: breakerCost,
                                tags: [`Q${motor.id}`]
                            });
                            totalCost += breakerCost * motor.quantity;
                            
                            // Power cables
                            let cableSize = this.getCableSize(power);
                            let cableCost = cableSize * 2 * 5;
                            bom.push({
                                name: `Power Cable for ${motor.name}`,
                                quantity: motor.quantity,
                                specifications: `${cableSize}mm², 5-core, 0.6/1kV`,
                                standards: 'IEC 60228',
                                unitPrice: cableCost,
                                tags: ['Cable', `${cableSize}mm²`]
                            });
                            totalCost += cableCost * motor.quantity;
                        }
                    });
                    
                    // Add actuators
                    this.actuators.forEach(actuator => {
                        if (actuator.quantity > 0) {
                            let actuatorCost = 120;
                            bom.push({
                                name: actuator.name,
                                quantity: actuator.quantity,
                                specifications: `${actuator.voltage}, ${actuator.hasPositioner ? 'with positioner' : 'without positioner'}`,
                                standards: 'IEC 60534',
                                unitPrice: actuatorCost,
                                tags: [`A${actuator.id}`]
                            });
                            totalCost += actuatorCost * actuator.quantity;
                            
                            // Relay for actuator
                            let relayCost = 15;
                            bom.push({
                                name: `Relay for ${actuator.name}`,
                                quantity: actuator.quantity,
                                specifications: `${actuator.voltage} coil, 2NO+2NC`,
                                standards: 'IEC 61810',
                                unitPrice: relayCost,
                                tags: [`K${actuator.id}`]
                            });
                            totalCost += relayCost * actuator.quantity;
                            
                            // Positioner if needed
                            if (actuator.hasPositioner) {
                                let positionerCost = 85;
                                bom.push({
                                    name: `Positioner for ${actuator.name}`,
                                    quantity: actuator.quantity,
                                    specifications: `Analog ${actuator.readPosition ? 'Input/Output' : 'Output'}`,
                                    standards: 'IEC 60534',
                                    unitPrice: positionerCost,
                                    tags: [`P${actuator.id}`]
                                });
                                totalCost += positionerCost * actuator.quantity;
                            }
                        }
                    });
                    
                    // Add sensors
                    this.sensors.forEach(sensor => {
                        if (sensor.quantity > 0) {
                            let sensorCost = sensor.type.includes('Analog') ? 95 : 25;
                            bom.push({
                                name: sensor.name,
                                quantity: sensor.quantity,
                                specifications: `${sensor.type}`,
                                standards: sensor.name.includes('Temperature') ? 'IEC 60751' : 'IEC 60770',
                                unitPrice: sensorCost,
                                tags: [`S${sensor.id}`]
                            });
                            totalCost += sensorCost * sensor.quantity;
                        }
                    });
                    
                    // Add optional components
                    this.optionalComponents.forEach(optional => {
                        if (optional.quantity > 0) {
                            let cost = 0;
                            let spec = optional.spec;
                            
                            if (optional.name.includes('VFD')) {
                                cost = largestMotorPower * 100;
                                if (this.starterType === 'inverter') {
                                    spec = `${largestMotorPower}kW, 400V AC, Vector Control`;
                                }
                            } else if (optional.name.includes('Soft')) {
                                cost = largestMotorPower * 80;
                                if (this.starterType === 'soft') {
                                    spec = `${largestMotorPower}kW, 400V AC, Soft Start`;
                                }
                            } else if (optional.name.includes('HMI')) {
                                cost = 450;
                            } else if (optional.name.includes('Heat')) {
                                cost = 35;
                            } else {
                                cost = 50;
                            }
                            
                            if (cost > 0) {
                                bom.push({
                                    name: optional.name,
                                    quantity: optional.quantity,
                                    specifications: spec,
                                    standards: optional.name.includes('HMI') ? 'IP65' : 'IEC 61800',
                                    unitPrice: cost,
                                    tags: optional.name.includes('HMI') ? ['HMI'] : optional.name.includes('VFD') ? ['VFD'] : optional.name.includes('Soft') ? ['SS'] : ['Sensor']
                                });
                                totalCost += cost * optional.quantity;
                            }
                        }
                    });
                    
                    // Add PLC system
                    let diCount = this.calculateDigitalInputs();
                    let doCount = this.calculateDigitalOutputs();
                    let aiCount = this.calculateAnalogInputs();
                    let aoCount = this.calculateAnalogOutputs();
                    
                    // PLC CPU
                    let plcCost = 850;
                    bom.push({
                        name: 'PLC CPU',
                        quantity: 1,
                        specifications: `Siemens S7-1200, ${Math.max(24, diCount)}DI/${Math.max(16, doCount)}DO/${Math.max(4, aiCount)}AI`,
                        standards: 'IEC 61131',
                        unitPrice: plcCost,
                        tags: ['CPU1214C', 'PLC']
                    });
                    totalCost += plcCost;
                    
                    // Additional modules if needed
                    if (diCount > 24) {
                        let diModules = Math.ceil((diCount - 24) / 16);
                        bom.push({
                            name: 'Digital Input Module',
                            quantity: diModules,
                            specifications: '16DI, 24V DC',
                            standards: 'IEC 61131',
                            unitPrice: 120,
                            tags: ['SM1221', 'DI']
                        });
                        totalCost += 120 * diModules;
                    }
                    
                    if (doCount > 16) {
                        let doModules = Math.ceil((doCount - 16) / 16);
                        bom.push({
                            name: 'Digital Output Module',
                            quantity: doModules,
                            specifications: '16DO, Relay',
                            standards: 'IEC 61131',
                            unitPrice: 135,
                            tags: ['SM1222', 'DO']
                        });
                        totalCost += 135 * doModules;
                    }
                    
                    if (aiCount > 4) {
                        let aiModules = Math.ceil((aiCount - 4) / 4);
                        bom.push({
                            name: 'Analog Input Module',
                            quantity: aiModules,
                            specifications: '4AI, 4-20mA',
                            standards: 'IEC 61131',
                            unitPrice: 185,
                            tags: ['SM1231', 'AI']
                        });
                        totalCost += 185 * aiModules;
                    }
                    
                    if (aoCount > 2) {
                        let aoModules = Math.ceil(aoCount / 2);
                        bom.push({
                            name: 'Analog Output Module',
                            quantity: aoModules,
                            specifications: '2AO, 4-20mA',
                            standards: 'IEC 61131',
                            unitPrice: 195,
                            tags: ['SM1232', 'AO']
                        });
                        totalCost += 195 * aoModules;
                    }
                    
                    // Power supply
                    bom.push({
                        name: 'Power Supply',
                        quantity: 1,
                        specifications: '24V DC, 5A, Switching',
                        standards: 'IEC 61010',
                        unitPrice: 85,
                        tags: ['PSU', '24V']
                    });
                    totalCost += 85;
                    
                    // Main circuit breaker
                    bom.push({
                        name: 'Main Circuit Breaker',
                        quantity: 1,
                        specifications: '100A, 4P, 10kA',
                        standards: 'IEC 60947-2',
                        unitPrice: 120,
                        tags: ['Q0', 'Main']
                    });
                    totalCost += 120;
                    
                    // Control transformer if needed
                    bom.push({
                        name: 'Control Transformer',
                        quantity: 1,
                        specifications: '400V/230V, 500VA',
                        standards: 'IEC 61558',
                        unitPrice: 95,
                        tags: ['TR1']
                    });
                    totalCost += 95;
                    
                    // Terminal blocks
                    let terminalPoints = diCount + doCount + aiCount + aoCount + 20;
                    let terminalBlocks = Math.ceil(terminalPoints / 12);
                    bom.push({
                        name: 'Terminal Block',
                        quantity: terminalBlocks,
                        specifications: '12 positions, 600V, Screw Type',
                        standards: 'IEC 60947',
                        unitPrice: 8,
                        tags: ['TB', 'Terminal']
                    });
                    totalCost += 8 * terminalBlocks;
                    
                    // Cabinet
                    let cabinetCost = 350;
                    bom.push({
                        name: 'Control Cabinet',
                        quantity: 1,
                        specifications: this.cabinetSize + ', IP54, Steel',
                        standards: 'IEC 60529',
                        unitPrice: cabinetCost,
                        tags: ['Cabinet', 'Enclosure']
                    });
                    totalCost += cabinetCost;
                    
                    // Wiring
                    let controlWireLength = 50 + (diCount + doCount) * 2 + (aiCount + aoCount) * 3;
                    let controlWireReels = Math.ceil(controlWireLength / 100);
                    bom.push({
                        name: 'Control Wire',
                        quantity: controlWireReels,
                        specifications: '1.5mm², Black, 100m Reel',
                        standards: 'IEC 60228',
                        unitPrice: 45,
                        tags: ['Wire', '1.5mm²']
                    });
                    totalCost += 45 * controlWireReels;
                    
                    let powerWireLength = this.motors.reduce((sum, motor) => sum + (motor.quantity * 10), 0);
                    let powerWireReels = Math.ceil(powerWireLength / 50);
                    bom.push({
                        name: 'Power Wire',
                        quantity: powerWireReels,
                        specifications: '4mm², 5-core, 50m Reel',
                        standards: 'IEC 60228',
                        unitPrice: 120,
                        tags: ['Power', '4mm²']
                    });
                    totalCost += 120 * powerWireReels;
                    
                    // Cable ducts
                    bom.push({
                        name: 'Cable Duct',
                        quantity: 6,
                        specifications: '40x40mm, PVC, 2m Length',
                        standards: 'IEC 61084',
                        unitPrice: 12,
                        tags: ['Duct', 'Cable Management']
                    });
                    totalCost += 12 * 6;
                    
                    // DIN rails
                    bom.push({
                        name: 'DIN Rail',
                        quantity: 8,
                        specifications: '35mm, 1m Length, Aluminum',
                        standards: 'IEC 60715',
                        unitPrice: 6,
                        tags: ['DIN', 'Rail']
                    });
                    totalCost += 6 * 8;
                    
                    // Emergency stop
                    bom.push({
                        name: 'Emergency Stop Button',
                        quantity: 2,
                        specifications: 'Red Mushroom, NC Contact',
                        standards: 'IEC 60947',
                        unitPrice: 25,
                        tags: ['Emergency', 'E-Stop']
                    });
                    totalCost += 25 * 2;
                    
                    // Control buttons and indicators
                    bom.push({
                        name: 'Control Button Set',
                        quantity: 1,
                        specifications: 'Start/Stop/Reset, Green/Red/Yellow',
                        standards: 'IEC 60947',
                        unitPrice: 35,
                        tags: ['Buttons', 'Indicators']
                    });
                    totalCost += 35;
                    
                    // Fuses
                    bom.push({
                        name: 'Fuse Set',
                        quantity: 1,
                        specifications: '10A, 16A, 20A, 32A, 5x20mm',
                        standards: 'IEC 60127',
                        unitPrice: 25,
                        tags: ['Fuses', 'Protection']
                    });
                    totalCost += 25;
                    
                    // Grounding
                    bom.push({
                        name: 'Grounding Kit',
                        quantity: 1,
                        specifications: '16mm², Lugs, Bolts',
                        standards: 'IEC 60364',
                        unitPrice: 45,
                        tags: ['Ground', 'Earth']
                    });
                    totalCost += 45;
                    
                    // Labels and markers
                    bom.push({
                        name: 'Labeling Kit',
                        quantity: 1,
                        specifications: 'Wire Markers, Component Labels',
                        standards: 'ISO 3864',
                        unitPrice: 30,
                        tags: ['Labels', 'Marking']
                    });
                    totalCost += 30;
                    
                    this.bom = bom;
                    this.totalCost = Math.round(totalCost);
                    this.updateCounts();
                },
                
                // Helper methods for calculations
                getContactorSize(power) {
                    if (power <= 4) return 'Size 0';
                    if (power <= 7.5) return 'Size 1';
                    if (power <= 15) return 'Size 2';
                    if (power <= 30) return 'Size 3';
                    if (power <= 45) return 'Size 4';
                    return 'Size 5';
                },
                
                getContactorCost(size) {
                    const costs = {
                        'Size 0': 25,
                        'Size 1': 35,
                        'Size 2': 50,
                        'Size 3': 75,
                        'Size 4': 110,
                        'Size 5': 160
                    };
                    return costs[size] || 50;
                },
                
                getBreakerSize(power) {
                    // Simple calculation: 1kW ≈ 2A at 400V 3-phase
                    let current = power * 2 * 1.25; // 25% safety margin
                    if (current <= 10) return 10;
                    if (current <= 16) return 16;
                    if (current <= 20) return 20;
                    if (current <= 25) return 25;
                    if (current <= 32) return 32;
                    if (current <= 40) return 40;
                    if (current <= 50) return 50;
                    return 63;
                },
                
                getCableSize(power) {
                    if (power <= 1.5) return 1.5;
                    if (power <= 3) return 2.5;
                    if (power <= 5.5) return 4;
                    if (power <= 7.5) return 6;
                    if (power <= 11) return 10;
                    if (power <= 15) return 16;
                    if (power <= 22) return 25;
                    return 35;
                },
                
                calculateDigitalInputs() {
                    let count = 0;
                    // Micro switches
                    let microSwitch = this.sensors.find(s => s.name.includes('Micro') || s.name.includes('Switch'));
                    if (microSwitch) count += microSwitch.quantity;
                    // Door switches
                    let doorSwitch = this.sensors.find(s => s.name.includes('Door'));
                    if (doorSwitch) count += doorSwitch.quantity;
                    // Emergency stops
                    count += 2; // Always include 2 emergency stops
                    // Control buttons
                    count += 3; // Start, Stop, Reset
                    return count;
                },
                
                calculateDigitalOutputs() {
                    let count = 0;
                    // Motor contactors
                    this.motors.forEach(motor => {
                        count += motor.quantity * motor.contactors;
                    });
                    // Actuator relays
                    this.actuators.forEach(actuator => {
                        count += actuator.quantity;
                    });
                    // Indicators
                    count += 3; // Power, Run, Fault
                    return count;
                },
                
                calculateAnalogInputs() {
                    let count = 0;
                    // Temperature sensors
                    let tempSensors = this.sensors.filter(s => s.name.includes('Temperature'));
                    tempSensors.forEach(s => count += s.quantity);
                    // Humidity sensors
                    let humiditySensors = this.sensors.filter(s => s.name.includes('Humidity'));
                    humiditySensors.forEach(s => count += s.quantity);
                    // Pressure sensors
                    let pressureSensors = this.sensors.filter(s => s.name.includes('Pressure'));
                    pressureSensors.forEach(s => count += s.quantity);
                    // Actuator position feedback
                    this.actuators.forEach(actuator => {
                        if (actuator.hasPositioner && actuator.readPosition) {
                            count += actuator.quantity;
                        }
                    });
                    return count;
                },
                
                calculateAnalogOutputs() {
                    let count = 0;
                    // Actuator position control
                    this.actuators.forEach(actuator => {
                        if (actuator.hasPositioner) {
                            count += actuator.quantity;
                        }
                    });
                    // VFD speed control if present
                    let vfd = this.optionalComponents.find(o => o.name.includes('VFD'));
                    if (vfd && vfd.quantity > 0 && this.starterType === 'inverter') {
                        count += this.motors.filter(m => parseFloat(m.power) > 5).length;
                    }
                    return count;
                },
                
                updateCounts() {
                    this.relayCount = this.actuators.reduce((sum, a) => sum + a.quantity, 0);
                    this.contactorCount = this.motors.reduce((sum, m) => sum + (m.quantity * m.contactors), 0);
                    let terminalPoints = this.calculateDigitalInputs() + this.calculateDigitalOutputs() + 
                                       this.calculateAnalogInputs() + this.calculateAnalogOutputs() + 20;
                    this.terminalCount = Math.ceil(terminalPoints / 12);
                },
                
                // Layout generation
                generateLayout() {
                    let layout = [];
                    let gridX = 1;
                    let gridY = 1;
                    
                    // PLC and PSU at top
                    layout.push({
                        type: 'plc',
                        tag: 'PLC',
                        details: 'S7-1200',
                        width: 32, // 2 columns
                        height: 40, // 2 rows
                        x: gridX,
                        y: gridY
                    });
                    
                    gridX += 2;
                    
                    layout.push({
                        type: 'psu',
                        tag: 'PSU',
                        details: '24V/5A',
                        width: 32,
                        height: 40,
                        x: gridX,
                        y: gridY
                    });
                    
                    gridX += 2;
                    
                    // Main breaker
                    layout.push({
                        type: 'breaker',
                        tag: 'Q0',
                        details: '100A 4P',
                        width: 32,
                        height: 40,
                        x: gridX,
                        y: gridY
                    });
                    
                    // Next row: Contactors
                    gridX = 1;
                    gridY += 2;
                    
                    let contactorIndex = 1;
                    this.motors.forEach(motor => {
                        for (let i = 0; i < motor.quantity; i++) {
                            for (let c = 0; c < motor.contactors; c++) {
                                layout.push({
                                    type: 'contactor',
                                    tag: `KM${contactorIndex}`,
                                    details: `${motor.power}kW`,
                                    width: 32,
                                    height: 40,
                                    x: gridX,
                                    y: gridY
                                });
                                
                                gridX += 2;
                                if (gridX > 10) {
                                    gridX = 1;
                                    gridY += 2;
                                }
                                contactorIndex++;
                            }
                        }
                    });
                    
                    // Relays row
                    if (gridX > 1) {
                        gridY += 2;
                        gridX = 1;
                    }
                    
                    let relayIndex = 1;
                    this.actuators.forEach(actuator => {
                        for (let i = 0; i < actuator.quantity; i++) {
                            layout.push({
                                type: 'relay',
                                tag: `K${relayIndex}`,
                                details: '24V DC',
                                width: 16,
                                height: 20,
                                x: gridX,
                                y: gridY
                            });
                            
                            gridX += 1;
                            if (gridX > 12) {
                                gridX = 1;
                                gridY += 1;
                            }
                            relayIndex++;
                        }
                    });
                    
                    // Optional components
                    let vfd = this.optionalComponents.find(c => c.name.includes('VFD'));
                    let softStarter = this.optionalComponents.find(c => c.name.includes('Soft'));
                    
                    if (gridX > 1) {
                        gridY += 1;
                        gridX = 1;
                    }
                    
                    if (vfd && vfd.quantity > 0 && this.starterType === 'inverter') {
                        layout.push({
                            type: 'inverter',
                            tag: 'VFD1',
                            details: `${vfd.spec}`,
                            width: 80,
                            height: 80,
                            x: gridX,
                            y: gridY
                        });
                        gridX += 5;
                    }
                    
                    if (softStarter && softStarter.quantity > 0 && this.starterType === 'soft') {
                        layout.push({
                            type: 'soft-starter',
                            tag: 'SS1',
                            details: `${softStarter.spec}`,
                            width: 80,
                            height: 40,
                            x: gridX,
                            y: gridY
                        });
                        gridX += 5;
                    }
                    
                    // Terminal blocks at bottom
                    if (gridX > 1) {
                        gridY += 4;
                        gridX = 1;
                    }
                    
                    layout.push({
                        type: 'terminal',
                        tag: 'Terminals',
                        details: `${this.terminalCount} blocks`,
                        width: 96,
                        height: 40,
                        x: gridX,
                        y: gridY
                    });
                    
                    this.layoutComponents = layout;
                },
                
                getLayoutStyle(component) {
                    // Convert cm to grid units (16cm = 1 grid column, 20cm = 1 grid row)
                    const gridCols = Math.max(1, Math.round(component.width / 16));
                    const gridRows = Math.max(1, Math.round(component.height / 20));
                    
                    return `
                        grid-column: ${component.x} / span ${gridCols};
                        grid-row: ${component.y} / span ${gridRows};
                    `;
                },
                
                // Connection generation
                generateConnections() {
                    let connections = [];
                    let connId = 1;
                    
                    // Motor connections
                    this.motors.forEach(motor => {
                        for (let i = 0; i < motor.quantity; i++) {
                            connections.push({
                                id: connId++,
                                from: `Q${motor.id}.${i+1}`,
                                to: `KM${motor.id}.${i+1}`,
                                type: 'Power',
                                wireSize: `${this.getCableSize(parseFloat(motor.power))}mm²`,
                                length: '15',
                                terminal: `TB${Math.floor(connId/10)+1}`,
                                color: 'Black',
                                voltage: '400V AC'
                            });
                            
                            connections.push({
                                id: connId++,
                                from: `PLC Q0.${i}`,
                                to: `KM${motor.id}.${i+1} A1`,
                                type: 'Control',
                                wireSize: '1.5mm²',
                                length: '3',
                                terminal: `TB${Math.floor(connId/10)+1}`,
                                color: 'Blue',
                                voltage: '24V DC'
                            });
                        }
                    });
                    
                    // Actuator connections
                    this.actuators.forEach(actuator => {
                        for (let i = 0; i < actuator.quantity; i++) {
                            connections.push({
                                id: connId++,
                                from: `PLC Q1.${i}`,
                                to: `K${actuator.id}.${i+1} A1`,
                                type: 'Control',
                                wireSize: '1.5mm²',
                                length: '2.5',
                                terminal: `TB${Math.floor(connId/10)+1}`,
                                color: 'White',
                                voltage: '24V DC'
                            });
                            
                            connections.push({
                                id: connId++,
                                from: `K${actuator.id}.${i+1} 13`,
                                to: `A${actuator.id}.${i+1}`,
                                type: 'Actuator',
                                wireSize: '1.5mm²',
                                length: '5',
                                terminal: `TB${Math.floor(connId/10)+1}`,
                                color: 'Gray',
                                voltage: actuator.voltage
                            });
                        }
                    });
                    
                    this.connections = connections;
                },
                
                // I/O Lists
                generateIOLists() {
                    this.digitalInputs = [];
                    this.digitalOutputs = [];
                    this.analogInputs = [];
                    this.analogOutputs = [];
                    
                    let diAddr = 0;
                    let doAddr = 0;
                    let aiAddr = 0;
                    let aoAddr = 0;
                    
                    // Digital Inputs
                    // Emergency stops
                    this.digitalInputs.push({ name: 'Emergency Stop 1', address: `I${diAddr}.0` });
                    this.digitalInputs.push({ name: 'Emergency Stop 2', address: `I${diAddr}.1` });
                    diAddr++;
                    
                    // Control buttons
                    this.digitalInputs.push({ name: 'Start Button', address: `I${diAddr}.0` });
                    this.digitalInputs.push({ name: 'Stop Button', address: `I${diAddr}.1` });
                    this.digitalInputs.push({ name: 'Reset Button', address: `I${diAddr}.2` });
                    
                    // Door switches
                    let doorSwitches = this.sensors.filter(s => s.name.includes('Door') || s.name.includes('Micro'));
                    doorSwitches.forEach(sensor => {
                        for (let i = 0; i < sensor.quantity; i++) {
                            this.digitalInputs.push({ 
                                name: `${sensor.name} ${i+1}`, 
                                address: `I${diAddr}.${i}` 
                            });
                        }
                        diAddr++;
                    });
                    
                    // Digital Outputs
                    // Motor contactors
                    let motorIndex = 0;
                    this.motors.forEach(motor => {
                        for (let i = 0; i < motor.quantity; i++) {
                            for (let c = 0; c < motor.contactors; c++) {
                                this.digitalOutputs.push({
                                    name: `${motor.name} ${i+1} Contactor ${c+1}`,
                                    address: `Q${doAddr}.${motorIndex}`
                                });
                                motorIndex++;
                            }
                        }
                        doAddr++;
                    });
                    
                    // Actuator relays
                    let actuatorIndex = 0;
                    this.actuators.forEach(actuator => {
                        for (let i = 0; i < actuator.quantity; i++) {
                            this.digitalOutputs.push({
                                name: `${actuator.name} ${i+1}`,
                                address: `Q${doAddr}.${actuatorIndex}`
                            });
                            actuatorIndex++;
                        }
                        doAddr++;
                    });
                    
                    // Indicators
                    this.digitalOutputs.push({ name: 'Power Indicator', address: `Q${doAddr}.0` });
                    this.digitalOutputs.push({ name: 'Run Indicator', address: `Q${doAddr}.1` });
                    this.digitalOutputs.push({ name: 'Fault Indicator', address: `Q${doAddr}.2` });
                    
                    // Analog Inputs
                    // Temperature sensors
                    let tempSensors = this.sensors.filter(s => s.name.includes('Temperature'));
                    tempSensors.forEach(sensor => {
                        for (let i = 0; i < sensor.quantity; i++) {
                            this.analogInputs.push({
                                name: `${sensor.name} ${i+1}`,
                                address: `AI${aiAddr}.${i}`
                            });
                        }
                        aiAddr++;
                    });
                    
                    // Humidity sensors
                    let humiditySensors = this.sensors.filter(s => s.name.includes('Humidity'));
                    humiditySensors.forEach(sensor => {
                        for (let i = 0; i < sensor.quantity; i++) {
                            this.analogInputs.push({
                                name: `${sensor.name} ${i+1}`,
                                address: `AI${aiAddr}.${i}`
                            });
                        }
                        aiAddr++;
                    });
                    
                    // Actuator position feedback
                    this.actuators.forEach(actuator => {
                        if (actuator.hasPositioner && actuator.readPosition) {
                            for (let i = 0; i < actuator.quantity; i++) {
                                this.analogInputs.push({
                                    name: `${actuator.name} ${i+1} Position`,
                                    address: `AI${aiAddr}.${i}`
                                });
                            }
                            aiAddr++;
                        }
                    });
                    
                    // Analog Outputs
                    // Actuator position control
                    this.actuators.forEach(actuator => {
                        if (actuator.hasPositioner) {
                            for (let i = 0; i < actuator.quantity; i++) {
                                this.analogOutputs.push({
                                    name: `${actuator.name} ${i+1} Control`,
                                    address: `AQ${aoAddr}.${i}`
                                });
                            }
                            aoAddr++;
                        }
                    });
                },
                
                // Database operations
                async testConnection() {
                    // Simulate database connection
                    this.dbConnected = true;
                    alert('Database connection test successful!');
                },
                
                saveToDatabase() {
                    const project = {
                        name: `PLC Project ${new Date().toLocaleDateString()}`,
                        data: this.getProjectJSON(),
                        created_at: new Date().toISOString()
                    };
                    
                    // Save to localStorage (simulating database)
                    let projects = JSON.parse(localStorage.getItem('plc_projects') || '[]');
                    project.id = projects.length + 1;
                    projects.push(project);
                    localStorage.setItem('plc_projects', JSON.stringify(projects));
                    
                    this.dbProjects = projects;
                    alert('Project saved to database!');
                },
                
                loadFromDatabase() {
                    this.dbProjects = JSON.parse(localStorage.getItem('plc_projects') || '[]');
                    if (this.dbProjects.length === 0) {
                        alert('No projects found in database.');
                    }
                },
                
                loadProjectFromDB(id) {
                    let projects = JSON.parse(localStorage.getItem('plc_projects') || '[]');
                    let project = projects.find(p => p.id === id);
                    if (project) {
                        this.importProject(project.data);
                        alert('Project loaded from database!');
                    }
                },
                
                deleteProjectFromDB(id) {
                    if (confirm('Are you sure you want to delete this project?')) {
                        let projects = JSON.parse(localStorage.getItem('plc_projects') || '[]');
                        projects = projects.filter(p => p.id !== id);
                        localStorage.setItem('plc_projects', JSON.stringify(projects));
                        this.dbProjects = projects;
                    }
                },
                
                installDatabase() {
                    // Generate SQL schema
                    const schema = `
-- PLC Designer Database Schema
CREATE DATABASE IF NOT EXISTS esmartis_plc;
USE esmartis_plc;

CREATE TABLE IF NOT EXISTS projects (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    template VARCHAR(50),
    data JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS components (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT,
    type ENUM('motor', 'actuator', 'sensor', 'optional'),
    name VARCHAR(100),
    quantity INT,
    specifications TEXT,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS bom_items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT,
    name VARCHAR(255),
    quantity INT,
    unit_price DECIMAL(10,2),
    total_price DECIMAL(10,2),
    standards VARCHAR(100),
    tags JSON,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS templates (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    category VARCHAR(50),
    description TEXT,
    data JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO templates (name, category, description) VALUES
('Evaporative Ventilation', 'ventilation', 'Complete PLC system for textile ventilation'),
('Filter Plant', 'filtration', 'Multi-room filter plant control system'),
('Pumping Station', 'pumping', 'Water pumping control system');
                    `;
                    
                    // Show schema
                    this.showModal = null;
                    const newWindow = window.open();
                    newWindow.document.write('<pre>' + schema + '</pre>');
                    newWindow.document.title = 'Database Schema';
                },
                
                exportDatabaseSchema() {
                    const schema = this.generateSQLSchema();
                    const blob = new Blob([schema], { type: 'text/sql' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'plc_database_schema.sql';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },
                
                generateSQLSchema() {
                    return `-- PLC Designer Database Schema
-- Generated on ${new Date().toLocaleString()}

CREATE DATABASE IF NOT EXISTS esmartis_plc;
USE esmartis_plc;

CREATE TABLE IF NOT EXISTS users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    email VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS projects (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    template_type VARCHAR(50),
    data JSON,
    total_cost DECIMAL(10,2),
    cabinet_size VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS components (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT,
    component_type VARCHAR(50),
    name VARCHAR(255),
    quantity INT DEFAULT 1,
    specifications TEXT,
    unit_price DECIMAL(10,2),
    standards VARCHAR(255),
    tags JSON,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE,
    INDEX idx_project_type (project_id, component_type)
);

CREATE TABLE IF NOT EXISTS bom_items (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT,
    item_number INT,
    name VARCHAR(255),
    quantity INT,
    specifications TEXT,
    standards VARCHAR(100),
    unit_price DECIMAL(10,2),
    total_price DECIMAL(10,2),
    tags JSON,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS connections (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT,
    from_point VARCHAR(100),
    to_point VARCHAR(100),
    connection_type VARCHAR(50),
    wire_size VARCHAR(20),
    length DECIMAL(5,2),
    terminal VARCHAR(50),
    color VARCHAR(20),
    voltage VARCHAR(20),
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS layouts (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT,
    component_type VARCHAR(50),
    tag VARCHAR(50),
    details VARCHAR(100),
    x_position INT,
    y_position INT,
    width INT,
    height INT,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS plc_io (
    id INT AUTO_INCREMENT PRIMARY KEY,
    project_id INT,
    io_type ENUM('DI', 'DO', 'AI', 'AO'),
    name VARCHAR(255),
    address VARCHAR(50),
    description TEXT,
    FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);

CREATE TABLE IF NOT EXISTS templates (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    category VARCHAR(50),
    description TEXT,
    author VARCHAR(100),
    data JSON,
    download_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

-- Default user (for testing)
INSERT INTO users (username, password_hash, email) VALUES
('esmartis_user', MD5('esmartis1364'), 'admin@esmartis.com');

-- Sample template data
INSERT INTO templates (name, category, description, author) VALUES
('Evaporative Ventilation Station', 'Ventilation', 'Textile industry evaporative cooling system', 'System'),
('Filter Plant Control', 'Filtration', 'Multi-room air filtration system', 'System'),
('Water Pumping Station', 'Pumping', 'Industrial water pumping control', 'System');

-- Indexes for better performance
CREATE INDEX idx_projects_user ON projects(user_id);
CREATE INDEX idx_components_project ON components(project_id);
CREATE INDEX idx_bom_project ON bom_items(project_id);
CREATE INDEX idx_connections_project ON connections(project_id);
CREATE INDEX idx_templates_category ON templates(category);`;
                },
                
                // Project management
                getProjectJSON() {
                    const project = {
                        motors: this.motors,
                        actuators: this.actuators,
                        sensors: this.sensors,
                        optionalComponents: this.optionalComponents,
                        starterType: this.starterType,
                        template: this.selectedTemplate,
                        bom: this.bom,
                        layoutComponents: this.layoutComponents,
                        connections: this.connections,
                        digitalInputs: this.digitalInputs,
                        digitalOutputs: this.digitalOutputs,
                        analogInputs: this.analogInputs,
                        analogOutputs: this.analogOutputs,
                        totalCost: this.totalCost,
                        cabinetSize: this.cabinetSize,
                        generatedAt: new Date().toISOString()
                    };
                    return JSON.stringify(project, null, 2);
                },
                
                saveProject() {
                    const json = this.getProjectJSON();
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `plc-project-${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },
                
                loadProject() {
                    document.getElementById('fileInput').click();
                },
                
                loadProjectFromFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            this.importProject(e.target.result);
                            alert('Project loaded successfully!');
                        } catch (error) {
                            alert('Error loading project: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = '';
                },
                
                importProject(jsonString) {
                    const project = JSON.parse(jsonString);
                    
                    // Import all data
                    this.motors = project.motors || [];
                    this.actuators = project.actuators || [];
                    this.sensors = project.sensors || [];
                    this.optionalComponents = project.optionalComponents || [];
                    this.starterType = project.starterType || 'soft';
                    this.selectedTemplate = project.template || 'custom';
                    this.bom = project.bom || [];
                    this.layoutComponents = project.layoutComponents || [];
                    this.connections = project.connections || [];
                    this.digitalInputs = project.digitalInputs || [];
                    this.digitalOutputs = project.digitalOutputs || [];
                    this.analogInputs = project.analogInputs || [];
                    this.analogOutputs = project.analogOutputs || [];
                    this.totalCost = project.totalCost || 0;
                    this.cabinetSize = project.cabinetSize || '800x600x200mm';
                    
                    // Recalculate if needed
                    if (this.bom.length === 0) {
                        this.calculateBOM();
                        this.generateLayout();
                        this.generateConnections();
                        this.generateIOLists();
                    }
                },
                
                // Export functions
                exportBOM() {
                    // Convert BOM to CSV
                    let csv = 'Item #,Component,Quantity,Specifications,Standards,Unit Price (€),Total Price (€),Tags\n';
                    this.bom.forEach((item, index) => {
                        const tags = item.tags ? item.tags.join(';') : '';
                        const total = (item.unitPrice * item.quantity).toFixed(2);
                        csv += `${index + 1},"${item.name}",${item.quantity},"${item.specifications}","${item.standards}",${item.unitPrice},${total},"${tags}"\n`;
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `plc-bom-${new Date().toISOString().slice(0, 10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },
                
                exportJSON() {
                    this.saveProject();
                },
                
                async exportPDF() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('p', 'mm', 'a4');
                    
                    // Title
                    doc.setFontSize(20);
                    doc.text('PLC Control Panel Design Report', 105, 20, { align: 'center' });
                    doc.setFontSize(12);
                    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
                    
                    // Summary
                    doc.setFontSize(14);
                    doc.text('Project Summary', 20, 45);
                    doc.setFontSize(10);
                    doc.text(`Total Components: ${this.bom.length}`, 20, 55);
                    doc.text(`Estimated Cost: ${this.totalCost} €`, 20, 60);
                    doc.text(`Cabinet Size: ${this.cabinetSize}`, 20, 65);
                    doc.text(`PLC I/O: ${this.digitalInputs.length} DI, ${this.digitalOutputs.length} DO, ${this.analogInputs.length} AI, ${this.analogOutputs.length} AO`, 20, 70);
                    
                    // BOM Table
                    let yPos = 85;
                    doc.setFontSize(12);
                    doc.text('Bill of Materials', 20, yPos);
                    yPos += 10;
                    
                    // Table headers
                    doc.setFontSize(8);
                    doc.text('#', 20, yPos);
                    doc.text('Component', 30, yPos);
                    doc.text('Qty', 100, yPos);
                    doc.text('Unit Price', 115, yPos);
                    doc.text('Total', 140, yPos);
                    yPos += 5;
                    doc.line(20, yPos, 190, yPos);
                    yPos += 5;
                    
                    // Table rows
                    this.bom.forEach((item, index) => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        doc.text(`${index + 1}`, 20, yPos);
                        doc.text(item.name.substring(0, 30), 30, yPos);
                        doc.text(`${item.quantity}`, 100, yPos);
                        doc.text(`${item.unitPrice} €`, 115, yPos);
                        doc.text(`${(item.unitPrice * item.quantity).toFixed(2)} €`, 140, yPos);
                        yPos += 7;
                    });
                    
                    // Save PDF
                    doc.save(`plc-design-${new Date().toISOString().slice(0, 10)}.pdf`);
                },
                
                async exportImage() {
                    const layoutElement = document.querySelector('.layout-grid');
                    const canvas = await html2canvas(layoutElement);
                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = `plc-layout-${new Date().toISOString().slice(0, 10)}.png`;
                    link.click();
                },
                
                // Print functions
                printBOM() {
                    const printContent = document.querySelector('.bom-table-container').innerHTML;
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                            <head>
                                <title>PLC BOM Print</title>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 20px; }
                                    table { width: 100%; border-collapse: collapse; }
                                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                                    th { background-color: #f2f2f2; }
                                    h1 { color: #2c3e50; }
                                </style>
                            </head>
                            <body>
                                <h1>PLC Bill of Materials</h1>
                                <p>Generated: ${new Date().toLocaleDateString()}</p>
                                ${printContent}
                            </body>
                        </html>
                    `);
                    printWindow.document.close();
                    printWindow.print();
                },
                
                printLayout() {
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                            <head>
                                <title>PLC Layout Print</title>
                                <style>
                                    body { font-family: Arial, sans-serif; margin: 20px; }
                                    .layout-grid { 
                                        display: grid; 
                                        grid-template-columns: repeat(12, 20mm); 
                                        grid-auto-rows: 25mm; 
                                        gap: 2mm; 
                                        background: #f5f5f5; 
                                        padding: 10mm; 
                                    }
                                    .layout-component { 
                                        border: 1px solid #000; 
                                        padding: 2mm; 
                                        font-size: 8pt; 
                                        overflow: hidden; 
                                        break-inside: avoid; 
                                    }
                                    h1 { color: #2c3e50; }
                                </style>
                            </head>
                            <body>
                                <h1>PLC Panel Layout</h1>
                                <p>Generated: ${new Date().toLocaleDateString()}</p>
                                <div class="layout-grid">
                                    ${this.layoutComponents.map(comp => 
                                        `<div class="layout-component" style="grid-column: span ${Math.round(comp.width/16)}; grid-row: span ${Math.round(comp.height/20)};">
                                            <strong>${comp.tag}</strong><br>${comp.details}
                                        </div>`
                                    ).join('')}
                                </div>
                            </body>
                        </html>
                    `);
                    printWindow.document.close();
                    printWindow.print();
                },
                
                printFullReport() {
                    window.print();
                },
                
                // Template management
                saveCurrentAsTemplate() {
                    if (!this.newTemplateName.trim()) {
                        alert('Please enter a template name.');
                        return;
                    }
                    
                    const template = {
                        name: this.newTemplateName,
                        description: this.newTemplateDescription,
                        category: this.newTemplateCategory,
                        data: this.getProjectJSON(),
                        created: new Date().toISOString()
                    };
                    
                    // Save to localStorage
                    let templates = JSON.parse(localStorage.getItem('plc_templates') || '[]');
                    templates.push(template);
                    localStorage.setItem('plc_templates', JSON.stringify(templates));
                    
                    this.showModal = null;
                    this.newTemplateName = '';
                    this.newTemplateDescription = '';
                    alert('Template saved successfully!');
                },
                
                loadProjectsFromLocalStorage() {
                    this.dbProjects = JSON.parse(localStorage.getItem('plc_projects') || '[]');
                }
            };
        }
    </script>
</body>
</html>