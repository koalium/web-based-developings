<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>طراح پیشرفته تابلو PLC - ایستگاه تهویه تبخیری نساجی</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        @font-face {
            font-family: 'Vazir';
            src: url('https://cdn.jsdelivr.net/gh/rastikerdar/vazir-font@v30.1.0/dist/Vazir.woff2') format('woff2');
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            direction: rtl;
            text-align: right;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 15px;
        }
        
        header {
            background: linear-gradient(135deg, #2c3e50 0%, #4a6491 100%);
            color: white;
            padding: 20px 0;
            border-radius: 10px 10px 0 0;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 15px;
            flex-wrap: wrap;
        }
        
        h1 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .control-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 0.85rem;
        }
        
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #2ecc71;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }
        
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }
        
        .btn-warning {
            background-color: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #d68910;
            transform: translateY(-2px);
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-info:hover {
            background-color: #138496;
            transform: translateY(-2px);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (min-width: 768px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        @media (min-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }
        
        .card {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            margin-bottom: 15px;
            height: fit-content;
        }
        
        .card-title {
            font-size: 1.2rem;
            margin-top: 0;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .component-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .component-item {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            border-right: 4px solid #3498db;
            transition: all 0.3s ease;
        }
        
        .component-item:hover {
            background-color: #edf2f7;
            transform: translateX(-5px);
        }
        
        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .component-name {
            font-weight: 600;
            font-size: 1rem;
            color: #2c3e50;
        }
        
        .component-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .qty-btn {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: none;
            background-color: #3498db;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .qty-btn:hover {
            background-color: #2980b9;
        }
        
        .qty-display {
            min-width: 35px;
            text-align: center;
            font-weight: bold;
            font-size: 1rem;
        }
        
        .component-details {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 8px;
        }
        
        .detail-item {
            display: flex;
            flex-direction: column;
            min-width: 100px;
        }
        
        .detail-label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-bottom: 3px;
        }
        
        .detail-value {
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .detail-input {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.85rem;
            width: 100%;
            direction: ltr;
            text-align: left;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
            font-size: 0.85rem;
        }
        
        .checkbox-label {
            color: #555;
        }
        
        .layout-container {
            background-color: #2c3e50;
            border-radius: 8px;
            padding: 12px;
            min-height: 400px;
            position: relative;
            overflow: auto;
        }
        
        .layout-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, 40px);
            grid-auto-rows: 50px;
            gap: 3px;
            width: 100%;
            min-height: 400px;
            background-color: #34495e;
            padding: 12px;
            border-radius: 5px;
        }
        
        .layout-component {
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.6rem;
            text-align: center;
            padding: 3px;
            overflow: hidden;
            position: relative;
            color: white;
            font-weight: 500;
            word-break: break-word;
            cursor: move;
        }
        
        .layout-component.plc {
            background-color: #3498db;
        }
        
        .layout-component.psu {
            background-color: #9b59b6;
        }
        
        .layout-component.breaker {
            background-color: #e74c3c;
        }
        
        .layout-component.contactor {
            background-color: #2ecc71;
        }
        
        .layout-component.relay {
            background-color: #f39c12;
        }
        
        .layout-component.inverter {
            background-color: #1abc9c;
        }
        
        .layout-component.soft-starter {
            background-color: #d35400;
        }
        
        .layout-component.hmi {
            background-color: #34495e;
        }
        
        .layout-component.terminal {
            background-color: #7f8c8d;
        }
        
        .layout-component.sensor {
            background-color: #e74c3c;
        }
        
        .bom-container {
            margin-top: 15px;
        }
        
        .bom-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
            font-size: 0.85rem;
        }
        
        .bom-table th {
            background-color: #2c3e50;
            color: white;
            text-align: right;
            padding: 10px 12px;
            font-weight: 600;
        }
        
        .bom-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .bom-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .tag {
            display: inline-block;
            background-color: #ecf0f1;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin: 2px;
            font-family: monospace;
            direction: ltr;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            padding: 12px 20px;
            border-radius: 10px;
            margin-top: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            flex-wrap: wrap;
        }
        
        .total-cost {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .component-count {
            font-size: 1rem;
            color: #7f8c8d;
        }
        
        .modal {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            padding: 20px;
            width: 95%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            direction: rtl;
        }
        
        .modal-wide {
            max-width: 1200px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            margin: 0;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.95rem;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .json-editor {
            width: 100%;
            height: 300px;
            font-family: monospace;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.85rem;
            direction: ltr;
            text-align: left;
        }
        
        .connection-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .connection-item {
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border-right: 4px solid #3498db;
        }
        
        .control-scenario {
            background-color: #f0f7ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            border-right: 5px solid #3498db;
        }
        
        .scenario-title {
            font-size: 1.1rem;
            margin-top: 0;
            color: #2c3e50;
        }
        
        .scenario-text {
            font-family: monospace;
            background-color: #f8f9fa;
            padding: 12px;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
            line-height: 1.5;
            font-size: 0.85rem;
        }
        
        .color-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }
        
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 4px;
        }
        
        .template-selector {
            margin-bottom: 20px;
        }
        
        .template-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .template-btn {
            padding: 8px 15px;
            background-color: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .template-btn:hover {
            background-color: #3498db;
            color: white;
        }
        
        .template-btn.active {
            background-color: #3498db;
            color: white;
            border-color: #2980b9;
        }
        
        .wiring-canvas-container {
            background-color: #2c3e50;
            border-radius: 8px;
            padding: 12px;
            margin-top: 20px;
            min-height: 400px;
        }
        
        .wiring-canvas {
            width: 100%;
            height: 400px;
            background-color: white;
            border-radius: 5px;
        }
        
        .wiring-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .wiring-btn {
            padding: 8px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .drag-drop-info {
            background-color: #fff8e1;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.85rem;
            text-align: center;
        }
        
        .component-palette {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .palette-title {
            font-size: 1rem;
            margin-top: 0;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .palette-items {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .palette-item {
            padding: 8px 12px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: move;
            font-size: 0.85rem;
            text-align: center;
        }
        
        .dragging {
            opacity: 0.5;
        }
        
        .grid-coordinates {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background-color: rgba(0,0,0,0.7);
            color: white;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
        }
        
        .summary-card {
            background-color: #e8f5e9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .summary-title {
            font-size: 1.1rem;
            margin-top: 0;
            color: #27ae60;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .summary-item {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .summary-label {
            font-size: 0.85rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }
        
        .summary-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .mobile-menu {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
        }
        
        .mobile-menu-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: #3498db;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        
        .mobile-panel {
            position: fixed;
            bottom: 90px;
            right: 20px;
            background-color: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            width: 250px;
            display: none;
            z-index: 99;
        }
        
        .mobile-panel.active {
            display: block;
        }
        
        .mobile-panel-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        @media (max-width: 768px) {
            .mobile-menu {
                display: block;
            }
            
            .control-buttons {
                display: none;
            }
            
            .container {
                padding: 10px;
            }
            
            .card {
                padding: 15px;
            }
            
            .component-list {
                max-height: 300px;
            }
            
            .bom-table {
                font-size: 0.8rem;
            }
            
            .bom-table th, .bom-table td {
                padding: 8px 10px;
            }
            
            .layout-grid {
                grid-template-columns: repeat(auto-fill, 30px);
                grid-auto-rows: 40px;
            }
            
            .layout-component {
                font-size: 0.5rem;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.2rem;
            }
            
            .subtitle {
                font-size: 0.8rem;
            }
            
            .btn {
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .card-title {
                font-size: 1.1rem;
            }
            
            .detail-item {
                min-width: 80px;
            }
        }
        
        .no-print {
            display: block;
        }
        
        @media print {
            .no-print, .control-buttons, .status-bar, .btn, .mobile-menu, .mobile-panel {
                display: none !important;
            }
            
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
            
            .container {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div x-data="plcDesigner()" x-init="init()">
        <header>
            <div class="container">
                <div class="header-content">
                    <div>
                        <h1><i class="fas fa-industry"></i> طراح پیشرفته تابلو PLC</h1>
                        <div class="subtitle">ایستگاه تهویه تبخیری نساجی - طراحی، لیست مواد، چینش و وایرینگ</div>
                    </div>
                    <div class="control-buttons no-print">
                        <button class="btn btn-primary" @click="saveProject()">
                            <i class="fas fa-save"></i> ذخیره پروژه
                        </button>
                        <button class="btn btn-secondary" @click="loadProject()">
                            <i class="fas fa-folder-open"></i> بارگذاری پروژه
                        </button>
                        <button class="btn btn-warning" @click="showModal = 'templates'">
                            <i class="fas fa-layer-group"></i> تمپلیت‌ها
                        </button>
                        <button class="btn btn-info" @click="showModal = 'wiring'">
                            <i class="fas fa-project-diagram"></i> طراحی وایرینگ
                        </button>
                        <button class="btn btn-danger" @click="showModal = 'export'">
                            <i class="fas fa-print"></i> خروجی و پرینت
                        </button>
                    </div>
                </div>
            </div>
        </header>
        
        <div class="container">
            <!-- انتخاب تمپلیت -->
            <div class="template-selector no-print">
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-clone"></i> انتخاب تمپلیت پروژه</h2>
                    <div class="template-buttons">
                        <button class="template-btn" :class="{active: activeTemplate === 'evaporative'}" @click="loadTemplate('evaporative')">
                            ایستگاه تهویه تبخیری
                        </button>
                        <button class="template-btn" :class="{active: activeTemplate === 'vfd'}" @click="loadTemplate('vfd')">
                            تهویه با اینورتر برای هر موتور
                        </button>
                        <button class="template-btn" :class="{active: activeTemplate === 'softstart'}" @click="loadTemplate('softstart')">
                            فیلتر پلنت با سافت استارت
                        </button>
                        <button class="template-btn" :class="{active: activeTemplate === 'filter_vfd'}" @click="loadTemplate('filter_vfd')">
                            فیلتر پلنت با VFD فن اصلی
                        </button>
                        <button class="template-btn" :class="{active: activeTemplate === 'custom'}" @click="loadTemplate('custom')">
                            پروژه سفارشی
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="main-content">
                <!-- ستون اول: موتورها و عملگرها -->
                <div>
                    <!-- موتورهای سه فاز -->
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-cogs"></i> موتورهای سه فاز</h2>
                        <div class="component-list">
                            <template x-for="(motor, index) in motors" :key="index">
                                <div class="component-item">
                                    <div class="component-header">
                                        <div class="component-name" x-text="motor.name"></div>
                                        <div class="component-controls">
                                            <div class="quantity-control">
                                                <button class="qty-btn" @click="decrementQuantity(motor)">-</button>
                                                <div class="qty-display" x-text="motor.quantity"></div>
                                                <button class="qty-btn" @click="incrementQuantity(motor)">+</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="component-details">
                                        <div class="detail-item">
                                            <div class="detail-label">تعداد پیش‌فرض</div>
                                            <div class="detail-value" x-text="motor.defaultQuantity"></div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">توان (کیلووات)</div>
                                            <input type="text" class="detail-input" x-model="motor.power" @change="calculateComponents()" dir="ltr">
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">ولتاژ</div>
                                            <div class="detail-value">400V AC</div>
                                        </div>
                                    </div>
                                    <div class="checkbox-group" x-show="motor.hasOver5kw">
                                        <input type="checkbox" id="softstarter" x-model="useSoftStarter">
                                        <label class="checkbox-label" for="softstarter">استفاده از سافت استارتر (برای موتورهای بالای ۵ کیلووات)</label>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- عملگرها -->
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-sliders-h"></i> عملگرها (Actuators)</h2>
                        <div class="component-list">
                            <template x-for="(actuator, index) in actuators" :key="index">
                                <div class="component-item">
                                    <div class="component-header">
                                        <div class="component-name" x-text="actuator.name"></div>
                                        <div class="component-controls">
                                            <div class="quantity-control">
                                                <button class="qty-btn" @click="decrementQuantity(actuator)">-</button>
                                                <div class="qty-display" x-text="actuator.quantity"></div>
                                                <button class="qty-btn" @click="incrementQuantity(actuator)">+</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="component-details">
                                        <div class="detail-item">
                                            <div class="detail-label">تعداد پیش‌فرض</div>
                                            <div class="detail-value" x-text="actuator.defaultQuantity"></div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">ولتاژ</div>
                                            <input type="text" class="detail-input" x-model="actuator.voltage" @change="calculateComponents()" dir="ltr">
                                        </div>
                                    </div>
                                    <div class="checkbox-group">
                                        <input type="checkbox" :id="'hasPositioner' + index" x-model="actuator.hasPositioner">
                                        <label class="checkbox-label" :for="'hasPositioner' + index">دارای پوزیشنر</label>
                                    </div>
                                    <div class="checkbox-group" x-show="actuator.hasPositioner">
                                        <input type="checkbox" :id="'readPosition' + index" x-model="actuator.readPosition">
                                        <label class="checkbox-label" :for="'readPosition' + index">خواندن پوزیشن</label>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                
                <!-- ستون دوم: سنسورها و قطعات اختیاری -->
                <div>
                    <!-- سنسورها -->
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-thermometer-half"></i> سنسورها</h2>
                        <div class="component-list">
                            <template x-for="(sensor, index) in sensors" :key="index">
                                <div class="component-item">
                                    <div class="component-header">
                                        <div class="component-name" x-text="sensor.name"></div>
                                        <div class="component-controls">
                                            <div class="quantity-control">
                                                <button class="qty-btn" @click="decrementQuantity(sensor)">-</button>
                                                <div class="qty-display" x-text="sensor.quantity"></div>
                                                <button class="qty-btn" @click="incrementQuantity(sensor)">+</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="component-details">
                                        <div class="detail-item">
                                            <div class="detail-label">تعداد پیش‌فرض</div>
                                            <div class="detail-value" x-text="sensor.defaultQuantity"></div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">نوع</div>
                                            <div class="detail-value" x-text="sensor.type"></div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- قطعات اختیاری -->
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-plus-circle"></i> قطعات اختیاری</h2>
                        <div class="component-list">
                            <template x-for="(optional, index) in optionalComponents" :key="index">
                                <div class="component-item">
                                    <div class="component-header">
                                        <div class="component-name" x-text="optional.name"></div>
                                        <div class="component-controls">
                                            <div class="quantity-control">
                                                <button class="qty-btn" @click="decrementQuantity(optional)">-</button>
                                                <div class="qty-display" x-text="optional.quantity"></div>
                                                <button class="qty-btn" @click="incrementQuantity(optional)">+</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="component-details">
                                        <div class="detail-item">
                                            <div class="detail-label">تعداد پیش‌فرض</div>
                                            <div class="detail-value" x-text="optional.defaultQuantity"></div>
                                        </div>
                                        <div class="detail-item">
                                            <div class="detail-label">مشخصات</div>
                                            <input type="text" class="detail-input" x-model="optional.spec" @change="calculateComponents()" dir="ltr">
                                        </div>
                                    </div>
                                    <div class="checkbox-group" x-show="optional.name === 'اینورتر VFD'">
                                        <input type="checkbox" id="useInverter" x-model="useInverter">
                                        <label class="checkbox-label" for="useInverter">استفاده از VFD برای بزرگترین موتور</label>
                                    </div>
                                    <div class="checkbox-group" x-show="optional.name === 'سنسور حرارت تابلو'">
                                        <input type="checkbox" id="useCabinetSensor" x-model="useCabinetSensor">
                                        <label class="checkbox-label" for="useCabinetSensor">نصب سنسور حرارت داخل تابلو</label>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <!-- خلاصه محاسبات -->
                    <div class="summary-card">
                        <h3 class="summary-title"><i class="fas fa-calculator"></i> خلاصه محاسبات</h3>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-label">تعداد کل قطعات</div>
                                <div class="summary-value" x-text="summary.totalComponents"></div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">کنتاکتورها</div>
                                <div class="summary-value" x-text="summary.contactors"></div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">رله‌های PLC</div>
                                <div class="summary-value" x-text="summary.relays"></div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">ماژول‌های I/O</div>
                                <div class="summary-value" x-text="summary.ioModules"></div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">ترمینال‌ها</div>
                                <div class="summary-value" x-text="summary.terminals"></div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-label">فیوزها</div>
                                <div class="summary-value" x-text="summary.fuses"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ستون سوم: چینش تابلو و BOM -->
                <div>
                    <!-- پالت قطعات برای درگ و دراپ -->
                    <div class="component-palette no-print">
                        <h3 class="palette-title"><i class="fas fa-th"></i> پالت قطعات برای چینش</h3>
                        <div class="drag-drop-info">
                            <i class="fas fa-mouse-pointer"></i> قطعات را از اینجا برداشته و در گرید زیر رها کنید
                        </div>
                        <div class="palette-items">
                            <div class="palette-item" draggable="true" @dragstart="dragStart($event, 'plc')">PLC</div>
                            <div class="palette-item" draggable="true" @dragstart="dragStart($event, 'psu')">منبع تغذیه</div>
                            <div class="palette-item" draggable="true" @dragstart="dragStart($event, 'breaker')">بریکر اصلی</div>
                            <div class="palette-item" draggable="true" @dragstart="dragStart($event, 'contactor')">کنتاکتور</div>
                            <div class="palette-item" draggable="true" @dragstart="dragStart($event, 'relay')">رله</div>
                            <div class="palette-item" draggable="true" @dragstart="dragStart($event, 'inverter')">اینورتر</div>
                            <div class="palette-item" draggable="true" @dragstart="dragStart($event, 'soft-starter')">سافت استارتر</div>
                            <div class="palette-item" draggable="true" @dragstart="dragStart($event, 'hmi')">HMI</div>
                            <div class="palette-item" draggable="true" @dragstart="dragStart($event, 'terminal')">ترمینال</div>
                        </div>
                    </div>
                    
                    <!-- چینش تابلو -->
                    <div class="card">
                        <h2 class="card-title"><i class="fas fa-th-large"></i> چینش تابلو (Drag & Drop)</h2>
                        <div class="color-legend">
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #3498db;"></div>
                                <span>PLC و ماژول‌ها</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #9b59b6;"></div>
                                <span>منبع تغذیه</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #e74c3c;"></div>
                                <span>بریکرها</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #2ecc71;"></div>
                                <span>کنتاکتورها</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color" style="background-color: #f39c12;"></div>
                                <span>رله‌ها</span>
                            </div>
                        </div>
                        <div class="layout-container" @dragover="dragOver($event)" @drop="drop($event)">
                            <div class="layout-grid" id="layoutGrid">
                                <template x-for="(component, index) in layoutComponents" :key="index">
                                    <div class="layout-component" 
                                         :class="component.type"
                                         :style="getLayoutStyle(component)"
                                         draggable="true"
                                         @dragstart="dragComponent($event, index)"
                                         @dragend="dragEnd($event, index)">
                                        <div x-text="component.tag"></div>
                                        <div style="font-size: 0.5rem; margin-top: 2px;" x-text="component.details"></div>
                                        <div class="grid-coordinates" x-text="'(' + component.x + ',' + component.y + ')'"></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div class="wiring-controls no-print">
                            <button class="wiring-btn" @click="autoLayout()">
                                <i class="fas fa-magic"></i> چینش اتوماتیک
                            </button>
                            <button class="wiring-btn" @click="clearLayout()">
                                <i class="fas fa-trash"></i> پاک کردن چینش
                            </button>
                            <button class="wiring-btn" @click="exportLayoutImage()">
                                <i class="fas fa-camera"></i> ذخیره عکس
                            </button>
                        </div>
                    </div>
                    
                    <!-- لیست مواد (BOM) -->
                    <div class="card bom-container">
                        <h2 class="card-title"><i class="fas fa-clipboard-list"></i> لیست مواد (BOM)</h2>
                        <div class="component-count">تعداد کل قطعات: <span x-text="bom.length"></span></div>
                        <div style="overflow-x: auto;">
                            <table class="bom-table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>قطعه</th>
                                        <th>تعداد</th>
                                        <th>مشخصات</th>
                                        <th>استانداردها</th>
                                        <th>تگ‌ها</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-for="(item, index) in bom" :key="index">
                                        <tr>
                                            <td x-text="index + 1"></td>
                                            <td x-text="item.name"></td>
                                            <td x-text="item.quantity"></td>
                                            <td x-text="item.specifications"></td>
                                            <td x-text="item.standards"></td>
                                            <td>
                                                <template x-for="tag in item.tags" :key="tag">
                                                    <span class="tag" x-text="tag"></span>
                                                </template>
                                            </td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- سناریوی کنترلی -->
            <div class="control-scenario">
                <h3 class="scenario-title"><i class="fas fa-code"></i> سناریوی کنترلی</h3>
                <div class="scenario-text">
هوای برگشت از سالن با دمای RT و رطوبت RH می‌آید.
هوای تخلیه به همراه هوای داخل سالن تخلیه می‌شود.
دمای خارج OT و رطوبت خارج OH است.
دمای هوای سیکل CT و رطوبت CH است.
خصوصیات هوای سیکل بستگی به وضعیت شیر گرمایش دارد و در صورت روشن بودن، هوا با جریان روی کویل‌ها گرم می‌شود و با استفاده از سایکرومتریک و دمای حباب تر ثابت محاسبه می‌شود.
دمای هوای مخلوط MT و رطوبت HT با مخلوط کردن درصدی از هوای سیکل با هوای خارج با استفاده از روش HVAC برای مخلوط کردن هواها محاسبه می‌شود.
هوای تغذیه، هوای مخلوط است که در صورت نیاز می‌توان از آب برای رطوبت‌زنی استفاده کرد و نتیجه با استفاده از سایکرومتریک با ثابت حباب تر تبخیری محاسبه می‌شود.

هوای تغذیه = درصد هوای تازه + درصد هوای سیکل
درصد هوای تازه = درصد هوای تخلیه
درصد هوای سیکل = ۱۰۰ - درصد هوای تازه
سیکل می‌تواند در صورت نیاز گرم شود
هوای تغذیه می‌تواند در صورت نیاز رطوبت‌زنی شود
کنترل با حلقه بسته و کنترل دمپرها و شیر بخار و پمپ آب انجام می‌شود.
                </div>
            </div>
            
            <!-- نوار وضعیت -->
            <div class="status-bar no-print">
                <div class="total-cost">تمپلیت: <span x-text="activeTemplateName"></span></div>
                <div class="component-count">کنتاکتور: <span x-text="summary.contactors"></span> | رله: <span x-text="summary.relays"></span> | ترمینال: <span x-text="summary.terminals"></span></div>
                <div>
                    <button class="btn btn-primary" @click="showModal = 'calculations'">
                        <i class="fas fa-calculator"></i> جزئیات محاسبات
                    </button>
                    <button class="btn btn-secondary" @click="generateAllCode()">
                        <i class="fas fa-file-code"></i> تولید کد PLC
                    </button>
                </div>
            </div>
            
            <!-- منوی موبایل -->
            <div class="mobile-menu no-print">
                <button class="mobile-menu-btn" @click="mobilePanelActive = !mobilePanelActive">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="mobile-panel" :class="{active: mobilePanelActive}">
                    <div class="mobile-panel-buttons">
                        <button class="btn btn-primary" @click="saveProject(); mobilePanelActive = false">
                            <i class="fas fa-save"></i> ذخیره پروژه
                        </button>
                        <button class="btn btn-secondary" @click="loadProject(); mobilePanelActive = false">
                            <i class="fas fa-folder-open"></i> بارگذاری
                        </button>
                        <button class="btn btn-warning" @click="showModal = 'templates'; mobilePanelActive = false">
                            <i class="fas fa-layer-group"></i> تمپلیت‌ها
                        </button>
                        <button class="btn btn-info" @click="showModal = 'wiring'; mobilePanelActive = false">
                            <i class="fas fa-project-diagram"></i> وایرینگ
                        </button>
                        <button class="btn btn-danger" @click="showModal = 'export'; mobilePanelActive = false">
                            <i class="fas fa-print"></i> خروجی
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- مودال تمپلیت‌ها -->
        <template x-if="showModal === 'templates'">
            <div class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">تمپلیت‌های از پیش تعریف شده</h3>
                        <button class="close-modal" @click="showModal = null">&times;</button>
                    </div>
                    <div class="tabs">
                        <button class="tab" :class="{ active: activeTemplateTab === 'predefined' }" @click="activeTemplateTab = 'predefined'">تمپلیت‌های آماده</button>
                        <button class="tab" :class="{ active: activeTemplateTab === 'custom' }" @click="activeTemplateTab = 'custom'">تمپلیت سفارشی</button>
                        <button class="tab" :class="{ active: activeTemplateTab === 'manage' }" @click="activeTemplateTab = 'manage'">مدیریت تمپلیت‌ها</button>
                    </div>
                    
                    <div class="tab-content" :class="{ active: activeTemplateTab === 'predefined' }">
                        <h4>انتخاب تمپلیت آماده</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
                            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 2px solid #3498db; cursor: pointer;" @click="loadFullTemplate('evaporative'); showModal = null;">
                                <h5 style="margin-top: 0; color: #3498db;">ایستگاه تهویه تبخیری نساجی</h5>
                                <p style="font-size: 0.9rem;">پیکربندی استاندارد برای تهویه تبخیری در صنعت نساجی</p>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <span class="tag">موتورهای فن</span>
                                    <span class="tag">دمپرها</span>
                                    <span class="tag">سنسورها</span>
                                </div>
                            </div>
                            
                            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 2px solid #2ecc71; cursor: pointer;" @click="loadFullTemplate('vfd'); showModal = null;">
                                <h5 style="margin-top: 0; color: #2ecc71;">تهویه با اینورتر برای هر موتور</h5>
                                <p style="font-size: 0.9rem;">استفاده از اینورتر جداگانه برای هر موتور فن و پمپ</p>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <span class="tag">اینورتر</span>
                                    <span class="tag">کنترل دور</span>
                                    <span class="tag">صرفه‌جویی انرژی</span>
                                </div>
                            </div>
                            
                            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 2px solid #f39c12; cursor: pointer;" @click="loadFullTemplate('softstart'); showModal = null;">
                                <h5 style="margin-top: 0; color: #f39c12;">فیلتر پلنت با سافت استارت</h5>
                                <p style="font-size: 0.9rem;">سیستم فیلتراسیون با سافت استارتر برای موتور اصلی</p>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <span class="tag">سافت استارتر</span>
                                    <span class="tag">فیلتر روم</span>
                                    <span class="tag">فن اصلی</span>
                                </div>
                            </div>
                            
                            <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; border: 2px solid #9b59b6; cursor: pointer;" @click="loadFullTemplate('filter_vfd'); showModal = null;">
                                <h5 style="margin-top: 0; color: #9b59b6;">فیلتر پلنت با VFD فن اصلی</h5>
                                <p style="font-size: 0.9rem;">سیستم فیلتراسیون با اینورتر برای فن اصلی هر فیلتر روم</p>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <span class="tag">VFD</span>
                                    <span class="tag">فیلتر روم</span>
                                    <span class="tag">کنترل دقیق</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="tab-content" :class="{ active: activeTemplateTab === 'custom' }">
                        <h4>ایجاد تمپلیت سفارشی</h4>
                        <div style="background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-top: 15px;">
                            <div class="detail-item" style="margin-bottom: 15px;">
                                <div class="detail-label">نام تمپلیت</div>
                                <input type="text" class="detail-input" x-model="customTemplateName" placeholder="نام تمپلیت سفارشی">
                            </div>
                            <div class="detail-item" style="margin-bottom: 15px;">
                                <div class="detail-label">توضیحات</div>
                                <textarea class="detail-input" x-model="customTemplateDescription" placeholder="توضیحاتی درباره تمپلیت" style="height: 100px;"></textarea>
                            </div>
                            <button class="btn btn-primary" @click="saveCustomTemplate()">
                                <i class="fas fa-save"></i> ذخیره تمپلیت فعلی
                            </button>
                        </div>
                    </div>
                    
                    <div class="tab-content" :class="{ active: activeTemplateTab === 'manage' }">
                        <h4>تمپلیت‌های ذخیره شده</h4>
                        <div style="margin-top: 15px;">
                            <template x-for="(template, index) in savedTemplates" :key="index">
                                <div style="background-color: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee;">
                                    <div>
                                        <div style="font-weight: 600;" x-text="template.name"></div>
                                        <div style="font-size: 0.9rem; color: #7f8c8d;" x-text="template.description"></div>
                                    </div>
                                    <div style="display: flex; gap: 10px;">
                                        <button class="btn btn-primary" style="padding: 5px 10px; font-size: 0.8rem;" @click="loadSavedTemplate(template)">
                                            <i class="fas fa-check"></i> بارگذاری
                                        </button>
                                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;" @click="deleteTemplate(index)">
                                            <i class="fas fa-trash"></i> حذف
                                        </button>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: left;">
                        <button class="btn btn-danger" @click="showModal = null">
                            بستن
                        </button>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- مودال وایرینگ -->
        <template x-if="showModal === 'wiring'">
            <div class="modal">
                <div class="modal-content modal-wide">
                    <div class="modal-header">
                        <h3 class="modal-title">طراحی وایرینگ و سیم‌کشی</h3>
                        <button class="close-modal" @click="showModal = null">&times;</button>
                    </div>
                    <div class="tabs">
                        <button class="tab" :class="{ active: activeWiringTab === 'diagram' }" @click="activeWiringTab = 'diagram'; initWiringCanvas()">نمودار وایرینگ</button>
                        <button class="tab" :class="{ active: activeWiringTab === 'connections' }" @click="activeWiringTab = 'connections'">لیست اتصالات</button>
                        <button class="tab" :class="{ active: activeWiringTab === 'wirelist' }" @click="activeWiringTab = 'wirelist'">لیست سیم‌ها</button>
                        <button class="tab" :class="{ active: activeWiringTab === 'terminals' }" @click="activeWiringTab = 'terminals'">پلان ترمینال</button>
                    </div>
                    
                    <div class="tab-content" :class="{ active: activeWiringTab === 'diagram' }">
                        <div class="wiring-canvas-container">
                            <canvas id="wiringCanvas" class="wiring-canvas"></canvas>
                        </div>
                        <div class="wiring-controls">
                            <button class="wiring-btn" @click="generateAutoWiring()">
                                <i class="fas fa-magic"></i> تولید خودکار وایرینگ
                            </button>
                            <button class="wiring-btn" @click="clearWiringCanvas()">
                                <i class="fas fa-trash"></i> پاک کردن
                            </button>
                            <button class="wiring-btn" @click="exportWiringImage()">
                                <i class="fas fa-camera"></i> ذخیره عکس
                            </button>
                            <button class="wiring-btn" @click="addWire()">
                                <i class="fas fa-plus"></i> افزودن سیم
                            </button>
                            <button class="wiring-btn" @click="addComponentToWiring()">
                                <i class="fas fa-cube"></i> افزودن قطعه
                            </button>
                        </div>
                    </div>
                    
                    <div class="tab-content" :class="{ active: activeWiringTab === 'connections' }">
                        <h4>لیست اتصالات</h4>
                        <div class="connection-list">
                            <template x-for="(connection, index) in wiringConnections" :key="index">
                                <div class="connection-item">
                                    <div style="font-weight: 600; margin-bottom: 5px;" x-text="connection.from + ' → ' + connection.to"></div>
                                    <div style="font-size: 0.9rem; color: #555;" x-text="connection.type"></div>
                                    <div style="display: flex; gap: 10px; margin-top: 8px;">
                                        <span class="tag" x-text="connection.wireSize"></span>
                                        <span class="tag" x-text="connection.color"></span>
                                        <span class="tag" x-text="connection.terminal"></span>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    
                    <div class="tab-content" :class="{ active: activeWiringTab === 'wirelist' }">
                        <h4>لیست سیم‌ها</h4>
                        <table class="bom-table" style="margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>مبدا</th>
                                    <th>مقصد</th>
                                    <th>نوع سیم</th>
                                    <th>سایز (mm²)</th>
                                    <th>رنگ</th>
                                    <th>طول (m)</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(wire, index) in wireList" :key="index">
                                    <tr>
                                        <td x-text="wire.from"></td>
                                        <td x-text="wire.to"></td>
                                        <td x-text="wire.type"></td>
                                        <td x-text="wire.size"></td>
                                        <td x-text="wire.color"></td>
                                        <td x-text="wire.length"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="tab-content" :class="{ active: activeWiringTab === 'terminals' }">
                        <h4>پلان ترمینال</h4>
                        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin-top: 15px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                                <template x-for="(terminal, index) in terminalPlan" :key="index">
                                    <div style="background-color: white; padding: 10px; border-radius: 5px; border-right: 4px solid #3498db;">
                                        <div style="font-weight: 600;" x-text="terminal.name"></div>
                                        <div style="font-size: 0.9rem; color: #555;">نوع: <span x-text="terminal.type"></span></div>
                                        <div style="font-size: 0.9rem; color: #555;">تعداد نقطه: <span x-text="terminal.points"></span></div>
                                        <div style="font-size: 0.9rem; color: #555;">تگ: <span class="tag" x-text="terminal.tag"></span></div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: left;">
                        <button class="btn btn-danger" @click="showModal = null">
                            بستن
                        </button>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- مودال خروجی -->
        <template x-if="showModal === 'export'">
            <div class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">خروجی‌گیری و پرینت</h3>
                        <button class="close-modal" @click="showModal = null">&times;</button>
                    </div>
                    <p>گزینه مورد نظر برای خروجی‌گیری را انتخاب کنید:</p>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                        <button class="btn btn-primary" style="flex-direction: column; height: auto; padding: 20px;" @click="printDocument()">
                            <i class="fas fa-print fa-2x"></i>
                            <span style="margin-top: 10px;">پرینت سند</span>
                        </button>
                        <button class="btn btn-secondary" style="flex-direction: column; height: auto; padding: 20px;" @click="exportProjectAsJSON()">
                            <i class="fas fa-file-code fa-2x"></i>
                            <span style="margin-top: 10px;">ذخیره JSON</span>
                        </button>
                        <button class="btn btn-primary" style="flex-direction: column; height: auto; padding: 20px;" @click="exportBOMToCSV()">
                            <i class="fas fa-file-csv fa-2x"></i>
                            <span style="margin-top: 10px;">خروجی BOM به CSV</span>
                        </button>
                        <button class="btn btn-secondary" style="flex-direction: column; height: auto; padding: 20px;" @click="exportLayoutImage()">
                            <i class="fas fa-image fa-2x"></i>
                            <span style="margin-top: 10px;">عکس چینش تابلو</span>
                        </button>
                        <button class="btn btn-primary" style="flex-direction: column; height: auto; padding: 20px;" @click="exportWiringImage()">
                            <i class="fas fa-project-diagram fa-2x"></i>
                            <span style="margin-top: 10px;">عکس وایرینگ</span>
                        </button>
                        <button class="btn btn-secondary" style="flex-direction: column; height: auto; padding: 20px;" @click="exportFullReport()">
                            <i class="fas fa-file-pdf fa-2x"></i>
                            <span style="margin-top: 10px;">گزارش کامل PDF</span>
                        </button>
                    </div>
                    <div style="margin-top: 20px; text-align: left;">
                        <button class="btn btn-danger" @click="showModal = null">
                            لغو
                        </button>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- مودال جزئیات محاسبات -->
        <template x-if="showModal === 'calculations'">
            <div class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 class="modal-title">جزئیات محاسبات فنی</h3>
                        <button class="close-modal" @click="showModal = null">&times;</button>
                    </div>
                    <div class="tabs">
                        <button class="tab" :class="{ active: activeCalcTab === 'contactors' }" @click="activeCalcTab = 'contactors'">کنتاکتورها</button>
                        <button class="tab" :class="{ active: activeCalcTab === 'breakers' }" @click="activeCalcTab = 'breakers'">بریکرها و فیوزها</button>
                        <button class="tab" :class="{ active: activeCalcTab === 'wires' }" @click="activeCalcTab = 'wires'">سیم‌ها و کابل‌ها</button>
                        <button class="tab" :class="{ active: activeCalcTab === 'io' }" @click="activeCalcTab = 'io'">ورودی/خروجی PLC</button>
                    </div>
                    
                    <div class="tab-content" :class="{ active: activeCalcTab === 'contactors' }">
                        <h4>محاسبات کنتاکتورها</h4>
                        <table class="bom-table" style="margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>موتور</th>
                                    <th>توان (kW)</th>
                                    <th>جریان (A)</th>
                                    <th>سایز کنتاکتور</th>
                                    <th>تعداد</th>
                                    <th>کلید حرارتی</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(calc, index) in contactorCalculations" :key="index">
                                    <tr>
                                        <td x-text="calc.motor"></td>
                                        <td x-text="calc.power"></td>
                                        <td x-text="calc.current"></td>
                                        <td x-text="calc.contactorSize"></td>
                                        <td x-text="calc.quantity"></td>
                                        <td x-text="calc.overload"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="tab-content" :class="{ active: activeCalcTab === 'breakers' }">
                        <h4>محاسبات بریکرها و فیوزها</h4>
                        <table class="bom-table" style="margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>مدار</th>
                                    <th>جریان (A)</th>
                                    <th>نوع بریکر</th>
                                    <th>سایز</th>
                                    <th>فیوز</th>
                                    <th>تعداد</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(calc, index) in breakerCalculations" :key="index">
                                    <tr>
                                        <td x-text="calc.circuit"></td>
                                        <td x-text="calc.current"></td>
                                        <td x-text="calc.type"></td>
                                        <td x-text="calc.size"></td>
                                        <td x-text="calc.fuse"></td>
                                        <td x-text="calc.quantity"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <div style="margin-top: 20px; text-align: left;">
                        <button class="btn btn-danger" @click="showModal = null">
                            بستن
                        </button>
                    </div>
                </div>
            </div>
        </template>
        
        <!-- فایل مخفی برای بارگذاری پروژه -->
        <input type="file" id="fileInput" accept=".json" style="display: none;" @change="loadProjectFromFile($event)">
    </div>

    <script>
        function plcDesigner() {
            return {
                // حالت برنامه
                showModal: null,
                activeTemplateTab: 'predefined',
                activeWiringTab: 'diagram',
                activeCalcTab: 'contactors',
                mobilePanelActive: false,
                draggingComponent: null,
                dragStartIndex: null,
                wiringCanvas: null,
                wiringObjects: [],
                
                // تمپلیت‌ها
                activeTemplate: 'evaporative',
                activeTemplateName: 'ایستگاه تهویه تبخیری',
                customTemplateName: '',
                customTemplateDescription: '',
                savedTemplates: [],
                
                // آرایه‌های قطعات
                motors: [
                    { id: 1, name: 'موتور فن رفت', quantity: 2, defaultQuantity: 2, power: '22', voltage: '400V', hasOver5kw: true },
                    { id: 2, name: 'موتور فن برگشت', quantity: 2, defaultQuantity: 2, power: '30', voltage: '400V', hasOver5kw: true },
                    { id: 3, name: 'موتور فن گرد و غبار', quantity: 4, defaultQuantity: 4, power: '3.3', voltage: '400V', hasOver5kw: false },
                    { id: 4, name: 'موتور روتاری', quantity: 2, defaultQuantity: 2, power: '1', voltage: '400V', hasOver5kw: false },
                    { id: 5, name: 'موتور مکانیزم', quantity: 2, defaultQuantity: 2, power: '0.25', voltage: '400V', hasOver5kw: false },
                    { id: 6, name: 'موتور پمپ آب', quantity: 1, defaultQuantity: 1, power: '30', voltage: '400V', hasOver5kw: true }
                ],
                
                actuators: [
                    { id: 1, name: 'دمپر هوای تازه', quantity: 2, defaultQuantity: 2, voltage: '24V DC', hasPositioner: true, readPosition: true },
                    { id: 2, name: 'دمپر تخلیه', quantity: 2, defaultQuantity: 2, voltage: '24V DC', hasPositioner: true, readPosition: true },
                    { id: 3, name: 'دمپر برگشت', quantity: 2, defaultQuantity: 2, voltage: '24V DC', hasPositioner: false, readPosition: false },
                    { id: 4, name: 'شیر بخار', quantity: 1, defaultQuantity: 1, voltage: '24V DC', hasPositioner: true, readPosition: false }
                ],
                
                sensors: [
                    { id: 1, name: 'سنسور دما', quantity: 2, defaultQuantity: 2, type: 'آنالوگ 4-20mA' },
                    { id: 2, name: 'سنسور رطوبت', quantity: 2, defaultQuantity: 2, type: 'آنالوگ 4-20mA' },
                    { id: 3, name: 'میکروسوییچ', quantity: 5, defaultQuantity: 5, type: 'دیجیتال ON/OFF' }
                ],
                
                optionalComponents: [
                    { id: 1, name: 'اینورتر VFD', quantity: 0, defaultQuantity: 0, spec: '30kW' },
                    { id: 2, name: 'سافت استارتر', quantity: 0, defaultQuantity: 0, spec: '30kW' },
                    { id: 3, name: 'پنل HMI', quantity: 1, defaultQuantity: 1, spec: '7 اینچ' },
                    { id: 4, name: 'سنسور حرارت تابلو', quantity: 0, defaultQuantity: 0, spec: 'ترمال' }
                ],
                
                // تنظیمات
                useSoftStarter: true,
                useInverter: false,
                useCabinetSensor: false,
                
                // چینش تابلو
                layoutComponents: [],
                
                // محاسبات
                bom: [],
                summary: {
                    totalComponents: 0,
                    contactors: 0,
                    relays: 0,
                    ioModules: 0,
                    terminals: 0,
                    fuses: 0
                },
                contactorCalculations: [],
                breakerCalculations: [],
                wiringConnections: [],
                wireList: [],
                terminalPlan: [],
                
                // مقداردهی اولیه برنامه
                init() {
                    this.loadTemplate('evaporative');
                    this.loadSavedTemplates();
                    this.calculateComponents();
                    this.generateAutoLayout();
                },
                
                // کنترل تعداد قطعات
                incrementQuantity(component) {
                    component.quantity++;
                    this.calculateComponents();
                },
                
                decrementQuantity(component) {
                    if (component.quantity > 0) {
                        component.quantity--;
                        this.calculateComponents();
                    }
                },
                
                // بارگذاری تمپلیت
                loadTemplate(templateName) {
                    this.activeTemplate = templateName;
                    
                    const templates = {
                        evaporative: {
                            name: 'ایستگاه تهویه تبخیری',
                            motors: [
                                { id: 1, name: 'موتور فن رفت', quantity: 2, defaultQuantity: 2, power: '22', voltage: '400V', hasOver5kw: true },
                                { id: 2, name: 'موتور فن برگشت', quantity: 2, defaultQuantity: 2, power: '30', voltage: '400V', hasOver5kw: true },
                                { id: 3, name: 'موتور فن گرد و غبار', quantity: 4, defaultQuantity: 4, power: '3.3', voltage: '400V', hasOver5kw: false },
                                { id: 4, name: 'موتور روتاری', quantity: 2, defaultQuantity: 2, power: '1', voltage: '400V', hasOver5kw: false },
                                { id: 5, name: 'موتور مکانیزم', quantity: 2, defaultQuantity: 2, power: '0.25', voltage: '400V', hasOver5kw: false },
                                { id: 6, name: 'موتور پمپ آب', quantity: 1, defaultQuantity: 1, power: '30', voltage: '400V', hasOver5kw: true }
                            ],
                            actuators: [
                                { id: 1, name: 'دمپر هوای تازه', quantity: 2, defaultQuantity: 2, voltage: '24V DC', hasPositioner: true, readPosition: true },
                                { id: 2, name: 'دمپر تخلیه', quantity: 2, defaultQuantity: 2, voltage: '24V DC', hasPositioner: true, readPosition: true },
                                { id: 3, name: 'دمپر برگشت', quantity: 2, defaultQuantity: 2, voltage: '24V DC', hasPositioner: false, readPosition: false },
                                { id: 4, name: 'شیر بخار', quantity: 1, defaultQuantity: 1, voltage: '24V DC', hasPositioner: true, readPosition: false }
                            ],
                            sensors: [
                                { id: 1, name: 'سنسور دما', quantity: 2, defaultQuantity: 2, type: 'آنالوگ 4-20mA' },
                                { id: 2, name: 'سنسور رطوبت', quantity: 2, defaultQuantity: 2, type: 'آنالوگ 4-20mA' },
                                { id: 3, name: 'میکروسوییچ', quantity: 5, defaultQuantity: 5, type: 'دیجیتال ON/OFF' }
                            ],
                            optionalComponents: [
                                { id: 1, name: 'اینورتر VFD', quantity: 0, defaultQuantity: 0, spec: '30kW' },
                                { id: 2, name: 'سافت استارتر', quantity: 0, defaultQuantity: 0, spec: '30kW' },
                                { id: 3, name: 'پنل HMI', quantity: 1, defaultQuantity: 1, spec: '7 اینچ' },
                                { id: 4, name: 'سنسور حرارت تابلو', quantity: 0, defaultQuantity: 0, spec: 'ترمال' }
                            ],
                            useSoftStarter: true,
                            useInverter: false
                        },
                        vfd: {
                            name: 'تهویه با اینورتر برای هر موتور',
                            motors: [
                                { id: 1, name: 'موتور فن رفت', quantity: 2, defaultQuantity: 2, power: '22', voltage: '400V', hasOver5kw: true },
                                { id: 2, name: 'موتور فن برگشت', quantity: 2, defaultQuantity: 2, power: '30', voltage: '400V', hasOver5kw: true },
                                { id: 6, name: 'موتور پمپ آب', quantity: 1, defaultQuantity: 1, power: '30', voltage: '400V', hasOver5kw: true }
                            ],
                            actuators: [
                                { id: 1, name: 'دمپر هوای تازه', quantity: 2, defaultQuantity: 2, voltage: '24V DC', hasPositioner: true, readPosition: true },
                                { id: 2, name: 'دمپر تخلیه', quantity: 2, defaultQuantity: 2, voltage: '24V DC', hasPositioner: true, readPosition: true },
                                { id: 3, name: 'دمپر برگشت', quantity: 2, defaultQuantity: 2, voltage: '24V DC', hasPositioner: false, readPosition: false }
                            ],
                            sensors: [
                                { id: 1, name: 'سنسور دما', quantity: 2, defaultQuantity: 2, type: 'آنالوگ 4-20mA' },
                                { id: 2, name: 'سنسور رطوبت', quantity: 2, defaultQuantity: 2, type: 'آنالوگ 4-20mA' }
                            ],
                            optionalComponents: [
                                { id: 1, name: 'اینورتر VFD', quantity: 3, defaultQuantity: 3, spec: '30kW' },
                                { id: 2, name: 'سافت استارتر', quantity: 0, defaultQuantity: 0, spec: '30kW' },
                                { id: 3, name: 'پنل HMI', quantity: 1, defaultQuantity: 1, spec: '7 اینچ' },
                                { id: 4, name: 'سنسور حرارت تابلو', quantity: 1, defaultQuantity: 1, spec: 'ترمال' }
                            ],
                            useSoftStarter: false,
                            useInverter: true
                        },
                        softstart: {
                            name: 'فیلتر پلنت با سافت استارت',
                            motors: [
                                { id: 7, name: 'موتور فن اصلی فیلتر روم', quantity: 2, defaultQuantity: 2, power: '75', voltage: '400V', hasOver5kw: true },
                                { id: 8, name: 'موتور فیلتر دیسک', quantity: 2, defaultQuantity: 2, power: '1', voltage: '400V', hasOver5kw: false },
                                { id: 9, name: 'موتور فیلتر چرخان', quantity: 2, defaultQuantity: 2, power: '1', voltage: '400V', hasOver5kw: false },
                                { id: 10, name: 'موتور مکانیزم جاروب', quantity: 2, defaultQuantity: 2, power: '0.3', voltage: '400V', hasOver5kw: false },
                                { id: 11, name: 'موتور فن گردگیر', quantity: 4, defaultQuantity: 4, power: '5', voltage: '400V', hasOver5kw: true }
                            ],
                            actuators: [],
                            sensors: [
                                { id: 3, name: 'میکروسوییچ درب', quantity: 2, defaultQuantity: 2, type: 'دیجیتال ON/OFF' },
                                { id: 4, name: 'سنسور فشار', quantity: 2, defaultQuantity: 2, type: 'آنالوگ 4-20mA' }
                            ],
                            optionalComponents: [
                                { id: 1, name: 'اینورتر VFD', quantity: 0, defaultQuantity: 0, spec: '30kW' },
                                { id: 2, name: 'سافت استارتر', quantity: 2, defaultQuantity: 2, spec: '75kW' },
                                { id: 3, name: 'پنل HMI', quantity: 1, defaultQuantity: 1, spec: '7 اینچ' },
                                { id: 4, name: 'سنسور حرارت تابلو', quantity: 1, defaultQuantity: 1, spec: 'ترمال' }
                            ],
                            useSoftStarter: true,
                            useInverter: false
                        },
                        filter_vfd: {
                            name: 'فیلتر پلنت با VFD فن اصلی',
                            motors: [
                                { id: 7, name: 'موتور فن اصلی فیلتر روم', quantity: 3, defaultQuantity: 3, power: '75', voltage: '400V', hasOver5kw: true },
                                { id: 8, name: 'موتور فیلتر دیسک', quantity: 3, defaultQuantity: 3, power: '1', voltage: '400V', hasOver5kw: false },
                                { id: 9, name: 'موتور فیلتر چرخان', quantity: 3, defaultQuantity: 3, power: '1', voltage: '400V', hasOver5kw: false },
                                { id: 10, name: 'موتور مکانیزم جاروب', quantity: 3, defaultQuantity: 3, power: '0.3', voltage: '400V', hasOver5kw: false },
                                { id: 11, name: 'موتور فن گردگیر', quantity: 6, defaultQuantity: 6, power: '5', voltage: '400V', hasOver5kw: true }
                            ],
                            actuators: [],
                            sensors: [
                                { id: 3, name: 'میکروسوییچ درب', quantity: 3, defaultQuantity: 3, type: 'دیجیتال ON/OFF' },
                                { id: 4, name: 'سنسور فشار', quantity: 3, defaultQuantity: 3, type: 'آنالوگ 4-20mA' }
                            ],
                            optionalComponents: [
                                { id: 1, name: 'اینورتر VFD', quantity: 3, defaultQuantity: 3, spec: '75kW' },
                                { id: 2, name: 'سافت استارتر', quantity: 0, defaultQuantity: 0, spec: '30kW' },
                                { id: 3, name: 'پنل HMI', quantity: 1, defaultQuantity: 1, spec: '7 اینچ' },
                                { id: 4, name: 'سنسور حرارت تابلو', quantity: 1, defaultQuantity: 1, spec: 'ترمال' }
                            ],
                            useSoftStarter: false,
                            useInverter: true
                        },
                        custom: {
                            name: 'پروژه سفارشی',
                            motors: [],
                            actuators: [],
                            sensors: [],
                            optionalComponents: [],
                            useSoftStarter: false,
                            useInverter: false
                        }
                    };
                    
                    if (templates[templateName]) {
                        const template = templates[templateName];
                        this.activeTemplateName = template.name;
                        this.motors = template.motors;
                        this.actuators = template.actuators;
                        this.sensors = template.sensors;
                        this.optionalComponents = template.optionalComponents;
                        this.useSoftStarter = template.useSoftStarter;
                        this.useInverter = template.useInverter;
                        this.calculateComponents();
                        this.generateAutoLayout();
                    }
                },
                
                // بارگذاری کامل تمپلیت (با همه تنظیمات)
                loadFullTemplate(templateName) {
                    this.loadTemplate(templateName);
                    this.calculateComponents();
                    this.generateAutoLayout();
                },
                
                // محاسبات قطعات
                calculateComponents() {
                    let bom = [];
                    let contactorCount = 0;
                    let relayCount = 0;
                    let terminalCount = 0;
                    let fuseCount = 0;
                    let ioModuleCount = 0;
                    
                    // محاسبات کنتاکتورها
                    this.contactorCalculations = [];
                    this.motors.forEach(motor => {
                        if (motor.quantity > 0) {
                            const power = parseFloat(motor.power) || 0;
                            const current = Math.round(power * 1000 / (400 * 1.732 * 0.85));
                            let contactorSize = 'سایز 1';
                            let overload = 'ندارد';
                            
                            if (power > 15) {
                                contactorSize = 'سایز 3';
                                overload = `${current}A`;
                            } else if (power > 5) {
                                contactorSize = 'سایز 2';
                                overload = `${current}A`;
                            }
                            
                            // اگر اینورتر یا سافت استارتر داریم و موتور بالای 5kW است، دو کنتاکتور نیاز دارد
                            let contactorQuantity = motor.quantity;
                            if ((this.useInverter || this.useSoftStarter) && power > 5) {
                                contactorQuantity = motor.quantity * 2;
                            }
                            
                            this.contactorCalculations.push({
                                motor: motor.name,
                                power: `${power} kW`,
                                current: `${current} A`,
                                contactorSize: contactorSize,
                                quantity: contactorQuantity,
                                overload: overload
                            });
                            
                            contactorCount += contactorQuantity;
                            
                            // افزودن به BOM
                            bom.push({
                                name: `کنتاکتور ${contactorSize} برای ${motor.name}`,
                                quantity: contactorQuantity,
                                specifications: `${contactorSize}, ${current}A, 400V AC`,
                                standards: 'IEC 60947-4-1',
                                tags: [`KM${motor.id}`, contactorSize]
                            });
                            
                            // کلید حرارتی برای موتورهای بالای 5kW
                            if (power > 5) {
                                bom.push({
                                    name: `کلید حرارتی برای ${motor.name}`,
                                    quantity: motor.quantity,
                                    specifications: `جریان ${current}A, تنظیم ${current}A`,
                                    standards: 'IEC 60947-4-1',
                                    tags: [`OL${motor.id}`]
                                });
                            }
                        }
                    });
                    
                    // محاسبات بریکرها
                    this.breakerCalculations = [];
                    this.motors.forEach(motor => {
                        if (motor.quantity > 0) {
                            const power = parseFloat(motor.power) || 0;
                            const current = Math.round(power * 1000 / (400 * 1.732 * 0.85));
                            let breakerSize = '10A';
                            let fuseSize = 'بدون فیوز';
                            
                            if (power > 22) {
                                breakerSize = '63A';
                                fuseSize = '63A';
                            } else if (power > 11) {
                                breakerSize = '32A';
                                fuseSize = '32A';
                            } else if (power > 5.5) {
                                breakerSize = '16A';
                                fuseSize = '16A';
                            }
                            
                            this.breakerCalculations.push({
                                circuit: motor.name,
                                current: `${current} A`,
                                type: 'MCB 3P',
                                size: breakerSize,
                                fuse: fuseSize,
                                quantity: motor.quantity
                            });
                            
                            fuseCount += motor.quantity;
                            
                            bom.push({
                                name: `بریکر مدار ${breakerSize} برای ${motor.name}`,
                                quantity: motor.quantity,
                                specifications: `MCB ${breakerSize}, 3P, 400V`,
                                standards: 'IEC 60898',
                                tags: [`Q${motor.id}`]
                            });
                        }
                    });
                    
                    // رله‌های PLC برای عملگرها
                    this.actuators.forEach(actuator => {
                        if (actuator.quantity > 0) {
                            relayCount += actuator.quantity;
                            
                            bom.push({
                                name: `رله خروجی PLC برای ${actuator.name}`,
                                quantity: actuator.quantity,
                                specifications: '24V DC Coil, 2NO+2NC',
                                standards: 'IEC 61810',
                                tags: [`K${actuator.id}`]
                            });
                        }
                    });
                    
                    // PLC و ماژول‌ها
                    let diCount = 0;
                    let doCount = 0;
                    let aiCount = 0;
                    
                    // محاسبه I/O مورد نیاز
                    this.sensors.forEach(sensor => {
                        if (sensor.type.includes('دیجیتال')) {
                            diCount += sensor.quantity;
                        } else {
                            aiCount += sensor.quantity;
                        }
                    });
                    
                    this.actuators.forEach(actuator => {
                        doCount += actuator.quantity;
                        if (actuator.hasPositioner && actuator.readPosition) {
                            aiCount += actuator.quantity;
                        }
                    });
                    
                    // افزودن PLC اصلی
                    bom.push({
                        name: 'PLC CPU',
                        quantity: 1,
                        specifications: 'Siemens S7-1200 CPU 1214C, 14DI/10DO/2AI',
                        standards: 'IEC 61131',
                        tags: ['CPU1214C']
                    });
                    
                    // محاسبه ماژول‌های اضافی
                    if (diCount > 14) {
                        const modulesNeeded = Math.ceil((diCount - 14) / 8);
                        ioModuleCount += modulesNeeded;
                        bom.push({
                            name: 'ماژول ورودی دیجیتال',
                            quantity: modulesNeeded,
                            specifications: '8DI, 24V DC',
                            standards: 'IEC 61131',
                            tags: ['SM1221']
                        });
                    }
                    
                    if (doCount > 10) {
                        const modulesNeeded = Math.ceil((doCount - 10) / 8);
                        ioModuleCount += modulesNeeded;
                        bom.push({
                            name: 'ماژول خروجی دیجیتال',
                            quantity: modulesNeeded,
                            specifications: '8DO, Relay',
                            standards: 'IEC 61131',
                            tags: ['SM1222']
                        });
                    }
                    
                    if (aiCount > 2) {
                        const modulesNeeded = Math.ceil((aiCount - 2) / 2);
                        ioModuleCount += modulesNeeded;
                        bom.push({
                            name: 'ماژول ورودی آنالوگ',
                            quantity: modulesNeeded,
                            specifications: '2AI, 4-20mA',
                            standards: 'IEC 61131',
                            tags: ['SM1231']
                        });
                    }
                    
                    // ترمینال‌ها
                    const totalTerminalPoints = diCount + doCount + aiCount + 20;
                    terminalCount = Math.ceil(totalTerminalPoints / 12);
                    
                    bom.push({
                        name: 'بلوک ترمینال',
                        quantity: terminalCount,
                        specifications: '12 پوزیشن، 600V',
                        standards: 'IEC 60947',
                        tags: ['TB1']
                    });
                    
                    // سایر قطعات
                    bom.push({
                        name: 'منبع تغذیه',
                        quantity: 1,
                        specifications: '24V DC, 5A',
                        standards: 'IEC 61010',
                        tags: ['PS1']
                    });
                    
                    bom.push({
                        name: 'بریکر اصلی',
                        quantity: 1,
                        specifications: '100A, 4P',
                        standards: 'IEC 60947-2',
                        tags: ['Q0']
                    });
                    
                    bom.push({
                        name: 'تابلو کنترل',
                        quantity: 1,
                        specifications: '800x600x200mm, IP54',
                        standards: 'IEC 60529',
                        tags: ['CAB1']
                    });
                    
                    // سیم‌ها
                    bom.push({
                        name: 'سیم کنترل',
                        quantity: 5,
                        specifications: '1.5mm², مشکی',
                        standards: 'IEC 60228',
                        tags: ['W1']
                    });
                    
                    bom.push({
                        name: 'سیم قدرت',
                        quantity: 3,
                        specifications: '4mm², مشکی/آبی/قهوه‌ای',
                        standards: 'IEC 60228',
                        tags: ['W2']
                    });
                    
                    // قطعات اختیاری
                    this.optionalComponents.forEach(optional => {
                        if (optional.quantity > 0) {
                            bom.push({
                                name: optional.name,
                                quantity: optional.quantity,
                                specifications: optional.spec,
                                standards: optional.name.includes('HMI') ? 'IP65' : 'IEC 61800',
                                tags: [optional.name.includes('HMI') ? 'HMI1' : optional.name.includes('اینورتر') ? 'VFD1' : 'SS1']
                            });
                        }
                    });
                    
                    // به‌روزرسانی خلاصه
                    this.summary = {
                        totalComponents: bom.length,
                        contactors: contactorCount,
                        relays: relayCount,
                        ioModules: ioModuleCount,
                        terminals: terminalCount,
                        fuses: fuseCount
                    };
                    
                    this.bom = bom;
                    
                    // تولید لیست اتصالات
                    this.generateWiringConnections();
                    this.generateWireList();
                    this.generateTerminalPlan();
                },
                
                // تولید لیست اتصالات وایرینگ
                generateWiringConnections() {
                    this.wiringConnections = [];
                    let connectionId = 1;
                    
                    // اتصالات موتورها
                    this.motors.forEach((motor, index) => {
                        for (let i = 0; i < motor.quantity; i++) {
                            this.wiringConnections.push({
                                id: connectionId++,
                                from: `بریکر Q${motor.id}.${i+1}`,
                                to: `کنتاکتور KM${motor.id}.${i+1}`,
                                type: 'قدرت',
                                wireSize: '4mm²',
                                color: 'مشکی',
                                terminal: `TB${Math.floor(connectionId/10)+1}`
                            });
                        }
                    });
                    
                    // اتصالات عملگرها
                    this.actuators.forEach((actuator, index) => {
                        for (let i = 0; i < actuator.quantity; i++) {
                            this.wiringConnections.push({
                                id: connectionId++,
                                from: `خروجی PLC Q${index}.${i+1}`,
                                to: `رله K${actuator.id}.${i+1}`,
                                type: 'کنترل',
                                wireSize: '1.5mm²',
                                color: 'آبی',
                                terminal: `TB${Math.floor(connectionId/10)+1}`
                            });
                        }
                    });
                },
                
                // تولید لیست سیم‌ها
                generateWireList() {
                    this.wireList = [
                        { from: 'بریکر اصلی', to: 'تابلو قدرت', type: 'قدرت', size: '16mm²', color: 'مشکی/آبی/قهوه‌ای', length: 1.5 },
                        { from: 'منبع تغذیه', to: 'PLC', type: 'کنترل', size: '1.5mm²', color: 'آبی', length: 0.8 },
                        { from: 'PLC', to: 'ترمینال 1', type: 'سیگنال', size: '1.5mm²', color: 'سفید', length: 0.5 },
                        { from: 'ترمینال 1', to: 'سنسور دما 1', type: 'سیگنال', size: '1.5mm²', color: 'خاکستری', length: 5.0 },
                        { from: 'ترمینال 2', to: 'دمپر 1', type: 'کنترل', size: '1.5mm²', color: 'خاکستری', length: 4.0 }
                    ];
                },
                
                // تولید پلان ترمینال
                generateTerminalPlan() {
                    this.terminalPlan = [
                        { name: 'توزیع قدرت', type: 'قدرت', points: 24, tag: 'TB-PWR' },
                        { name: 'ورودی‌های دیجیتال PLC', type: 'DI', points: 16, tag: 'TB-DI' },
                        { name: 'خروجی‌های دیجیتال PLC', type: 'DO', points: 16, tag: 'TB-DO' },
                        { name: 'ورودی‌های آنالوگ PLC', type: 'AI', points: 8, tag: 'TB-AI' },
                        { name: 'کنترل موتورها', type: 'کنترل', points: 20, tag: 'TB-MOT' },
                        { name: 'اتصالات سنسورها', type: 'سنسور', points: 16, tag: 'TB-SEN' },
                        { name: 'اتصالات عملگرها', type: 'عملگر', points: 16, tag: 'TB-ACT' },
                        { name: 'اتصال شیلد', type: 'ارت', points: 12, tag: 'TB-SHD' }
                    ];
                },
                
                // چینش اتوماتیک تابلو
                generateAutoLayout() {
                    let layout = [];
                    let x = 1, y = 1;
                    
                    // PLC (2x2 بلوک)
                    layout.push({
                        type: 'plc',
                        tag: 'PLC',
                        details: 'S7-1200',
                        width: 2,
                        height: 2,
                        x: x,
                        y: y
                    });
                    x += 2;
                    
                    // منبع تغذیه (2x2)
                    layout.push({
                        type: 'psu',
                        tag: 'PSU',
                        details: '24V/5A',
                        width: 2,
                        height: 2,
                        x: x,
                        y: y
                    });
                    x += 2;
                    
                    // بریکر اصلی (2x2)
                    y += 2;
                    x = 1;
                    layout.push({
                        type: 'breaker',
                        tag: 'Q0',
                        details: '100A 4P',
                        width: 2,
                        height: 2,
                        x: x,
                        y: y
                    });
                    x += 2;
                    
                    // کنتاکتورها
                    let contactorIndex = 1;
                    this.motors.forEach(motor => {
                        for (let i = 0; i < motor.quantity; i++) {
                            layout.push({
                                type: 'contactor',
                                tag: `KM${contactorIndex}`,
                                details: `${motor.power}kW`,
                                width: 2,
                                height: 2,
                                x: x,
                                y: y
                            });
                            
                            x += 2;
                            if (x > 10) {
                                x = 1;
                                y += 2;
                            }
                            contactorIndex++;
                        }
                    });
                    
                    // رله‌ها
                    y += 2;
                    x = 1;
                    let relayIndex = 1;
                    this.actuators.forEach(actuator => {
                        for (let i = 0; i < actuator.quantity; i++) {
                            layout.push({
                                type: 'relay',
                                tag: `K${relayIndex}`,
                                details: '24V DC',
                                width: 1,
                                height: 1,
                                x: x,
                                y: y
                            });
                            
                            x += 1;
                            if (x > 12) {
                                x = 1;
                                y += 1;
                            }
                            relayIndex++;
                        }
                    });
                    
                    // قطعات اختیاری
                    let vfd = this.optionalComponents.find(c => c.name === 'اینورتر VFD');
                    let softStarter = this.optionalComponents.find(c => c.name === 'سافت استارتر');
                    let hmi = this.optionalComponents.find(c => c.name === 'پنل HMI');
                    
                    if (vfd && vfd.quantity > 0 && this.useInverter) {
                        y += 2;
                        x = 1;
                        layout.push({
                            type: 'inverter',
                            tag: 'VFD',
                            details: `${vfd.spec}`,
                            width: 5,
                            height: 5,
                            x: x,
                            y: y
                        });
                    }
                    
                    if (softStarter && softStarter.quantity > 0 && this.useSoftStarter) {
                        y += 5;
                        x = 1;
                        layout.push({
                            type: 'soft-starter',
                            tag: 'SS',
                            details: `${softStarter.spec}`,
                            width: 5,
                            height: 3,
                            x: x,
                            y: y
                        });
                    }
                    
                    if (hmi && hmi.quantity > 0) {
                        y += 3;
                        x = 1;
                        layout.push({
                            type: 'hmi',
                            tag: 'HMI',
                            details: `${hmi.spec}`,
                            width: 3,
                            height: 3,
                            x: x,
                            y: y
                        });
                    }
                    
                    // ترمینال‌ها
                    y += 3;
                    x = 1;
                    layout.push({
                        type: 'terminal',
                        tag: 'ترمینال',
                        details: `${this.summary.terminals} بلوک`,
                        width: 6,
                        height: 2,
                        x: x,
                        y: y
                    });
                    
                    this.layoutComponents = layout;
                },
                
                // استایل چینش
                getLayoutStyle(component) {
                    const blockWidth = 40; // پیکسل
                    const blockHeight = 50; // پیکسل
                    const gap = 3;
                    
                    return `
                        grid-column: ${component.x} / span ${component.width};
                        grid-row: ${component.y} / span ${component.height};
                    `;
                },
                
                // درگ اند دراپ
                dragStart(event, type) {
                    this.draggingComponent = type;
                    event.dataTransfer.setData('text/plain', type);
                    event.currentTarget.classList.add('dragging');
                },
                
                dragComponent(event, index) {
                    this.dragStartIndex = index;
                    event.dataTransfer.setData('text/plain', index);
                },
                
                dragOver(event) {
                    event.preventDefault();
                },
                
                drop(event) {
                    event.preventDefault();
                    
                    if (this.draggingComponent) {
                        // محاسبه موقعیت در گرید
                        const grid = document.getElementById('layoutGrid');
                        const rect = grid.getBoundingClientRect();
                        const x = Math.floor((event.clientX - rect.left) / 43); // 40px + 3px gap
                        const y = Math.floor((event.clientY - rect.top) / 53); // 50px + 3px gap
                        
                        // افزودن قطعه جدید
                        const newComponent = {
                            type: this.draggingComponent,
                            tag: this.draggingComponent.toUpperCase(),
                            details: 'دستی',
                            width: 2,
                            height: 2,
                            x: Math.max(1, Math.min(x, 12)),
                            y: Math.max(1, Math.min(y, 20))
                        };
                        
                        this.layoutComponents.push(newComponent);
                        this.draggingComponent = null;
                    }
                },
                
                dragEnd(event, index) {
                    // اگر قطعه به بیرون گرید کشیده شد، حذف شود
                    const grid = document.getElementById('layoutGrid');
                    const rect = grid.getBoundingClientRect();
                    
                    if (event.clientX < rect.left || event.clientX > rect.right || 
                        event.clientY < rect.top || event.clientY > rect.bottom) {
                        this.layoutComponents.splice(index, 1);
                    }
                },
                
                // چینش اتوماتیک
                autoLayout() {
                    this.generateAutoLayout();
                },
                
                // پاک کردن چینش
                clearLayout() {
                    if (confirm('آیا از پاک کردن چینش فعلی مطمئن هستید؟')) {
                        this.layoutComponents = [];
                    }
                },
                
                // مدیریت تمپلیت‌ها
                loadSavedTemplates() {
                    const saved = localStorage.getItem('plcTemplates');
                    if (saved) {
                        this.savedTemplates = JSON.parse(saved);
                    }
                },
                
                saveCustomTemplate() {
                    if (!this.customTemplateName.trim()) {
                        alert('لطفا نامی برای تمپلیت انتخاب کنید');
                        return;
                    }
                    
                    const template = {
                        name: this.customTemplateName,
                        description: this.customTemplateDescription,
                        data: {
                            motors: this.motors,
                            actuators: this.actuators,
                            sensors: this.sensors,
                            optionalComponents: this.optionalComponents,
                            useSoftStarter: this.useSoftStarter,
                            useInverter: this.useInverter,
                            layoutComponents: this.layoutComponents
                        },
                        savedAt: new Date().toISOString()
                    };
                    
                    this.savedTemplates.push(template);
                    localStorage.setItem('plcTemplates', JSON.stringify(this.savedTemplates));
                    
                    this.customTemplateName = '';
                    this.customTemplateDescription = '';
                    
                    alert('تمپلیت با موفقیت ذخیره شد');
                },
                
                loadSavedTemplate(template) {
                    this.motors = template.data.motors;
                    this.actuators = template.data.actuators;
                    this.sensors = template.data.sensors;
                    this.optionalComponents = template.data.optionalComponents;
                    this.useSoftStarter = template.data.useSoftStarter;
                    this.useInverter = template.data.useInverter;
                    this.layoutComponents = template.data.layoutComponents;
                    
                    this.calculateComponents();
                    this.activeTemplate = 'custom';
                    this.activeTemplateName = template.name;
                    
                    this.showModal = null;
                    alert(`تمپلیت "${template.name}" بارگذاری شد`);
                },
                
                deleteTemplate(index) {
                    if (confirm('آیا از حذف این تمپلیت مطمئن هستید؟')) {
                        this.savedTemplates.splice(index, 1);
                        localStorage.setItem('plcTemplates', JSON.stringify(this.savedTemplates));
                    }
                },
                
                // وایرینگ
                initWiringCanvas() {
                    setTimeout(() => {
                        const canvas = document.getElementById('wiringCanvas');
                        if (canvas) {
                            this.wiringCanvas = new fabric.Canvas('wiringCanvas');
                            this.generateAutoWiring();
                        }
                    }, 100);
                },
                
                generateAutoWiring() {
                    if (!this.wiringCanvas) return;
                    
                    this.wiringCanvas.clear();
                    
                    // ایجاد اجزای وایرینگ
                    const components = [
                        { type: 'plc', label: 'PLC', x: 50, y: 100 },
                        { type: 'psu', label: 'PSU', x: 200, y: 100 },
                        { type: 'contactor', label: 'KM1', x: 350, y: 100 },
                        { type: 'motor', label: 'M1', x: 500, y: 100 },
                        { type: 'sensor', label: 'T1', x: 50, y: 250 },
                        { type: 'terminal', label: 'TB1', x: 200, y: 250 }
                    ];
                    
                    // رسم اجزا
                    components.forEach(comp => {
                        let color = '#3498db';
                        if (comp.type === 'plc') color = '#3498db';
                        else if (comp.type === 'psu') color = '#9b59b6';
                        else if (comp.type === 'contactor') color = '#2ecc71';
                        else if (comp.type === 'motor') color = '#f39c12';
                        else if (comp.type === 'sensor') color = '#e74c3c';
                        else if (comp.type === 'terminal') color = '#7f8c8d';
                        
                        const rect = new fabric.Rect({
                            left: comp.x,
                            top: comp.y,
                            width: 80,
                            height: 60,
                            fill: color,
                            stroke: '#2c3e50',
                            strokeWidth: 2
                        });
                        
                        const text = new fabric.Text(comp.label, {
                            left: comp.x + 40,
                            top: comp.y + 30,
                            fontSize: 14,
                            fill: 'white',
                            textAlign: 'center',
                            originX: 'center',
                            originY: 'center'
                        });
                        
                        const group = new fabric.Group([rect, text], {
                            selectable: true,
                            hasControls: true,
                            hasBorders: true
                        });
                        
                        this.wiringCanvas.add(group);
                        this.wiringObjects.push(group);
                    });
                    
                    // رسم سیم‌ها
                    const wires = [
                        { from: { x: 130, y: 130 }, to: { x: 200, y: 130 }, color: 'blue' },
                        { from: { x: 280, y: 130 }, to: { x: 350, y: 130 }, color: 'red' },
                        { from: { x: 430, y: 130 }, to: { x: 500, y: 130 }, color: 'green' },
                        { from: { x: 90, y: 280 }, to: { x: 200, y: 280 }, color: 'gray' }
                    ];
                    
                    wires.forEach(wire => {
                        const line = new fabric.Line([
                            wire.from.x, wire.from.y,
                            wire.to.x, wire.to.y
                        ], {
                            stroke: wire.color,
                            strokeWidth: 2,
                            selectable: false
                        });
                        
                        this.wiringCanvas.add(line);
                    });
                    
                    this.wiringCanvas.renderAll();
                },
                
                clearWiringCanvas() {
                    if (this.wiringCanvas) {
                        this.wiringCanvas.clear();
                        this.wiringObjects = [];
                    }
                },
                
                addWire() {
                    if (!this.wiringCanvas) return;
                    
                    // اضافه کردن سیم جدید
                    const line = new fabric.Line([100, 300, 300, 300], {
                        stroke: 'black',
                        strokeWidth: 2,
                        selectable: true,
                        hasControls: true,
                        hasBorders: true
                    });
                    
                    this.wiringCanvas.add(line);
                    this.wiringCanvas.renderAll();
                },
                
                addComponentToWiring() {
                    if (!this.wiringCanvas) return;
                    
                    // اضافه کردن قطعه جدید
                    const rect = new fabric.Rect({
                        left: 400,
                        top: 200,
                        width: 80,
                        height: 60,
                        fill: '#3498db',
                        stroke: '#2c3e50',
                        strokeWidth: 2,
                        selectable: true,
                        hasControls: true,
                        hasBorders: true
                    });
                    
                    const text = new fabric.Text('NEW', {
                        left: 440,
                        top: 230,
                        fontSize: 14,
                        fill: 'white',
                        textAlign: 'center',
                        originX: 'center',
                        originY: 'center'
                    });
                    
                    const group = new fabric.Group([rect, text]);
                    this.wiringCanvas.add(group);
                    this.wiringObjects.push(group);
                    this.wiringCanvas.renderAll();
                },
                
                // تولید کد PLC
                generateAllCode() {
                    alert('کدهای PLC با توجه به تنظیمات فعلی تولید شدند. برای مشاهده جزئیات، بخش "تولید کد PLC" را انتخاب کنید.');
                },
                
                // خروجی‌گیری
                printDocument() {
                    window.print();
                },
                
                exportProjectAsJSON() {
                    const project = {
                        template: this.activeTemplate,
                        motors: this.motors,
                        actuators: this.actuators,
                        sensors: this.sensors,
                        optionalComponents: this.optionalComponents,
                        settings: {
                            useSoftStarter: this.useSoftStarter,
                            useInverter: this.useInverter
                        },
                        bom: this.bom,
                        layoutComponents: this.layoutComponents,
                        generatedAt: new Date().toISOString()
                    };
                    
                    const json = JSON.stringify(project, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `plc-project-${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },
                
                exportBOMToCSV() {
                    let csv = 'قطعه,تعداد,مشخصات,استانداردها,تگ‌ها\n';
                    this.bom.forEach(item => {
                        const tags = item.tags ? item.tags.join(';') : '';
                        csv += `"${item.name}",${item.quantity},"${item.specifications}","${item.standards}","${tags}"\n`;
                    });
                    
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `plc-bom-${new Date().toISOString().slice(0, 10)}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                },
                
                exportLayoutImage() {
                    const layoutElement = document.getElementById('layoutGrid');
                    html2canvas(layoutElement).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `plc-layout-${new Date().toISOString().slice(0, 10)}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                    });
                },
                
                exportWiringImage() {
                    if (!this.wiringCanvas) {
                        alert('لطفا ابتدا بخش وایرینگ را باز کنید');
                        return;
                    }
                    
                    const dataURL = this.wiringCanvas.toDataURL({
                        format: 'png',
                        quality: 1
                    });
                    
                    const link = document.createElement('a');
                    link.download = `plc-wiring-${new Date().toISOString().slice(0, 10)}.png`;
                    link.href = dataURL;
                    link.click();
                },
                
                exportFullReport() {
                    alert('گزارش کامل PDF در حال تولید است...');
                    // در نسخه کامل، از jsPDF برای تولید PDF استفاده می‌شود
                },
                
                // ذخیره و بارگذاری پروژه
                saveProject() {
                    this.exportProjectAsJSON();
                },
                
                loadProject() {
                    document.getElementById('fileInput').click();
                },
                
                loadProjectFromFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const project = JSON.parse(e.target.result);
                            
                            this.motors = project.motors || this.motors;
                            this.actuators = project.actuators || this.actuators;
                            this.sensors = project.sensors || this.sensors;
                            this.optionalComponents = project.optionalComponents || this.optionalComponents;
                            this.layoutComponents = project.layoutComponents || this.layoutComponents;
                            
                            if (project.settings) {
                                this.useSoftStarter = project.settings.useSoftStarter || false;
                                this.useInverter = project.settings.useInverter || false;
                            }
                            
                            this.activeTemplate = project.template || 'custom';
                            this.activeTemplateName = 'پروژه بارگذاری شده';
                            
                            this.calculateComponents();
                            
                            alert('پروژه با موفقیت بارگذاری شد!');
                        } catch (error) {
                            alert('خطا در بارگذاری فایل: ' + error.message);
                        }
                    };
                    reader.readAsText(file);
                    
                    event.target.value = '';
                }
            };
        }
    </script>
</body>
</html>