<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>طراح تابلو PLC - ایستگاه تهویه تبخیری نساجی</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1d4ed8;
            --secondary-color: #10b981;
            --secondary-dark: #059669;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --info-color: #3b82f6;
            --dark-color: #1f2937;
            --light-color: #f9fafb;
            --gray-color: #6b7280;
            --border-radius: 10px;
            --box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s ease;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Vazirmatn', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f3f4f6;
            color: #1f2937;
            line-height: 1.6;
            font-size: 16px;
            overflow-x: hidden;
        }

        .container {
            max-width: 100%;
            padding: 0 15px;
            margin: 0 auto;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 750px;
            }
        }

        @media (min-width: 992px) {
            .container {
                max-width: 970px;
            }
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 1200px;
            }
        }

        /* هدر و نویگیشن */
        .main-header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 1.2rem 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 50px;
            height: 50px;
            background-color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1e3a8a;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .site-title h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }

        .site-title p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }

            .header-controls {
                display: none;
                flex-direction: column;
                width: 100%;
                margin-top: 15px;
            }

            .header-controls.show {
                display: flex;
            }
        }

        /* تب‌ها و نویگیشن اصلی */
        .main-nav {
            background-color: white;
            border-bottom: 1px solid #e5e7eb;
            position: sticky;
            top: 82px;
            z-index: 999;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .nav-tabs {
            display: flex;
            overflow-x: auto;
            padding: 0;
            list-style: none;
            scrollbar-width: thin;
        }

        .nav-tabs::-webkit-scrollbar {
            height: 5px;
        }

        .nav-tabs::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 10px;
        }

        .tab-btn {
            padding: 15px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #6b7280;
            white-space: nowrap;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background-color: #f8fafc;
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background-color: #eff6ff;
        }

        .tab-btn .badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 20px;
        }

        /* محتوای اصلی */
        .main-content {
            padding: 25px 0;
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        @media (min-width: 992px) {
            .main-content {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* کارت‌ها */
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            margin-bottom: 20px;
            transition: var(--transition);
            border: 1px solid #e5e7eb;
        }

        .card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f3f4f6;
        }

        .card-title {
            font-size: 1.3rem;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            color: var(--primary-color);
        }

        .card-actions {
            display: flex;
            gap: 10px;
        }

        /* دکمه‌ها */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: var(--transition);
            font-size: 0.95rem;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.85rem;
        }

        .btn-lg {
            padding: 12px 24px;
            font-size: 1.1rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
            transform: translateY(-2px);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-2px);
        }

        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
        }

        /* کامپوننت‌ها */
        .component-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .component-item {
            background-color: #f8fafc;
            border-radius: 8px;
            padding: 18px;
            border-right: 4px solid var(--primary-color);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .component-item:hover {
            background-color: #f0f9ff;
            transform: translateX(-5px);
        }

        .component-item.highlight {
            border-right-color: var(--warning-color);
            background-color: #fef3c7;
        }

        .component-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .component-name {
            font-weight: 700;
            font-size: 1.1rem;
            color: #1f2937;
        }

        .component-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 12px;
            background-color: white;
            padding: 5px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .qty-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: none;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
            transition: var(--transition);
        }

        .qty-btn:hover {
            background-color: var(--primary-dark);
        }

        .qty-display {
            min-width: 40px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--dark-color);
        }

        .component-details {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
        }

        .detail-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 5px;
        }

        .detail-value {
            font-weight: 500;
            color: #1f2937;
        }

        .detail-input {
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.95rem;
            width: 100%;
            transition: var(--transition);
        }

        .detail-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .checkbox-label {
            font-size: 0.9rem;
            color: #4b5563;
            cursor: pointer;
        }

        /* لیست BOM */
        .bom-container {
            grid-column: 1 / -1;
        }

        .bom-table-container {
            overflow-x: auto;
            margin-top: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .bom-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        .bom-table th {
            background-color: #f9fafb;
            color: #374151;
            text-align: right;
            padding: 15px;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb;
            position: sticky;
            top: 0;
        }

        .bom-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #f3f4f6;
            color: #4b5563;
        }

        .bom-table tr:hover {
            background-color: #f9fafb;
        }

        .bom-table tr.total-row {
            background-color: #eff6ff;
            font-weight: bold;
        }

        /* لیوت تابلو */
        .layout-container {
            background-color: #1e293b;
            border-radius: var(--border-radius);
            padding: 20px;
            min-height: 500px;
            position: relative;
            overflow: auto;
        }

        .layout-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, 80px);
            grid-auto-rows: 100px;
            gap: 5px;
            width: 100%;
            min-height: 500px;
            background-color: #334155;
            padding: 15px;
            border-radius: 8px;
            position: relative;
        }

        .layout-component {
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            text-align: center;
            padding: 8px;
            overflow: hidden;
            position: relative;
            color: white;
            font-weight: 500;
            word-break: break-word;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
            cursor: pointer;
        }

        .layout-component:hover {
            transform: scale(1.05);
            z-index: 10;
        }

        .layout-component.plc {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .layout-component.psu {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .layout-component.breaker {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .layout-component.contactor {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .layout-component.relay {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .layout-component.inverter {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
        }

        .layout-component.soft-starter {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }

        .layout-component.hmi {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
        }

        .layout-component.terminal {
            background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
        }

        /* بخش کد PLC */
        .code-container {
            background-color: #1e293b;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
            color: #e2e8f0;
            max-height: 500px;
            overflow-y: auto;
        }

        .code-line {
            padding: 5px 0;
            border-bottom: 1px solid #334155;
            display: flex;
        }

        .line-number {
            width: 40px;
            color: #94a3b8;
            text-align: left;
            user-select: none;
        }

        .code-content {
            flex: 1;
            color: #e2e8f0;
        }

        .code-keyword {
            color: #60a5fa;
            font-weight: bold;
        }

        .code-comment {
            color: #94a3b8;
            font-style: italic;
        }

        .code-string {
            color: #34d399;
        }

        /* سناریو کنترل */
        .scenario-container {
            background-color: #f0f9ff;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-top: 25px;
            border-right: 5px solid var(--primary-color);
        }

        .scenario-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #1e3a8a;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .scenario-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            line-height: 1.8;
            white-space: pre-wrap;
            overflow-x: auto;
            border: 1px solid #e5e7eb;
        }

        /* لیست اتصالات */
        .connection-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .connection-item {
            background-color: #f8fafc;
            padding: 18px;
            border-radius: 8px;
            border-right: 4px solid var(--secondary-color);
            transition: var(--transition);
        }

        .connection-item:hover {
            background-color: #f0f9ff;
            transform: translateX(-5px);
        }

        .connection-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #1f2937;
            display: flex;
            justify-content: space-between;
        }

        .connection-details {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .connection-tags {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .tag {
            display: inline-block;
            background-color: #e0f2fe;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            color: #0369a1;
            font-weight: 500;
        }

        /* پایین صفحه */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 30px;
            box-shadow: var(--box-shadow);
            flex-wrap: wrap;
            gap: 15px;
        }

        .stats {
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
        }

        /* مودال */
        .modal {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 30px;
            width: 100%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: var(--transition);
            position: relative;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-title {
            font-size: 1.5rem;
            color: #1f2937;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            color: #6b7280;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .close-modal:hover {
            background-color: #f3f4f6;
            color: var(--danger-color);
        }

        /* تب‌های داخلی */
        .inner-tabs {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .inner-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }

        .inner-tab:hover {
            color: var(--primary-color);
        }

        .inner-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            font-weight: 600;
        }

        .inner-tab-content {
            display: none;
        }

        .inner-tab-content.active {
            display: block;
        }

        /* ادیتور JSON */
        .json-editor {
            width: 100%;
            height: 400px;
            font-family: 'Courier New', monospace;
            padding: 15px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: vertical;
            direction: ltr;
        }

        /* واکنش‌گرا */
        @media (max-width: 768px) {
            .component-details {
                grid-template-columns: 1fr;
            }

            .connection-list {
                grid-template-columns: 1fr;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .header-controls {
                width: 100%;
                margin-top: 15px;
            }

            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
            }

            .tab-btn {
                padding: 12px 15px;
                font-size: 0.9rem;
            }

            .card {
                padding: 20px;
            }

            .status-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats {
                width: 100%;
                justify-content: space-between;
            }

            .modal-content {
                padding: 20px;
            }

            .layout-grid {
                grid-template-columns: repeat(auto-fill, 70px);
                grid-auto-rows: 85px;
            }

            .layout-component {
                font-size: 0.65rem;
                padding: 5px;
            }
        }

        /* انیمیشن‌ها */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        /* پیش‌بارگذاری */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* گام‌های راهنما */
        .step-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 20px;
            right: 0;
            left: 0;
            height: 2px;
            background-color: #e5e7eb;
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            background-color: white;
            padding: 0 10px;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-bottom: 8px;
            transition: var(--transition);
        }

        .step.active .step-circle {
            background-color: var(--primary-color);
            color: white;
        }

        .step.completed .step-circle {
            background-color: var(--secondary-color);
            color: white;
        }

        .step-label {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .step.active .step-label {
            color: var(--primary-color);
            font-weight: 600;
        }
    </style>
</head>
<body x-data="plcDesigner()" x-init="init()" @keydown.escape="closeModals()">
    <!-- هدر اصلی -->
    <header class="main-header">
        <div class="container">
            <div class="header-content">
                <div class="logo-area">
                    <div class="logo">
                        <i class="fas fa-industry"></i>
                    </div>
                    <div class="site-title">
                        <h1>طراح تابلو PLC هوشمند</h1>
                        <p>ایستگاه تهویه تبخیری نساجی - طراحی و شبیه‌سازی کامل</p>
                    </div>
                </div>
                
                <button class="mobile-menu-btn" @click="mobileMenuOpen = !mobileMenuOpen">
                    <i class="fas fa-bars"></i>
                </button>
                
                <div class="header-controls" :class="{'show': mobileMenuOpen}">
                    <button class="btn btn-primary" @click="saveProject()" title="ذخیره پروژه">
                        <i class="fas fa-save"></i> ذخیره پروژه
                    </button>
                    <button class="btn btn-secondary" @click="loadProject()" title="بارگذاری پروژه">
                        <i class="fas fa-folder-open"></i> بارگذاری
                    </button>
                    <button class="btn btn-primary" @click="exportProject()" title="خروجی گرفتن">
                        <i class="fas fa-file-export"></i> خروجی
                    </button>
                    <button class="btn btn-danger" @click="showModal = 'export'" title="چاپ و خروجی">
                        <i class="fas fa-print"></i> چاپ/خروجی
                    </button>
                    <button class="btn btn-outline" @click="toggleLanguage()" title="تغییر زبان">
                        <i class="fas fa-language"></i> EN/FA
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- نویگیشن تب‌ها -->
    <nav class="main-nav">
        <div class="container">
            <div class="step-indicator">
                <div class="step" :class="{'active': activeTab === 'design', 'completed': activeTab !== 'design'}">
                    <div class="step-circle">۱</div>
                    <span class="step-label">طراحی اجزا</span>
                </div>
                <div class="step" :class="{'active': activeTab === 'layout', 'completed': activeTab === 'code' || activeTab === 'scenario' || activeTab === 'connections'}">
                    <div class="step-circle">۲</div>
                    <span class="step-label">چیدمان تابلو</span>
                </div>
                <div class="step" :class="{'active': activeTab === 'code', 'completed': activeTab === 'scenario' || activeTab === 'connections'}">
                    <div class="step-circle">۳</div>
                    <span class="step-label">کدنویسی PLC</span>
                </div>
                <div class="step" :class="{'active': activeTab === 'scenario'}">
                    <div class="step-circle">۴</div>
                    <span class="step-label">سناریو کنترل</span>
                </div>
                <div class="step" :class="{'active': activeTab === 'connections'}">
                    <div class="step-circle">۵</div>
                    <span class="step-label">اتصالات و سیم‌کشی</span>
                </div>
            </div>
            
            <ul class="nav-tabs">
                <li>
                    <button class="tab-btn" :class="{'active': activeTab === 'design'}" @click="activeTab = 'design'">
                        <i class="fas fa-cogs"></i> طراحی اجزا
                        <span class="badge" x-text="getTotalComponents()"></span>
                    </button>
                </li>
                <li>
                    <button class="tab-btn" :class="{'active': activeTab === 'layout'}" @click="activeTab = 'layout'">
                        <i class="fas fa-th-large"></i> چیدمان تابلو
                        <span class="badge" x-text="layoutComponents.length"></span>
                    </button>
                </li>
                <li>
                    <button class="tab-btn" :class="{'active': activeTab === 'bom'}" @click="activeTab = 'bom'">
                        <i class="fas fa-clipboard-list"></i> لیست قطعات (BOM)
                        <span class="badge" x-text="bom.length"></span>
                    </button>
                </li>
                <li>
                    <button class="tab-btn" :class="{'active': activeTab === 'code'}" @click="activeTab = 'code'">
                        <i class="fas fa-code"></i> کدنویسی PLC
                        <span class="badge" x-text="codeTemplates.length"></span>
                    </button>
                </li>
                <li>
                    <button class="tab-btn" :class="{'active': activeTab === 'scenario'}" @click="activeTab = 'scenario'">
                        <i class="fas fa-project-diagram"></i> سناریو کنترل
                    </button>
                </li>
                <li>
                    <button class="tab-btn" :class="{'active': activeTab === 'connections'}" @click="activeTab = 'connections'">
                        <i class="fas fa-network-wired"></i> اتصالات
                        <span class="badge" x-text="connections.length"></span>
                    </button>
                </li>
            </ul>
        </div>
    </nav>

    <!-- محتوای اصلی -->
    <main class="container">
        <!-- تب طراحی اجزا -->
        <div class="main-content" x-show="activeTab === 'design'">
            <!-- موتورهای سه فاز -->
            <div class="card fade-in">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-cogs"></i>
                        <span>موتورهای سه فاز</span>
                    </h2>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-primary" @click="resetSection('motors')">
                            <i class="fas fa-redo"></i> تنظیم مجدد
                        </button>
                    </div>
                </div>
                <div class="component-list">
                    <template x-for="(motor, index) in motors" :key="index">
                        <div class="component-item" :class="{'highlight': parseFloat(motor.power) > 5}">
                            <div class="component-header">
                                <div class="component-name">
                                    <i class="fas fa-motorcycle"></i>
                                    <span x-text="motor.name"></span>
                                    <span class="tag" x-show="parseFloat(motor.power) > 5">> 5kW</span>
                                </div>
                                <div class="component-controls">
                                    <div class="quantity-control">
                                        <button class="qty-btn" @click="decrementQuantity(motor)" :disabled="motor.quantity <= 0">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <div class="qty-display" x-text="motor.quantity"></div>
                                        <button class="qty-btn" @click="incrementQuantity(motor)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="component-details">
                                <div class="detail-item">
                                    <div class="detail-label">تعداد پیش‌فرض</div>
                                    <div class="detail-value" x-text="motor.defaultQuantity"></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">توان (کیلووات)</div>
                                    <input type="number" class="detail-input" x-model="motor.power" @change="calculateBOM()" min="0.1" max="60" step="0.1">
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">ولتاژ</div>
                                    <div class="detail-value">400V AC</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">جریان تخمینی (آمپر)</div>
                                    <div class="detail-value" x-text="calculateMotorCurrent(motor)"></div>
                                </div>
                            </div>
                            <div class="checkbox-group" x-show="parseFloat(motor.power) > 5">
                                <input type="checkbox" :id="'motorSoftStart' + index" x-model="motor.requiresSoftStart">
                                <label class="checkbox-label" :for="'motorSoftStart' + index">نیاز به سافت استارتر</label>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- عملگرها -->
            <div class="card fade-in">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-sliders-h"></i>
                        <span>عملگرها (Actuators)</span>
                    </h2>
                </div>
                <div class="component-list">
                    <template x-for="(actuator, index) in actuators" :key="index">
                        <div class="component-item">
                            <div class="component-header">
                                <div class="component-name">
                                    <i class="fas fa-compress-arrows-alt"></i>
                                    <span x-text="actuator.name"></span>
                                </div>
                                <div class="component-controls">
                                    <div class="quantity-control">
                                        <button class="qty-btn" @click="decrementQuantity(actuator)" :disabled="actuator.quantity <= 0">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <div class="qty-display" x-text="actuator.quantity"></div>
                                        <button class="qty-btn" @click="incrementQuantity(actuator)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="component-details">
                                <div class="detail-item">
                                    <div class="detail-label">تعداد پیش‌فرض</div>
                                    <div class="detail-value" x-text="actuator.defaultQuantity"></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">ولتاژ</div>
                                    <input type="text" class="detail-input" x-model="actuator.voltage" @change="calculateBOM()">
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">نوع کنترل</div>
                                    <select class="detail-input" x-model="actuator.controlType" @change="calculateBOM()">
                                        <option value="analog">آنالوگ 4-20mA</option>
                                        <option value="digital">دیجیتال</option>
                                        <option value="modbus">Modbus</option>
                                    </select>
                                </div>
                            </div>
                            <div class="checkbox-group">
                                <input type="checkbox" :id="'hasPositioner' + index" x-model="actuator.hasPositioner" @change="calculateBOM()">
                                <label class="checkbox-label" :for="'hasPositioner' + index">دارای پوزیشنر</label>
                            </div>
                            <div class="checkbox-group" x-show="actuator.hasPositioner">
                                <input type="checkbox" :id="'readPosition' + index" x-model="actuator.readPosition" @change="calculateBOM()">
                                <label class="checkbox-label" :for="'readPosition' + index">خواندن موقعیت</label>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- سنسورها -->
            <div class="card fade-in">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-thermometer-half"></i>
                        <span>سنسورها</span>
                    </h2>
                </div>
                <div class="component-list">
                    <template x-for="(sensor, index) in sensors" :key="index">
                        <div class="component-item">
                            <div class="component-header">
                                <div class="component-name">
                                    <i class="fas fa-satellite-dish"></i>
                                    <span x-text="sensor.name"></span>
                                </div>
                                <div class="component-controls">
                                    <div class="quantity-control">
                                        <button class="qty-btn" @click="decrementQuantity(sensor)" :disabled="sensor.quantity <= 0">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <div class="qty-display" x-text="sensor.quantity"></div>
                                        <button class="qty-btn" @click="incrementQuantity(sensor)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="component-details">
                                <div class="detail-item">
                                    <div class="detail-label">تعداد پیش‌فرض</div>
                                    <div class="detail-value" x-text="sensor.defaultQuantity"></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">نوع</div>
                                    <div class="detail-value" x-text="sensor.type"></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">سیگنال</div>
                                    <select class="detail-input" x-model="sensor.signalType" @change="calculateBOM()">
                                        <option value="4-20ma">4-20mA</option>
                                        <option value="0-10v">0-10V</option>
                                        <option value="digital">دیجیتال</option>
                                        <option value="pt100">PT100</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- تجهیزات اختیاری -->
            <div class="card fade-in">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-plus-circle"></i>
                        <span>تجهیزات اختیاری</span>
                    </h2>
                </div>
                <div class="component-list">
                    <template x-for="(optional, index) in optionalComponents" :key="index">
                        <div class="component-item">
                            <div class="component-header">
                                <div class="component-name">
                                    <i class="fas fa-tools"></i>
                                    <span x-text="optional.name"></span>
                                </div>
                                <div class="component-controls">
                                    <div class="quantity-control">
                                        <button class="qty-btn" @click="decrementQuantity(optional)" :disabled="optional.quantity <= 0">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <div class="qty-display" x-text="optional.quantity"></div>
                                        <button class="qty-btn" @click="incrementQuantity(optional)">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="component-details">
                                <div class="detail-item">
                                    <div class="detail-label">تعداد پیش‌فرض</div>
                                    <div class="detail-value" x-text="optional.defaultQuantity"></div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">مشخصات</div>
                                    <input type="text" class="detail-input" x-model="optional.spec" @change="calculateBOM()">
                                </div>
                                <div class="detail-item" x-show="optional.name === 'VFD Inverter'">
                                    <div class="detail-label">بزرگترین موتور (kW)</div>
                                    <div class="detail-value" x-text="getLargestMotorPower()"></div>
                                </div>
                            </div>
                            <div class="checkbox-group" x-show="optional.name === 'VFD Inverter'">
                                <input type="checkbox" id="useInverter" x-model="useInverter" @change="calculateBOM()">
                                <label class="checkbox-label" for="useInverter">استفاده از اینورتر برای بزرگترین موتور</label>
                            </div>
                            <div class="checkbox-group" x-show="optional.name === 'Soft Starter'">
                                <input type="checkbox" id="useSoftStarter" x-model="useSoftStarter" @change="calculateBOM()">
                                <label class="checkbox-label" for="useSoftStarter">استفاده از سافت استارتر برای موتورهای بالای 5kW</label>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>

        <!-- تب چیدمان تابلو -->
        <div class="main-content" x-show="activeTab === 'layout'">
            <div class="card fade-in" style="grid-column: 1 / -1;">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-th-large"></i>
                        <span>چیدمان تابلو کنترل</span>
                    </h2>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-secondary" @click="autoArrangeLayout()">
                            <i class="fas fa-magic"></i> چیدمان خودکار
                        </button>
                        <button class="btn btn-sm btn-primary" @click="showModal = 'layoutSettings'">
                            <i class="fas fa-cog"></i> تنظیمات چیدمان
                        </button>
                    </div>
                </div>
                
                <div class="color-legend" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; padding: 15px; background-color: #f8fafc; border-radius: 8px;">
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <div class="legend-color" style="width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);"></div>
                        <span>PLC و ماژول‌ها</span>
                    </div>
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <div class="legend-color" style="width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);"></div>
                        <span>منبع تغذیه</span>
                    </div>
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <div class="legend-color" style="width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);"></div>
                        <span>بریکرها</span>
                    </div>
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <div class="legend-color" style="width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(135deg, #10b981 0%, #059669 100%);"></div>
                        <span>کنتاکتورها</span>
                    </div>
                    <div class="legend-item" style="display: flex; align-items: center; gap: 8px;">
                        <div class="legend-color" style="width: 20px; height: 20px; border-radius: 4px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);"></div>
                        <span>رله‌ها</span>
                    </div>
                </div>
                
                <div class="layout-container">
                    <div class="layout-grid" id="layoutGrid">
                        <template x-for="(component, index) in layoutComponents" :key="index">
                            <div class="layout-component" 
                                 :class="component.type"
                                 :style="`grid-column: span ${Math.max(1, Math.ceil(component.width / 16))}; grid-row: span ${Math.max(1, Math.ceil(component.height / 20))};`"
                                 :title="component.tag + ' - ' + component.details"
                                 @click="showComponentDetails(component)">
                                <div x-text="component.tag" style="font-weight: bold; font-size: 0.85rem;"></div>
                                <div style="font-size: 0.7rem; margin-top: 3px;" x-text="component.details"></div>
                                <div style="position: absolute; bottom: 3px; left: 5px; font-size: 0.6rem; opacity: 0.8;" x-text="component.size"></div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <h4 style="margin-bottom: 10px;">مشخصات تابلو</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px;">
                            <div>
                                <span style="font-size: 0.9rem; color: #6b7280;">ابعاد تابلو:</span>
                                <span style="font-weight: 600; margin-right: 5px;" x-text="cabinetDimensions"></span>
                            </div>
                            <div>
                                <span style="font-size: 0.9rem; color: #6b7280;">فضای استفاده شده:</span>
                                <span style="font-weight: 600; margin-right: 5px;" x-text="calculateUsedSpace()"></span>
                            </div>
                            <div>
                                <span style="font-size: 0.9rem; color: #6b7280;">تعداد اجزا:</span>
                                <span style="font-weight: 600; margin-right: 5px;" x-text="layoutComponents.length"></span>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" @click="exportLayoutImage()">
                        <i class="fas fa-camera"></i> ذخیره تصویر چیدمان
                    </button>
                </div>
            </div>
        </div>

        <!-- تب لیست قطعات -->
        <div class="main-content" x-show="activeTab === 'bom'">
            <div class="card fade-in bom-container">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-clipboard-list"></i>
                        <span>لیست قطعات (BOM)</span>
                    </h2>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-secondary" @click="exportBOM('csv')">
                            <i class="fas fa-file-csv"></i> خروجی CSV
                        </button>
                        <button class="btn btn-sm btn-primary" @click="exportBOM('pdf')">
                            <i class="fas fa-file-pdf"></i> خروجی PDF
                        </button>
                        <button class="btn btn-sm btn-outline" @click="showModal = 'bomSettings'">
                            <i class="fas fa-cog"></i> تنظیمات
                        </button>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div style="display: flex; gap: 20px;">
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">تعداد کل قطعات:</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary-color);" x-text="bom.length"></div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">تعداد رله‌ها:</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--secondary-color);" x-text="relayCount"></div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">تعداد کنتاکتورها:</div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: var(--danger-color);" x-text="contactorCount"></div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size: 0.9rem; color: #6b7280;">تخمین هزینه (یورو):</div>
                        <div style="font-size: 1.8rem; font-weight: bold; color: var(--warning-color);" x-text="'€' + totalCost.toLocaleString('fa-IR')"></div>
                    </div>
                </div>
                
                <div class="bom-table-container">
                    <table class="bom-table">
                        <thead>
                            <tr>
                                <th>ردیف</th>
                                <th>نام قطعه</th>
                                <th>تعداد</th>
                                <th>مشخصات فنی</th>
                                <th>استانداردها</th>
                                <th>تگ‌ها</th>
                                <th>قیمت تخمینی (یورو)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(item, index) in bom" :key="index">
                                <tr>
                                    <td x-text="index + 1"></td>
                                    <td>
                                        <div style="font-weight: 600;" x-text="item.name"></div>
                                        <div style="font-size: 0.8rem; color: #6b7280;" x-text="item.category"></div>
                                    </td>
                                    <td>
                                        <span x-text="item.quantity" style="font-weight: bold; font-size: 1.1rem;"></span>
                                    </td>
                                    <td x-text="item.specifications"></td>
                                    <td x-text="item.standards"></td>
                                    <td>
                                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                            <template x-for="tag in item.tags" :key="tag">
                                                <span class="tag" x-text="tag"></span>
                                            </template>
                                        </div>
                                    </td>
                                    <td style="font-weight: bold; text-align: left;">
                                        <span x-text="'€' + (item.estimatedPrice || 0).toLocaleString('fa-IR')"></span>
                                    </td>
                                </tr>
                            </template>
                            <tr class="total-row">
                                <td colspan="6" style="text-align: left; font-size: 1.1rem;">مجموع هزینه:</td>
                                <td style="text-align: left; font-size: 1.3rem; color: var(--warning-color);">
                                    <span x-text="'€' + totalCost.toLocaleString('fa-IR')"></span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- تب کدنویسی PLC -->
        <div class="main-content" x-show="activeTab === 'code'">
            <div class="card fade-in" style="grid-column: 1 / -1;">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-code"></i>
                        <span>کد کنترل PLC</span>
                    </h2>
                    <div class="card-actions">
                        <select class="detail-input" style="width: 200px;" x-model="selectedCodeTemplate" @change="generatePLCcode()">
                            <option value="">انتخاب قالب کد</option>
                            <template x-for="(template, index) in codeTemplates" :key="index">
                                <option :value="index" x-text="template.name"></option>
                            </template>
                        </select>
                        <button class="btn btn-sm btn-primary" @click="downloadPLCcode()">
                            <i class="fas fa-download"></i> دانلود کد
                        </button>
                        <button class="btn btn-sm btn-secondary" @click="showModal = 'codeSettings'">
                            <i class="fas fa-cog"></i> تنظیمات
                        </button>
                    </div>
                </div>
                
                <div class="inner-tabs">
                    <button class="inner-tab" :class="{'active': activeCodeTab === 'ladder'}" @click="activeCodeTab = 'ladder'">
                        <i class="fas fa-sitemap"></i> منطق نردبانی (Ladder)
                    </button>
                    <button class="inner-tab" :class="{'active': activeCodeTab === 'structured'}" @click="activeCodeTab = 'structured'">
                        <i class="fas fa-file-code"></i> متن ساخت یافته
                    </button>
                    <button class="inner-tab" :class="{'active': activeCodeTab === 'function'}" @click="activeCodeTab = 'function'">
                        <i class="fas fa-functions"></i> بلوک‌های تابع
                    </button>
                </div>
                
                <div class="inner-tab-content" :class="{'active': activeCodeTab === 'ladder'}">
                    <div class="code-container">
                        <template x-for="(line, index) in plcCode.ladder" :key="index">
                            <div class="code-line">
                                <div class="line-number" x-text="index + 1"></div>
                                <div class="code-content">
                                    <template x-if="line.type === 'comment'">
                                        <span class="code-comment" x-text="'// ' + line.text"></span>
                                    </template>
                                    <template x-if="line.type === 'instruction'">
                                        <span x-html="line.text"></span>
                                    </template>
                                    <template x-if="line.type === 'network'">
                                        <span style="color: #fbbf24; font-weight: bold;" x-text="'Network ' + line.text"></span>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="inner-tab-content" :class="{'active': activeCodeTab === 'structured'}">
                    <div class="code-container">
                        <template x-for="(line, index) in plcCode.structured" :key="index">
                            <div class="code-line">
                                <div class="line-number" x-text="index + 1"></div>
                                <div class="code-content">
                                    <template x-if="line.type === 'comment'">
                                        <span class="code-comment" x-text="'// ' + line.text"></span>
                                    </template>
                                    <template x-if="line.type === 'code'">
                                        <span x-html="line.text"></span>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="inner-tab-content" :class="{'active': activeCodeTab === 'function'}">
                    <div class="code-container">
                        <template x-for="(line, index) in plcCode.functionBlocks" :key="index">
                            <div class="code-line">
                                <div class="line-number" x-text="index + 1"></div>
                                <div class="code-content" x-text="line.text"></div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px;">
                    <div style="background-color: #f8fafc; padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; color: var(--primary-color);">
                            <i class="fas fa-microchip"></i> اطلاعات PLC
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">ورودی‌های دیجیتال:</div>
                                <div style="font-weight: bold;" x-text="digitalInputs.length"></div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">خروجی‌های دیجیتال:</div>
                                <div style="font-weight: bold;" x-text="digitalOutputs.length"></div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">ورودی‌های آنالوگ:</div>
                                <div style="font-weight: bold;" x-text="analogInputs.length"></div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">خروجی‌های آنالوگ:</div>
                                <div style="font-weight: bold;" x-text="analogOutputs.length"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background-color: #f0f9ff; padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; color: var(--primary-color);">
                            <i class="fas fa-cogs"></i> تنظیمات کنترلی
                        </h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">PID Loops:</div>
                                <div style="font-weight: bold;">4</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">Timers:</div>
                                <div style="font-weight: bold;">8</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">Counters:</div>
                                <div style="font-weight: bold;">6</div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">Memory Used:</div>
                                <div style="font-weight: bold;">65%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- تب سناریو کنترل -->
        <div class="main-content" x-show="activeTab === 'scenario'">
            <div class="card fade-in" style="grid-column: 1 / -1;">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-project-diagram"></i>
                        <span>سناریو کنترل سیستم تهویه</span>
                    </h2>
                    <div class="card-actions">
                        <select class="detail-input" style="width: 200px;" x-model="selectedScenario" @change="loadScenario()">
                            <option value="">انتخاب سناریو</option>
                            <option value="default">کنترل استاندارد</option>
                            <option value="energy">صرفه‌جویی انرژی</option>
                            <option value="humidity">کنترل رطوبت دقیق</option>
                            <option value="temperature">کنترل دمای دقیق</option>
                            <option value="manual">کنترل دستی</option>
                        </select>
                    </div>
                </div>
                
                <div class="scenario-container">
                    <h3 class="scenario-title">
                        <i class="fas fa-info-circle"></i>
                        <span>توضیحات سناریو</span>
                    </h3>
                    <div class="scenario-content" x-text="scenarioDescription"></div>
                </div>
                
                <div style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <h4 style="margin-bottom: 15px; color: var(--primary-color);">
                            <i class="fas fa-wind"></i> کنترل دمپرها
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">دمپر هوای تازه:</div>
                                <div style="font-weight: bold;" x-text="damperControl.fresh + '%'"></div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">دمپر هوای برگشت:</div>
                                <div style="font-weight: bold;" x-text="damperControl.return + '%'"></div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">دمپر اگزاست:</div>
                                <div style="font-weight: bold;" x-text="damperControl.exhaust + '%'"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <h4 style="margin-bottom: 15px; color: var(--secondary-color);">
                            <i class="fas fa-tachometer-alt"></i> کنترل موتورها
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">فن رفت:</div>
                                <div style="font-weight: bold;" x-text="motorControl.fanFeed + '%'"></div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">فن برگشت:</div>
                                <div style="font-weight: bold;" x-text="motorControl.fanReturn + '%'"></div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">پمپ آب:</div>
                                <div style="font-weight: bold;" x-text="motorControl.waterPump + '%'"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                        <h4 style="margin-bottom: 15px; color: var(--danger-color);">
                            <i class="fas fa-thermometer-three-quarters"></i> کنترل دما و رطوبت
                        </h4>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">دمای سالن (RT):</div>
                                <div style="font-weight: bold;" x-text="controlParams.rt + '°C'"></div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">رطوبت سالن (RH):</div>
                                <div style="font-weight: bold;" x-text="controlParams.rh + '%'"></div>
                            </div>
                            <div>
                                <div style="font-size: 0.9rem; color: #6b7280;">دمای بیرون (OT):</div>
                                <div style="font-weight: bold;" x-text="controlParams.ot + '°C'"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 30px;">
                    <h4 style="margin-bottom: 15px; color: var(--dark-color);">
                        <i class="fas fa-calculator"></i> محاسبات سایکرومتریک
                    </h4>
                    <div class="scenario-content">
feed = fresh percentage + cycle percentage;
fresh percentage = exhaust percentage;
cycle percentage = 100 - fresh percentage;

// محاسبه دمای هوای مخلوط (MT)
mt = (ot * fresh_percentage + ct * cycle_percentage) / 100;

// محاسبه رطوبت هوای مخلوط (HT)
ht = (oh * fresh_percentage + ch * cycle_percentage) / 100;

// کنترل گرمایش در صورت نیاز
if (rt < setpoint_temp) {
    heat_valve = ON;
    ct = calculate_heating_coil_output(ct);
}

// کنترل رطوبت‌دهی در صورت نیاز
if (rh < setpoint_humidity) {
    water_pump = ON;
    feed = calculate_evaporative_cooling(feed);
}

// حلقه‌های کنترلی PID
pid_temp.setpoint = setpoint_temp;
pid_humidity.setpoint = setpoint_humidity;
pid_temp.input = rt;
pid_humidity.input = rh;

fresh_percentage = pid_temp.output;
water_pump_speed = pid_humidity.output;
                    </div>
                </div>
            </div>
        </div>

        <!-- تب اتصالات -->
        <div class="main-content" x-show="activeTab === 'connections'">
            <div class="card fade-in" style="grid-column: 1 / -1;">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-network-wired"></i>
                        <span>اتصالات و سیم‌کشی</span>
                    </h2>
                    <div class="card-actions">
                        <button class="btn btn-sm btn-primary" @click="exportWiringDiagram()">
                            <i class="fas fa-download"></i> خروجی نقشه سیم‌کشی
                        </button>
                        <button class="btn btn-sm btn-secondary" @click="showModal = 'terminalPlan'">
                            <i class="fas fa-th"></i> نقشه ترمینال‌ها
                        </button>
                    </div>
                </div>
                
                <div class="inner-tabs">
                    <button class="inner-tab" :class="{'active': activeConnectionTab === 'list'}" @click="activeConnectionTab = 'list'">
                        <i class="fas fa-list"></i> لیست اتصالات
                    </button>
                    <button class="inner-tab" :class="{'active': activeConnectionTab === 'terminals'}" @click="activeConnectionTab = 'terminals'">
                        <i class="fas fa-plug"></i> نقشه ترمینال
                    </button>
                    <button class="inner-tab" :class="{'active': activeConnectionTab === 'io'}" @click="activeConnectionTab = 'io'">
                        <i class="fas fa-microchip"></i> لیست I/O
                    </button>
                </div>
                
                <div class="inner-tab-content" :class="{'active': activeConnectionTab === 'list'}">
                    <div class="connection-list">
                        <template x-for="(connection, index) in connections" :key="index">
                            <div class="connection-item">
                                <div class="connection-title">
                                    <span x-text="connection.from + ' → ' + connection.to"></span>
                                    <span class="tag" x-text="connection.wireSize"></span>
                                </div>
                                <div class="connection-details" x-text="connection.type"></div>
                                <div class="connection-tags">
                                    <span class="tag" x-text="connection.terminal"></span>
                                    <span class="tag" x-text="connection.color"></span>
                                    <span class="tag" x-text="connection.length + 'm'"></span>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
                
                <div class="inner-tab-content" :class="{'active': activeConnectionTab === 'terminals'}">
                    <div style="background-color: #f8fafc; padding: 20px; border-radius: 8px;">
                        <h4 style="margin-bottom: 15px; color: var(--primary-color);">نقشه ترمینال‌ها</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;">
                            <template x-for="(terminal, index) in terminalPlan" :key="index">
                                <div style="background-color: white; padding: 15px; border-radius: 8px; border: 1px solid #e5e7eb;">
                                    <div style="font-weight: 600; margin-bottom: 5px; color: var(--primary-color);" x-text="terminal.name"></div>
                                    <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 3px;">نوع: <span x-text="terminal.type"></span></div>
                                    <div style="font-size: 0.9rem; color: #6b7280; margin-bottom: 3px;">تعداد نقاط: <span x-text="terminal.points"></span></div>
                                    <div style="font-size: 0.9rem; color: #6b7280;">شماره: <span class="tag" x-text="terminal.number"></span></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
                
                <div class="inner-tab-content" :class="{'active': activeConnectionTab === 'io'}">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                        <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <h4 style="margin-bottom: 15px; color: var(--primary-color);">
                                <i class="fas fa-sign-in-alt"></i> ورودی‌های دیجیتال
                            </h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <template x-for="(di, index) in digitalInputs" :key="index">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f3f4f6;">
                                        <div>
                                            <div style="font-weight: 500;" x-text="di.name"></div>
                                            <div style="font-size: 0.8rem; color: #6b7280;" x-text="di.description"></div>
                                        </div>
                                        <span class="tag" x-text="di.address"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <h4 style="margin-bottom: 15px; color: var(--secondary-color);">
                                <i class="fas fa-sign-out-alt"></i> خروجی‌های دیجیتال
                            </h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <template x-for="(do, index) in digitalOutputs" :key="index">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f3f4f6;">
                                        <div>
                                            <div style="font-weight: 500;" x-text="do.name"></div>
                                            <div style="font-size: 0.8rem; color: #6b7280;" x-text="do.description"></div>
                                        </div>
                                        <span class="tag" x-text="do.address"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                        
                        <div style="background-color: white; padding: 20px; border-radius: 8px; border: 1px solid #e5e7eb;">
                            <h4 style="margin-bottom: 15px; color: var(--warning-color);">
                                <i class="fas fa-wave-square"></i> ورودی‌های آنالوگ
                            </h4>
                            <div style="max-height: 300px; overflow-y: auto;">
                                <template x-for="(ai, index) in analogInputs" :key="index">
                                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #f3f4f6;">
                                        <div>
                                            <div style="font-weight: 500;" x-text="ai.name"></div>
                                            <div style="font-size: 0.8rem; color: #6b7280;" x-text="ai.range"></div>
                                        </div>
                                        <span class="tag" x-text="ai.address"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- نوار وضعیت پایین -->
    <div class="status-bar">
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" x-text="getTotalComponents()"></div>
                <div class="stat-label">مجموع اجزا</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" x-text="relayCount"></div>
                <div class="stat-label">رله</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" x-text="contactorCount"></div>
                <div class="stat-label">کنتاکتور</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" x-text="terminalCount"></div>
                <div class="stat-label">ترمینال</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" x-text="'€' + totalCost.toLocaleString('fa-IR')"></div>
                <div class="stat-label">هزینه تخمینی</div>
            </div>
        </div>
        <div>
            <button class="btn btn-primary btn-lg" @click="showModal = 'summary'">
                <i class="fas fa-chart-bar"></i> مشاهده خلاصه پروژه
            </button>
        </div>
    </div>

    <!-- مودال خلاصه پروژه -->
    <div class="modal" :class="{'show': showModal === 'summary'}">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">خلاصه پروژه طراحی تابلو</h3>
                <button class="close-modal" @click="showModal = null">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <div style="background-color: #f0f9ff; padding: 20px; border-radius: 8px;">
                    <h4 style="margin-bottom: 15px; color: var(--primary-color);">مشخصات کلی</h4>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>نام پروژه:</span>
                            <span style="font-weight: bold;">ایستگاه تهویه تبخیری نساجی</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>تاریخ طراحی:</span>
                            <span style="font-weight: bold;" x-text="new Date().toLocaleDateString('fa-IR')"></span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>تعداد اجزا:</span>
                            <span style="font-weight: bold;" x-text="getTotalComponents()"></span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>ابعاد تابلو:</span>
                            <span style="font-weight: bold;" x-text="cabinetDimensions"></span>
                        </div>
                    </div>
                </div>
                
                <div style="background-color: #f0fdf4; padding: 20px; border-radius: 8px;">
                    <h4 style="margin-bottom: 15px; color: var(--secondary-color);">جزئیات فنی</h4>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>PLC:</span>
                            <span style="font-weight: bold;">Siemens S7-1200</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>HMI:</span>
                            <span style="font-weight: bold;" x-text="getHMIcount()"></span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>اینورتر:</span>
                            <span style="font-weight: bold;" x-text="useInverter ? 'دارد' : 'ندارد'"></span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>سافت استارتر:</span>
                            <span style="font-weight: bold;" x-text="useSoftStarter ? 'دارد' : 'ندارد'"></span>
                        </div>
                    </div>
                </div>
                
                <div style="background-color: #fef3c7; padding: 20px; border-radius: 8px;">
                    <h4 style="margin-bottom: 15px; color: var(--warning-color);">هزینه‌ها</h4>
                    <div style="display: grid; gap: 10px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>قطعات اصلی:</span>
                            <span style="font-weight: bold;" x-text="'€' + (totalCost * 0.7).toLocaleString('fa-IR')"></span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>لوازم مصرفی:</span>
                            <span style="font-weight: bold;" x-text="'€' + (totalCost * 0.2).toLocaleString('fa-IR')"></span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>ساخت و مونتاژ:</span>
                            <span style="font-weight: bold;" x-text="'€' + (totalCost * 0.3).toLocaleString('fa-IR')"></span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>مجموع:</span>
                            <span style="font-weight: bold; font-size: 1.2rem; color: var(--warning-color);" x-text="'€' + (totalCost * 1.2).toLocaleString('fa-IR')"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 20px;">
                <h4>گزارش فنی</h4>
                <div style="background-color: #f8fafc; padding: 15px; border-radius: 8px; margin-top: 10px;">
                    <p>این تابلو برای کنترل ایستگاه تهویه تبخیری با مشخصات زیر طراحی شده است:</p>
                    <ul style="margin-top: 10px; padding-right: 20px;">
                        <li>کنترل 6 نوع موتور سه فاز با توان‌های مختلف</li>
                        <li>کنترل 4 نوع عملگر با قابلیت خواندن موقعیت</li>
                        <li>نظارت بر 3 نوع سنسور دما، رطوبت و وضعیت درب</li>
                        <li>دارای قابلیت اتصال HMI برای مانیتورینگ</li>
                        <li>سیستم کنترل PID برای دما و رطوبت</li>
                        <li>حفاظت کامل الکتریکی و اتصال زمین</li>
                    </ul>
                </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn btn-primary" @click="exportFullReport()">
                    <i class="fas fa-file-pdf"></i> خروجی PDF کامل
                </button>
                <button class="btn btn-danger" @click="showModal = null">
                    بستن
                </button>
            </div>
        </div>
    </div>

    <!-- مودال خروجی -->
    <div class="modal" :class="{'show': showModal === 'export'}">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">گزینه‌های خروجی و چاپ</h3>
                <button class="close-modal" @click="showModal = null">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p>نوع خروجی مورد نظر خود را انتخاب کنید:</p>
            <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; margin-top: 20px;">
                <button class="btn btn-primary" style="flex-direction: column; height: auto; padding: 20px;" @click="printDocument()">
                    <i class="fas fa-print fa-2x"></i>
                    <span style="margin-top: 10px;">چاپ سند</span>
                </button>
                <button class="btn btn-secondary" style="flex-direction: column; height: auto; padding: 20px;" @click="exportLayoutImage()">
                    <i class="fas fa-image fa-2x"></i>
                    <span style="margin-top: 10px;">ذخیره تصویر چیدمان</span>
                </button>
                <button class="btn btn-primary" style="flex-direction: column; height: auto; padding: 20px;" @click="exportBOM('csv')">
                    <i class="fas fa-file-csv fa-2x"></i>
                    <span style="margin-top: 10px;">خروجی BOM به CSV</span>
                </button>
                <button class="btn btn-secondary" style="flex-direction: column; height: auto; padding: 20px;" @click="exportBOM('pdf')">
                    <i class="fas fa-file-pdf fa-2x"></i>
                    <span style="margin-top: 10px;">خروجی BOM به PDF</span>
                </button>
                <button class="btn btn-primary" style="flex-direction: column; height: auto; padding: 20px;" @click="saveProject()">
                    <i class="fas fa-save fa-2x"></i>
                    <span style="margin-top: 10px;">ذخیره پروژه (JSON)</span>
                </button>
                <button class="btn btn-secondary" style="flex-direction: column; height: auto; padding: 20px;" @click="exportFullReport()">
                    <i class="fas fa-file-archive fa-2x"></i>
                    <span style="margin-top: 10px;">گزارش کامل پروژه</span>
                </button>
            </div>
            <div style="margin-top: 20px; text-align: left;">
                <button class="btn btn-danger" @click="showModal = null">
                    لغو
                </button>
            </div>
        </div>
    </div>

    <!-- مودال JSON -->
    <div class="modal" :class="{'show': showModal === 'json'}">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">داده‌های JSON پروژه</h3>
                <button class="close-modal" @click="showModal = null">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <p>برای ذخیره پروژه، داده‌های JSON زیر را کپی کنید یا برای بارگذاری پروژه، داده‌های JSON را در کادر زیر قرار دهید.</p>
            <textarea class="json-editor" x-text="getProjectJSON()"></textarea>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" @click="copyJSON()">
                    <i class="fas fa-copy"></i> کپی JSON
                </button>
                <button class="btn btn-secondary" @click="importJSON()">
                    <i class="fas fa-file-import"></i> بارگذاری از JSON
                </button>
                <button class="btn btn-danger" @click="showModal = null">
                    بستن
                </button>
            </div>
        </div>
    </div>

    <!-- مودال جزئیات قطعه -->
    <div class="modal" :class="{'show': showModal === 'componentDetails'}">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" x-text="selectedComponent ? selectedComponent.tag : ''"></h3>
                <button class="close-modal" @click="showModal = null">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <template x-if="selectedComponent">
                <div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">نوع:</div>
                            <div style="font-weight: bold; font-size: 1.1rem;" x-text="selectedComponent.type"></div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">ابعاد:</div>
                            <div style="font-weight: bold; font-size: 1.1rem;" x-text="selectedComponent.width + ' × ' + selectedComponent.height + ' cm'"></div>
                        </div>
                        <div>
                            <div style="font-size: 0.9rem; color: #6b7280;">موقعیت در تابلو:</div>
                            <div style="font-weight: bold; font-size: 1.1rem;" x-text="'ردیف ' + selectedComponent.row + ', ستون ' + selectedComponent.col"></div>
                        </div>
                    </div>
                    
                    <div style="background-color: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="margin-bottom: 10px; color: var(--primary-color);">مشخصات فنی</h4>
                        <div x-text="selectedComponent.details"></div>
                    </div>
                    
                    <div style="background-color: #f0f9ff; padding: 15px; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; color: var(--primary-color);">اتصالات</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                            <template x-for="(conn, index) in getComponentConnections(selectedComponent.tag)" :key="index">
                                <div style="background-color: white; padding: 10px; border-radius: 6px; border: 1px solid #e5e7eb;">
                                    <div style="font-weight: 500;" x-text="conn.to"></div>
                                    <div style="font-size: 0.8rem; color: #6b7280;" x-text="conn.type"></div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </template>
            <div style="margin-top: 20px; text-align: left;">
                <button class="btn btn-danger" @click="showModal = null">
                    بستن
                </button>
            </div>
        </div>
    </div>

    <!-- فایل ورودی پنهان برای بارگذاری -->
    <input type="file" id="fileInput" accept=".json" style="display: none;" @change="loadProjectFromFile($event)">

    <!-- اسکریپت اصلی -->
    <script>
        function plcDesigner() {
            return {
                // حالت‌های برنامه
                activeTab: 'design',
                showModal: null,
                mobileMenuOpen: false,
                activeCodeTab: 'ladder',
                activeConnectionTab: 'list',
                selectedComponent: null,
                selectedScenario: 'default',
                selectedCodeTemplate: 0,
                language: 'fa',
                
                // داده‌های پروژه
                projectName: 'ایستگاه تهویه تبخیری نساجی',
                projectVersion: '1.0',
                
                // موتورهای سه فاز
                motors: [
                    { 
                        id: 1, 
                        name: 'فن رفت (Fan Feed)', 
                        quantity: 2, 
                        defaultQuantity: 2, 
                        power: '22', 
                        voltage: '400V AC',
                        requiresSoftStart: true,
                        current: 0
                    },
                    { 
                        id: 2, 
                        name: 'فن برگشت (Fan Return)', 
                        quantity: 2, 
                        defaultQuantity: 2, 
                        power: '30', 
                        voltage: '400V AC',
                        requiresSoftStart: true,
                        current: 0
                    },
                    { 
                        id: 3, 
                        name: 'فن غبار (Dust Fan)', 
                        quantity: 4, 
                        defaultQuantity: 4, 
                        power: '3.3', 
                        voltage: '400V AC',
                        requiresSoftStart: false,
                        current: 0
                    },
                    { 
                        id: 4, 
                        name: 'موتور روتاری (Rotary Motor)', 
                        quantity: 2, 
                        defaultQuantity: 2, 
                        power: '1', 
                        voltage: '400V AC',
                        requiresSoftStart: false,
                        current: 0
                    },
                    { 
                        id: 5, 
                        name: 'موتور مکانیزم (Mechanism Motor)', 
                        quantity: 2, 
                        defaultQuantity: 2, 
                        power: '0.25', 
                        voltage: '400V AC',
                        requiresSoftStart: false,
                        current: 0
                    },
                    { 
                        id: 6, 
                        name: 'پمپ آب (Pump Water Motor)', 
                        quantity: 1, 
                        defaultQuantity: 1, 
                        power: '30', 
                        voltage: '400V AC',
                        requiresSoftStart: true,
                        current: 0
                    }
                ],
                
                // عملگرها
                actuators: [
                    { 
                        id: 1, 
                        name: 'دمپر هوای تازه (Damper Fresh)', 
                        quantity: 2, 
                        defaultQuantity: 2, 
                        voltage: '24V DC', 
                        controlType: 'analog',
                        hasPositioner: true, 
                        readPosition: true 
                    },
                    { 
                        id: 2, 
                        name: 'دمپر اگزاست (Damper Exhaust)', 
                        quantity: 2, 
                        defaultQuantity: 2, 
                        voltage: '24V DC', 
                        controlType: 'analog',
                        hasPositioner: true, 
                        readPosition: true 
                    },
                    { 
                        id: 3, 
                        name: 'دمپر برگشت (Damper Return)', 
                        quantity: 2, 
                        defaultQuantity: 2, 
                        voltage: '24V DC', 
                        controlType: 'digital',
                        hasPositioner: false, 
                        readPosition: false 
                    },
                    { 
                        id: 4, 
                        name: 'شیر بخار (Steam Valve)', 
                        quantity: 1, 
                        defaultQuantity: 1, 
                        voltage: '24V DC', 
                        controlType: 'analog',
                        hasPositioner: true, 
                        readPosition: false 
                    }
                ],
                
                // سنسورها
                sensors: [
                    { 
                        id: 1, 
                        name: 'سنسور دما (Temperature)', 
                        quantity: 2, 
                        defaultQuantity: 2, 
                        type: 'آنالوگ', 
                        signalType: '4-20ma',
                        range: '-20°C تا 80°C'
                    },
                    { 
                        id: 2, 
                        name: 'سنسور رطوبت (Humidity)', 
                        quantity: 2, 
                        defaultQuantity: 2, 
                        type: 'آنالوگ', 
                        signalType: '4-20ma',
                        range: '0% تا 100% RH'
                    },
                    { 
                        id: 3, 
                        name: 'مایکروسویچ (Micro Switch)', 
                        quantity: 5, 
                        defaultQuantity: 5, 
                        type: 'دیجیتال', 
                        signalType: 'digital',
                        range: 'NO/NC'
                    }
                ],
                
                // تجهیزات اختیاری
                optionalComponents: [
                    { 
                        id: 1, 
                        name: 'اینورتر VFD', 
                        quantity: 0, 
                        defaultQuantity: 0, 
                        spec: '30kW'
                    },
                    { 
                        id: 2, 
                        name: 'سافت استارتر', 
                        quantity: 0, 
                        defaultQuantity: 0, 
                        spec: '30kW'
                    },
                    { 
                        id: 3, 
                        name: 'HMI', 
                        quantity: 1, 
                        defaultQuantity: 1, 
                        spec: '7 اینچ'
                    },
                    { 
                        id: 4, 
                        name: 'سنسور حرارت داخل تابلو', 
                        quantity: 0, 
                        defaultQuantity: 0, 
                        spec: 'ترموکوپل'
                    }
                ],
                
                // تنظیمات
                useSoftStarter: true,
                useInverter: false,
                cabinetDimensions: '800×600×200 میلی‌متر',
                
                // داده‌های محاسبه شده
                bom: [],
                layoutComponents: [],
                connections: [],
                terminalPlan: [],
                wireList: [],
                digitalInputs: [],
                digitalOutputs: [],
                analogInputs: [],
                analogOutputs: [],
                relayCount: 0,
                contactorCount: 0,
                terminalCount: 0,
                totalCost: 0,
                
                // کد PLC
                plcCode: {
                    ladder: [],
                    structured: [],
                    functionBlocks: []
                },
                
                // قالب‌های کد
                codeTemplates: [
                    {
                        name: 'کنترل استاندارد تهویه',
                        description: 'کد کامل کنترل سیستم تهویه تبخیری'
                    },
                    {
                        name: 'کنترل PID دما و رطوبت',
                        description: 'کنترل پیشرفته با حلقه‌های PID'
                    },
                    {
                        name: 'صرفه‌جویی انرژی',
                        description: 'الگوریتم‌های بهینه‌سازی مصرف انرژی'
                    }
                ],
                
                // سناریو کنترل
                scenarioDescription: '',
                damperControl: {
                    fresh: 40,
                    return: 40,
                    exhaust: 20
                },
                motorControl: {
                    fanFeed: 80,
                    fanReturn: 75,
                    waterPump: 60
                },
                controlParams: {
                    rt: 24,
                    rh: 55,
                    ot: 18,
                    oh: 40,
                    ct: 26,
                    ch: 50,
                    mt: 22,
                    ht: 48
                },
                
                // توابع اولیه
                init() {
                    this.calculateBOM();
                    this.generateLayout();
                    this.generateConnections();
                    this.generateIOLists();
                    this.generatePLCcode();
                    this.loadScenario();
                    
                    // تنظیم رویداد کلیک خارج از مودال
                    document.addEventListener('click', (e) => {
                        if (this.showModal && e.target.classList.contains('modal')) {
                            this.showModal = null;
                        }
                    });
                    
                    // نمایش پیام خوش‌آمد
                    this.showToast('طراحی تابلو PLC برای تهویه تبخیری نساجی آماده است!', 'success');
                },
                
                // کنترل تعداد اجزا
                incrementQuantity(component) {
                    component.quantity++;
                    this.recalculateAll();
                },
                
                decrementQuantity(component) {
                    if (component.quantity > 0) {
                        component.quantity--;
                        this.recalculateAll();
                    }
                },
                
                // محاسبه مجدد همه داده‌ها
                recalculateAll() {
                    this.calculateBOM();
                    this.generateLayout();
                    this.generateConnections();
                    this.generateIOLists();
                    this.generatePLCcode();
                    this.showToast('داده‌ها به روز شدند', 'info');
                },
                
                // محاسبه جریان موتور
                calculateMotorCurrent(motor) {
                    const power = parseFloat(motor.power) || 0;
                    // محاسبه ساده جریان: P = √3 × V × I × PF
                    // فرض: PF = 0.85، V = 400
                    const current = (power * 1000) / (Math.sqrt(3) * 400 * 0.85);
                    motor.current = current;
                    return current.toFixed(1) + ' A';
                },
                
                // محاسبه بزرگترین موتور
                getLargestMotorPower() {
                    let maxPower = 0;
                    this.motors.forEach(motor => {
                        const power = parseFloat(motor.power) || 0;
                        if (power > maxPower) maxPower = power;
                    });
                    return maxPower + ' kW';
                },
                
                // محاسبه لیست قطعات
                calculateBOM() {
                    let bom = [];
                    let totalCost = 0;
                    
                    // محاسبه بزرگترین موتور
                    let largestMotorPower = 0;
                    this.motors.forEach(motor => {
                        const power = parseFloat(motor.power) || 0;
                        if (power > largestMotorPower) largestMotorPower = power;
                    });
                    
                    // افزودن موتورها
                    this.motors.forEach(motor => {
                        if (motor.quantity > 0) {
                            const power = parseFloat(motor.power) || 0;
                            const price = power * 120; // قیمت تخمینی
                            
                            bom.push({
                                name: motor.name,
                                quantity: motor.quantity,
                                specifications: `${motor.power}kW, ${motor.voltage}, ${this.calculateMotorCurrent(motor)}`,
                                standards: 'IEC 60034, IP55',
                                tags: [`M${motor.id}`, `${motor.power}kW`],
                                category: 'موتور',
                                estimatedPrice: price * motor.quantity
                            });
                            
                            totalCost += price * motor.quantity;
                            
                            // کنتاکتور برای هر موتور
                            let contactorSize = 'Size 1';
                            let contactorPrice = 80;
                            if (power > 15) {
                                contactorSize = 'Size 3';
                                contactorPrice = 200;
                            } else if (power > 5) {
                                contactorSize = 'Size 2';
                                contactorPrice = 120;
                            }
                            
                            bom.push({
                                name: 'کنتاکتور',
                                quantity: motor.quantity,
                                specifications: `${contactorSize}, ${motor.power}kW, 400V AC, 3P`,
                                standards: 'IEC 60947-4-1',
                                tags: [`KM${motor.id}`, contactorSize],
                                category: 'قطعات کنترلی',
                                estimatedPrice: contactorPrice * motor.quantity
                            });
                            
                            totalCost += contactorPrice * motor.quantity;
                            this.contactorCount += motor.quantity;
                            
                            // رله اضافه بار برای موتورهای بالای 5kW
                            if (power > 5) {
                                bom.push({
                                    name: 'رله اضافه بار',
                                    quantity: motor.quantity,
                                    specifications: `برای موتور ${motor.power}kW`,
                                    standards: 'IEC 60947-4-1',
                                    tags: [`F${motor.id}`],
                                    category: 'حفاظتی',
                                    estimatedPrice: 60 * motor.quantity
                                });
                                
                                totalCost += 60 * motor.quantity;
                            }
                            
                            // بریکر مدار برای هر موتور
                            let breakerSize = '16A';
                            let breakerPrice = 40;
                            if (power > 22) {
                                breakerSize = '63A';
                                breakerPrice = 120;
                            } else if (power > 11) {
                                breakerSize = '32A';
                                breakerPrice = 80;
                            } else if (power > 5.5) {
                                breakerSize = '16A';
                                breakerPrice = 40;
                            } else {
                                breakerSize = '10A';
                                breakerPrice = 30;
                            }
                            
                            bom.push({
                                name: 'بریکر مدار',
                                quantity: motor.quantity,
                                specifications: `MCB ${breakerSize}, 3P, 400V`,
                                standards: 'IEC 60898',
                                tags: [`Q${motor.id}`],
                                category: 'حفاظتی',
                                estimatedPrice: breakerPrice * motor.quantity
                            });
                            
                            totalCost += breakerPrice * motor.quantity;
                        }
                    });
                    
                    // افزودن عملگرها
                    this.actuators.forEach(actuator => {
                        if (actuator.quantity > 0) {
                            const price = 45;
                            
                            bom.push({
                                name: actuator.name,
                                quantity: actuator.quantity,
                                specifications: `${actuator.voltage}, کنترل ${actuator.controlType}`,
                                standards: 'IEC 60534',
                                tags: [`A${actuator.id}`],
                                category: 'عملگر',
                                estimatedPrice: price * actuator.quantity
                            });
                            
                            totalCost += price * actuator.quantity;
                            
                            // رله برای هر عملگر
                            bom.push({
                                name: 'رله کنترل',
                                quantity: actuator.quantity,
                                specifications: `${actuator.voltage} کویل, 2NO+2NC`,
                                standards: 'IEC 61810',
                                tags: [`K${actuator.id}`],
                                category: 'قطعات کنترلی',
                                estimatedPrice: 25 * actuator.quantity
                            });
                            
                            totalCost += 25 * actuator.quantity;
                            this.relayCount += actuator.quantity;
                            
                            // پوزیشنر در صورت نیاز
                            if (actuator.hasPositioner) {
                                const posPrice = actuator.readPosition ? 120 : 80;
                                
                                bom.push({
                                    name: 'پوزیشنر',
                                    quantity: actuator.quantity,
                                    specifications: actuator.readPosition ? 'ورودی/خروجی آنالوگ' : 'خروجی آنالوگ',
                                    standards: 'IEC 60534',
                                    tags: [`P${actuator.id}`],
                                    category: 'سنسور',
                                    estimatedPrice: posPrice * actuator.quantity
                                });
                                
                                totalCost += posPrice * actuator.quantity;
                            }
                        }
                    });
                    
                    // افزودن سنسورها
                    this.sensors.forEach(sensor => {
                        if (sensor.quantity > 0) {
                            let price = 0;
                            if (sensor.name.includes('دما')) price = 85;
                            else if (sensor.name.includes('رطوبت')) price = 110;
                            else price = 15;
                            
                            bom.push({
                                name: sensor.name,
                                quantity: sensor.quantity,
                                specifications: `${sensor.type}, ${sensor.signalType}, ${sensor.range}`,
                                standards: sensor.name.includes('دما') ? 'IEC 60751' : 'IEC 60770',
                                tags: [`S${sensor.id}`],
                                category: 'سنسور',
                                estimatedPrice: price * sensor.quantity
                            });
                            
                            totalCost += price * sensor.quantity;
                        }
                    });
                    
                    // افزودن تجهیزات اختیاری
                    this.optionalComponents.forEach(optional => {
                        if (optional.quantity > 0) {
                            let price = 0;
                            let specs = optional.spec;
                            
                            if (optional.name === 'VFD Inverter' && this.useInverter) {
                                specs = `${largestMotorPower}kW, 400V AC, Vector Control`;
                                price = largestMotorPower * 150;
                            } else if (optional.name === 'Soft Starter' && this.useSoftStarter) {
                                specs = `${largestMotorPower}kW, 400V AC`;
                                price = largestMotorPower * 80;
                            } else if (optional.name === 'HMI') {
                                specs = `${optional.spec}, لمسی, Ethernet`;
                                price = 350;
                            } else {
                                specs = optional.spec;
                                price = 45;
                            }
                            
                            bom.push({
                                name: optional.name,
                                quantity: optional.quantity,
                                specifications: specs,
                                standards: optional.name === 'HMI' ? 'IP65' : 'IEC 61800',
                                tags: [optional.name === 'HMI' ? 'HMI1' : optional.name === 'VFD Inverter' ? 'VFD1' : 'SS1'],
                                category: 'تجهیزات اختیاری',
                                estimatedPrice: price * optional.quantity
                            });
                            
                            totalCost += price * optional.quantity;
                        }
                    });
                    
                    // PLC سیستم
                    const diCount = this.digitalInputs.length;
                    const doCount = this.digitalOutputs.length;
                    const aiCount = this.analogInputs.length;
                    
                    bom.push({
                        name: 'CPU PLC',
                        quantity: 1,
                        specifications: `Siemens S7-1200, 24DI/16DO/4AI`,
                        standards: 'IEC 61131',
                        tags: ['CPU1214C'],
                        category: 'کنترلر',
                        estimatedPrice: 650
                    });
                    
                    totalCost += 650;
                    
                    // ماژول‌های اضافی در صورت نیاز
                    if (diCount > 24) {
                        const modules = Math.ceil((diCount - 24) / 16);
                        bom.push({
                            name: 'ماژول ورودی دیجیتال',
                            quantity: modules,
                            specifications: '16DI, 24V DC',
                            standards: 'IEC 61131',
                            tags: ['SM1221'],
                            category: 'کنترلر',
                            estimatedPrice: 180 * modules
                        });
                        
                        totalCost += 180 * modules;
                    }
                    
                    if (doCount > 16) {
                        const modules = Math.ceil((doCount - 16) / 16);
                        bom.push({
                            name: 'ماژول خروجی دیجیتال',
                            quantity: modules,
                            specifications: '16DO, Relay',
                            standards: 'IEC 61131',
                            tags: ['SM1222'],
                            category: 'کنترلر',
                            estimatedPrice: 220 * modules
                        });
                        
                        totalCost += 220 * modules;
                    }
                    
                    if (aiCount > 4) {
                        const modules = Math.ceil((aiCount - 4) / 4);
                        bom.push({
                            name: 'ماژول ورودی آنالوگ',
                            quantity: modules,
                            specifications: '4AI, 4-20mA',
                            standards: 'IEC 61131',
                            tags: ['SM1231'],
                            category: 'کنترلر',
                            estimatedPrice: 280 * modules
                        });
                        
                        totalCost += 280 * modules;
                    }
                    
                    // منبع تغذیه
                    bom.push({
                        name: 'منبع تغذیه',
                        quantity: 1,
                        specifications: '24V DC, 5A, Switch Mode',
                        standards: 'IEC 61010',
                        tags: ['PS1'],
                        category: 'تغذیه',
                        estimatedPrice: 120
                    });
                    
                    totalCost += 120;
                    
                    // بریکر اصلی
                    bom.push({
                        name: 'بریکر اصلی',
                        quantity: 1,
                        specifications: '100A, 4P, 400V',
                        standards: 'IEC 60947-2',
                        tags: ['Q0'],
                        category: 'حفاظتی',
                        estimatedPrice: 180
                    });
                    
                    totalCost += 180;
                    
                    // ترمینال‌ها
                    const terminalPoints = diCount + doCount + aiCount + 20;
                    const terminalBlocks = Math.ceil(terminalPoints / 12);
                    this.terminalCount = terminalBlocks;
                    
                    bom.push({
                        name: 'بلوک ترمینال',
                        quantity: terminalBlocks,
                        specifications: '12 پوزیشن, 600V, پیچی',
                        standards: 'IEC 60947',
                        tags: ['TB'],
                        category: 'اتصالات',
                        estimatedPrice: 8 * terminalBlocks
                    });
                    
                    totalCost += 8 * terminalBlocks;
                    
                    // تابلو
                    bom.push({
                        name: 'تابلو کنترل',
                        quantity: 1,
                        specifications: this.cabinetDimensions + ', IP54, رنگ الکترواستاتیک',
                        standards: 'IEC 60529',
                        tags: ['CAB1'],
                        category: 'ساختاری',
                        estimatedPrice: 450
                    });
                    
                    totalCost += 450;
                    
                    // سیم‌ها
                    const wireLength = 50 + (diCount + doCount) * 2 + aiCount * 3;
                    bom.push({
                        name: 'سیم کنترل',
                        quantity: Math.ceil(wireLength / 100),
                        specifications: '1.5mm², مشکی',
                        standards: 'IEC 60228',
                        tags: ['W1'],
                        category: 'لوازم مصرفی',
                        estimatedPrice: 1.5 * Math.ceil(wireLength / 100)
                    });
                    
                    totalCost += 1.5 * Math.ceil(wireLength / 100);
                    
                    bom.push({
                        name: 'سیم قدرت',
                        quantity: 3,
                        specifications: '4mm², مشکی/آبی/قهوه‌ای',
                        standards: 'IEC 60228',
                        tags: ['W2'],
                        category: 'لوازم مصرفی',
                        estimatedPrice: 45
                    });
                    
                    totalCost += 45;
                    
                    // کانال کابل
                    bom.push({
                        name: 'کانال کابل',
                        quantity: 4,
                        specifications: '40×40mm, PVC',
                        standards: 'IEC 61084',
                        tags: ['CD1'],
                        category: 'ساختاری',
                        estimatedPrice: 12 * 4
                    });
                    
                    totalCost += 48;
                    
                    // ریل DIN
                    bom.push({
                        name: 'ریل DIN',
                        quantity: 6,
                        specifications: '35mm, طول 1 متر',
                        standards: 'IEC 60715',
                        tags: ['DR1'],
                        category: 'ساختاری',
                        estimatedPrice: 8 * 6
                    });
                    
                    totalCost += 48;
                    
                    // سایر لوازم
                    bom.push({
                        name: 'فیوز',
                        quantity: 10,
                        specifications: '10A, 5x20mm',
                        standards: 'IEC 60127',
                        tags: ['FUSE'],
                        category: 'حفاظتی',
                        estimatedPrice: 1.5 * 10
                    });
                    
                    totalCost += 15;
                    
                    bom.push({
                        name: 'چراغ سیگنال',
                        quantity: 5,
                        specifications: 'LED, 24V, قرمز/سبز/زرد',
                        standards: 'IEC 60073',
                        tags: ['HL'],
                        category: 'نشانگر',
                        estimatedPrice: 8 * 5
                    });
                    
                    totalCost += 40;
                    
                    bom.push({
                        name: 'کلید قطع و وصل',
                        quantity: 1,
                        specifications: 'کلید چاقویی, 3P, 400V',
                        standards: 'IEC 60947-3',
                        tags: ['S0'],
                        category: 'کنترل دستی',
                        estimatedPrice: 65
                    });
                    
                    totalCost += 65;
                    
                    this.bom = bom;
                    this.totalCost = Math.round(totalCost);
                },
                
                // تولید چیدمان تابلو
                generateLayout() {
                    let layout = [];
                    let currentX = 1;
                    let currentY = 1;
                    
                    // PLC
                    layout.push({
                        type: 'plc',
                        tag: 'PLC',
                        details: 'S7-1200 CPU',
                        width: 32,
                        height: 40,
                        row: currentY,
                        col: currentX,
                        size: '2×2'
                    });
                    
                    currentX += 2;
                    
                    // منبع تغذیه
                    layout.push({
                        type: 'psu',
                        tag: 'PSU',
                        details: '24V/5A',
                        width: 32,
                        height: 40,
                        row: currentY,
                        col: currentX,
                        size: '2×2'
                    });
                    
                    currentX += 2;
                    
                    // HMI (اگر وجود دارد)
                    const hmi = this.optionalComponents.find(c => c.name === 'HMI' && c.quantity > 0);
                    if (hmi) {
                        layout.push({
                            type: 'hmi',
                            tag: 'HMI',
                            details: '7" Touch',
                            width: 32,
                            height: 40,
                            row: currentY,
                            col: currentX,
                            size: '2×2'
                        });
                        
                        currentX += 2;
                    }
                    
                    // رفتن به ردیف بعدی
                    currentY += 2;
                    currentX = 1;
                    
                    // بریکر اصلی
                    layout.push({
                        type: 'breaker',
                        tag: 'Q0',
                        details: '100A 4P',
                        width: 32,
                        height: 40,
                        row: currentY,
                        col: currentX,
                        size: '2×2'
                    });
                    
                    currentX += 2;
                    
                    // اینورتر (اگر استفاده می‌شود)
                    if (this.useInverter) {
                        const inverter = this.optionalComponents.find(c => c.name === 'VFD Inverter' && c.quantity > 0);
                        if (inverter) {
                            layout.push({
                                type: 'inverter',
                                tag: 'VFD1',
                                details: `${this.getLargestMotorPower()}`,
                                width: 80,
                                height: 80,
                                row: currentY,
                                col: currentX,
                                size: '5×4'
                            });
                            
                            currentX += 5;
                        }
                    }
                    
                    // سافت استارتر (اگر استفاده می‌شود)
                    if (this.useSoftStarter) {
                        const softStarter = this.optionalComponents.find(c => c.name === 'Soft Starter' && c.quantity > 0);
                        if (softStarter) {
                            layout.push({
                                type: 'soft-starter',
                                tag: 'SS1',
                                details: `${this.getLargestMotorPower()}`,
                                width: 80,
                                height: 40,
                                row: currentY,
                                col: currentX,
                                size: '5×2'
                            });
                            
                            currentY += 2;
                            currentX = 1;
                        }
                    }
                    
                    // کنتاکتورها
                    let contactorIndex = 1;
                    this.motors.forEach(motor => {
                        if (motor.quantity > 0) {
                            for (let i = 0; i < motor.quantity; i++) {
                                if (currentX > 10) {
                                    currentY += 2;
                                    currentX = 1;
                                }
                                
                                layout.push({
                                    type: 'contactor',
                                    tag: `KM${contactorIndex}`,
                                    details: `${motor.power}kW`,
                                    width: 32,
                                    height: 40,
                                    row: currentY,
                                    col: currentX,
                                    size: '2×2'
                                });
                                
                                currentX += 2;
                                contactorIndex++;
                            }
                        }
                    });
                    
                    // رفتن به ردیف بعدی برای رله‌ها
                    currentY += 2;
                    currentX = 1;
                    
                    // رله‌ها
                    let relayIndex = 1;
                    this.actuators.forEach(actuator => {
                        if (actuator.quantity > 0) {
                            for (let i = 0; i < actuator.quantity; i++) {
                                if (currentX > 12) {
                                    currentY += 1;
                                    currentX = 1;
                                }
                                
                                layout.push({
                                    type: 'relay',
                                    tag: `K${relayIndex}`,
                                    details: actuator.voltage,
                                    width: 16,
                                    height: 20,
                                    row: currentY,
                                    col: currentX,
                                    size: '1×1'
                                });
                                
                                currentX += 1;
                                relayIndex++;
                            }
                        }
                    });
                    
                    // رله‌های اضافه بار
                    this.motors.forEach(motor => {
                        if (motor.quantity > 0 && parseFloat(motor.power) > 5) {
                            for (let i = 0; i < motor.quantity; i++) {
                                if (currentX > 12) {
                                    currentY += 1;
                                    currentX = 1;
                                }
                                
                                layout.push({
                                    type: 'relay',
                                    tag: `F${relayIndex}`,
                                    details: 'OL Relay',
                                    width: 16,
                                    height: 20,
                                    row: currentY,
                                    col: currentX,
                                    size: '1×1'
                                });
                                
                                currentX += 1;
                                relayIndex++;
                            }
                        }
                    });
                    
                    // رفتن به ردیف پایین برای ترمینال‌ها
                    currentY += 1;
                    currentX = 1;
                    
                    // بلوک ترمینال
                    layout.push({
                        type: 'terminal',
                        tag: 'Terminal',
                        details: `${this.terminalCount} بلوک`,
                        width: 96,
                        height: 40,
                        row: currentY,
                        col: currentX,
                        size: '6×2'
                    });
                    
                    this.layoutComponents = layout;
                },
                
                // تولید اتصالات
                generateConnections() {
                    let connections = [];
                    let connectionId = 1;
                    
                    // اتصالات موتورها
                    this.motors.forEach((motor, motorIndex) => {
                        for (let i = 0; i < motor.quantity; i++) {
                            connections.push({
                                id: connectionId++,
                                from: `Q${motor.id}.${i+1}`,
                                to: `KM${motor.id}.${i+1}`,
                                type: 'قدرت',
                                wireSize: '4mm²',
                                color: 'مشکی',
                                length: 1.2,
                                terminal: `TB${Math.floor(connectionId/10)+1}`
                            });
                            
                            connections.push({
                                id: connectionId++,
                                from: `PLC Q${motorIndex}.${i+1}`,
                                to: `KM${motor.id}.${i+1} A1`,
                                type: 'کنترل',
                                wireSize: '1.5mm²',
                                color: 'آبی',
                                length: 0.8,
                                terminal: `TB${Math.floor(connectionId/10)+1}`
                            });
                        }
                    });
                    
                    // اتصالات عملگرها
                    this.actuators.forEach((actuator, actuatorIndex) => {
                        for (let i = 0; i < actuator.quantity; i++) {
                            connections.push({
                                id: connectionId++,
                                from: `PLC Q${this.motors.length + actuatorIndex}.${i+1}`,
                                to: `K${actuator.id}.${i+1} A1`,
                                type: 'کنترل',
                                wireSize: '1.5mm²',
                                color: 'سفید',
                                length: 0.7,
                                terminal: `TB${Math.floor(connectionId/10)+1}`
                            });
                            
                            connections.push({
                                id: connectionId++,
                                from: `K${actuator.id}.${i+1} 13`,
                                to: `A${actuator.id}.${i+1}`,
                                type: 'عملگر',
                                wireSize: '1.5mm²',
                                color: 'قرمز',
                                length: 3.5,
                                terminal: `TB${Math.floor(connectionId/10)+1}`
                            });
                            
                            if (actuator.hasPositioner && actuator.readPosition) {
                                connections.push({
                                    id: connectionId++,
                                    from: `P${actuator.id}.${i+1}`,
                                    to: `PLC I${actuatorIndex}.${i+1}`,
                                    type: 'آنالوگ',
                                    wireSize: '1.5mm² شیلددار',
                                    color: 'بنفش',
                                    length: 2.5,
                                    terminal: `TB${Math.floor(connectionId/10)+1}`
                                });
                            }
                        }
                    });
                    
                    // اتصالات سنسورها
                    this.sensors.forEach((sensor, sensorIndex) => {
                        for (let i = 0; i < sensor.quantity; i++) {
                            const isAnalog = sensor.type === 'آنالوگ';
                            connections.push({
                                id: connectionId++,
                                from: `S${sensor.id}.${i+1}`,
                                to: isAnalog ? `PLC AI${sensorIndex}.${i+1}` : `PLC I${this.actuators.length + sensorIndex}.${i+1}`,
                                type: isAnalog ? 'آنالوگ' : 'دیجیتال',
                                wireSize: isAnalog ? '1.5mm² شیلددار' : '1.5mm²',
                                color: isAnalog ? 'سبز' : 'زرد',
                                length: 5.0,
                                terminal: `TB${Math.floor(connectionId/10)+1}`
                            });
                        }
                    });
                    
                    this.connections = connections;
                    
                    // تولید نقشه ترمینال
                    this.generateTerminalPlan();
                },
                
                // تولید نقشه ترمینال
                generateTerminalPlan() {
                    this.terminalPlan = [
                        { name: 'توزیع قدرت', type: 'قدرت', points: 24, number: 'TB1-TB3' },
                        { name: 'ورودی‌های دیجیتال PLC', type: 'DI', points: 24, number: 'TB4-TB6' },
                        { name: 'خروجی‌های دیجیتال PLC', type: 'DO', points: 16, number: 'TB7-TB9' },
                        { name: 'ورودی‌های آنالوگ PLC', type: 'AI', points: 8, number: 'TB10-TB11' },
                        { name: 'کنترل موتورها', type: 'کنترل', points: 20, number: 'TB12-TB14' },
                        { name: 'اتصالات سنسورها', type: 'سنسور', points: 16, number: 'TB15-TB17' },
                        { name: 'اتصالات عملگرها', type: 'عملگر', points: 16, number: 'TB18-TB20' },
                        { name: 'اتصالات شیلد', type: 'زمین', points: 12, number: 'TB21-TB22' }
                    ];
                },
                
                // تولید لیست I/O
                generateIOLists() {
                    this.digitalInputs = [];
                    this.digitalOutputs = [];
                    this.analogInputs = [];
                    this.analogOutputs = [];
                    
                    let diAddress = 0;
                    let doAddress = 0;
                    let aiAddress = 0;
                    let aoAddress = 0;
                    
                    // سنسورهای دیجیتال (مایکروسویچ)
                    const microSwitch = this.sensors.find(s => s.name === 'مایکروسویچ (Micro Switch)');
                    if (microSwitch && microSwitch.quantity > 0) {
                        for (let i = 0; i < microSwitch.quantity; i++) {
                            this.digitalInputs.push({
                                name: `درب ${i+1}`,
                                address: `I${diAddress}.${i}`,
                                description: 'مایکروسویچ وضعیت درب'
                            });
                        }
                        diAddress++;
                    }
                    
                    // عملگرهای با پوزیشنر و خواندن موقعیت
                    this.actuators.forEach(actuator => {
                        if (actuator.hasPositioner && actuator.readPosition) {
                            for (let i = 0; i < actuator.quantity; i++) {
                                this.analogInputs.push({
                                    name: `موقعیت ${actuator.name} ${i+1}`,
                                    address: `AI${aiAddress}.${i}`,
                                    range: '4-20mA',
                                    description: 'فیدبک موقعیت'
                                });
                            }
                            aiAddress++;
                        }
                    });
                    
                    // سنسورهای آنالوگ (دما و رطوبت)
                    this.sensors.forEach(sensor => {
                        if (sensor.name.includes('دما') || sensor.name.includes('رطوبت')) {
                            for (let i = 0; i < sensor.quantity; i++) {
                                this.analogInputs.push({
                                    name: `${sensor.name} ${i+1}`,
                                    address: `AI${aiAddress}.${i}`,
                                    range: sensor.name.includes('دما') ? '-20°C تا 80°C' : '0% تا 100% RH',
                                    description: sensor.name.includes('دما') ? 'سنسور دما' : 'سنسور رطوبت'
                                });
                            }
                            aiAddress++;
                        }
                    });
                    
                    // خروجی‌های دیجیتال برای عملگرها
                    this.actuators.forEach(actuator => {
                        for (let i = 0; i < actuator.quantity; i++) {
                            this.digitalOutputs.push({
                                name: `کنترل ${actuator.name} ${i+1}`,
                                address: `Q${doAddress}.${i}`,
                                description: 'خروجی کنترل عملگر'
                            });
                        }
                        doAddress++;
                    });
                    
                    // خروجی‌های دیجیتال برای موتورها
                    this.motors.forEach(motor => {
                        for (let i = 0; i < motor.quantity; i++) {
                            this.digitalOutputs.push({
                                name: `کنترل ${motor.name} ${i+1}`,
                                address: `Q${doAddress}.${i}`,
                                description: 'خروجی کنترل کنتاکتور'
                            });
                        }
                        doAddress++;
                    });
                    
                    // خروجی‌های آنالوگ برای عملگرهای آنالوگ
                    this.actuators.forEach(actuator => {
                        if (actuator.controlType === 'analog') {
                            for (let i = 0; i < actuator.quantity; i++) {
                                this.analogOutputs.push({
                                    name: `سیگنال ${actuator.name} ${i+1}`,
                                    address: `AQ${aoAddress}.${i}`,
                                    range: '4-20mA',
                                    description: 'سیگنال کنترل آنالوگ'
                                });
                            }
                            aoAddress++;
                        }
                    });
                },
                
                // تولید کد PLC
                generatePLCcode() {
                    // منطق نردبانی
                    this.plcCode.ladder = [
                        { type: 'comment', text: '// کنترل ایستگاه تهویه تبخیری نساجی' },
                        { type: 'comment', text: '// ایجاد شده توسط سیستم طراحی تابلو PLC' },
                        { type: 'network', text: '1' },
                        { type: 'instruction', text: 'Network 1: کنترل اصلی سیستم' },
                        { type: 'instruction', text: 'LD I0.0 // سیگنال راه‌اندازی' },
                        { type: 'instruction', text: 'AN I0.1 // سیگنال توقف اضطراری' },
                        { type: 'instruction', text: '= M0.0 // بیت فعال‌سازی سیستم' },
                        { type: 'network', text: '2' },
                        { type: 'instruction', text: 'Network 2: کنترل فن رفت' },
                        { type: 'instruction', text: 'LD M0.0 // سیستم فعال' },
                        { type: 'instruction', text: 'AN I0.2 // محافظت اضافه بار' },
                        { type: 'instruction', text: 'TON T37, 100 // تایمر راه‌اندازی نرم' },
                        { type: 'instruction', text: 'LD T37' },
                        { type: 'instruction', text: '= Q0.0 // خروجی کنتاکتور فن رفت' },
                        { type: 'network', text: '3' },
                        { type: 'instruction', text: 'Network 3: کنترل فن برگشت' },
                        { type: 'instruction', text: 'LD M0.0 // سیستم فعال' },
                        { type: 'instruction', text: 'AN I0.3 // محافظت اضافه بار' },
                        { type: 'instruction', text: 'TON T38, 150 // تایمر راه‌اندازی نرم' },
                        { type: 'instruction', text: 'LD T38' },
                        { type: 'instruction', text: '= Q0.1 // خروجی کنتاکتور فن برگشت' },
                        { type: 'network', text: '4' },
                        { type: 'instruction', text: 'Network 4: کنترل دمپر هوای تازه' },
                        { type: 'instruction', text: 'LD M0.0 // سیستم فعال' },
                        { type: 'instruction', text: 'MOV 40, AQW0 // موقعیت 40% برای دمپر هوای تازه' },
                        { type: 'instruction', text: 'CALL PID_CTRL // فراخوانی کنترل PID' },
                        { type: 'network', text: '5' },
                        { type: 'instruction', text: 'Network 5: کنترل دمپر برگشت' },
                        { type: 'instruction', text: 'LD M0.0 // سیستم فعال' },
                        { type: 'instruction', text: 'MOV 40, AQW2 // موقعیت 40% برای دمپر برگشت' },
                        { type: 'instruction', text: 'CALL PID_CTRL // فراخوانی کنترل PID' }
                    ];
                    
                    // کد ساخت یافته
                    this.plcCode.structured = [
                        { type: 'comment', text: '// برنامه کنترل اصلی سیستم تهویه' },
                        { type: 'comment', text: '// ورودی‌ها:' },
                        { type: 'comment', text: '// I0.0 - راه‌اندازی سیستم' },
                        { type: 'comment', text: '// I0.1 - توقف اضطراری' },
                        { type: 'comment', text: '// I0.2 - اضافه بار فن رفت' },
                        { type: 'comment', text: '// I0.3 - اضافه بار فن برگشت' },
                        { type: 'comment', text: '// AIW0 - دمای سالن' },
                        { type: 'comment', text: '// AIW2 - رطوبت سالن' },
                        { type: 'code', text: 'PROGRAM Main_Control' },
                        { type: 'code', text: 'VAR' },
                        { type: 'code', text: '    System_Active : BOOL;' },
                        { type: 'code', text: '    Temp_SP : REAL := 24.0; // نقطه تنظیم دما' },
                        { type: 'code', text: '    Humid_SP : REAL := 55.0; // نقطه تنظیم رطوبت' },
                        { type: 'code', text: '    Temp_PV : REAL; // مقدار فعلی دما' },
                        { type: 'code', text: '    Humid_PV : REAL; // مقدار فعلی رطوبت' },
                        { type: 'code', text: '    Fresh_Air : REAL; // درصد هوای تازه' },
                        { type: 'code', text: '    Return_Air : REAL; // درصد هوای برگشت' },
                        { type: 'code', text: 'END_VAR' },
                        { type: 'code', text: '' },
                        { type: 'code', text: 'BEGIN' },
                        { type: 'code', text: '    // فعال‌سازی سیستم' },
                        { type: 'code', text: '    System_Active := I0.0 AND NOT I0.1;' },
                        { type: 'code', text: '    ' },
                        { type: 'code', text: '    // خواندن سنسورها' },
                        { type: 'code', text: '    Temp_PV := AIW0 / 10.0; // تبدیل به درجه سانتیگراد' },
                        { type: 'code', text: '    Humid_PV := AIW2 / 10.0; // تبدیل به درصد' },
                        { type: 'code', text: '    ' },
                        { type: 'code', text: '    // محاسبه درصد هوای تازه و برگشت' },
                        { type: 'code', text: '    IF System_Active THEN' },
                        { type: 'code', text: '        Fresh_Air := PID_Temp(Temp_SP, Temp_PV);' },
                        { type: 'code', text: '        Return_Air := 100.0 - Fresh_Air;' },
                        { type: 'code', text: '        ' },
                        { type: 'code', text: '        // کنترل دمپرها' },
                        { type: 'code', text: '        AQW0 := Fresh_Air * 2.55; // تبدیل به 0-255' },
                        { type: 'code', text: '        AQW2 := Return_Air * 2.55;' },
                        { type: 'code', text: '        ' },
                        { type: 'code', text: '        // کنترل رطوبت' },
                        { type: 'code', text: '        IF Humid_PV < Humid_SP THEN' },
                        { type: 'code', text: '            Q0.5 := TRUE; // فعال کردن پمپ آب' },
                        { type: 'code', text: '            AQW4 := PID_Humid(Humid_SP, Humid_PV) * 2.55;' },
                        { type: 'code', text: '        ELSE' },
                        { type: 'code', text: '            Q0.5 := FALSE;' },
                        { type: 'code', text: '            AQW4 := 0;' },
                        { type: 'code', text: '        END_IF;' },
                        { type: 'code', text: '    END_IF;' },
                        { type: 'code', text: 'END_PROGRAM' }
                    ];
                    
                    // بلوک‌های تابع
                    this.plcCode.functionBlocks = [
                        { text: 'FUNCTION_BLOCK PID_Controller' },
                        { text: 'VAR_INPUT' },
                        { text: '    Setpoint : REAL;' },
                        { text: '    ProcessValue : REAL;' },
                        { text: '    Kp : REAL := 1.0;' },
                        { text: '    Ki : REAL := 0.1;' },
                        { text: '    Kd : REAL := 0.01;' },
                        { text: 'END_VAR' },
                        { text: 'VAR_OUTPUT' },
                        { text: '    Output : REAL;' },
                        { text: 'END_VAR' },
                        { text: 'VAR' },
                        { text: '    Error : REAL;' },
                        { text: '    Integral : REAL;' },
                        { text: '    Derivative : REAL;' },
                        { text: '    PreviousError : REAL;' },
                        { text: 'END_VAR' },
                        { text: '' },
                        { text: '// محاسبه خطا' },
                        { text: 'Error := Setpoint - ProcessValue;' },
                        { text: '' },
                        { text: '// محاسبه انتگرال' },
                        { text: 'Integral := Integral + Error;' },
                        { text: '' },
                        { text: '// محاسبه مشتق' },
                        { text: 'Derivative := Error - PreviousError;' },
                        { text: '' },
                        { text: '// محاسبه خروجی PID' },
                        { text: 'Output := Kp * Error + Ki * Integral + Kd * Derivative;' },
                        { text: '' },
                        { text: '// ذخیره خطا برای مرحله بعد' },
                        { text: 'PreviousError := Error;' },
                        { text: 'END_FUNCTION_BLOCK' }
                    ];
                },
                
                // بارگذاری سناریو
                loadScenario() {
                    switch(this.selectedScenario) {
                        case 'default':
                            this.scenarioDescription = `کنترل استاندارد سیستم تهویه تبخیری:
                            
                            • دمای سالن (RT): ۲۴°C
                            • رطوبت سالن (RH): ۵۵%
                            • درصد هوای تازه: ۴۰%
                            • درصد هوای برگشت: ۶۰%
                            • دمپر اگزاست: ۲۰%
                            • کنترل PID برای دما و رطوبت
                            • راه‌اندازی مرحله‌ای موتورها
                            • حفاظت کامل در برابر اضافه بار`;
                            
                            this.damperControl = { fresh: 40, return: 40, exhaust: 20 };
                            this.motorControl = { fanFeed: 80, fanReturn: 75, waterPump: 60 };
                            this.controlParams = { rt: 24, rh: 55, ot: 18, oh: 40, ct: 26, ch: 50, mt: 22, ht: 48 };
                            break;
                            
                        case 'energy':
                            this.scenarioDescription = `صرفه‌جویی انرژی:
                            
                            • کاهش سرعت فن‌ها در ساعات غیر‌کاری
                            • بهینه‌سازی درصد هوای تازه بر اساس دمای بیرون
                            • کنترل هوشمند پمپ آب
                            • کاهش مصرف در حالت آماده‌باش
                            • پیش‌بین‌سازی بار بر اساس الگوی کاری`;
                            
                            this.damperControl = { fresh: 30, return: 50, exhaust: 20 };
                            this.motorControl = { fanFeed: 70, fanReturn: 65, waterPump: 50 };
                            this.controlParams = { rt: 22, rh: 50, ot: 20, oh: 45, ct: 24, ch: 48, mt: 21, ht: 46 };
                            break;
                            
                        case 'humidity':
                            this.scenarioDescription = `کنترل دقیق رطوبت:
                            
                            • اولویت با کنترل رطوبت
                            • پاسخ سریع به تغییرات رطوبت
                            • جبران‌سازی اثر دما بر رطوبت
                            • کنترل پیش‌بین برای فصل‌های مختلف
                            • کالیبراسیون خودکار سنسورها`;
                            
                            this.damperControl = { fresh: 35, return: 45, exhaust: 20 };
                            this.motorControl = { fanFeed: 75, fanReturn: 70, waterPump: 80 };
                            this.controlParams = { rt: 23, rh: 60, ot: 19, oh: 50, ct: 25, ch: 55, mt: 22, ht: 52 };
                            break;
                            
                        default:
                            this.scenarioDescription = 'لطفاً یک سناریو انتخاب کنید.';
                    }
                },
                
                // توابع کمکی
                getTotalComponents() {
                    let total = 0;
                    total += this.motors.reduce((sum, motor) => sum + motor.quantity, 0);
                    total += this.actuators.reduce((sum, actuator) => sum + actuator.quantity, 0);
                    total += this.sensors.reduce((sum, sensor) => sum + sensor.quantity, 0);
                    total += this.optionalComponents.reduce((sum, opt) => sum + opt.quantity, 0);
                    return total;
                },
                
                getHMIcount() {
                    const hmi = this.optionalComponents.find(c => c.name === 'HMI');
                    return hmi ? hmi.quantity + ' عدد' : 'ندارد';
                },
                
                calculateUsedSpace() {
                    const totalComponents = this.layoutComponents.length;
                    const gridSize = 10 * 6; // فرضی
                    const usedPercent = Math.min(100, Math.round((totalComponents / gridSize) * 100));
                    return usedPercent + '%';
                },
                
                getComponentConnections(tag) {
                    return this.connections.filter(conn => 
                        conn.from.includes(tag) || conn.to.includes(tag)
                    ).slice(0, 5);
                },
                
                showComponentDetails(component) {
                    this.selectedComponent = component;
                    this.showModal = 'componentDetails';
                },
                
                // مدیریت پروژه
                getProjectJSON() {
                    const project = {
                        projectName: this.projectName,
                        projectVersion: this.projectVersion,
                        motors: this.motors,
                        actuators: this.actuators,
                        sensors: this.sensors,
                        optionalComponents: this.optionalComponents,
                        settings: {
                            useSoftStarter: this.useSoftStarter,
                            useInverter: this.useInverter,
                            cabinetDimensions: this.cabinetDimensions
                        },
                        bom: this.bom,
                        layoutComponents: this.layoutComponents,
                        connections: this.connections,
                        plcCode: this.plcCode,
                        generatedAt: new Date().toISOString()
                    };
                    return JSON.stringify(project, null, 2);
                },
                
                copyJSON() {
                    const json = this.getProjectJSON();
                    navigator.clipboard.writeText(json).then(() => {
                        this.showToast('JSON در کلیپ‌بورد کپی شد', 'success');
                    });
                },
                
                importJSON() {
                    const jsonText = document.querySelector('.json-editor').value;
                    try {
                        const project = JSON.parse(jsonText);
                        
                        this.motors = project.motors || this.motors;
                        this.actuators = project.actuators || this.actuators;
                        this.sensors = project.sensors || this.sensors;
                        this.optionalComponents = project.optionalComponents || this.optionalComponents;
                        this.useSoftStarter = project.settings?.useSoftStarter || false;
                        this.useInverter = project.settings?.useInverter || false;
                        this.cabinetDimensions = project.settings?.cabinetDimensions || '800×600×200 میلی‌متر';
                        
                        this.recalculateAll();
                        this.showModal = null;
                        this.showToast('پروژه با موفقیت بارگذاری شد', 'success');
                    } catch (error) {
                        this.showToast('خطا در پردازش JSON: ' + error.message, 'error');
                    }
                },
                
                saveProject() {
                    const json = this.getProjectJSON();
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `plc-panel-${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    this.showToast('پروژه ذخیره شد', 'success');
                },
                
                loadProject() {
                    document.getElementById('fileInput').click();
                },
                
                loadProjectFromFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const project = JSON.parse(e.target.result);
                            
                            this.motors = project.motors || this.motors;
                            this.actuators = project.actuators || this.actuators;
                            this.sensors = project.sensors || this.sensors;
                            this.optionalComponents = project.optionalComponents || this.optionalComponents;
                            this.useSoftStarter = project.settings?.useSoftStarter || false;
                            this.useInverter = project.settings?.useInverter || false;
                            this.cabinetDimensions = project.settings?.cabinetDimensions || '800×600×200 میلی‌متر';
                            
                            this.recalculateAll();
                            this.showToast('پروژه با موفقیت بارگذاری شد', 'success');
                        } catch (error) {
                            this.showToast('خطا در بارگذاری فایل: ' + error.message, 'error');
                        }
                    };
                    reader.readAsText(file);
                    event.target.value = '';
                },
                
                // توابع خروجی
                exportBOM(format) {
                    if (format === 'csv') {
                        let csv = 'نام قطعه,تعداد,مشخصات فنی,استانداردها,قیمت تخمینی (یورو)\n';
                        this.bom.forEach(item => {
                            csv += `"${item.name}",${item.quantity},"${item.specifications}","${item.standards}",${item.estimatedPrice || 0}\n`;
                        });
                        
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `bom-${new Date().toISOString().slice(0, 10)}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        this.showToast('فایل CSV ذخیره شد', 'success');
                    } else if (format === 'pdf') {
                        this.exportFullReport();
                    }
                },
                
                exportLayoutImage() {
                    const layoutElement = document.getElementById('layoutGrid');
                    html2canvas(layoutElement).then(canvas => {
                        const link = document.createElement('a');
                        link.download = `layout-${new Date().toISOString().slice(0, 10)}.png`;
                        link.href = canvas.toDataURL();
                        link.click();
                        this.showToast('تصویر چیدمان ذخیره شد', 'success');
                    });
                },
                
                exportFullReport() {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // عنوان
                    doc.setFontSize(20);
                    doc.text('گزارش کامل طراحی تابلو PLC', 105, 20, { align: 'center' });
                    doc.setFontSize(12);
                    doc.text('ایستگاه تهویه تبخیری نساجی', 105, 30, { align: 'center' });
                    doc.text(`تاریخ: ${new Date().toLocaleDateString('fa-IR')}`, 105, 40, { align: 'center' });
                    
                    // خلاصه
                    doc.setFontSize(14);
                    doc.text('خلاصه پروژه', 20, 60);
                    doc.setFontSize(10);
                    doc.text(`تعداد کل قطعات: ${this.getTotalComponents()}`, 20, 70);
                    doc.text(`تعداد رله‌ها: ${this.relayCount}`, 20, 76);
                    doc.text(`تعداد کنتاکتورها: ${this.contactorCount}`, 20, 82);
                    doc.text(`تعداد ترمینال‌ها: ${this.terminalCount}`, 20, 88);
                    doc.text(`هزینه تخمینی: €${this.totalCost.toLocaleString('fa-IR')}`, 20, 94);
                    doc.text(`ابعاد تابلو: ${this.cabinetDimensions}`, 120, 70);
                    doc.text(`PLC: Siemens S7-1200`, 120, 76);
                    doc.text(`HMI: ${this.getHMIcount()}`, 120, 82);
                    doc.text(`اینورتر: ${this.useInverter ? 'دارد' : 'ندارد'}`, 120, 88);
                    doc.text(`سافت استارتر: ${this.useSoftStarter ? 'دارد' : 'ندارد'}`, 120, 94);
                    
                    // لیست قطعات
                    doc.addPage();
                    doc.setFontSize(16);
                    doc.text('لیست قطعات (BOM)', 20, 20);
                    
                    let y = 40;
                    doc.setFontSize(10);
                    this.bom.slice(0, 30).forEach((item, index) => {
                        if (y > 270) {
                            doc.addPage();
                            y = 20;
                        }
                        doc.text(`${index + 1}. ${item.name} - ${item.quantity} عدد - €${item.estimatedPrice || 0}`, 20, y);
                        y += 7;
                    });
                    
                    // ذخیره PDF
                    doc.save(`plc-report-${new Date().toISOString().slice(0, 10)}.pdf`);
                    this.showToast('گزارش PDF ذخیره شد', 'success');
                },
                
                exportProject() {
                    this.showModal = 'export';
                },
                
                printDocument() {
                    window.print();
                },
                
                downloadPLCcode() {
                    const code = this.plcCode.structured.map(line => 
                        line.type === 'comment' ? `// ${line.text}` : line.text
                    ).join('\n');
                    
                    const blob = new Blob([code], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `plc-code-${new Date().toISOString().slice(0, 10)}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    this.showToast('کد PLC دانلود شد', 'success');
                },
                
                exportWiringDiagram() {
                    this.showToast('نقشه سیم‌کشی آماده سازی می‌شود...', 'info');
                    // در اینجا می‌توان نقشه سیم‌کشی را تولید و ذخیره کرد
                },
                
                // توابع کمکی UI
                showToast(message, type = 'info') {
                    Toastify({
                        text: message,
                        duration: 3000,
                        gravity: "top",
                        position: "left",
                        backgroundColor: type === 'success' ? "#10b981" : 
                                       type === 'error' ? "#ef4444" : 
                                       type === 'warning' ? "#f59e0b" : "#3b82f6",
                        stopOnFocus: true
                    }).showToast();
                },
                
                toggleLanguage() {
                    this.language = this.language === 'fa' ? 'en' : 'fa';
                    this.showToast(`زبان به ${this.language === 'fa' ? 'فارسی' : 'انگلیسی'} تغییر کرد`, 'info');
                },
                
                resetSection(section) {
                    if (section === 'motors') {
                        this.motors.forEach(motor => {
                            motor.quantity = motor.defaultQuantity;
                            motor.requiresSoftStart = parseFloat(motor.power) > 5;
                        });
                        this.recalculateAll();
                        this.showToast('موتورها به تنظیمات اولیه بازگردانده شدند', 'info');
                    }
                },
                
                autoArrangeLayout() {
                    this.generateLayout();
                    this.showToast('چیدمان به صورت خودکار تنظیم شد', 'success');
                },
                
                closeModals() {
                    this.showModal = null;
                }
            };
        }
    </script>
</body>
</html>