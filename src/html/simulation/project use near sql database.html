<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrial Solution App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2ecc71;
            --accent-color: #e74c3c;
            --text-color: #ecf0f1;
            --bg-color: #2c3e50;
            --card-bg: #34495e;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
            --transition-speed: 0.3s;
        }

        .light-theme {
            --primary-color: #2980b9;
            --secondary-color: #27ae60;
            --accent-color: #c0392b;
            --text-color: #2c3e50;
            --bg-color: #ecf0f1;
            --card-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color var(--transition-speed), color var(--transition-speed);
            padding-bottom: 80px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation */
        .nav-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: var(--card-bg);
            box-shadow: 0 -2px 10px var(--shadow-color);
            z-index: 1000;
            display: flex;
            justify-content: space-around;
            padding: 10px 0;
        }

        .nav-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: all var(--transition-speed);
            position: relative;
            opacity: 0.7;
        }

        .nav-btn i {
            font-size: 24px;
            margin-bottom: 4px;
            transition: all var(--transition-speed);
        }

        .nav-btn:hover, .nav-btn:focus {
            opacity: 1;
        }

        .nav-btn.active {
            opacity: 1;
            color: var(--primary-color);
        }

        .nav-btn:hover i, .nav-btn:focus i, .nav-btn.active i {
            transform: translateY(-5px) scale(1.1);
            filter: drop-shadow(0 5px 5px var(--shadow-color));
        }

        .nav-btn:active i {
            transform: translateY(0) scale(1.3);
            color: var(--accent-color);
        }

        /* Project Controls */
        .project-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .project-btn {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .project-btn i {
            font-size: 16px;
        }

        .btn-new {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-open {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-close {
            background-color: #e67e22;
            color: white;
        }

        .btn-save {
            background-color: #9b59b6;
            color: white;
        }

        .project-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        /* Sections */
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
            padding: 20px;
            border-radius: 10px;
            background-color: var(--card-bg);
            margin-bottom: 20px;
            box-shadow: 0 4px 6px var(--shadow-color);
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Problem Section Blocks */
        .block {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--card-bg), #3d566e);
            box-shadow: 0 4px 8px var(--shadow-color);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .block:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px var(--shadow-color);
        }

        .block::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
        }

        .block-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
        }

        .block-title i {
            margin-right: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #4a627a;
            border-radius: 4px;
            background-color: #3d566e;
            color: var(--text-color);
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.3);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #27ae60;
            transform: translateY(-2px);
        }

        .btn-default {
            background-color: #7f8c8d;
            color: white;
        }

        .btn-default:hover {
            background-color: #95a5a6;
            transform: translateY(-2px);
        }

        .btn-group {
            display: flex;
            justify-content: flex-end;
            margin-top: 20px;
            gap: 10px;
        }

        /* 3D Visualization */
        #visualization-container {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            overflow: hidden;
            background-color: #3d566e;
            position: relative;
        }

        /* Psychrometric Calculator */
        .psychrometric-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .psychrometric-result {
            background-color: #3d566e;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .result-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--secondary-color);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 4px;
            color: white;
            font-weight: 600;
            box-shadow: 0 4px 12px var(--shadow-color);
            z-index: 1100;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background-color: var(--success-color);
        }

        .toast.error {
            background-color: var(--error-color);
        }

        .toast.warning {
            background-color: var(--warning-color);
        }

        /* Project Status */
        .project-status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 8px;
            background-color: var(--card-bg);
            font-weight: 600;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background-color: var(--success-color);
        }

        .status-inactive {
            background-color: var(--warning-color);
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .block {
                padding: 15px;
            }

            .nav-btn {
                padding: 5px 8px;
                font-size: 10px;
            }

            .nav-btn i {
                font-size: 20px;
            }

            .psychrometric-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn-group .btn {
                width: 100%;
                margin-bottom: 5px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                padding: 15px;
            }

            .psychrometric-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Landscape specific styles */
        @media (orientation: landscape) and (max-height: 500px) {
            .container {
                padding-bottom: 60px;
            }

            .nav-container {
                padding: 5px 0;
            }

            .nav-btn {
                font-size: 10px;
                padding: 5px;
            }

            .nav-btn i {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Project Status -->
        <div class="project-status">
            <span id="project-status-indicator" class="status-indicator status-inactive"></span>
            <span id="project-status-text">No active project</span>
        </div>
        
        <!-- Project Controls -->
        <div class="project-controls">
            <button class="project-btn btn-new" id="new-project">
                <i class="fas fa-file"></i> New Project
            </button>
            <button class="project-btn btn-open" id="open-project">
                <i class="fas fa-folder-open"></i> Open Project
            </button>
            <button class="project-btn btn-close" id="close-project">
                <i class="fas fa-times-circle"></i> Close Project
            </button>
            <button class="project-btn btn-save" id="save-project">
                <i class="fas fa-save"></i> Save Project
            </button>
        </div>
        
        <!-- Toast Notification -->
        <div id="toast" class="toast"></div>

        <!-- Problem Section -->
        <section id="problem-section" class="section active">
            <div class="block" id="project-info-block">
                <h2 class="block-title"><i class="fas fa-project-diagram"></i> Project Information</h2>
                <div class="form-group">
                    <label for="project-name">Project Name</label>
                    <input type="text" id="project-name" placeholder="Enter project name">
                </div>
                <div class="form-group">
                    <label for="company">Company</label>
                    <input type="text" id="company" placeholder="Enter company name">
                </div>
                <div class="form-group">
                    <label for="author">Author</label>
                    <input type="text" id="author" placeholder="Enter author name">
                </div>
                <div class="form-group">
                    <label for="revision">Revision</label>
                    <input type="text" id="revision" placeholder="Enter revision number">
                </div>
                <div class="form-group">
                    <label for="project-date">Date</label>
                    <input type="date" id="project-date">
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" rows="3" placeholder="Enter project description"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-default" id="reset-project">Reset to Default</button>
                    <button class="btn btn-primary" id="save-project-info">Save & Continue</button>
                </div>
            </div>

            <div class="block" id="location-block">
                <h2 class="block-title"><i class="fas fa-map-marker-alt"></i> Location Information</h2>
                <div class="form-group">
                    <label for="location-name">Location Name</label>
                    <input type="text" id="location-name" placeholder="Enter location name">
                </div>
                <div class="form-group">
                    <label for="location-type">Location Type</label>
                    <select id="location-type">
                        <option value="urban">Urban</option>
                        <option value="suburban">Suburban</option>
                        <option value="rural">Rural</option>
                        <option value="industrial">Industrial</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="latitude">Latitude</label>
                    <input type="text" id="latitude" placeholder="Enter latitude">
                </div>
                <div class="form-group">
                    <label for="longitude">Longitude</label>
                    <input type="text" id="longitude" placeholder="Enter longitude">
                </div>
                <div class="btn-group">
                    <button class="btn btn-default" id="reset-location">Reset to Default</button>
                    <button class="btn btn-primary" id="save-location">Save & Continue</button>
                </div>
            </div>

            <div class="block" id="weather-block">
                <h2 class="block-title"><i class="fas fa-cloud-sun"></i> Weather Conditions</h2>
                <div class="form-group">
                    <label for="warm-temp">Warm Season Highest Temperature (°C)</label>
                    <input type="number" id="warm-temp" placeholder="Enter temperature">
                </div>
                <div class="form-group">
                    <label for="warm-humidity">Warm Season Highest Humidity (%)</label>
                    <input type="number" id="warm-humidity" placeholder="Enter humidity" min="0" max="100">
                </div>
                <div class="form-group">
                    <label for="cold-temp">Cold Season Lowest Temperature (°C)</label>
                    <input type="number" id="cold-temp" placeholder="Enter temperature">
                </div>
                <div class="form-group">
                    <label for="cold-humidity">Cold Season Lowest Humidity (%)</label>
                    <input type="number" id="cold-humidity" placeholder="Enter humidity" min="0" max="100">
                </div>
                <div class="btn-group">
                    <button class="btn btn-default" id="reset-weather">Reset to Default</button>
                    <button class="btn btn-primary" id="save-weather">Save & Continue</button>
                </div>
            </div>

            <div class="block" id="production-block">
                <h2 class="block-title"><i class="fas fa-industry"></i> Production Capacity</h2>
                <div class="form-group">
                    <label for="capacity">Production Capacity (ton/day)</label>
                    <input type="number" id="capacity" placeholder="Enter capacity">
                </div>
                <div class="form-group">
                    <label for="working-hours">Working Hours (hours/day)</label>
                    <input type="number" id="working-hours" placeholder="Enter working hours" min="1" max="24">
                </div>
                <div class="form-group">
                    <label for="moisture">Input Moisture (%)</label>
                    <input type="number" id="moisture" value="8" min="0" max="100">
                </div>
                <div class="form-group">
                    <label for="losses">Losses per Line (%)</label>
                    <input type="number" id="losses" value="2" min="0" max="100">
                </div>
                <div class="btn-group">
                    <button class="btn btn-default" id="reset-production">Reset to Default</button>
                    <button class="btn btn-primary" id="save-production">Save & Continue</button>
                </div>
            </div>

            <div class="block" id="silos-block">
                <h2 class="block-title"><i class="fas fa-warehouse"></i> Silos/Plant Dimensions</h2>
                <div class="form-group">
                    <label for="silos-length">Length (m)</label>
                    <input type="number" id="silos-length" placeholder="Enter length">
                </div>
                <div class="form-group">
                    <label for="silos-width">Width (m)</label>
                    <input type="number" id="silos-width" placeholder="Enter width">
                </div>
                <div class="form-group">
                    <label for="silos-height">Height (m)</label>
                    <input type="number" id="silos-height" placeholder="Enter height">
                </div>
                <div class="form-group">
                    <label for="roof-height">Roof Height (m)</label>
                    <input type="number" id="roof-height" placeholder="Enter roof height">
                </div>
                <div class="form-group">
                    <label for="wall-material">Wall Material</label>
                    <select id="wall-material">
                        <option value="concrete">Concrete</option>
                        <option value="steel">Steel</option>
                        <option value="brick">Brick</option>
                        <option value="composite">Composite</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="insulation">Insulation Type</label>
                    <select id="insulation">
                        <option value="none">None</option>
                        <option value="fiberglass">Fiberglass</option>
                        <option value="foam">Foam</option>
                        <option value="mineral-wool">Mineral Wool</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="door-count">Number of Doors</label>
                    <input type="number" id="door-count" min="1" max="10" value="1">
                </div>
                <div class="form-group">
                    <label for="door-width">Door Width (m)</label>
                    <input type="number" id="door-width" placeholder="Enter door width">
                </div>
                <div class="form-group">
                    <label for="door-height">Door Height (m)</label>
                    <input type="number" id="door-height" placeholder="Enter door height">
                </div>
                <div class="btn-group">
                    <button class="btn btn-default" id="reset-silos">Reset to Default</button>
                    <button class="btn btn-primary" id="save-silos">Save & Continue</button>
                </div>
            </div>

            <div class="block" id="visualization-block">
                <h2 class="block-title"><i class="fas fa-cube"></i> 3D Visualization</h2>
                <div id="visualization-container"></div>
                <div class="btn-group">
                    <button class="btn btn-secondary" id="update-visualization">Update Visualization</button>
                </div>
            </div>

            <div class="block" id="comments-block">
                <h2 class="block-title"><i class="fas fa-comment-alt"></i> Additional Comments</h2>
                <div class="form-group">
                    <label for="comments">Comments & Notes</label>
                    <textarea id="comments" rows="5" placeholder="Enter any additional comments or notes"></textarea>
                </div>
                <div class="btn-group">
                    <button class="btn btn-default" id="reset-comments">Reset</button>
                    <button class="btn btn-primary" id="save-comments">Save All Data</button>
                </div>
            </div>

            <div class="block" id="psychrometric-block">
                <h2 class="block-title"><i class="fas fa-temperature-low"></i> Psychrometric Calculations</h2>
                <div class="psychrometric-grid">
                    <div class="form-group">
                        <label for="dry-temp">Dry Bulb Temperature (°C)</label>
                        <input type="number" id="dry-temp" placeholder="Enter temperature">
                    </div>
                    <div class="form-group">
                        <label for="wet-temp">Wet Bulb Temperature (°C)</label>
                        <input type="number" id="wet-temp" placeholder="Enter temperature">
                    </div>
                    <div class="form-group">
                        <label for="rh">Relative Humidity (%)</label>
                        <input type="number" id="rh" placeholder="Enter RH" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="dew-point">Dew Point (°C)</label>
                        <input type="number" id="dew-point" placeholder="Enter dew point">
                    </div>
                </div>
                <div class="form-group">
                    <label for="calculation-method">Calculation Method</label>
                    <select id="calculation-method">
                        <option value="standard">Standard Psychrometric</option>
                        <option value="approximate">Approximate Method</option>
                        <option value="hybrid">Hybrid Method</option>
                    </select>
                </div>
                <div class="btn-group">
                    <button class="btn btn-default" id="reset-psychro">Reset</button>
                    <button class="btn btn-secondary" id="calculate-psychro">Calculate</button>
                </div>
                <div class="psychrometric-result" id="psychrometric-result" style="display: none;">
                    <h3>Results</h3>
                    <div class="result-grid">
                        <div class="result-item">
                            <span>Humidity Ratio:</span>
                            <span class="result-value" id="humidity-ratio">0.0</span> kg/kg
                        </div>
                        <div class="result-item">
                            <span>Specific Volume:</span>
                            <span class="result-value" id="specific-volume">0.0</span> m³/kg
                        </div>
                        <div class="result-item">
                            <span>Enthalpy:</span>
                            <span class="result-value" id="enthalpy">0.0</span> kJ/kg
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Other Sections -->
        <section id="hvac-section" class="section">
            <div class="block">
                <h2 class="block-title"><i class="fas fa-wind"></i> HVAC System</h2>
                <p>This section contains HVAC system specifications and controls.</p>
                <div class="form-group">
                    <label for="hvac-type">HVAC System Type</label>
                    <select id="hvac-type">
                        <option value="central">Central Air Conditioning</option>
                        <option value="split">Split System</option>
                        <option value="vrf">VRF System</option>
                        <option value="chiller">Chilled Water System</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="cooling-capacity">Cooling Capacity (kW)</label>
                    <input type="number" id="cooling-capacity" placeholder="Enter capacity">
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary">Save HVAC Settings</button>
                </div>
            </div>
        </section>

        <section id="filter-section" class="section">
            <div class="block">
                <h2 class="block-title"><i class="fas fa-filter"></i> Filtration System</h2>
                <p>This section contains filtration system specifications and controls.</p>
                <div class="form-group">
                    <label for="filter-type">Filter Type</label>
                    <select id="filter-type">
                        <option value="hepa">HEPA Filter</option>
                        <option value="carbon">Activated Carbon</option>
                        <option value="bag">Bag Filter</option>
                        <option value="electrostatic">Electrostatic Precipitator</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="filter-efficiency">Filter Efficiency (%)</label>
                    <input type="number" id="filter-efficiency" min="0" max="100" value="95">
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary">Save Filter Settings</button>
                </div>
            </div>
        </section>

        <section id="plc-section" class="section">
            <div class="block">
                <h2 class="block-title"><i class="fas fa-microchip"></i> PLC Control System</h2>
                <p>This section contains PLC control system settings.</p>
                <div class="form-group">
                    <label for="plc-model">PLC Model</label>
                    <input type="text" id="plc-model" placeholder="Enter PLC model">
                </div>
                <div class="form-group">
                    <label for="io-count">I/O Count</label>
                    <input type="number" id="io-count" min="8" value="16">
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary">Save PLC Settings</button>
                </div>
            </div>
        </section>

        <section id="etc-section" class="section">
            <div class="block">
                <h2 class="block-title"><i class="fas fa-cog"></i> Additional Settings</h2>
                <p>This section contains additional settings and configurations.</p>
                <div class="form-group">
                    <label for="theme-select">Theme</label>
                    <select id="theme-select">
                        <option value="dark">Dark Theme</option>
                        <option value="light">Light Theme</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="auto-save">Auto-save Interval (minutes)</label>
                    <input type="number" id="auto-save" min="1" max="60" value="5">
                </div>
                <div class="btn-group">
                    <button class="btn btn-secondary">Save Settings</button>
                </div>
            </div>
        </section>
    </div>

    <!-- Bottom Navigation -->
    <div class="nav-container">
        <button class="nav-btn active" data-section="problem-section">
            <i class="fas fa-exclamation-circle"></i>
            <span>Problem</span>
        </button>
        <button class="nav-btn" data-section="hvac-section">
            <i class="fas fa-wind"></i>
            <span>HVAC</span>
        </button>
        <button class="nav-btn" data-section="filter-section">
            <i class="fas fa-filter"></i>
            <span>Filter</span>
        </button>
        <button class="nav-btn" data-section="plc-section">
            <i class="fas fa-microchip"></i>
            <span>PLC</span>
        </button>
        <button class="nav-btn" data-section="etc-section">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </button>
    </div>

    <script>
        // Initialize SQL.js
        let db;
        let sqlLoaded = false;
        let currentProjectId = null;
        
        // Initialize Three.js variables
        let scene, camera, renderer, silos;
        
        // Theme management
        let currentTheme = 'dark';
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize SQL.js
            await initSQLite();
            
            // Initialize database tables
            await initDatabase();
            
            // Initialize navigation
            initNavigation();
            
            // Initialize form handlers
            initFormHandlers();
            
            // Initialize 3D visualization
            initVisualization();
            
            // Check for last project
            await checkLastProject();
            
            // Show first block
            showBlock('project-info-block');
        });
        
        // Initialize SQLite database
        async function initSQLite() {
            try {
                // Load SQL.js
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
                
                // Try to open existing database
                try {
                    const response = await fetch('mydata.sql');
                    if (response.ok) {
                        const arrayBuffer = await response.arrayBuffer();
                        const uint8Array = new Uint8Array(arrayBuffer);
                        db = new SQL.Database(uint8Array);
                        showToast('Database loaded successfully', 'success');
                    } else {
                        throw new Error('Database file not found');
                    }
                } catch (error) {
                    // Create new database
                    db = new SQL.Database();
                    showToast('New database created', 'warning');
                    
                    // Save the empty database to create the file
                    await saveDatabase();
                }
                
                sqlLoaded = true;
            } catch (error) {
                console.error('SQL.js initialization error:', error);
                showToast('Database initialization failed', 'error');
            }
        }
        
        // Initialize database tables
        async function initDatabase() {
            if (!sqlLoaded) return;
            
            try {
                // Check if settings table exists
                const settingsCheck = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='settings'");
                if (settingsCheck.length === 0) {
                    // Create settings table
                    db.exec(`
                        CREATE TABLE settings (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            item TEXT NOT NULL UNIQUE,
                            value TEXT
                        );
                        INSERT INTO settings (item, value) VALUES ('theme', '${currentTheme}');
                        INSERT INTO settings (item, value) VALUES ('last_project', NULL);
                    `);
                }
                
                // Check if project table exists
                const projectCheck = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='project'");
                if (projectCheck.length === 0) {
                    // Create project table
                    db.exec(`
                        CREATE TABLE project (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            name TEXT,
                            company TEXT,
                            author TEXT,
                            revision TEXT,
                            date TEXT,
                            description TEXT,
                            location_name TEXT,
                            location_type TEXT,
                            latitude TEXT,
                            longitude TEXT,
                            warm_temp REAL,
                            warm_humidity REAL,
                            cold_temp REAL,
                            cold_humidity REAL,
                            capacity REAL,
                            working_hours INTEGER,
                            moisture REAL,
                            losses REAL,
                            silos_length REAL,
                            silos_width REAL,
                            silos_height REAL,
                            roof_height REAL,
                            wall_material TEXT,
                            insulation TEXT,
                            door_count INTEGER,
                            door_width REAL,
                            door_height REAL,
                            comments TEXT,
                            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                            updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                        );
                    `);
                }
                
                // Check if psychrometric table exists
                const psychroCheck = db.exec("SELECT name FROM sqlite_master WHERE type='table' AND name='psychrometric'");
                if (psychroCheck.length === 0) {
                    db.exec(`
                        CREATE TABLE psychrometric (
                            id INTEGER PRIMARY KEY AUTOINCREMENT,
                            project_id INTEGER,
                            dry_temp REAL,
                            wet_temp REAL,
                            rh REAL,
                            dew_point REAL,
                            method TEXT,
                            humidity_ratio REAL,
                            specific_volume REAL,
                            enthalpy REAL,
                            calculated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                        );
                    `);
                }
                
                showToast('Database tables initialized', 'success');
            } catch (error) {
                console.error('Database initialization error:', error);
                showToast('Database table creation failed', 'error');
            }
        }
        
        // Save database to file
        async function saveDatabase() {
            if (!sqlLoaded) return;
            
            try {
                const data = db.export();
                const blob = new Blob([data], { type: 'application/octet-stream' });
                const url = URL.createObjectURL(blob);
                
                // Create a temporary link to trigger download
                const a = document.createElement('a');
                a.href = url;
                a.download = 'mydata.sql';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                // Revoke the URL after some time
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                return true;
            } catch (error) {
                console.error('Database save error:', error);
                showToast('Failed to save database', 'error');
                return false;
            }
        }
        
        // Check for last project and load it
        async function checkLastProject() {
            if (!sqlLoaded) return;
            
            try {
                // Load last project ID from settings
                const lastProjectResult = db.exec("SELECT value FROM settings WHERE item = 'last_project'");
                if (lastProjectResult.length > 0 && lastProjectResult[0].values.length > 0) {
                    const lastProjectId = lastProjectResult[0].values[0][0];
                    
                    if (lastProjectId) {
                        currentProjectId = lastProjectId;
                        await loadProjectData(currentProjectId);
                        updateProjectStatus(true, `Project "${document.getElementById('project-name').value}" loaded`);
                    } else {
                        updateProjectStatus(false, "No active project");
                    }
                }
            } catch (error) {
                console.error('Check last project error:', error);
                showToast('Failed to check last project', 'error');
            }
        }
        
        // Load project data
        async function loadProjectData(projectId) {
            if (!sqlLoaded) return;
            
            try {
                const projectResult = db.exec(`SELECT * FROM project WHERE id = ${projectId}`);
                if (projectResult.length > 0 && projectResult[0].values.length > 0) {
                    const row = projectResult[0].columns.reduce((obj, col, index) => {
                        obj[col] = projectResult[0].values[0][index];
                        return obj;
                    }, {});
                    
                    // Project info
                    document.getElementById('project-name').value = row.name || '';
                    document.getElementById('company').value = row.company || '';
                    document.getElementById('author').value = row.author || '';
                    document.getElementById('revision').value = row.revision || '';
                    document.getElementById('project-date').value = row.date || '';
                    document.getElementById('description').value = row.description || '';
                    
                    // Location
                    document.getElementById('location-name').value = row.location_name || '';
                    document.getElementById('location-type').value = row.location_type || 'urban';
                    document.getElementById('latitude').value = row.latitude || '';
                    document.getElementById('longitude').value = row.longitude || '';
                    
                    // Weather
                    document.getElementById('warm-temp').value = row.warm_temp || '';
                    document.getElementById('warm-humidity').value = row.warm_humidity || '';
                    document.getElementById('cold-temp').value = row.cold_temp || '';
                    document.getElementById('cold-humidity').value = row.cold_humidity || '';
                    
                    // Production
                    document.getElementById('capacity').value = row.capacity || '';
                    document.getElementById('working-hours').value = row.working_hours || '';
                    document.getElementById('moisture').value = row.moisture || '8';
                    document.getElementById('losses').value = row.losses || '2';
                    
                    // Silos
                    document.getElementById('silos-length').value = row.silos_length || '';
                    document.getElementById('silos-width').value = row.silos_width || '';
                    document.getElementById('silos-height').value = row.silos_height || '';
                    document.getElementById('roof-height').value = row.roof_height || '';
                    document.getElementById('wall-material').value = row.wall_material || 'concrete';
                    document.getElementById('insulation').value = row.insulation || 'none';
                    document.getElementById('door-count').value = row.door_count || '1';
                    document.getElementById('door-width').value = row.door_width || '';
                    document.getElementById('door-height').value = row.door_height || '';
                    
                    // Comments
                    document.getElementById('comments').value = row.comments || '';
                    
                    // Update visualization
                    updateVisualization();
                    
                    showToast(`Project "${row.name}" loaded`, 'success');
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Project load error:', error);
                showToast('Failed to load project data', 'error');
                return false;
            }
        }
        
        // Update project status indicator
        function updateProjectStatus(active, message) {
            const indicator = document.getElementById('project-status-indicator');
            const statusText = document.getElementById('project-status-text');
            
            if (active) {
                indicator.className = 'status-indicator status-active';
                statusText.textContent = message;
            } else {
                indicator.className = 'status-indicator status-inactive';
                statusText.textContent = message;
            }
        }
        
        // Initialize navigation
        function initNavigation() {
            const navButtons = document.querySelectorAll('.nav-btn');
            
            navButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // Animation
                    this.querySelector('i').style.transform = 'translateY(0) scale(1.3)';
                    this.querySelector('i').style.color = 'var(--accent-color)';
                    
                    setTimeout(() => {
                        this.querySelector('i').style.transform = 'translateY(-5px) scale(1.1)';
                        this.querySelector('i').style.color = '';
                    }, 300);
                    
                    // Section switching
                    const sectionId = this.getAttribute('data-section');
                    switchSection(sectionId);
                    
                    // Update active state
                    navButtons.forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                });
                
                // Hover effects
                button.addEventListener('mouseenter', function() {
                    if (!this.classList.contains('active')) {
                        this.querySelector('i').style.transform = 'translateY(-5px) scale(1.1)';
                    }
                });
                
                button.addEventListener('mouseleave', function() {
                    if (!this.classList.contains('active')) {
                        this.querySelector('i').style.transform = '';
                    }
                });
            });
        }
        
        // Switch between sections
        function switchSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
        }
        
        // Show specific block in problem section
        function showBlock(blockId) {
            document.querySelectorAll('#problem-section .block').forEach(block => {
                block.style.display = 'none';
            });
            
            document.getElementById(blockId).style.display = 'block';
        }
        
        // Initialize form handlers
        function initFormHandlers() {
            // Project controls
            document.getElementById('new-project').addEventListener('click', createNewProject);
            document.getElementById('open-project').addEventListener('click', openProject);
            document.getElementById('close-project').addEventListener('click', closeProject);
            document.getElementById('save-project').addEventListener('click', saveCurrentProject);
            
            // Project info
            document.getElementById('save-project-info').addEventListener('click', saveProjectInfo);
            document.getElementById('reset-project').addEventListener('click', resetProjectInfo);
            
            // Location
            document.getElementById('save-location').addEventListener('click', saveLocationInfo);
            document.getElementById('reset-location').addEventListener('click', resetLocationInfo);
            
            // Weather
            document.getElementById('save-weather').addEventListener('click', saveWeatherInfo);
            document.getElementById('reset-weather').addEventListener('click', resetWeatherInfo);
            
            // Production
            document.getElementById('save-production').addEventListener('click', saveProductionInfo);
            document.getElementById('reset-production').addEventListener('click', resetProductionInfo);
            
            // Silos
            document.getElementById('save-silos').addEventListener('click', saveSilosInfo);
            document.getElementById('reset-silos').addEventListener('click', resetSilosInfo);
            
            // Comments
            document.getElementById('save-comments').addEventListener('click', saveComments);
            document.getElementById('reset-comments').addEventListener('click', resetComments);
            
            // Psychrometric
            document.getElementById('calculate-psychro').addEventListener('click', calculatePsychrometric);
            document.getElementById('reset-psychro').addEventListener('click', resetPsychrometric);
            
            // Visualization
            document.getElementById('update-visualization').addEventListener('click', updateVisualization);
            
            // Theme selector
            document.getElementById('theme-select').addEventListener('change', function() {
                currentTheme = this.value;
                document.body.classList.toggle('light-theme', currentTheme === 'light');
                
                // Save theme to settings
                if (sqlLoaded) {
                    db.exec(`UPDATE settings SET value = '${currentTheme}' WHERE item = 'theme'`);
                    saveDatabase();
                }
            });
        }
        
        // Create new project
        async function createNewProject() {
            if (currentProjectId) {
                const confirmCreate = confirm('Creating a new project will reset all current data. Are you sure?');
                if (!confirmCreate) return;
            }
            
            try {
                // Create new project in database
                db.exec(`
                    INSERT INTO project (name, created_at) 
                    VALUES ('New Project', CURRENT_TIMESTAMP)
                `);
                
                // Get the new project ID
                const result = db.exec("SELECT last_insert_rowid()");
                if (result.length > 0 && result[0].values.length > 0) {
                    currentProjectId = result[0].values[0][0];
                    
                    // Set as last project
                    db.exec(`UPDATE settings SET value = ${currentProjectId} WHERE item = 'last_project'`);
                    
                    // Save database
                    await saveDatabase();
                    
                    // Reset form to default values
                    resetAllForms();
                    
                    // Set default project name
                    document.getElementById('project-name').value = 'New Project';
                    
                    updateProjectStatus(true, 'New project created');
                    showToast('New project created', 'success');
                }
            } catch (error) {
                console.error('Create new project error:', error);
                showToast('Failed to create new project', 'error');
            }
        }
        
        // Open project
        async function openProject() {
            try {
                // Get list of projects
                const projectsResult = db.exec("SELECT id, name FROM project ORDER BY created_at DESC");
                if (projectsResult.length > 0 && projectsResult[0].values.length > 0) {
                    // For simplicity, we'll just open the most recent project
                    const projectId = projectsResult[0].values[0][0];
                    const projectName = projectsResult[0].values[0][1];
                    
                    // Load the project
                    const success = await loadProjectData(projectId);
                    
                    if (success) {
                        currentProjectId = projectId;
                        db.exec(`UPDATE settings SET value = ${currentProjectId} WHERE item = 'last_project'`);
                        await saveDatabase();
                        updateProjectStatus(true, `Project "${projectName}" loaded`);
                    }
                } else {
                    showToast('No projects found', 'warning');
                }
            } catch (error) {
                console.error('Open project error:', error);
                showToast('Failed to open project', 'error');
            }
        }
        
        // Close project
        async function closeProject() {
            if (!currentProjectId) {
                showToast('No project is currently open', 'warning');
                return;
            }
            
            const confirmClose = confirm('Are you sure you want to close the current project? All unsaved changes will be lost.');
            if (!confirmClose) return;
            
            // Reset the form
            resetAllForms();
            
            // Clear last project setting
            db.exec("UPDATE settings SET value = NULL WHERE item = 'last_project'");
            await saveDatabase();
            
            currentProjectId = null;
            updateProjectStatus(false, 'Project closed');
            showToast('Project closed', 'success');
        }
        
        // Save current project
        async function saveCurrentProject() {
            if (!currentProjectId) {
                showToast('No project is currently open', 'warning');
                return;
            }
            
            // Save all sections
            await saveProjectInfo();
            await saveLocationInfo();
            await saveWeatherInfo();
            await saveProductionInfo();
            await saveSilosInfo();
            await saveComments();
            
            showToast('Project saved successfully', 'success');
        }
        
        // Reset all forms to default values
        function resetAllForms() {
            document.getElementById('project-name').value = '';
            document.getElementById('company').value = '';
            document.getElementById('author').value = '';
            document.getElementById('revision').value = '';
            document.getElementById('project-date').value = '';
            document.getElementById('description').value = '';
            
            document.getElementById('location-name').value = '';
            document.getElementById('location-type').value = 'urban';
            document.getElementById('latitude').value = '';
            document.getElementById('longitude').value = '';
            
            document.getElementById('warm-temp').value = '';
            document.getElementById('warm-humidity').value = '';
            document.getElementById('cold-temp').value = '';
            document.getElementById('cold-humidity').value = '';
            
            document.getElementById('capacity').value = '';
            document.getElementById('working-hours').value = '';
            document.getElementById('moisture').value = '8';
            document.getElementById('losses').value = '2';
            
            document.getElementById('silos-length').value = '';
            document.getElementById('silos-width').value = '';
            document.getElementById('silos-height').value = '';
            document.getElementById('roof-height').value = '';
            document.getElementById('wall-material').value = 'concrete';
            document.getElementById('insulation').value = 'none';
            document.getElementById('door-count').value = '1';
            document.getElementById('door-width').value = '';
            document.getElementById('door-height').value = '';
            
            document.getElementById('comments').value = '';
            
            document.getElementById('dry-temp').value = '';
            document.getElementById('wet-temp').value = '';
            document.getElementById('rh').value = '';
            document.getElementById('dew-point').value = '';
            document.getElementById('calculation-method').value = 'standard';
            document.getElementById('psychrometric-result').style.display = 'none';
            
            showToast('All forms reset to default', 'warning');
        }
        
        // Save project info
        async function saveProjectInfo() {
            if (!currentProjectId) {
                showToast('No project is currently open', 'warning');
                return false;
            }
            
            if (!validateProjectInfo()) return false;
            
            try {
                const project = {
                    name: document.getElementById('project-name').value,
                    company: document.getElementById('company').value,
                    author: document.getElementById('author').value,
                    revision: document.getElementById('revision').value,
                    date: document.getElementById('project-date').value,
                    description: document.getElementById('description').value
                };
                
                // Update project
                db.exec(`
                    UPDATE project SET
                        name = '${escapeSQL(project.name)}',
                        company = '${escapeSQL(project.company)}',
                        author = '${escapeSQL(project.author)}',
                        revision = '${escapeSQL(project.revision)}',
                        date = '${escapeSQL(project.date)}',
                        description = '${escapeSQL(project.description)}',
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = ${currentProjectId}
                `);
                
                await saveDatabase();
                showToast('Project information saved', 'success');
                showBlock('location-block');
                return true;
            } catch (error) {
                console.error('Save project error:', error);
                showToast('Failed to save project information', 'error');
                return false;
            }
        }
        
        // Reset project info to default
        function resetProjectInfo() {
            if (confirm('Are you sure you want to reset project information to default values?')) {
                document.getElementById('project-name').value = '';
                document.getElementById('company').value = '';
                document.getElementById('author').value = '';
                document.getElementById('revision').value = '';
                document.getElementById('project-date').value = '';
                document.getElementById('description').value = '';
                showToast('Project information reset', 'warning');
            }
        }
        
        // Validate project info
        function validateProjectInfo() {
            const name = document.getElementById('project-name').value.trim();
            
            if (!name) {
                showToast('Project name is required', 'error');
                return false;
            }
            
            return true;
        }
        
        // Save location info
        async function saveLocationInfo() {
            if (!currentProjectId) {
                showToast('No project is currently open', 'warning');
                return false;
            }
            
            if (!validateLocationInfo()) return false;
            
            try {
                const location = {
                    name: document.getElementById('location-name').value,
                    type: document.getElementById('location-type').value,
                    latitude: document.getElementById('latitude').value,
                    longitude: document.getElementById('longitude').value
                };
                
                // Update project with location info
                db.exec(`
                    UPDATE project SET
                        location_name = '${escapeSQL(location.name)}',
                        location_type = '${escapeSQL(location.type)}',
                        latitude = '${escapeSQL(location.latitude)}',
                        longitude = '${escapeSQL(location.longitude)}',
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = ${currentProjectId}
                `);
                
                await saveDatabase();
                showToast('Location information saved', 'success');
                showBlock('weather-block');
                return true;
            } catch (error) {
                console.error('Save location error:', error);
                showToast('Failed to save location information', 'error');
                return false;
            }
        }
        
        // Reset location info
        function resetLocationInfo() {
            if (confirm('Are you sure you want to reset location information to default values?')) {
                document.getElementById('location-name').value = '';
                document.getElementById('location-type').value = 'urban';
                document.getElementById('latitude').value = '';
                document.getElementById('longitude').value = '';
                showToast('Location information reset', 'warning');
            }
        }
        
        // Validate location info
        function validateLocationInfo() {
            const name = document.getElementById('location-name').value.trim();
            
            if (!name) {
                showToast('Location name is required', 'error');
                return false;
            }
            
            return true;
        }
        
        // Save weather info
        async function saveWeatherInfo() {
            if (!currentProjectId) {
                showToast('No project is currently open', 'warning');
                return false;
            }
            
            if (!validateWeatherInfo()) return false;
            
            try {
                const weather = {
                    warmTemp: document.getElementById('warm-temp').value,
                    warmHumidity: document.getElementById('warm-humidity').value,
                    coldTemp: document.getElementById('cold-temp').value,
                    coldHumidity: document.getElementById('cold-humidity').value
                };
                
                // Update project with weather info
                db.exec(`
                    UPDATE project SET
                        warm_temp = ${weather.warmTemp || 'NULL'},
                        warm_humidity = ${weather.warmHumidity || 'NULL'},
                        cold_temp = ${weather.coldTemp || 'NULL'},
                        cold_humidity = ${weather.coldHumidity || 'NULL'},
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = ${currentProjectId}
                `);
                
                await saveDatabase();
                showToast('Weather information saved', 'success');
                showBlock('production-block');
                return true;
            } catch (error) {
                console.error('Save weather error:', error);
                showToast('Failed to save weather information', 'error');
                return false;
            }
        }
        
        // Reset weather info
        function resetWeatherInfo() {
            if (confirm('Are you sure you want to reset weather information to default values?')) {
                document.getElementById('warm-temp').value = '';
                document.getElementById('warm-humidity').value = '';
                document.getElementById('cold-temp').value = '';
                document.getElementById('cold-humidity').value = '';
                showToast('Weather information reset', 'warning');
            }
        }
        
        // Validate weather info
        function validateWeatherInfo() {
            const warmTemp = parseFloat(document.getElementById('warm-temp').value);
            const warmHumidity = parseFloat(document.getElementById('warm-humidity').value);
            
            if (isNaN(warmTemp)) {
                showToast('Warm season temperature is required', 'error');
                return false;
            }
            
            if (isNaN(warmHumidity)) {
                showToast('Warm season humidity is required', 'error');
                return false;
            }
            
            if (warmHumidity < 0 || warmHumidity > 100) {
                showToast('Humidity must be between 0 and 100%', 'error');
                return false;
            }
            
            return true;
        }
        
        // Save production info
        async function saveProductionInfo() {
            if (!currentProjectId) {
                showToast('No project is currently open', 'warning');
                return false;
            }
            
            if (!validateProductionInfo()) return false;
            
            try {
                const production = {
                    capacity: document.getElementById('capacity').value,
                    workingHours: document.getElementById('working-hours').value,
                    moisture: document.getElementById('moisture').value,
                    losses: document.getElementById('losses').value
                };
                
                // Update project with production info
                db.exec(`
                    UPDATE project SET
                        capacity = ${production.capacity || 'NULL'},
                        working_hours = ${production.workingHours || 'NULL'},
                        moisture = ${production.moisture || '8'},
                        losses = ${production.losses || '2'},
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = ${currentProjectId}
                `);
                
                await saveDatabase();
                showToast('Production information saved', 'success');
                showBlock('silos-block');
                return true;
            } catch (error) {
                console.error('Save production error:', error);
                showToast('Failed to save production information', 'error');
                return false;
            }
        }
        
        // Reset production info
        function resetProductionInfo() {
            if (confirm('Are you sure you want to reset production information to default values?')) {
                document.getElementById('capacity').value = '';
                document.getElementById('working-hours').value = '';
                document.getElementById('moisture').value = '8';
                document.getElementById('losses').value = '2';
                showToast('Production information reset', 'warning');
            }
        }
        
        // Validate production info
        function validateProductionInfo() {
            const capacity = parseFloat(document.getElementById('capacity').value);
            const workingHours = parseInt(document.getElementById('working-hours').value);
            
            if (isNaN(capacity)) {
                showToast('Production capacity is required', 'error');
                return false;
            }
            
            if (isNaN(workingHours)) {
                showToast('Working hours are required', 'error');
                return false;
            }
            
            if (workingHours < 1 || workingHours > 24) {
                showToast('Working hours must be between 1 and 24', 'error');
                return false;
            }
            
            return true;
        }
        
        // Save silos info
        async function saveSilosInfo() {
            if (!currentProjectId) {
                showToast('No project is currently open', 'warning');
                return false;
            }
            
            if (!validateSilosInfo()) return false;
            
            try {
                const silosData = {
                    length: document.getElementById('silos-length').value,
                    width: document.getElementById('silos-width').value,
                    height: document.getElementById('silos-height').value,
                    roofHeight: document.getElementById('roof-height').value,
                    wallMaterial: document.getElementById('wall-material').value,
                    insulation: document.getElementById('insulation').value,
                    doorCount: document.getElementById('door-count').value,
                    doorWidth: document.getElementById('door-width').value,
                    doorHeight: document.getElementById('door-height').value
                };
                
                // Update project with silos info
                db.exec(`
                    UPDATE project SET
                        silos_length = ${silosData.length || 'NULL'},
                        silos_width = ${silosData.width || 'NULL'},
                        silos_height = ${silosData.height || 'NULL'},
                        roof_height = ${silosData.roofHeight || 'NULL'},
                        wall_material = '${escapeSQL(silosData.wallMaterial)}',
                        insulation = '${escapeSQL(silosData.insulation)}',
                        door_count = ${silosData.doorCount || '1'},
                        door_width = ${silosData.doorWidth || 'NULL'},
                        door_height = ${silosData.doorHeight || 'NULL'},
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = ${currentProjectId}
                `);
                
                await saveDatabase();
                showToast('Silos information saved', 'success');
                showBlock('visualization-block');
                updateVisualization();
                return true;
            } catch (error) {
                console.error('Save silos error:', error);
                showToast('Failed to save silos information', 'error');
                return false;
            }
        }
        
        // Reset silos info
        function resetSilosInfo() {
            if (confirm('Are you sure you want to reset silos information to default values?')) {
                document.getElementById('silos-length').value = '';
                document.getElementById('silos-width').value = '';
                document.getElementById('silos-height').value = '';
                document.getElementById('roof-height').value = '';
                document.getElementById('wall-material').value = 'concrete';
                document.getElementById('insulation').value = 'none';
                document.getElementById('door-count').value = '1';
                document.getElementById('door-width').value = '';
                document.getElementById('door-height').value = '';
                showToast('Silos information reset', 'warning');
            }
        }
        
        // Validate silos info
        function validateSilosInfo() {
            const length = parseFloat(document.getElementById('silos-length').value);
            const width = parseFloat(document.getElementById('silos-width').value);
            const height = parseFloat(document.getElementById('silos-height').value);
            const doorWidth = parseFloat(document.getElementById('door-width').value);
            const doorHeight = parseFloat(document.getElementById('door-height').value);
            
            if (isNaN(length)) {
                showToast('Silos length is required', 'error');
                return false;
            }
            
            if (isNaN(width)) {
                showToast('Silos width is required', 'error');
                return false;
            }
            
            if (isNaN(height)) {
                showToast('Silos height is required', 'error');
                return false;
            }
            
            return true;
        }
        
        // Save comments
        async function saveComments() {
            if (!currentProjectId) {
                showToast('No project is currently open', 'warning');
                return false;
            }
            
            try {
                const comments = document.getElementById('comments').value;
                
                // Update project with comments
                db.exec(`
                    UPDATE project SET
                        comments = '${escapeSQL(comments)}',
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = ${currentProjectId}
                `);
                
                await saveDatabase();
                showToast('Comments saved', 'success');
                return true;
            } catch (error) {
                console.error('Save comments error:', error);
                showToast('Failed to save comments', 'error');
                return false;
            }
        }
        
        // Reset comments
        function resetComments() {
            if (confirm('Are you sure you want to reset comments?')) {
                document.getElementById('comments').value = '';
                showToast('Comments reset', 'warning');
            }
        }
        
        // Calculate psychrometric values
        async function calculatePsychrometric() {
            if (!validatePsychrometricInputs()) return;
            
            try {
                const dryTemp = parseFloat(document.getElementById('dry-temp').value);
                const wetTemp = parseFloat(document.getElementById('wet-temp').value);
                const rh = parseFloat(document.getElementById('rh').value);
                const dewPoint = parseFloat(document.getElementById('dew-point').value);
                const method = document.getElementById('calculation-method').value;
                
                // Simple psychrometric calculations
                let humidityRatio, specificVolume, enthalpy;
                
                if (method === 'standard') {
                    humidityRatio = (0.622 * rh/100 * 6.112 * Math.exp(17.67 * dryTemp / (dryTemp + 243.5))) / 
                                  (101.325 - (rh/100 * 6.112 * Math.exp(17.67 * dryTemp / (dryTemp + 243.5))));
                    specificVolume = 0.2871 * (dryTemp + 273.15) * (1 + 1.6078 * humidityRatio) / 101.325;
                    enthalpy = 1.006 * dryTemp + humidityRatio * (2501 + 1.805 * dryTemp);
                } else if (method === 'approximate') {
                    humidityRatio = 0.00066 * (1 + 0.00115 * wetTemp) * (dryTemp - wetTemp);
                    specificVolume = 0.00283 + 0.00456 * humidityRatio;
                    enthalpy = 0.24 * dryTemp + humidityRatio * (597.3 + 0.441 * dryTemp);
                } else {
                    humidityRatio = (0.00066 * (1 + 0.00115 * wetTemp) * (dryTemp - wetTemp) + 
                                   0.622 * rh/100 * 6.112 * Math.exp(17.67 * dryTemp / (dryTemp + 243.5))) / 
                                   (101.325 - (rh/100 * 6.112 * Math.exp(17.67 * dryTemp / (dryTemp + 243.5)))) / 2;
                    specificVolume = (0.00283 + 0.00456 * humidityRatio + 
                                      0.2871 * (dryTemp + 273.15) * (1 + 1.6078 * humidityRatio) / 101.325) / 2;
                    enthalpy = (1.006 * dryTemp + humidityRatio * (2501 + 1.805 * dryTemp) + 
                               0.24 * dryTemp + humidityRatio * (597.3 + 0.441 * dryTemp)) / 2;
                }
                
                // Round results
                humidityRatio = Math.round(humidityRatio * 10000) / 10000;
                specificVolume = Math.round(specificVolume * 1000) / 1000;
                enthalpy = Math.round(enthalpy * 10) / 10;
                
                // Display results
                document.getElementById('psychrometric-result').style.display = 'block';
                document.getElementById('humidity-ratio').textContent = humidityRatio;
                document.getElementById('specific-volume').textContent = specificVolume;
                document.getElementById('enthalpy').textContent = enthalpy;
                
                // Save to database
                if (currentProjectId) {
                    db.exec(`
                        INSERT INTO psychrometric (
                            project_id, dry_temp, wet_temp, rh, dew_point, method, 
                            humidity_ratio, specific_volume, enthalpy
                        ) VALUES (
                            ${currentProjectId}, ${dryTemp}, ${wetTemp}, ${rh || 'NULL'}, ${dewPoint || 'NULL'}, '${method}',
                            ${humidityRatio}, ${specificVolume}, ${enthalpy}
                        )
                    `);
                    
                    await saveDatabase();
                    showToast('Psychrometric calculations saved', 'success');
                }
            } catch (error) {
                console.error('Psychrometric calculation error:', error);
                showToast('Failed to calculate psychrometric values', 'error');
            }
        }
        
        // Reset psychrometric inputs
        function resetPsychrometric() {
            if (confirm('Are you sure you want to reset psychrometric inputs?')) {
                document.getElementById('dry-temp').value = '';
                document.getElementById('wet-temp').value = '';
                document.getElementById('rh').value = '';
                document.getElementById('dew-point').value = '';
                document.getElementById('calculation-method').value = 'standard';
                document.getElementById('psychrometric-result').style.display = 'none';
                showToast('Psychrometric inputs reset', 'warning');
            }
        }
        
        // Validate psychrometric inputs
        function validatePsychrometricInputs() {
            const dryTemp = document.getElementById('dry-temp').value.trim();
            const wetTemp = document.getElementById('wet-temp').value.trim();
            const rh = document.getElementById('rh').value.trim();
            const dewPoint = document.getElementById('dew-point').value.trim();
            
            if (!dryTemp && !wetTemp && !rh && !dewPoint) {
                showToast('At least two parameters are required for calculation', 'error');
                return false;
            }
            
            // Check if at least two parameters are provided
            let providedCount = 0;
            if (dryTemp) providedCount++;
            if (wetTemp) providedCount++;
            if (rh) providedCount++;
            if (dewPoint) providedCount++;
            
            if (providedCount < 2) {
                showToast('At least two parameters are required for calculation', 'error');
                return false;
            }
            
            return true;
        }
        
        // Initialize 3D visualization
        function initVisualization() {
            const container = document.getElementById('visualization-container');
            
            // Set up scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x3d566e);
            
            // Set up camera
            camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(10, 10, 10);
            camera.lookAt(0, 0, 0);
            
            // Set up renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(container.clientWidth, container.clientHeight);
            container.appendChild(renderer.domElement);
            
            // Add lights
            const ambientLight = new THREE.AmbientLight(0x404040);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // Add grid helper
            const gridHelper = new THREE.GridHelper(20, 20);
            scene.add(gridHelper);
            
            // Create initial silos
            createSilos(10, 5, 8, 2, 2, 1.5, 1);
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Start animation loop
            animate();
        }
        
        // Create silos 3D model
        function createSilos(length, width, height, roofHeight, doorWidth, doorHeight, doorCount) {
            // Clear existing silos if any
            if (silos) scene.remove(silos);
            
            // Create silos group
            silos = new THREE.Group();
            
            // Create silos main structure
            const geometry = new THREE.BoxGeometry(length, height, width);
            const material = new THREE.MeshPhongMaterial({ 
                color: 0x8d8d8d,
                transparent: true,
                opacity: 0.8,
                wireframe: false
            });
            
            const mainBuilding = new THREE.Mesh(geometry, material);
            mainBuilding.position.y = height / 2;
            silos.add(mainBuilding);
            
            // Create roof (pyramid shape)
            const roofGeometry = new THREE.ConeGeometry(length * 0.8, roofHeight, 4);
            const roofMaterial = new THREE.MeshPhongMaterial({ color: 0xa52a2a });
            const roof = new THREE.Mesh(roofGeometry, roofMaterial);
            roof.position.y = height + roofHeight / 2;
            roof.rotation.y = Math.PI / 4;
            silos.add(roof);
            
            // Create doors
            const doorGeometry = new THREE.BoxGeometry(doorWidth, doorHeight, 0.2);
            const doorMaterial = new THREE.MeshPhongMaterial({ color: 0x5f9ea0 });
            
            // Calculate spacing between doors
            const totalWallLength = length;
            const spacing = (totalWallLength - doorWidth * doorCount) / (doorCount + 1);
            
            for (let i = 0; i < doorCount; i++) {
                const door = new THREE.Mesh(doorGeometry, doorMaterial);
                const xPos = -length/2 + spacing * (i+1) + doorWidth * (i + 0.5);
                door.position.set(xPos, doorHeight / 2, width / 2 + 0.1);
                silos.add(door);
            }
            
            scene.add(silos);
        }
        
        // Update visualization based on form inputs
        function updateVisualization() {
            const length = parseFloat(document.getElementById('silos-length').value) || 10;
            const width = parseFloat(document.getElementById('silos-width').value) || 5;
            const height = parseFloat(document.getElementById('silos-height').value) || 8;
            const roofHeight = parseFloat(document.getElementById('roof-height').value) || 2;
            const doorWidth = parseFloat(document.getElementById('door-width').value) || 2;
            const doorHeight = parseFloat(document.getElementById('door-height').value) || 1.5;
            const doorCount = parseInt(document.getElementById('door-count').value) || 1;
            
            createSilos(length, width, height, roofHeight, doorWidth, doorHeight, doorCount);
            showToast('Visualization updated', 'success');
        }
        
        // Handle window resize
        function onWindowResize() {
            const container = document.getElementById('visualization-container');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            if (silos) {
                silos.rotation.y += 0.005;
            }
            
            renderer.render(scene, camera);
        }
        
        // Show toast notification
        function showToast(message, type) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Escape SQL values to prevent injection
        function escapeSQL(str) {
            if (!str) return '';
            return str.replace(/'/g, "''");
        }
    </script>
</body>
</html>