<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شبیه‌سازی کوانتومی پروتون و نوترون</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tahoma', 'Segoe UI', sans-serif;
        }
        
        :root {
            --proton-color: #3b82f6;
            --neutron-color: #6b7280;
            --quark-red: #ef4444;
            --quark-green: #10b981;
            --quark-blue: #3b82f6;
            --antiquark-cyan: #06b6d4;
            --antiquark-magenta: #d946ef;
            --antiquark-yellow: #eab308;
            --gluon-orange: #f97316;
            --gluon-purple: #8b5cf6;
            --w-boson: #dc2626;
            --z-boson: #7c3aed;
            --pion: #ec4899;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --text: #e2e8f0;
            --highlight: #10b981;
        }
        
        body {
            background: linear-gradient(135deg, var(--dark-bg), #1e1b4b);
            color: var(--text);
            line-height: 1.8;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 30px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(100, 116, 139, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--quark-red), var(--quark-green), var(--quark-blue));
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 15px;
            background: linear-gradient(90deg, var(--proton-color), var(--neutron-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .subtitle {
            font-size: 1.3rem;
            opacity: 0.9;
            max-width: 800px;
            margin: 0 auto 20px;
        }
        
        .content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }
        
        @media (max-width: 1400px) {
            .content {
                grid-template-columns: 1fr;
            }
        }
        
        .nucleon-panel {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(100, 116, 139, 0.3);
            display: flex;
            flex-direction: column;
        }
        
        .panel-title {
            font-size: 1.6rem;
            margin-bottom: 20px;
            color: var(--proton-color);
            border-bottom: 2px solid rgba(100, 150, 255, 0.3);
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .neutron .panel-title {
            color: var(--neutron-color);
        }
        
        .panel-title::before {
            content: '';
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .proton .panel-title::before {
            background: var(--proton-color);
        }
        
        .neutron .panel-title::before {
            background: var(--neutron-color);
        }
        
        .visualization-area {
            position: relative;
            width: 100%;
            height: 400px;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 12px;
            border: 1px solid rgba(100, 116, 139, 0.3);
            overflow: hidden;
            margin-bottom: 20px;
        }
        
        .nucleon-boundary {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border-radius: 50%;
            border: 3px dashed;
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
        }
        
        .proton-boundary {
            border-color: var(--proton-color);
        }
        
        .neutron-boundary {
            border-color: var(--neutron-color);
        }
        
        .particle {
            position: absolute;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .particle.quark {
            width: 35px;
            height: 35px;
        }
        
        .particle.antiquark {
            width: 32px;
            height: 32px;
            border: 2px solid white;
        }
        
        .particle.gluon {
            width: 28px;
            height: 28px;
            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
            animation: gluonPulse 2s infinite alternate;
        }
        
        .particle.boson {
            width: 25px;
            height: 25px;
            border-radius: 20%;
        }
        
        @keyframes gluonPulse {
            0% { transform: scale(1) rotate(0deg); }
            100% { transform: scale(1.1) rotate(180deg); }
        }
        
        .quark.red { background: var(--quark-red); }
        .quark.green { background: var(--quark-green); }
        .quark.blue { background: var(--quark-blue); }
        
        .antiquark.cyan { background: var(--antiquark-cyan); }
        .antiquark.magenta { background: var(--antiquark-magenta); }
        .antiquark.yellow { background: var(--antiquark-yellow); }
        
        .gluon.orange { background: var(--gluon-orange); }
        .gluon.purple { background: var(--gluon-purple); }
        
        .boson.w { background: var(--w-boson); }
        .boson.z { background: var(--z-boson); }
        .boson.pion { background: var(--pion); }
        
        .interaction-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--gluon-orange), transparent);
            transform-origin: 0 0;
            z-index: 5;
            pointer-events: none;
        }
        
        .decay-line {
            position: absolute;
            height: 2px;
            background: linear-gradient(90deg, transparent, var(--w-boson), transparent);
            transform-origin: 0 0;
            z-index: 5;
            pointer-events: none;
        }
        
        .stats-panel {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(100, 116, 139, 0.3);
            margin-top: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid var(--highlight);
        }
        
        .stat-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--proton-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--highlight);
            font-family: 'Courier New', monospace;
        }
        
        .controls-panel {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(100, 116, 139, 0.3);
            margin-top: 30px;
        }
        
        .control-group {
            margin-bottom: 25px;
        }
        
        .control-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--proton-color);
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }
        
        label {
            min-width: 200px;
            font-weight: 600;
        }
        
        input[type="range"] {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: rgba(100, 116, 139, 0.3);
            outline: none;
            -webkit-appearance: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--proton-color);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        .value-display {
            min-width: 80px;
            text-align: center;
            padding: 5px 10px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        button {
            background: linear-gradient(90deg, var(--proton-color), #3b82f6);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            flex: 1;
            min-width: 150px;
        }
        
        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
        }
        
        button:active {
            transform: translateY(1px);
        }
        
        .probability-chart {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(100, 116, 139, 0.3);
            margin-top: 30px;
            height: 400px;
        }
        
        .calculation-panel {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(100, 116, 139, 0.3);
            margin-top: 30px;
        }
        
        .math {
            font-style: italic;
            margin: 15px 0;
            padding: 15px;
            background: rgba(30, 41, 59, 0.7);
            border-radius: 8px;
            border-left: 4px solid var(--gluon-orange);
            font-family: 'Times New Roman', serif;
            direction: ltr;
            text-align: left;
        }
        
        .event-log {
            background: rgba(15, 23, 42, 0.7);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }
        
        .log-entry {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(100, 116, 139, 0.3);
        }
        
        .log-time {
            color: var(--highlight);
            font-weight: bold;
        }
        
        footer {
            text-align: center;
            margin-top: 50px;
            padding: 25px;
            font-size: 0.9rem;
            opacity: 0.8;
            border-top: 1px solid rgba(100, 116, 139, 0.3);
        }
        
        .particle-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 8px;
        }
        
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        
        .quark-legend { background: var(--quark-red); }
        .antiquark-legend { 
            background: var(--antiquark-cyan); 
            border: 2px solid white;
        }
        .gluon-legend { 
            background: var(--gluon-orange); 
            border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%;
        }
        .boson-legend { background: var(--w-boson); border-radius: 20%; }
    </style>
</head>
<body>
    <div class="container" x-data="quantumSimulation()">
        <header>
            <h1>شبیه‌سازی کوانتومی پروتون و نوترون</h1>
            <p class="subtitle">مدل‌سازی پیشرفته برهمکنش‌های درون‌هسته‌ای با محاسبات احتمالاتی و فرمول‌های QCD</p>
            
            <div class="particle-legend">
                <div class="legend-item">
                    <div class="legend-color quark-legend"></div>
                    <span>کوارک‌ها</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color antiquark-legend"></div>
                    <span>پادکوارک‌ها</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color gluon-legend"></div>
                    <span>گلئون‌ها</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color boson-legend"></div>
                    <span>بوزون‌های弱</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--proton-color);"></div>
                    <span>پروتون</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: var(--neutron-color);"></div>
                    <span>نوترون</span>
                </div>
            </div>
        </header>
        
        <div class="content">
            <div class="nucleon-panel proton">
                <h2 class="panel-title">ساختار پروتون</h2>
                <div class="visualization-area" id="protonViz">
                    <div class="nucleon-boundary proton-boundary"></div>
                    <!-- ذرات به صورت پویا تولید می‌شوند -->
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title">کوارک‌های ظرفیت</div>
                        <div class="stat-value" x-text="protonStats.valenceQuarks"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">گلئون‌ها</div>
                        <div class="stat-value" x-text="protonStats.gluons"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">کوارک‌های دریایی</div>
                        <div class="stat-value" x-text="protonStats.seaQuarks"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">برهمکنش‌های فعال</div>
                        <div class="stat-value" x-text="protonStats.activeInteractions"></div>
                    </div>
                </div>
            </div>
            
            <div class="nucleon-panel neutron">
                <h2 class="panel-title">ساختار نوترون</h2>
                <div class="visualization-area" id="neutronViz">
                    <div class="nucleon-boundary neutron-boundary"></div>
                    <!-- ذرات به صورت پویا تولید می‌شوند -->
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-title">کوارک‌های ظرفیت</div>
                        <div class="stat-value" x-text="neutronStats.valenceQuarks"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">گلئون‌ها</div>
                        <div class="stat-value" x-text="neutronStats.gluons"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">کوارک‌های دریایی</div>
                        <div class="stat-value" x-text="neutronStats.seaQuarks"></div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-title">برهمکنش‌های فعال</div>
                        <div class="stat-value" x-text="neutronStats.activeInteractions"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls-panel">
            <h2 class="panel-title">کنترل‌های شبیه‌سازی</h2>
            
            <div class="control-group">
                <h3 class="control-title">پارامترهای فیزیکی</h3>
                <div class="slider-container">
                    <label for="energy-scale">مقیاس انرژی (GeV)</label>
                    <input type="range" id="energy-scale" min="0.1" max="2.0" step="0.1" 
                           x-model="energyScale" @input="updateSimulation">
                    <div class="value-display" x-text="`${energyScale} GeV`"></div>
                </div>
                
                <div class="slider-container">
                    <label for="coupling-constant">ثابت جفت‌شدگی قوی (αs)</label>
                    <input type="range" id="coupling-constant" min="0.1" max="1.0" step="0.05" 
                           x-model="couplingConstant" @input="updateSimulation">
                    <div class="value-display" x-text="couplingConstant"></div>
                </div>
                
                <div class="slider-container">
                    <label for="time-step">گام زمانی (fm/c)</label>
                    <input type="range" id="time-step" min="0.1" max="2.0" step="0.1" 
                           x-model="timeStep" @input="updateSimulation">
                    <div class="value-display" x-text="`${timeStep} fm/c`"></div>
                </div>
            </div>
            
            <div class="control-group">
                <h3 class="control-title">احتمالات برهمکنش</h3>
                <div class="slider-container">
                    <label for="gluon-exchange">تبادل گلئون</label>
                    <input type="range" id="gluon-exchange" min="0" max="100" step="1" 
                           x-model="interactionProbabilities.gluonExchange" @input="updateSimulation">
                    <div class="value-display" x-text="`${interactionProbabilities.gluonExchange}%`"></div>
                </div>
                
                <div class="slider-container">
                    <label for="quark-pair">تولید جفت کوارک-پادکوارک</label>
                    <input type="range" id="quark-pair" min="0" max="100" step="1" 
                           x-model="interactionProbabilities.quarkPair" @input="updateSimulation">
                    <div class="value-display" x-text="`${interactionProbabilities.quarkPair}%`"></div>
                </div>
                
                <div class="slider-container">
                    <label for="beta-decay">واپاشی بتا (نوترون)</label>
                    <input type="range" id="beta-decay" min="0" max="10" step="0.1" 
                           x-model="interactionProbabilities.betaDecay" @input="updateSimulation">
                    <div class="value-display" x-text="`${interactionProbabilities.betaDecay}%`"></div>
                </div>
            </div>
            
            <div class="button-group">
                <button @click="startSimulation()">شروع شبیه‌سازی</button>
                <button @click="pauseSimulation()">توقف موقت</button>
                <button @click="resetSimulation()">بازنشانی</button>
                <button @click="singleStep()">یک گام</button>
                <button @click="exportData()">خروجی داده</button>
            </div>
        </div>
        
        <div class="probability-chart">
            <h2 class="panel-title">توزیع احتمالات برهمکنش</h2>
            <canvas id="probabilityChart" width="400" height="200"></canvas>
        </div>
        
        <div class="calculation-panel">
            <h2 class="panel-title">محاسبات کوانتومی</h2>
            
            <div class="math">
                تابع چگالی کوارک‌ها در پروتون: 
                f(x, Q²) = A x^α (1-x)^β (1 + γ√x + δx)
            </div>
            
            <div class="math">
                معادله DGLAP برای تکامل تابع چگالی:
                ∂f(x, Q²)/∂lnQ² = (αs/2π) ∫_x^1 (dz/z) P(z) f(x/z, Q²)
            </div>
            
            <div class="math">
                احتمال واپاشی بتا:
                Γ = (G_F² m_p⁵ / 2π³) |V_ud|² (1 + 3g_A²) f(Q)
            </div>
            
            <div class="event-log">
                <h3 class="control-title">گزارش رویدادها</h3>
                <div x-html="eventLog"></div>
            </div>
        </div>
        
        <footer>
            <p>شبیه‌سازی پیشرفته فیزیک ذرات | مدل‌سازی کوانتومی پروتون و نوترون</p>
            <p>بر اساس QCD و نظریه میدان کوانتومی | ساخته شده با Alpine.js و Chart.js</p>
        </footer>
    </div>

    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('quantumSimulation', () => ({
                // پارامترهای شبیه‌سازی
                energyScale: 1.0,
                couplingConstant: 0.3,
                timeStep: 0.5,
                isRunning: false,
                simulationTime: 0,
                
                // احتمالات برهمکنش
                interactionProbabilities: {
                    gluonExchange: 30,
                    quarkPair: 15,
                    betaDecay: 0.1
                },
                
                // آمار ذرات
                protonStats: {
                    valenceQuarks: 'uud',
                    gluons: 0,
                    seaQuarks: 0,
                    activeInteractions: 0
                },
                
                neutronStats: {
                    valenceQuarks: 'udd',
                    gluons: 0,
                    seaQuarks: 0,
                    activeInteractions: 0
                },
                
                // ذرات و برهمکنش‌ها
                protonParticles: [],
                neutronParticles: [],
                interactions: [],
                eventLog: '',
                
                // نمودار
                probabilityChart: null,
                
                init() {
                    this.initializeParticles();
                    this.setupChart();
                    this.updateVisualization();
                    this.startSimulation();
                },
                
                initializeParticles() {
                    // مقداردهی اولیه ذرات پروتون
                    this.protonParticles = [
                        { type: 'quark', flavor: 'u', color: 'red', x: 125, y: 125, vx: 0, vy: 0 },
                        { type: 'quark', flavor: 'u', color: 'green', x: 175, y: 125, vx: 0, vy: 0 },
                        { type: 'quark', flavor: 'd', color: 'blue', x: 150, y: 175, vx: 0, vy: 0 }
                    ];
                    
                    // مقداردهی اولیه ذرات نوترون
                    this.neutronParticles = [
                        { type: 'quark', flavor: 'u', color: 'red', x: 125, y: 125, vx: 0, vy: 0 },
                        { type: 'quark', flavor: 'd', color: 'green', x: 175, y: 125, vx: 0, vy: 0 },
                        { type: 'quark', flavor: 'd', color: 'blue', x: 150, y: 175, vx: 0, vy: 0 }
                    ];
                    
                    // تولید ذرات مجازی
                    this.generateVirtualParticles();
                },
                
                generateVirtualParticles() {
                    // تولید گلئون‌ها
                    for (let i = 0; i < 8; i++) {
                        this.protonParticles.push(this.createGluon('proton'));
                        this.neutronParticles.push(this.createGluon('neutron'));
                    }
                    
                    // تولید جفت کوارک-پادکوارک دریایی
                    for (let i = 0; i < 4; i++) {
                        const pair = this.createQuarkPair();
                        this.protonParticles.push(pair.quark, pair.antiquark);
                        
                        const pair2 = this.createQuarkPair();
                        this.neutronParticles.push(pair2.quark, pair2.antiquark);
                    }
                    
                    this.updateStats();
                },
                
                createGluon(nucleon) {
                    const centerX = 200;
                    const centerY = 200;
                    const radius = 80 + Math.random() * 40;
                    const angle = Math.random() * 2 * Math.PI;
                    
                    return {
                        type: 'gluon',
                        color: Math.random() > 0.5 ? 'orange' : 'purple',
                        x: centerX + radius * Math.cos(angle),
                        y: centerY + radius * Math.sin(angle),
                        vx: (Math.random() - 0.5) * 2,
                        vy: (Math.random() - 0.5) * 2,
                        nucleon: nucleon
                    };
                },
                
                createQuarkPair() {
                    const flavors = ['u', 'd', 's'];
                    const quarkColors = ['red', 'green', 'blue'];
                    const antiquarkColors = ['cyan', 'magenta', 'yellow'];
                    
                    const flavor = flavors[Math.floor(Math.random() * flavors.length)];
                    const colorIdx = Math.floor(Math.random() * 3);
                    
                    const centerX = 200 + (Math.random() - 0.5) * 100;
                    const centerY = 200 + (Math.random() - 0.5) * 100;
                    
                    return {
                        quark: {
                            type: 'quark',
                            flavor: flavor,
                            color: quarkColors[colorIdx],
                            x: centerX - 10,
                            y: centerY - 10,
                            vx: (Math.random() - 0.5),
                            vy: (Math.random() - 0.5)
                        },
                        antiquark: {
                            type: 'antiquark',
                            flavor: flavor,
                            color: antiquarkColors[colorIdx],
                            x: centerX + 10,
                            y: centerY + 10,
                            vx: (Math.random() - 0.5),
                            vy: (Math.random() - 0.5)
                        }
                    };
                },
                
                setupChart() {
                    const ctx = document.getElementById('probabilityChart').getContext('2d');
                    this.probabilityChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['تبادل گلئون', 'جفت کوارک', 'واپاشی بتا', 'برهمکنش قوی', 'برهمکنش ضعیف'],
                            datasets: [{
                                label: 'احتمال برهمکنش (%)',
                                data: [30, 15, 0.1, 45, 5],
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.7)',
                                    'rgba(54, 162, 235, 0.7)',
                                    'rgba(255, 206, 86, 0.7)',
                                    'rgba(75, 192, 192, 0.7)',
                                    'rgba(153, 102, 255, 0.7)'
                                ],
                                borderColor: [
                                    'rgba(255, 99, 132, 1)',
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 206, 86, 1)',
                                    'rgba(75, 192, 192, 1)',
                                    'rgba(153, 102, 255, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 50,
                                    title: {
                                        display: true,
                                        text: 'احتمال (%)'
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: false
                                },
                                title: {
                                    display: true,
                                    text: 'توزیع احتمالات برهمکنش'
                                }
                            }
                        }
                    });
                },
                
                startSimulation() {
                    this.isRunning = true;
                    this.simulationLoop();
                    this.addEvent('شبیه‌سازی شروع شد');
                },
                
                pauseSimulation() {
                    this.isRunning = false;
                    this.addEvent('شبیه‌سازی متوقف شد');
                },
                
                resetSimulation() {
                    this.pauseSimulation();
                    this.simulationTime = 0;
                    this.initializeParticles();
                    this.interactions = [];
                    this.eventLog = '';
                    this.updateVisualization();
                    this.addEvent('شبیه‌سازی بازنشانی شد');
                },
                
                singleStep() {
                    this.simulationTime += this.timeStep;
                    this.processInteractions();
                    this.updateParticles();
                    this.updateVisualization();
                    this.addEvent('یک گام شبیه‌سازی اجرا شد');
                },
                
                simulationLoop() {
                    if (!this.isRunning) return;
                    
                    this.singleStep();
                    
                    // ادامه حلقه با توجه به سرعت شبیه‌سازی
                    setTimeout(() => {
                        this.simulationLoop();
                    }, 1000 / this.animationSpeed);
                },
                
                processInteractions() {
                    this.interactions = [];
                    
                    // پردازش برهمکنش‌های پروتون
                    this.processNucleonInteractions(this.protonParticles, 'proton');
                    
                    // پردازش برهمکنش‌های نوترون
                    this.processNucleonInteractions(this.neutronParticles, 'neutron');
                    
                    // پردازش واپاشی بتا برای نوترون
                    if (Math.random() * 100 < this.interactionProbabilities.betaDecay) {
                        this.processBetaDecay();
                    }
                    
                    this.updateStats();
                },
                
                processNucleonInteractions(particles, nucleonType) {
                    for (let i = 0; i < particles.length; i++) {
                        for (let j = i + 1; j < particles.length; j++) {
                            const p1 = particles[i];
                            const p2 = particles[j];
                            
                            // محاسبه فاصله
                            const dx = p1.x - p2.x;
                            const dy = p1.y - p2.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            // بررسی برهمکنش بر اساس نوع ذرات
                            if (p1.type === 'quark' && p2.type === 'quark' && distance < 60) {
                                if (Math.random() * 100 < this.interactionProbabilities.gluonExchange) {
                                    this.interactions.push({
                                        type: 'gluon-exchange',
                                        p1: p1,
                                        p2: p2,
                                        strength: (80 - distance) / 80
                                    });
                                    this.addEvent(`تبادل گلئون بین کوارک‌ها در ${nucleonType}`);
                                }
                            }
                            
                            if ((p1.type === 'quark' && p2.type === 'antiquark') || 
                                (p1.type === 'antiquark' && p2.type === 'quark')) {
                                if (distance < 40 && Math.random() * 100 < this.interactionProbabilities.quarkPair) {
                                    this.interactions.push({
                                        type: 'annihilation',
                                        p1: p1,
                                        p2: p2,
                                        strength: 1.0
                                    });
                                    this.addEvent(`نابودی جفت کوارک-پادکوارک در ${nucleonType}`);
                                }
                            }
                            
                            if (p1.type === 'gluon' && p2.type === 'gluon' && distance < 50) {
                                if (Math.random() * 100 < 20) {
                                    this.interactions.push({
                                        type: 'gluon-fusion',
                                        p1: p1,
                                        p2: p2,
                                        strength: (70 - distance) / 70
                                    });
                                    this.addEvent(`ادغام گلئون‌ها در ${nucleonType}`);
                                }
                            }
                        }
                    }
                },
                
                processBetaDecay() {
                    // شبیه‌سازی واپاشی بتا: n → p + e⁻ + ν̄e
                    if (Math.random() * 100 < this.interactionProbabilities.betaDecay) {
                        this.addEvent('واپاشی بتا: نوترون → پروتون + الکترون + پادنوترینو');
                        
                        // ایجاد خط واپاشی در ویژوال‌سازی
                        this.interactions.push({
                            type: 'beta-decay',
                            p1: { x: 200, y: 200 },
                            p2: { x: 300, y: 100 },
                            strength: 0.8
                        });
                    }
                },
                
                updateParticles() {
                    // به‌روزرسانی موقعیت ذرات
                    [...this.protonParticles, ...this.neutronParticles].forEach(particle => {
                        // حرکت براونی
                        particle.vx += (Math.random() - 0.5) * 0.5;
                        particle.vy += (Math.random() - 0.5) * 0.5;
                        
                        // محدود کردن سرعت
                        const speed = Math.sqrt(particle.vx * particle.vx + particle.vy * particle.vy);
                        if (speed > 3) {
                            particle.vx = (particle.vx / speed) * 3;
                            particle.vy = (particle.vy / speed) * 3;
                        }
                        
                        // به‌روزرسانی موقعیت
                        particle.x += particle.vx;
                        particle.y += particle.vy;
                        
                        // برخورد با مرز نوکلئون
                        const centerX = 200, centerY = 200;
                        const dx = particle.x - centerX;
                        const dy = particle.y - centerY;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance > 120) {
                            // برگرداندن ذره به داخل
                            const angle = Math.atan2(dy, dx);
                            particle.x = centerX + 115 * Math.cos(angle);
                            particle.y = centerY + 115 * Math.sin(angle);
                            
                            // تغییر جهت حرکت
                            particle.vx = -particle.vx * 0.8;
                            particle.vy = -particle.vy * 0.8;
                        }
                    });
                },
                
                updateVisualization() {
                    this.renderNucleon('proton', this.protonParticles);
                    this.renderNucleon('neutron', this.neutronParticles);
                },
                
                renderNucleon(nucleonType, particles) {
                    const container = document.getElementById(`${nucleonType}Viz`);
                    
                    // پاک‌سازی ویژوال‌سازی قبلی
                    container.querySelectorAll('.particle, .interaction-line, .decay-line').forEach(el => {
                        if (!el.classList.contains('nucleon-boundary')) el.remove();
                    });
                    
                    // رندر ذرات
                    particles.forEach(particle => {
                        const el = document.createElement('div');
                        el.className = `particle ${particle.type} ${particle.color}`;
                        el.style.left = `${particle.x}px`;
                        el.style.top = `${particle.y}px`;
                        
                        if (particle.type === 'quark' || particle.type === 'antiquark') {
                            el.textContent = particle.type === 'antiquark' ? `${particle.flavor}̄` : particle.flavor;
                        }
                        
                        container.appendChild(el);
                    });
                    
                    // رندر برهمکنش‌ها
                    this.interactions.forEach(interaction => {
                        if (interaction.type === 'beta-decay' && nucleonType === 'neutron') {
                            const line = document.createElement('div');
                            line.className = 'decay-line';
                            
                            const dx = interaction.p2.x - interaction.p1.x;
                            const dy = interaction.p2.y - interaction.p1.y;
                            const length = Math.sqrt(dx * dx + dy * dy);
                            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                            
                            line.style.width = `${length}px`;
                            line.style.left = `${interaction.p1.x}px`;
                            line.style.top = `${interaction.p1.y}px`;
                            line.style.transform = `rotate(${angle}deg)`;
                            line.style.opacity = interaction.strength;
                            
                            container.appendChild(line);
                        } else {
                            const line = document.createElement('div');
                            line.className = 'interaction-line';
                            
                            const dx = interaction.p2.x - interaction.p1.x;
                            const dy = interaction.p2.y - interaction.p1.y;
                            const length = Math.sqrt(dx * dx + dy * dy);
                            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                            
                            line.style.width = `${length}px`;
                            line.style.left = `${interaction.p1.x}px`;
                            line.style.top = `${interaction.p1.y}px`;
                            line.style.transform = `rotate(${angle}deg)`;
                            line.style.opacity = interaction.strength;
                            
                            container.appendChild(line);
                        }
                    });
                },
                
                updateStats() {
                    this.protonStats.gluons = this.protonParticles.filter(p => p.type === 'gluon').length;
                    this.protonStats.seaQuarks = this.protonParticles.filter(p => 
                        p.type === 'quark' && !['u', 'd'].includes(p.flavor)).length;
                    this.protonStats.activeInteractions = this.interactions.filter(i => 
                        i.type !== 'beta-decay').length;
                    
                    this.neutronStats.gluons = this.neutronParticles.filter(p => p.type === 'gluon').length;
                    this.neutronStats.seaQuarks = this.neutronParticles.filter(p => 
                        p.type === 'quark' && !['u', 'd'].includes(p.flavor)).length;
                    this.neutronStats.activeInteractions = this.interactions.filter(i => 
                        i.type === 'beta-decay').length;
                },
                
                addEvent(message) {
                    const timestamp = this.simulationTime.toFixed(2);
                    this.eventLog = `<div class="log-entry"><span class="log-time">t=${timestamp} fm/c:</span> ${message}</div>` + this.eventLog;
                    
                    // محدود کردن طول گزارش
                    if (this.eventLog.split('<div class="log-entry">').length > 20) {
                        const events = this.eventLog.split('<div class="log-entry">');
                        this.eventLog = events.slice(0, 20).join('<div class="log-entry">');
                    }
                },
                
                updateSimulation() {
                    // به‌روزرسانی نمودار احتمالات
                    this.probabilityChart.data.datasets[0].data = [
                        this.interactionProbabilities.gluonExchange,
                        this.interactionProbabilities.quarkPair,
                        this.interactionProbabilities.betaDecay,
                        45, // برهمکنش قوی ثابت
                        5   // برهمکنش ضعیف ثابت
                    ];
                    this.probabilityChart.update();
                },
                
                exportData() {
                    const data = {
                        simulationTime: this.simulationTime,
                        parameters: {
                            energyScale: this.energyScale,
                            couplingConstant: this.couplingConstant,
                            timeStep: this.timeStep
                        },
                        probabilities: this.interactionProbabilities,
                        protonStats: this.protonStats,
                        neutronStats: this.neutronStats
                    };
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], {type: 'application/json'});
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `quantum_simulation_${Date.now()}.json`;
                    link.click();
                    
                    this.addEvent('داده‌های شبیه‌سازی ذخیره شد');
                }
            }));
        });
    </script>
</body>
</html>