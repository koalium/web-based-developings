<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Three.js Ultra Detailed Steam Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Courier New', monospace;
            background: #0a0a14;
            color: #e0e0e0;
            overflow: hidden;
            height: 100vh;
        }
        
        #container {
            position: relative;
            width: 100%;
            height: 100vh;
        }
        
        #canvas-container {
            width: 100%;
            height: 100%;
        }
        
        #ui-overlay {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(10, 10, 20, 0.95);
            border-radius: 10px;
            padding: 20px;
            width: 400px;
            border: 1px solid rgba(100, 150, 200, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }
        
        .ui-section {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(100, 150, 200, 0.2);
        }
        
        .ui-section h3 {
            color: #4fc3f7;
            margin-bottom: 12px;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .control-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .control-label {
            font-size: 0.9rem;
            color: #b0b0c0;
            width: 150px;
        }
        
        .slider {
            width: 200px;
            height: 6px;
            -webkit-appearance: none;
            background: linear-gradient(to right, #1a237e, #283593, #3949ab);
            border-radius: 3px;
            outline: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4fc3f7;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 0 10px rgba(79, 195, 247, 0.8);
        }
        
        button {
            background: linear-gradient(135deg, #1a237e 0%, #283593 100%);
            color: white;
            border: 1px solid #3949ab;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            background: linear-gradient(135deg, #283593 0%, #3949ab 100%);
            border-color: #4fc3f7;
            box-shadow: 0 0 15px rgba(79, 195, 247, 0.3);
        }
        
        #component-browser {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 350px;
            background: rgba(10, 10, 20, 0.95);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid rgba(100, 150, 200, 0.3);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .component-category {
            margin-bottom: 20px;
        }
        
        .category-header {
            color: #81c784;
            font-weight: bold;
            margin-bottom: 10px;
            cursor: pointer;
            padding: 8px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }
        
        .component-list {
            display: none;
            padding-left: 15px;
        }
        
        .component-item {
            padding: 6px 10px;
            margin: 3px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85rem;
            border-left: 3px solid transparent;
            transition: all 0.2s ease;
        }
        
        .component-item:hover {
            background: rgba(79, 195, 247, 0.1);
            border-left-color: #4fc3f7;
        }
        
        .component-item.selected {
            background: rgba(79, 195, 247, 0.2);
            border-left-color: #4fc3f7;
            color: #4fc3f7;
        }
        
        #engine-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(10, 10, 20, 0.95);
            padding: 15px;
            border-radius: 10px;
            width: 300px;
            border: 1px solid rgba(100, 150, 200, 0.3);
            font-size: 0.85rem;
        }
        
        .info-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .info-label {
            color: #b0b0c0;
        }
        
        .info-value {
            color: #81c784;
            font-weight: bold;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #4fc3f7;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .stats {
            position: absolute;
            bottom: 20px;
            right: 20px;
            color: #888;
            font-size: 0.8rem;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="canvas-container"></div>
        
        <div id="ui-overlay">
            <div class="ui-section">
                <h3>Engine Control System</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                    <button id="ignition">‚ö° Ignition</button>
                    <button id="start-engine">‚ñ∂ Start Engine</button>
                    <button id="stop-engine">‚èπ Stop Engine</button>
                    <button id="reverse">‚Üª Reverse</button>
                    <button id="emergency-stop">üõë Emergency Stop</button>
                </div>
            </div>
            
            <div class="ui-section">
                <h3>Steam System Parameters</h3>
                <div class="control-row">
                    <span class="control-label">Boiler Pressure:</span>
                    <input type="range" class="slider" id="boiler-pressure" min="0" max="200" value="100">
                </div>
                <div class="control-row">
                    <span class="control-label">Steam Temperature:</span>
                    <input type="range" class="slider" id="steam-temp" min="100" max="400" value="200">
                </div>
                <div class="control-row">
                    <span class="control-label">Throttle Position:</span>
                    <input type="range" class="slider" id="throttle" min="0" max="100" value="50">
                </div>
                <div class="control-row">
                    <span class="control-label">Cut-off Point:</span>
                    <input type="range" class="slider" id="cutoff" min="10" max="90" value="60">
                </div>
            </div>
            
            <div class="ui-section">
                <h3>Mechanical Control</h3>
                <div class="control-row">
                    <span class="control-label">Governor Sensitivity:</span>
                    <input type="range" class="slider" id="governor" min="1" max="10" value="5">
                </div>
                <div class="control-row">
                    <span class="control-label">Lubrication Rate:</span>
                    <input type="range" class="slider" id="lubrication" min="0" max="100" value="30">
                </div>
                <div class="control-row">
                    <span class="control-label">Valve Timing:</span>
                    <input type="range" class="slider" id="valve-timing" min="-20" max="20" value="0">
                </div>
            </div>
            
            <div class="ui-section">
                <h3>Visualization Mode</h3>
                <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                    <button id="xray">ü©ª X-Ray View</button>
                    <button id="thermal">üî• Thermal View</button>
                    <button id="stress">‚öô Stress Analysis</button>
                    <button id="flow">üåä Steam Flow</button>
                    <button id="measure">üìê Measurements</button>
                </div>
            </div>
        </div>
        
        <div id="component-browser">
            <h3 style="color: #4fc3f7; margin-bottom: 20px; text-align: center;">COMPONENT BROWSER</h3>
            
            <div class="component-category">
                <div class="category-header">üéØ CYLINDER ASSEMBLY</div>
                <div class="component-list">
                    <div class="component-item" data-component="cylinder-liner">Cylinder Liner</div>
                    <div class="component-item" data-component="cylinder-jacket">Steam Jacket</div>
                    <div class="component-item" data-component="drain-cocks">Drain Cocks</div>
                    <div class="component-item" data-component="cylinder-head">Cylinder Head</div>
                    <div class="component-item" data-component="head-gasket">Head Gasket</div>
                    <div class="component-item" data-component="stud-bolts">Stud Bolts</div>
                    <div class="component-item" data-component="stuffing-box">Stuffing Box</div>
                    <div class="component-item" data-component="gland">Gland Assembly</div>
                </div>
            </div>
            
            <div class="component-category">
                <div class="category-header">üî© PISTON ASSEMBLY</div>
                <div class="component-list">
                    <div class="component-item" data-component="piston-body">Piston Body</div>
                    <div class="component-item" data-component="piston-rings">Piston Rings (3)</div>
                    <div class="component-item" data-component="ring-expanders">Ring Expanders</div>
                    <div class="component-item" data-component="piston-rod">Piston Rod</div>
                    <div class="component-item" data-component="rod-packing">Rod Packing</div>
                    <div class="component-item" data-component="crosshead">Crosshead</div>
                    <div class="component-item" data-component="crosshead-pin">Crosshead Pin</div>
                    <div class="component-item" data-component="crosshead-bush">Crosshead Bush</div>
                    <div class="component-item" data-component="wrist-pin">Wrist Pin</div>
                    <div class="component-item" data-component="cutter-key">Cutter Key</div>
                </div>
            </div>
            
            <div class="component-category">
                <div class="category-header">‚öô VALVE GEAR</div>
                <div class="component-list">
                    <div class="component-item" data-component="slide-valve">Slide Valve</div>
                    <div class="component-item" data-component="valve-seat">Valve Seat</div>
                    <div class="component-item" data-component="valve-rod">Valve Rod</div>
                    <div class="component-item" data-component="eccentric">Eccentric Sheave</div>
                    <div class="component-item" data-component="eccentric-strap">Eccentric Strap</div>
                    <div class="component-item" data-component="eccentric-rod">Eccentric Rod</div>
                    <div class="component-item" data-component="expansion-link">Expansion Link</div>
                    <div class="component-item" data-component="reversing-lever">Reversing Lever</div>
                    <div class="component-item" data-component="valve-spool">Valve Spool</div>
                    <div class="component-item" data-component="port-plate">Port Plate</div>
                </div>
            </div>
            
            <div class="component-category">
                <div class="category-header">üîß FASTENERS & BEARINGS</div>
                <div class="component-list">
                    <div class="component-item" data-component="main-bearings">Main Bearings</div>
                    <div class="component-item" data-component="big-end-bearing">Big End Bearing</div>
                    <div class="component-item" data-component="little-end-bearing">Little End Bearing</div>
                    <div class="component-item" data-component="babbitt-lining">Babbitt Lining</div>
                    <div class="component-item" data-component="shims">Shim Packs</div>
                    <div class="component-item" data-component="tie-rods">Tie Rods</div>
                    <div class="component-item" data-component="stay-bolts">Stay Bolts</div>
                    <div class="component-item" data-component="cotter-pins">Cotter Pins</div>
                    <div class="component-item" data-component="castle-nuts">Castle Nuts</div>
                    <div class="component-item" data-component="lock-washers">Lock Washers</div>
                </div>
            </div>
            
            <div class="component-category">
                <div class="category-header">üîÑ GOVERNOR SYSTEM</div>
                <div class="component-list">
                    <div class="component-item" data-component="centrifugal-governor">Centrifugal Governor</div>
                    <div class="component-item" data-component="governor-balls">Governor Balls</div>
                    <div class="component-item" data-component="governor-arms">Governor Arms</div>
                    <div class="component-item" data-component="governor-sleeve">Governor Sleeve</div>
                    <div class="component-item" data-component="throttle-valve">Throttle Valve</div>
                    <div class="component-item" data-component="regulator-spring">Regulator Spring</div>
                    <div class="component-item" data-component="speed-adjuster">Speed Adjuster</div>
                </div>
            </div>
            
            <div class="component-category">
                <div class="category-header">üõ° SAFETY SYSTEMS</div>
                <div class="component-list">
                    <div class="component-item" data-component="safety-valve">Safety Valve</div>
                    <div class="component-item" data-component="fusible-plug">Fusible Plug</div>
                    <div class="component-item" data-component="pressure-gauge">Pressure Gauge</div>
                    <div class="component-item" data-component="water-gauge">Water Gauge</div>
                    <div class="component-item" data-component="whistle">Steam Whistle</div>
                    <div class="component-item" data-component="blowdown-valve">Blowdown Valve</div>
                    <div class="component-item" data-component="check-valve">Check Valve</div>
                </div>
            </div>
        </div>
        
        <div id="engine-info">
            <div class="info-line">
                <span class="info-label">Engine Status:</span>
                <span class="info-value" id="status">OFF</span>
            </div>
            <div class="info-line">
                <span class="info-label">RPM:</span>
                <span class="info-value" id="rpm">0</span>
            </div>
            <div class="info-line">
                <span class="info-label">Power Output:</span>
                <span class="info-value" id="power">0 HP</span>
            </div>
            <div class="info-line">
                <span class="info-label">Steam Flow:</span>
                <span class="info-value" id="steam-flow">0 kg/h</span>
            </div>
            <div class="info-line">
                <span class="info-label">Temperature:</span>
                <span class="info-value" id="temperature">20¬∞C</span>
            </div>
            <div class="info-line">
                <span class="info-label">Pressure:</span>
                <span class="info-value" id="pressure">0 PSI</span>
            </div>
        </div>
        
        <div id="loading">
            <div style="margin-bottom: 20px;">‚öô Building Detailed Steam Engine Model...</div>
            <div style="font-size: 0.9rem; color: #888;">Initializing 200+ components</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script>
        // ULTRA DETAILED STEAM ENGINE MODEL
        // This model includes every mechanical component with extreme detail
        
        // Global variables
        let scene, camera, renderer, controls;
        let steamEngine = new THREE.Group();
        let clock = new THREE.Clock();
        let engineRunning = false;
        let engineSpeed = 0;
        let direction = 1;
        let boilerPressure = 100;
        let steamTemperature = 200;
        
        // Component storage
        let components = {};
        let selectedComponent = null;
        
        // Material library
        const materials = {
            castIron: new THREE.MeshStandardMaterial({ color: 0x444444, metalness: 0.3, roughness: 0.7 }),
            steel: new THREE.MeshStandardMaterial({ color: 0x888888, metalness: 0.8, roughness: 0.3 }),
            brass: new THREE.MeshStandardMaterial({ color: 0xbb9955, metalness: 0.9, roughness: 0.2 }),
            copper: new THREE.MeshStandardMaterial({ color: 0xb87333, metalness: 0.9, roughness: 0.1 }),
            bronze: new THREE.MeshStandardMaterial({ color: 0xcd7f32, metalness: 0.8, roughness: 0.4 }),
            rubber: new THREE.MeshStandardMaterial({ color: 0x333333, metalness: 0, roughness: 1 }),
            glass: new THREE.MeshPhysicalMaterial({ color: 0x88ccff, metalness: 0, roughness: 0, transmission: 0.9, transparent: true }),
            babbitt: new THREE.MeshStandardMaterial({ color: 0xc0c0c0, metalness: 0.5, roughness: 0.6 }),
            gasket: new THREE.MeshStandardMaterial({ color: 0x2a2a2a, metalness: 0, roughness: 0.9 })
        };
        
        // Initialize the scene
        function init() {
            // Create scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x050510);
            
            // Create camera
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(40, 30, 40);
            
            // Create renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            // Add orbit controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 10;
            controls.maxDistance = 150;
            controls.maxPolarAngle = Math.PI / 2 - 0.1;
            
            // Add lighting
            setupLighting();
            
            // Initialize components storage
            initializeComponents();
            
            // Build the ultra-detailed steam engine
            buildUltraDetailedEngine();
            
            // Setup UI interactions
            setupUI();
            
            // Hide loading text
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 1000);
            
            // Start animation
            animate();
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
        }
        
        // Setup lighting system
        function setupLighting() {
            // Main directional light (sun)
            const mainLight = new THREE.DirectionalLight(0xffffff, 1);
            mainLight.position.set(50, 100, 50);
            mainLight.castShadow = true;
            mainLight.shadow.mapSize.width = 4096;
            mainLight.shadow.mapSize.height = 4096;
            mainLight.shadow.camera.left = -100;
            mainLight.shadow.camera.right = 100;
            mainLight.shadow.camera.top = 100;
            mainLight.shadow.camera.bottom = -100;
            scene.add(mainLight);
            
            // Fill light
            const fillLight = new THREE.DirectionalLight(0x88aaff, 0.3);
            fillLight.position.set(-50, 30, -50);
            scene.add(fillLight);
            
            // Ambient light
            const ambientLight = new THREE.AmbientLight(0x404060, 0.4);
            scene.add(ambientLight);
            
            // Rim light for highlights
            const rimLight = new THREE.DirectionalLight(0x4488ff, 0.5);
            rimLight.position.set(0, 10, -50);
            scene.add(rimLight);
            
            // Engine glow light
            const glowLight = new THREE.PointLight(0xff8844, 0.3, 50);
            glowLight.position.set(0, 15, 0);
            scene.add(glowLight);
        }
        
        // Initialize components storage
        function initializeComponents() {
            const categories = [
                'cylinder', 'piston', 'valveGear', 'crankshaft', 'flywheel', 'governor',
                'bearings', 'fasteners', 'pipes', 'gauges', 'safety', 'frame', 'seals', 'bushings'
            ];
            
            categories.forEach(cat => {
                components[cat] = new THREE.Group();
                components[cat].name = cat;
            });
        }
        
        // Build ultra detailed steam engine
        function buildUltraDetailedEngine() {
            steamEngine.name = "UltraDetailedSteamEngine";
            
            // Build foundation and frame
            buildFoundation();
            
            // Build cylinder assembly with extreme detail
            buildDetailedCylinderAssembly();
            
            // Build piston assembly with all components
            buildDetailedPistonAssembly();
            
            // Build crankshaft with bearings
            buildDetailedCrankshaft();
            
            // Build valve gear with timing mechanism
            buildDetailedValveGear();
            
            // Build governor system
            buildGovernorSystem();
            
            // Build piping system
            buildPipingSystem();
            
            // Build safety systems
            buildSafetySystems();
            
            // Build gauges and indicators
            buildInstrumentation();
            
            // Build all fasteners
            buildFasteners();
            
            // Build seals and packings
            buildSealsAndPackings();
            
            // Build bushings and wear parts
            buildBushingsAndWearParts();
            
            // Add all component groups to main engine
            for (let component in components) {
                steamEngine.add(components[component]);
            }
            
            scene.add(steamEngine);
            
            // Initialize component browser
            initComponentBrowser();
        }
        
        // Build foundation with extreme detail
        function buildFoundation() {
            const foundationGroup = components.frame;
            
            // Main foundation bed
            const foundation = new THREE.Mesh(
                new THREE.BoxGeometry(60, 8, 30),
                materials.castIron
            );
            foundation.position.set(0, -4, 0);
            foundation.castShadow = true;
            foundation.receiveShadow = true;
            foundationGroup.add(foundation);
            
            // Foundation mounting pads with shims
            for (let x = -25; x <= 25; x += 25) {
                for (let z = -10; z <= 10; z += 20) {
                    const pad = new THREE.Mesh(
                        new THREE.CylinderGeometry(3, 4, 2, 16),
                        materials.steel
                    );
                    pad.position.set(x, 3, z);
                    foundationGroup.add(pad);
                    
                    // Shim pack under pad
                    const shim = new THREE.Mesh(
                        new THREE.CylinderGeometry(4, 4, 0.2, 16),
                        materials.steel
                    );
                    shim.position.set(x, 2.1, z);
                    shim.material.color.setHex(0x666666);
                    foundationGroup.add(shim);
                }
            }
            
            // Tie rods (stretch bolts)
            const tieRodGeometry = new THREE.CylinderGeometry(0.8, 0.8, 50, 16);
            for (let z = -12; z <= 12; z += 24) {
                const tieRod = new THREE.Mesh(tieRodGeometry, materials.steel);
                tieRod.rotation.z = Math.PI / 2;
                tieRod.position.set(0, 10, z);
                tieRod.castShadow = true;
                foundationGroup.add(tieRod);
                
                // Tie rod nuts
                const nutGeometry = new THREE.CylinderGeometry(1.5, 1.5, 1, 6);
                for (let x of [-25, 25]) {
                    const nut = new THREE.Mesh(nutGeometry, materials.steel);
                    nut.position.set(x, 10, z);
                    nut.rotation.z = Math.PI / 2;
                    foundationGroup.add(nut);
                    
                    // Lock washer
                    const washer = new THREE.Mesh(
                        new THREE.CylinderGeometry(2, 2, 0.3, 32),
                        materials.steel
                    );
                    washer.position.set(x, 10, z);
                    foundationGroup.add(washer);
                }
            }
        }
        
        // Build detailed cylinder assembly
        function buildDetailedCylinderAssembly() {
            const cylinderGroup = components.cylinder;
            
            // Cylinder liner (removable)
            const liner = new THREE.Mesh(
                new THREE.CylinderGeometry(6, 6, 28, 64),
                materials.steel
            );
            liner.rotation.z = Math.PI / 2;
            liner.position.set(20, 12, 0);
            cylinderGroup.add(liner);
            
            // Steam jacket around cylinder
            const jacket = new THREE.Mesh(
                new THREE.CylinderGeometry(8, 8, 26, 64),
                materials.castIron
            );
            jacket.rotation.z = Math.PI / 2;
            jacket.position.set(20, 12, 0);
            cylinderGroup.add(jacket);
            
            // Cylinder head with cooling fins
            const head = new THREE.Mesh(
                new THREE.CylinderGeometry(8.5, 8.5, 3, 64),
                materials.castIron
            );
            head.rotation.z = Math.PI / 2;
            head.position.set(33, 12, 0);
            
            // Add cooling fins to head
            for (let i = 0; i < 8; i++) {
                const fin = new THREE.Mesh(
                    new THREE.CylinderGeometry(9, 9, 0.2, 64),
                    materials.castIron
                );
                fin.rotation.z = Math.PI / 2;
                fin.position.set(33 + (i * 0.3), 12, 0);
                head.add(fin);
            }
            cylinderGroup.add(head);
            
            // Head gasket
            const gasket = new THREE.Mesh(
                new THREE.CylinderGeometry(8.2, 8.2, 0.3, 64),
                materials.gasket
            );
            gasket.rotation.z = Math.PI / 2;
            gasket.position.set(31.5, 12, 0);
            cylinderGroup.add(gasket);
            
            // Stud bolts for cylinder head
            const studGeometry = new THREE.CylinderGeometry(0.4, 0.4, 8, 16);
            for (let i = 0; i < 12; i++) {
                const angle = (i * Math.PI) / 6;
                const radius = 7.5;
                
                const stud = new THREE.Mesh(studGeometry, materials.steel);
                stud.position.set(
                    20 + Math.cos(angle) * radius,
                    12 + Math.sin(angle) * radius,
                    0
                );
                cylinderGroup.add(stud);
                
                // Hex nuts
                const nut = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.8, 0.8, 0.6, 6),
                    materials.steel
                );
                nut.position.set(
                    20 + Math.cos(angle) * radius,
                    12 + Math.sin(angle) * radius,
                    4
                );
                cylinderGroup.add(nut);
                
                // Lock washer
                const washer = new THREE.Mesh(
                    new THREE.CylinderGeometry(1, 1, 0.2, 32),
                    materials.steel
                );
                washer.position.set(
                    20 + Math.cos(angle) * radius,
                    12 + Math.sin(angle) * radius,
                    3.7
                );
                cylinderGroup.add(washer);
            }
            
            // Stuffing box for piston rod
            const stuffingBox = new THREE.Mesh(
                new THREE.CylinderGeometry(4, 4, 4, 32),
                materials.bronze
            );
            stuffingBox.position.set(7, 12, 0);
            cylinderGroup.add(stuffingBox);
            
            // Gland for stuffing box
            const gland = new THREE.Mesh(
                new THREE.CylinderGeometry(3.5, 3.5, 1.5, 32),
                materials.bronze
            );
            gland.position.set(5, 12, 0);
            cylinderGroup.add(gland);
            
            // Gland studs
            for (let i = 0; i < 4; i++) {
                const angle = (i * Math.PI) / 2;
                const glandStud = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.3, 0.3, 3, 16),
                    materials.steel
                );
                glandStud.position.set(
                    6 + Math.cos(angle) * 2.5,
                    12 + Math.sin(angle) * 2.5,
                    0
                );
                cylinderGroup.add(glandStud);
            }
            
            // Drain cocks
            const drainCock = createDrainCock();
            drainCock.position.set(20, 6, 5);
            cylinderGroup.add(drainCock);
            
            // Steam ports
            createSteamPorts(cylinderGroup);
        }
        
        // Create drain cock component
        function createDrainCock() {
            const group = new THREE.Group();
            
            // Cock body
            const body = new THREE.Mesh(
                new THREE.CylinderGeometry(1.5, 1.5, 3, 16),
                materials.brass
            );
            body.rotation.z = Math.PI / 2;
            group.add(body);
            
            // Valve stem
            const stem = new THREE.Mesh(
                new THREE.CylinderGeometry(0.4, 0.4, 2, 16),
                materials.brass
            );
            stem.position.x = -1;
            group.add(stem);
            
            // Handle
            const handle = new THREE.Mesh(
                new THREE.BoxGeometry(0.3, 2, 0.3),
                materials.steel
            );
            handle.position.set(-2, 0, 0);
            group.add(handle);
            
            // Outlet pipe
            const outlet = new THREE.Mesh(
                new THREE.CylinderGeometry(0.5, 0.5, 4, 16),
                materials.copper
            );
            outlet.rotation.z = -Math.PI / 2;
            outlet.position.set(0, 0, 2);
            group.add(outlet);
            
            return group;
        }
        
        // Create steam ports in cylinder
        function createSteamPorts(cylinderGroup) {
            // Admission ports
            for (let y of [8, 16]) {
                const port = new THREE.Mesh(
                    new THREE.BoxGeometry(2, 1, 4),
                    materials.steel
                );
                port.position.set(20, y, 3);
                cylinderGroup.add(port);
            }
            
            // Exhaust ports
            for (let y of [8, 16]) {
                const exhaustPort = new THREE.Mesh(
                    new THREE.BoxGeometry(2, 1, 4),
                    materials.steel
                );
                exhaustPort.position.set(20, y, -3);
                cylinderGroup.add(exhaustPort);
            }
        }
        
        // Build detailed piston assembly
        function buildDetailedPistonAssembly() {
            const pistonGroup = components.piston;
            
            // Piston body
            const piston = new THREE.Mesh(
                new THREE.CylinderGeometry(5.9, 5.9, 6, 64),
                materials.steel
            );
            piston.rotation.z = Math.PI / 2;
            piston.position.set(12, 12, 0);
            piston.castShadow = true;
            pistonGroup.add(piston);
            
            // Piston rings (3 compression rings)
            for (let i = 0; i < 3; i++) {
                const ring = new THREE.Mesh(
                    new THREE.TorusGeometry(5.95, 0.3, 16, 64),
                    materials.steel
                );
                ring.rotation.z = Math.PI / 2;
                ring.position.set(12 + (i * 1.5) - 2.25, 12, 0);
                pistonGroup.add(ring);
                
                // Ring gap
                const gap = new THREE.Mesh(
                    new THREE.BoxGeometry(0.5, 0.6, 0.3),
                    materials.steel
                );
                gap.position.set(12 + (i * 1.5) - 2.25, 12, 5.95);
                pistonGroup.add(gap);
            }
            
            // Oil control ring
            const oilRing = new THREE.Mesh(
                new THREE.TorusGeometry(5.95, 0.4, 16, 64),
                materials.steel
            );
            oilRing.rotation.z = Math.PI / 2;
            oilRing.position.set(15.5, 12, 0);
            oilRing.material.color.setHex(0x555555);
            pistonGroup.add(oilRing);
            
            // Piston rod
            const pistonRod = new THREE.Mesh(
                new THREE.CylinderGeometry(1.8, 1.8, 25, 32),
                materials.steel
            );
            pistonRod.position.set(-1, 12, 0);
            pistonRod.castShadow = true;
            pistonGroup.add(pistonRod);
            
            // Crosshead assembly
            buildCrossheadAssembly(pistonGroup);
            
            // Wrist pin (gudgeon pin)
            const wristPin = new THREE.Mesh(
                new THREE.CylinderGeometry(1.2, 1.2, 8, 32),
                materials.steel
            );
            wristPin.rotation.z = Math.PI / 2;
            wristPin.position.set(12, 12, 0);
            pistonGroup.add(wristPin);
            
            // Circlips for wrist pin retention
            for (let z of [-3.5, 3.5]) {
                const circlip = new THREE.Mesh(
                    new THREE.TorusGeometry(1.3, 0.1, 8, 32),
                    materials.steel
                );
                circlip.rotation.z = Math.PI / 2;
                circlip.position.set(12, 12, z);
                pistonGroup.add(circlip);
            }
        }
        
        // Build crosshead assembly
        function buildCrossheadAssembly(pistonGroup) {
            // Crosshead body
            const crosshead = new THREE.Mesh(
                new THREE.BoxGeometry(6, 8, 4),
                materials.steel
            );
            crosshead.position.set(-8, 12, 0);
            crosshead.castShadow = true;
            pistonGroup.add(crosshead);
            
            // Crosshead pin (wrist pin)
            const crossheadPin = new THREE.Mesh(
                new THREE.CylinderGeometry(1, 1, 6, 32),
                materials.steel
            );
            crossheadPin.rotation.z = Math.PI / 2;
            crossheadPin.position.set(-8, 12, 0);
            pistonGroup.add(crossheadPin);
            
            // Crosshead bush (bearing)
            const bush = new THREE.Mesh(
                new THREE.CylinderGeometry(1.1, 1.1, 6.2, 32),
                materials.babbitt
            );
            bush.rotation.z = Math.PI / 2;
            bush.position.set(-8, 12, 0);
            pistonGroup.add(bush);
            
            // Crosshead slippers (guides)
            for (let z of [-3, 3]) {
                const slipper = new THREE.Mesh(
                    new THREE.BoxGeometry(8, 1, 3),
                    materials.bronze
                );
                slipper.position.set(-8, 8, z);
                slipper.material.color.setHex(0x8B4513);
                pistonGroup.add(slipper);
                
                // Wear plates on slippers
                const wearPlate = new THREE.Mesh(
                    new THREE.BoxGeometry(8, 0.2, 2.8),
                    materials.steel
                );
                wearPlate.position.set(-8, 8.1, z);
                wearPlate.material.color.setHex(0x666666);
                pistonGroup.add(wearPlate);
            }
            
            // Lubrication holes in crosshead
            const lubeHole = new THREE.Mesh(
                new THREE.CylinderGeometry(0.2, 0.2, 2, 16),
                materials.steel
            );
            lubeHole.rotation.y = Math.PI / 2;
            lubeHole.position.set(-8, 12, 1.5);
            pistonGroup.add(lubeHole);
        }
        
        // Build detailed crankshaft
        function buildDetailedCrankshaft() {
            const crankshaftGroup = components.crankshaft;
            
            // Main journals
            for (let x of [-15, 0, 15]) {
                const journal = new THREE.Mesh(
                    new THREE.CylinderGeometry(2.5, 2.5, 10, 64),
                    materials.steel
                );
                journal.position.set(x, 2, 0);
                journal.castShadow = true;
                crankshaftGroup.add(journal);
                
                // Main bearing shells
                const bearing = new THREE.Mesh(
                    new THREE.CylinderGeometry(2.6, 2.6, 10.2, 64, 1, true, 0, Math.PI),
                    materials.babbitt
                );
                bearing.position.set(x, 4, 0);
                crankshaftGroup.add(bearing);
            }
            
            // Crank webs
            const webGeometry = new THREE.BoxGeometry(8, 4, 10);
            for (let x of [-7.5, 7.5]) {
                const web = new THREE.Mesh(webGeometry, materials.steel);
                web.position.set(x, 5, 0);
                crankshaftGroup.add(web);
                
                // Lightening holes in webs
                const hole = new THREE.Mesh(
                    new THREE.CylinderGeometry(2, 2, 4.2, 32),
                    materials.steel
                );
                hole.position.set(x, 5, 0);
                hole.material.color.setHex(0x222222);
                crankshaftGroup.add(hole);
            }
            
            // Crank pin
            const crankPin = new THREE.Mesh(
                new THREE.CylinderGeometry(2, 2, 8, 64),
                materials.steel
            );
            crankPin.position.set(0, 10, 0);
            crankshaftGroup.add(crankPin);
            
            // Big end bearing
            const bigEndBearing = new THREE.Mesh(
                new THREE.CylinderGeometry(2.1, 2.1, 8.2, 64, 1, true, 0, Math.PI),
                materials.babbitt
            );
            bigEndBearing.position.set(0, 10, 0);
            crankshaftGroup.add(bigEndBearing);
            
            // Balance weights
            const balanceWeight = new THREE.Mesh(
                new THREE.BoxGeometry(6, 8, 3),
                materials.steel
            );
            balanceWeight.position.set(0, 1, 5);
            crankshaftGroup.add(balanceWeight);
            
            // Keyway for flywheel
            const keyway = new THREE.Mesh(
                new THREE.BoxGeometry(1, 0.5, 12),
                materials.steel
            );
            keyway.position.set(-20, 2, 2.6);
            crankshaftGroup.add(keyway);
            
            // Oil passages
            createOilPassages(crankshaftGroup);
        }
        
        // Create oil passages in crankshaft
        function createOilPassages(crankshaftGroup) {
            const oilPassage = new THREE.Mesh(
                new THREE.CylinderGeometry(0.3, 0.3, 40, 16),
                materials.steel
            );
            oilPassage.rotation.z = Math.PI / 2;
            oilPassage.position.set(0, 2, 0);
            oilPassage.material.color.setHex(0x111111);
            crankshaftGroup.add(oilPassage);
            
            // Radial oil holes to crank pin
            for (let angle = 0; angle < Math.PI * 2; angle += Math.PI / 2) {
                const radialHole = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.2, 0.2, 4, 16),
                    materials.steel
                );
                radialHole.rotation.z = angle;
                radialHole.position.set(0, 10, 0);
                radialHole.material.color.setHex(0x111111);
                crankshaftGroup.add(radialHole);
            }
        }
        
        // Build detailed valve gear
        function buildDetailedValveGear() {
            const valveGroup = components.valveGear;
            
            // Slide valve
            const slideValve = new THREE.Mesh(
                new THREE.BoxGeometry(8, 3, 6),
                materials.bronze
            );
            slideValve.position.set(20, 12, 8);
            valveGroup.add(slideValve);
            
            // Valve seat (port face)
            const valveSeat = new THREE.Mesh(
                new THREE.BoxGeometry(10, 0.5, 8),
                materials.steel
            );
            valveSeat.position.set(20, 9, 8);
            valveGroup.add(valveSeat);
            
            // Valve rod
            const valveRod = new THREE.Mesh(
                new THREE.CylinderGeometry(0.8, 0.8, 20, 32),
                materials.steel
            );
            valveRod.position.set(20, 12, 13);
            valveGroup.add(valveRod);
            
            // Eccentric sheave
            const eccentric = new THREE.Mesh(
                new THREE.TorusGeometry(4, 1, 32, 64),
                materials.castIron
            );
            eccentric.position.set(-5, 2, 8);
            valveGroup.add(eccentric);
            
            // Eccentric strap
            const eccentricStrap = new THREE.Mesh(
                new THREE.TorusGeometry(4.2, 1.2, 32, 64),
                materials.bronze
            );
            eccentricStrap.position.set(-5, 2, 8);
            valveGroup.add(eccentricStrap);
            
            // Eccentric rod
            const eccentricRod = new THREE.Mesh(
                new THREE.BoxGeometry(1.5, 15, 1.5),
                materials.steel
            );
            eccentricRod.position.set(-5, 9, 8);
            valveGroup.add(eccentricRod);
            
            // Expansion link (Stephenson link)
            const expansionLink = new THREE.Mesh(
                new THREE.BoxGeometry(2, 20, 1),
                materials.steel
            );
            expansionLink.position.set(5, 12, 8);
            
            // Link slots
            const slotGeometry = new THREE.BoxGeometry(1.2, 15, 1.2);
            for (let y of [-5, 5]) {
                const slot = new THREE.Mesh(slotGeometry, materials.steel);
                slot.position.set(0, y, 0);
                slot.material.color.setHex(0x222222);
                expansionLink.add(slot);
            }
            valveGroup.add(expansionLink);
            
            // Reversing lever
            const reversingLever = new THREE.Mesh(
                new THREE.BoxGeometry(0.8, 30, 0.8),
                materials.steel
            );
            reversingLever.position.set(10, 20, 15);
            valveGroup.add(reversingLever);
            
            // Lever handle
            const leverHandle = new THREE.Mesh(
                new THREE.CylinderGeometry(0.5, 0.5, 4, 16),
                materials.wood
            );
            leverHandle.rotation.z = Math.PI / 2;
            leverHandle.position.set(10, 35, 15);
            valveGroup.add(leverHandle);
            
            // Detent for reversing lever
            const detent = new THREE.Mesh(
                new THREE.BoxGeometry(1, 0.5, 2),
                materials.steel
            );
            detent.position.set(10, 18, 15);
            valveGroup.add(detent);
            
            // Detent notches
            for (let i = -1; i <= 1; i++) {
                const notch = new THREE.Mesh(
                    new THREE.BoxGeometry(0.3, 0.5, 0.5),
                    materials.steel
                );
                notch.position.set(10 + i * 0.5, 18, 16);
                valveGroup.add(notch);
            }
        }
        
        // Build governor system
        function buildGovernorSystem() {
            const governorGroup = components.governor;
            
            // Governor spindle
            const spindle = new THREE.Mesh(
                new THREE.CylinderGeometry(0.5, 0.5, 30, 32),
                materials.steel
            );
            spindle.position.set(-25, 25, 0);
            governorGroup.add(spindle);
            
            // Governor balls (4)
            for (let i = 0; i < 4; i++) {
                const angle = (i * Math.PI) / 2;
                const ball = new THREE.Mesh(
                    new THREE.SphereGeometry(2, 32, 32),
                    materials.brass
                );
                ball.position.set(
                    -25 + Math.cos(angle) * 8,
                    25 + Math.sin(angle) * 8,
                    0
                );
                governorGroup.add(ball);
                
                // Ball arm
                const arm = new THREE.Mesh(
                    new THREE.BoxGeometry(0.3, 8, 0.3),
                    materials.steel
                );
                arm.position.set(-25 + Math.cos(angle) * 4, 25 + Math.sin(angle) * 4, 0);
                arm.rotation.z = angle;
                governorGroup.add(arm);
            }
            
            // Governor sleeve
            const sleeve = new THREE.Mesh(
                new THREE.CylinderGeometry(1.5, 1.5, 4, 32),
                materials.bronze
            );
            sleeve.position.set(-25, 15, 0);
            governorGroup.add(sleeve);
            
            // Governor spring
            const spring = createSpring(2, 8, 0.2, 32);
            spring.position.set(-25, 10, 0);
            governorGroup.add(spring);
            
            // Throttle linkage
            const linkage = new THREE.Mesh(
                new THREE.BoxGeometry(20, 0.3, 0.3),
                materials.steel
            );
            linkage.position.set(-15, 15, 0);
            governorGroup.add(linkage);
            
            // Throttle valve
            const throttleValve = new THREE.Mesh(
                new THREE.CylinderGeometry(2, 2, 3, 32),
                materials.brass
            );
            throttleValve.position.set(0, 15, 10);
            governorGroup.add(throttleValve);
            
            // Butterfly valve inside throttle
            const butterfly = new THREE.Mesh(
                new THREE.BoxGeometry(0.2, 3.8, 3.8),
                materials.brass
            );
            butterfly.position.set(0, 15, 10);
            governorGroup.add(butterfly);
        }
        
        // Create spring geometry
        function createSpring(radius, height, wireRadius, segments) {
            const points = [];
            const coils = 8;
            
            for (let i = 0; i <= segments; i++) {
                const t = i / segments * coils * Math.PI * 2;
                const x = Math.cos(t) * radius;
                const y = (i / segments) * height - height / 2;
                const z = Math.sin(t) * radius;
                points.push(new THREE.Vector3(x, y, z));
            }
            
            const path = new THREE.CatmullRomCurve3(points);
            const geometry = new THREE.TubeGeometry(path, segments, wireRadius, 8, false);
            const material = new THREE.MeshStandardMaterial({ color: 0x888888, metalness: 0.8 });
            
            return new THREE.Mesh(geometry, material);
        }
        
        // Build piping system
        function buildPipingSystem() {
            const pipesGroup = components.pipes;
            
            // Main steam pipe from boiler
            const mainSteamPipe = new THREE.Mesh(
                new THREE.CylinderGeometry(2, 2, 40, 32),
                materials.copper
            );
            mainSteamPipe.rotation.z = Math.PI / 2;
            mainSteamPipe.position.set(0, 20, 15);
            pipesGroup.add(mainSteamPipe);
            
            // Pipe flanges
            for (let x of [-15, 15]) {
                const flange = new THREE.Mesh(
                    new THREE.CylinderGeometry(3, 3, 1, 32),
                    materials.steel
                );
                flange.position.set(x, 20, 15);
                pipesGroup.add(flange);
                
                // Flange bolts
                for (let i = 0; i < 8; i++) {
                    const angle = (i * Math.PI) / 4;
                    const bolt = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.3, 0.3, 2, 16),
                        materials.steel
                    );
                    bolt.position.set(
                        x + Math.cos(angle) * 2.5,
                        20 + Math.sin(angle) * 2.5,
                        15
                    );
                    pipesGroup.add(bolt);
                }
            }
            
            // Exhaust pipe
            const exhaustPipe = new THREE.Mesh(
                new THREE.CylinderGeometry(2.5, 2.5, 20, 32),
                materials.castIron
            );
            exhaustPipe.position.set(20, 8, -15);
            pipesGroup.add(exhaustPipe);
            
            // Injector feed pipe
            const injectorPipe = createBentPipe();
            injectorPipe.position.set(10, 5, 12);
            pipesGroup.add(injectorPipe);
            
            // Blowdown pipe
            const blowdownPipe = new THREE.Mesh(
                new THREE.CylinderGeometry(1, 1, 15, 32),
                materials.steel
            );
            blowdownPipe.rotation.x = Math.PI / 2;
            blowdownPipe.position.set(-10, 2, -10);
            pipesGroup.add(blowdownPipe);
        }
        
        // Create bent pipe with elbows
        function createBentPipe() {
            const group = new THREE.Group();
            
            // First straight section
            const section1 = new THREE.Mesh(
                new THREE.CylinderGeometry(0.8, 0.8, 10, 16),
                materials.copper
            );
            section1.rotation.z = Math.PI / 2;
            section1.position.set(5, 0, 0);
            group.add(section1);
            
            // 90 degree elbow
            const elbow = new THREE.Mesh(
                new THREE.TorusGeometry(1.5, 0.8, 16, 32, Math.PI / 2),
                materials.copper
            );
            elbow.rotation.x = Math.PI / 2;
            elbow.position.set(0, 0, 1.5);
            group.add(elbow);
            
            // Second straight section
            const section2 = new THREE.Mesh(
                new THREE.CylinderGeometry(0.8, 0.8, 8, 16),
                materials.copper
            );
            section2.position.set(0, 4, 1.5);
            group.add(section2);
            
            return group;
        }
        
        // Build safety systems
        function buildSafetySystems() {
            const safetyGroup = components.safety;
            
            // Spring-loaded safety valve
            const safetyValve = new THREE.Group();
            
            // Valve body
            const valveBody = new THREE.Mesh(
                new THREE.CylinderGeometry(2, 2, 4, 32),
                materials.brass
            );
            safetyValve.add(valveBody);
            
            // Valve disc
            const valveDisc = new THREE.Mesh(
                new THREE.CylinderGeometry(1.5, 1.5, 0.5, 32),
                materials.bronze
            );
            valveDisc.position.y = 1.5;
            safetyValve.add(valveDisc);
            
            // Spring
            const safetySpring = createSpring(1, 6, 0.15, 32);
            safetySpring.position.y = 4;
            safetyValve.add(safetySpring);
            
            // Adjusting screw
            const adjustingScrew = new THREE.Mesh(
                new THREE.CylinderGeometry(0.3, 0.3, 3, 16),
                materials.steel
            );
            adjustingScrew.position.y = 7;
            safetyValve.add(adjustingScrew);
            
            // Lock nut
            const lockNut = new THREE.Mesh(
                new THREE.CylinderGeometry(0.6, 0.6, 0.4, 6),
                materials.steel
            );
            lockNut.position.y = 8.5;
            safetyValve.add(lockNut);
            
            safetyValve.position.set(0, 25, -10);
            safetyGroup.add(safetyValve);
            
            // Fusible plug
            const fusiblePlug = new THREE.Mesh(
                new THREE.CylinderGeometry(0.8, 0.8, 3, 16),
                materials.brass
            );
            fusiblePlug.position.set(10, 20, -8);
            safetyGroup.add(fusiblePlug);
            
            // Fusible metal core
            const fusibleCore = new THREE.Mesh(
                new THREE.CylinderGeometry(0.3, 0.3, 1, 16),
                materials.steel
            );
            fusibleCore.material.color.setHex(0xffaa00);
            fusibleCore.position.set(10, 21.5, -8);
            safetyGroup.add(fusibleCore);
            
            // Pressure relief valve
            const reliefValve = createReliefValve();
            reliefValve.position.set(-10, 20, -10);
            safetyGroup.add(reliefValve);
        }
        
        // Create pressure relief valve
        function createReliefValve() {
            const group = new THREE.Group();
            
            // Valve body
            const body = new THREE.Mesh(
                new THREE.CylinderGeometry(1.5, 1.5, 3, 32),
                materials.brass
            );
            group.add(body);
            
            // Pop mechanism
            const pop = new THREE.Mesh(
                new THREE.SphereGeometry(1, 16, 16),
                materials.brass
            );
            pop.position.y = 2;
            group.add(pop);
            
            // Lever
            const lever = new THREE.Mesh(
                new THREE.BoxGeometry(6, 0.3, 0.5),
                materials.steel
            );
            lever.position.set(3, 3, 0);
            group.add(lever);
            
            // Weight
            const weight = new THREE.Mesh(
                new THREE.BoxGeometry(1, 2, 1),
                materials.steel
            );
            weight.position.set(6, 3, 0);
            group.add(weight);
            
            return group;
        }
        
        // Build instrumentation
        function buildInstrumentation() {
            const gaugesGroup = components.gauges;
            
            // Pressure gauge
            const pressureGauge = createPressureGauge();
            pressureGauge.position.set(-5, 25, 10);
            gaugesGroup.add(pressureGauge);
            
            // Water gauge (sight glass)
            const waterGauge = createWaterGauge();
            waterGauge.position.set(5, 25, 10);
            gaugesGroup.add(waterGauge);
            
            // Steam thermometer
            const thermometer = createThermometer();
            thermometer.position.set(15, 25, 10);
            gaugesGroup.add(thermometer);
            
            // Tachometer
            const tachometer = createTachometer();
            tachometer.position.set(-15, 25, 10);
            gaugesGroup.add(tachometer);
        }
        
        // Create pressure gauge
        function createPressureGauge() {
            const group = new THREE.Group();
            
            // Gauge case
            const caseMesh = new THREE.Mesh(
                new THREE.CylinderGeometry(3, 3, 2, 32),
                materials.brass
            );
            group.add(caseMesh);
            
            // Glass face
            const glass = new THREE.Mesh(
                new THREE.CylinderGeometry(2.9, 2.9, 0.2, 32),
                materials.glass
            );
            glass.position.z = 1;
            group.add(glass);
            
            // Dial face
            const dial = new THREE.Mesh(
                new THREE.CylinderGeometry(2.8, 2.8, 0.1, 32),
                materials.steel
            );
            dial.material.color.setHex(0xffffff);
            dial.position.z = 0.9;
            group.add(dial);
            
            // Pointer
            const pointer = new THREE.Mesh(
                new THREE.BoxGeometry(2, 0.1, 0.05),
                materials.steel
            );
            pointer.material.color.setHex(0xff0000);
            pointer.position.z = 0.95;
            group.add(pointer);
            
            // Mounting bracket
            const bracket = new THREE.Mesh(
                new THREE.BoxGeometry(1, 4, 1),
                materials.steel
            );
            bracket.position.set(0, -2, -1);
            group.add(bracket);
            
            return group;
        }
        
        // Create water gauge
        function createWaterGauge() {
            const group = new THREE.Group();
            
            // Glass tube
            const tube = new THREE.Mesh(
                new THREE.CylinderGeometry(0.5, 0.5, 8, 32),
                materials.glass
            );
            group.add(tube);
            
            // Upper valve
            const upperValve = new THREE.Mesh(
                new THREE.CylinderGeometry(1, 1, 2, 32),
                materials.brass
            );
            upperValve.position.y = 5;
            group.add(upperValve);
            
            // Lower valve
            const lowerValve = new THREE.Mesh(
                new THREE.CylinderGeometry(1, 1, 2, 32),
                materials.brass
            );
            lowerValve.position.y = -5;
            group.add(lowerValve);
            
            // Water level indicator (red)
            const waterLevel = new THREE.Mesh(
                new THREE.BoxGeometry(1, 4, 0.1),
                materials.steel
            );
            waterLevel.material.color.setHex(0xff0000);
            waterLevel.position.y = -1;
            group.add(waterLevel);
            
            return group;
        }
        
        // Create thermometer
        function createThermometer() {
            const group = new THREE.Group();
            
            // Glass bulb
            const bulb = new THREE.Mesh(
                new THREE.SphereGeometry(1, 32, 32),
                materials.glass
            );
            group.add(bulb);
            
            // Capillary tube
            const tube = new THREE.Mesh(
                new THREE.CylinderGeometry(0.1, 0.1, 6, 16),
                materials.glass
            );
            tube.position.y = 3;
            group.add(tube);
            
            // Mercury column
            const mercury = new THREE.Mesh(
                new THREE.CylinderGeometry(0.08, 0.08, 3, 16),
                materials.steel
            );
            mercury.material.color.setHex(0x8888ff);
            mercury.position.y = 1.5;
            group.add(mercury);
            
            // Scale
            const scale = new THREE.Mesh(
                new THREE.BoxGeometry(0.5, 6, 0.05),
                materials.steel
            );
            scale.material.color.setHex(0xffffff);
            scale.position.set(0.3, 3, 0);
            group.add(scale);
            
            return group;
        }
        
        // Create tachometer
        function createTachometer() {
            const group = new THREE.Group();
            
            // Case
            const caseMesh = new THREE.Mesh(
                new THREE.CylinderGeometry(2, 2, 1.5, 32),
                materials.brass
            );
            group.add(caseMesh);
            
            // Dial
            const dial = new THREE.Mesh(
                new THREE.CylinderGeometry(1.9, 1.9, 0.1, 32),
                materials.steel
            );
            dial.material.color.setHex(0x000000);
            dial.position.z = 0.7;
            group.add(dial);
            
            // Numbers on dial
            for (let i = 0; i < 12; i++) {
                const angle = (i * Math.PI) / 6;
                const number = new THREE.Mesh(
                    new THREE.BoxGeometry(0.2, 0.5, 0.05),
                    materials.steel
                );
                number.material.color.setHex(0xffffff);
                number.position.set(
                    Math.cos(angle) * 1.4,
                    Math.sin(angle) * 1.4,
                    0.75
                );
                number.rotation.z = -angle;
                group.add(number);
            }
            
            // Pointer
            const pointer = new THREE.Mesh(
                new THREE.BoxGeometry(1.5, 0.1, 0.05),
                materials.steel
            );
            pointer.material.color.setHex(0xff4444);
            pointer.position.z = 0.8;
            group.add(pointer);
            
            // Drive cable
            const cable = new THREE.Mesh(
                new THREE.CylinderGeometry(0.2, 0.2, 10, 16),
                materials.rubber
            );
            cable.position.set(0, -5, 0);
            cable.rotation.x = Math.PI / 2;
            group.add(cable);
            
            return group;
        }
        
        // Build all fasteners
        function buildFasteners() {
            const fastenersGroup = components.fasteners;
            
            // Build various fastener types
            createHexBolts(fastenersGroup);
            createStuds(fastenersGroup);
            createMachineScrews(fastenersGroup);
            createCotterPins(fastenersGroup);
            createLockWashers(fastenersGroup);
            createSpringWashers(fastenersGroup);
            createTabWashers(fastenersGroup);
        }
        
        // Create hex bolts
        function createHexBolts(group) {
            // Various sizes of hex bolts throughout the engine
            for (let i = 0; i < 50; i++) {
                const x = Math.random() * 40 - 20;
                const y = Math.random() * 20 + 5;
                const z = Math.random() * 20 - 10;
                
                const bolt = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.3, 0.3, 2, 16),
                    materials.steel
                );
                bolt.position.set(x, y, z);
                group.add(bolt);
                
                const nut = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.6, 0.6, 0.5, 6),
                    materials.steel
                );
                nut.position.set(x, y + 1, z);
                group.add(nut);
            }
        }
        
        // Create studs
        function createStuds(group) {
            // Stud bolts with nuts on both ends
            for (let i = 0; i < 20; i++) {
                const x = Math.random() * 30 - 15;
                const y = Math.random() * 15 + 10;
                const z = Math.random() * 15 - 7.5;
                
                const stud = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.4, 0.4, 4, 16),
                    materials.steel
                );
                stud.position.set(x, y, z);
                group.add(stud);
                
                // Top nut
                const topNut = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.7, 0.7, 0.6, 6),
                    materials.steel
                );
                topNut.position.set(x, y + 2, z);
                group.add(topNut);
                
                // Bottom nut
                const bottomNut = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.7, 0.7, 0.6, 6),
                    materials.steel
                );
                bottomNut.position.set(x, y - 2, z);
                group.add(bottomNut);
            }
        }
        
        // Create machine screws
        function createMachineScrews(group) {
            // Smaller machine screws
            for (let i = 0; i < 30; i++) {
                const x = Math.random() * 25 - 12.5;
                const y = Math.random() * 10 + 15;
                const z = Math.random() * 12 - 6;
                
                const screw = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.2, 0.2, 1.5, 16),
                    materials.steel
                );
                screw.position.set(x, y, z);
                group.add(screw);
                
                // Phillips head
                const head = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.4, 0.4, 0.3, 6),
                    materials.steel
                );
                head.position.set(x, y + 0.75, z);
                group.add(head);
            }
        }
        
        // Create cotter pins
        function createCotterPins(group) {
            // Cotter pins for securing
            for (let i = 0; i < 15; i++) {
                const x = Math.random() * 20 - 10;
                const y = Math.random() * 8 + 8;
                const z = Math.random() * 8 - 4;
                
                // U-shaped cotter pin
                const points = [
                    new THREE.Vector3(0, 0, 0),
                    new THREE.Vector3(0.5, 1, 0),
                    new THREE.Vector3(0, 2, 0)
                ];
                const curve = new THREE.CatmullRomCurve3(points);
                const geometry = new THREE.TubeGeometry(curve, 20, 0.1, 8, false);
                const cotter = new THREE.Mesh(geometry, materials.steel);
                cotter.position.set(x, y, z);
                group.add(cotter);
            }
        }
        
        // Create lock washers
        function createLockWashers(group) {
            // Split lock washers
            for (let i = 0; i < 40; i++) {
                const x = Math.random() * 35 - 17.5;
                const y = Math.random() * 12 + 9;
                const z = Math.random() * 10 - 5;
                
                const washer = new THREE.Mesh(
                    new THREE.TorusGeometry(0.5, 0.1, 16, 32, Math.PI * 1.8),
                    materials.steel
                );
                washer.position.set(x, y, z);
                group.add(washer);
            }
        }
        
        // Create spring washers
        function createSpringWashers(group) {
            // Belleville spring washers
            for (let i = 0; i < 25; i++) {
                const x = Math.random() * 30 - 15;
                const y = Math.random() * 10 + 10;
                const z = Math.random() * 8 - 4;
                
                const springWasher = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.6, 0.8, 0.2, 32),
                    materials.steel
                );
                springWasher.position.set(x, y, z);
                group.add(springWasher);
            }
        }
        
        // Create tab washers
        function createTabWashers(group) {
            // Tab washers with locking tabs
            for (let i = 0; i < 10; i++) {
                const x = Math.random() * 20 - 10;
                const y = Math.random() * 8 + 12;
                const z = Math.random() * 6 - 3;
                
                // Main washer
                const washer = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.8, 0.8, 0.1, 32),
                    materials.steel
                );
                washer.position.set(x, y, z);
                group.add(washer);
                
                // Locking tab
                const tab = new THREE.Mesh(
                    new THREE.BoxGeometry(0.2, 0.5, 0.1),
                    materials.steel
                );
                tab.position.set(x + 0.8, y, z);
                group.add(tab);
            }
        }
        
        // Build seals and packings
        function buildSealsAndPackings() {
            const sealsGroup = components.seals;
            
            // O-rings
            for (let i = 0; i < 20; i++) {
                const x = Math.random() * 25 - 12.5;
                const y = Math.random() * 15 + 8;
                const z = Math.random() * 10 - 5;
                const radius = 0.5 + Math.random() * 1;
                
                const oRing = new THREE.Mesh(
                    new THREE.TorusGeometry(radius, 0.15, 16, 32),
                    materials.rubber
                );
                oRing.position.set(x, y, z);
                sealsGroup.add(oRing);
            }
            
            // Gaskets
            for (let i = 0; i < 15; i++) {
                const x = Math.random() * 20 - 10;
                const y = Math.random() * 12 + 10;
                const z = Math.random() * 8 - 4;
                
                const gasket = new THREE.Mesh(
                    new THREE.CylinderGeometry(1.5, 1.5, 0.2, 32),
                    materials.gasket
                );
                gasket.position.set(x, y, z);
                sealsGroup.add(gasket);
                
                // Bolt holes in gasket
                for (let j = 0; j < 4; j++) {
                    const angle = (j * Math.PI) / 2;
                    const hole = new THREE.Mesh(
                        new THREE.CylinderGeometry(0.2, 0.2, 0.3, 16),
                        materials.gasket
                    );
                    hole.position.set(
                        x + Math.cos(angle) * 1.2,
                        y,
                        z + Math.sin(angle) * 1.2
                    );
                    hole.material.color.setHex(0x000000);
                    sealsGroup.add(hole);
                }
            }
            
            // Lip seals
            for (let i = 0; i < 10; i++) {
                const x = Math.random() * 15 - 7.5;
                const y = Math.random() * 10 + 12;
                const z = Math.random() * 6 - 3;
                
                const lipSeal = new THREE.Mesh(
                    new THREE.TorusGeometry(0.8, 0.3, 16, 32),
                    materials.rubber
                );
                lipSeal.position.set(x, y, z);
                lipSeal.rotation.x = Math.PI / 2;
                sealsGroup.add(lipSeal);
            }
            
            // Mechanical seals
            for (let i = 0; i < 8; i++) {
                const x = Math.random() * 10 - 5;
                const y = Math.random() * 8 + 14;
                const z = Math.random() * 4 - 2;
                
                const mechSeal = new THREE.Group();
                
                // Rotating face
                const rotatingFace = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.6, 0.6, 0.2, 32),
                    materials.carbon
                );
                rotatingFace.material.color.setHex(0x222222);
                mechSeal.add(rotatingFace);
                
                // Stationary face
                const stationaryFace = new THREE.Mesh(
                    new THREE.CylinderGeometry(0.7, 0.7, 0.2, 32),
                    materials.ceramic
                );
                stationaryFace.position.z = 0.3;
                stationaryFace.material.color.setHex(0xffffff);
                mechSeal.add(stationaryFace);
                
                // Spring
                const spring = createSpring(0.4, 1, 0.05, 16);
                spring.position.z = 0.6;
                mechSeal.add(spring);
                
                mechSeal.position.set(x, y, z);
                sealsGroup.add(mechSeal);
            }
        }
        
        // Build bushings and wear parts
        function buildBushingsAndWearParts() {
            const bushingsGroup = components.bushings;
            
            // Bronze bushings
            for (let i = 0; i < 15; i++) {
                const x = Math.random() * 20 - 10;
                const y = Math.random() * 10 + 10;
                const z = Math.random() * 8 - 4;
                const length = 1 + Math.random() * 2;
                
                const bushing = new THREE.Mesh(
                    new THREE.CylinderGeometry(1, 1, length, 32),
                    materials.bronze
                );
                bushing.position.set(x, y, z);
                bushingsGroup.add(bushing);
                
                // Oil groove
                const groove = new THREE.Mesh(
                    new THREE.TorusGeometry(0.9, 0.1, 16, 32),
                    materials.bronze
                );
                groove.position.set(x, y, z);
                groove.material.color.setHex(0x8B4513);
                bushingsGroup.add(groove);
            }
            
            // Split bushings
            for (let i = 0; i < 8; i++) {
                const x = Math.random() * 15 - 7.5;
                const y = Math.random() * 8 + 12;
                const z = Math.random() * 6 - 3;
                
                const halfBushing = new THREE.Mesh(
                    new THREE.CylinderGeometry(1, 1, 2, 32, 1, true, 0, Math.PI),
                    materials.bronze
                );
                halfBushing.position.set(x, y, z);
                bushingsGroup.add(halfBushing);
            }
            
            // Wear plates
            for (let i = 0; i < 10; i++) {
                const x = Math.random() * 12 - 6;
                const y = Math.random() * 6 + 14;
                const z = Math.random() * 4 - 2;
                
                const wearPlate = new THREE.Mesh(
                    new THREE.BoxGeometry(3, 0.2, 2),
                    materials.steel
                );
                wearPlate.material.color.setHex(0x666666);
                wearPlate.position.set(x, y, z);
                bushingsGroup.add(wearPlate);
                
                // Hard facing (stellite)
                const hardFacing = new THREE.Mesh(
                    new THREE.BoxGeometry(2.8, 0.1, 1.8),
                    materials.steel
                );
                hardFacing.material.color.setHex(0xffcc00);
                hardFacing.position.set(x, y + 0.15, z);
                bushingsGroup.add(hardFacing);
            }
        }
        
        // Initialize component browser
        function initComponentBrowser() {
            const categoryHeaders = document.querySelectorAll('.category-header');
            
            categoryHeaders.forEach(header => {
                header.addEventListener('click', () => {
                    const list = header.nextElementSibling;
                    list.style.display = list.style.display === 'block' ? 'none' : 'block';
                });
            });
            
            const componentItems = document.querySelectorAll('.component-item');
            componentItems.forEach(item => {
                item.addEventListener('click', () => {
                    // Remove previous selection
                    componentItems.forEach(i => i.classList.remove('selected'));
                    
                    // Add selection to clicked item
                    item.classList.add('selected');
                    
                    // Highlight component in 3D view
                    const componentName = item.getAttribute('data-component');
                    highlightComponentInView(componentName);
                });
            });
        }
        
        // Highlight component in 3D view
        function highlightComponentInView(componentName) {
            // Reset all materials
            steamEngine.traverse(child => {
                if (child.isMesh) {
                    child.material.emissive?.setHex(0x000000);
                }
            });
            
            // Find and highlight the component
            steamEngine.traverse(child => {
                if (child.name && child.name.includes(componentName)) {
                    if (child.isMesh) {
                        child.material.emissive = child.material.emissive || new THREE.Color();
                        child.material.emissive.setHex(0xffaa00);
                        child.material.emissiveIntensity = 0.5;
                    }
                }
            });
        }
        
        // Setup UI interactions
        function setupUI() {
            // Engine controls
            document.getElementById('ignition').addEventListener('click', () => {
                engineRunning = true;
                engineSpeed = 0.5;
                updateEngineStatus('STARTING');
            });
            
            document.getElementById('start-engine').addEventListener('click', () => {
                engineRunning = true;
                engineSpeed = 1;
                updateEngineStatus('RUNNING');
            });
            
            document.getElementById('stop-engine').addEventListener('click', () => {
                engineRunning = false;
                engineSpeed = 0;
                updateEngineStatus('STOPPED');
            });
            
            document.getElementById('reverse').addEventListener('click', () => {
                direction *= -1;
            });
            
            document.getElementById('emergency-stop').addEventListener('click', () => {
                engineRunning = false;
                engineSpeed = 0;
                boilerPressure = 0;
                updateEngineStatus('EMERGENCY STOP');
            });
            
            // Sliders
            document.getElementById('boiler-pressure').addEventListener('input', (e) => {
                boilerPressure = parseInt(e.target.value);
                updateEngineInfo();
            });
            
            document.getElementById('steam-temp').addEventListener('input', (e) => {
                steamTemperature = parseInt(e.target.value);
                updateEngineInfo();
            });
            
            document.getElementById('throttle').addEventListener('input', (e) => {
                engineSpeed = parseInt(e.target.value) / 50;
            });
            
            // Visualization modes
            document.getElementById('xray').addEventListener('click', toggleXRayView);
            document.getElementById('thermal').addEventListener('click', toggleThermalView);
            document.getElementById('stress').addEventListener('click', toggleStressView);
            document.getElementById('flow').addEventListener('click', toggleFlowView);
            document.getElementById('measure').addEventListener('click', toggleMeasureMode);
        }
        
        // Update engine status display
        function updateEngineStatus(status) {
            document.getElementById('status').textContent = status;
            document.getElementById('status').style.color = 
                status === 'RUNNING' ? '#81c784' : 
                status === 'EMERGENCY STOP' ? '#f44336' : 
                '#ffb74d';
        }
        
        // Update engine info display
        function updateEngineInfo() {
            const rpm = engineRunning ? Math.round(engineSpeed * 200) : 0;
            const power = engineRunning ? Math.round(rpm * boilerPressure / 100) : 0;
            const steamFlow = engineRunning ? Math.round(rpm * 5) : 0;
            
            document.getElementById('rpm').textContent = rpm;
            document.getElementById('power').textContent = power + ' HP';
            document.getElementById('steam-flow').textContent = steamFlow + ' kg/h';
            document.getElementById('temperature').textContent = steamTemperature + '¬∞C';
            document.getElementById('pressure').textContent = boilerPressure + ' PSI';
        }
        
        // Toggle X-Ray view
        function toggleXRayView() {
            steamEngine.traverse(child => {
                if (child.isMesh) {
                    child.material.transparent = !child.material.transparent;
                    child.material.opacity = child.material.transparent ? 0.3 : 1.0;
                }
            });
        }
        
        // Toggle Thermal view
        function toggleThermalView() {
            // This would apply thermal gradient materials
            steamEngine.traverse(child => {
                if (child.isMesh && child.material) {
                    const heat = Math.random() * 0.5;
                    child.material.emissive = child.material.emissive || new THREE.Color();
                    child.material.emissive.setRGB(heat * 2, heat * 0.5, 0);
                    child.material.emissiveIntensity = heat;
                }
            });
        }
        
        // Toggle Stress view
        function toggleStressView() {
            // This would show stress patterns
            steamEngine.traverse(child => {
                if (child.isMesh && child.material) {
                    const stress = Math.random();
                    child.material.color.setHex(
                        stress > 0.7 ? 0xff0000 :
                        stress > 0.4 ? 0xffff00 :
                        0x00ff00
                    );
                }
            });
        }
        
        // Toggle Steam Flow view
        function toggleFlowView() {
            // Would visualize steam flow paths
        }
        
        // Toggle Measurement mode
        function toggleMeasureMode() {
            // Would enable measurement tools
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            const deltaTime = clock.getDelta();
            
            // Update engine animation
            if (engineRunning) {
                updateEngineAnimation(deltaTime);
                updateEngineInfo();
            }
            
            // Update controls
            controls.update();
            
            // Render scene
            renderer.render(scene, camera);
        }
        
        // Update engine animation
        function updateEngineAnimation(deltaTime) {
            const rotationSpeed = engineSpeed * direction * deltaTime * 2;
            
            // Rotate crankshaft and connected components
            components.crankshaft.rotation.z += rotationSpeed;
            components.flywheel.rotation.z += rotationSpeed;
            
            // Calculate piston position based on crankshaft angle
            const crankAngle = components.crankshaft.rotation.z;
            const pistonX = 12 + Math.cos(crankAngle) * 8;
            components.piston.position.x = pistonX;
            
            // Update connecting rod angle
            const rodAngle = Math.asin(Math.sin(crankAngle) * 0.5);
            components.connectingRod.rotation.z = rodAngle;
            
            // Update valve gear
            const valvePosition = Math.sin(crankAngle * 2) * 3;
            components.valveGear.children[2].position.z = 8 + valvePosition; // Valve rod
            
            // Update governor (centrifugal force effect)
            const governorSpeed = engineSpeed * 10;
            components.governor.children[1].rotation.z += governorSpeed * deltaTime;
            
            // Update pressure gauge pointer
            const gaugePointer = components.gauges.children[0].children[4];
            gaugePointer.rotation.z = boilerPressure / 100 * Math.PI;
        }
        
        // Handle window resize
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // Initialize the application
        init();
    </script>
</body>
</html>