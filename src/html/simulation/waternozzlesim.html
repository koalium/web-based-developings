<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ø´Ø¨ÛŒÙ‡ Ø³Ø§Ø²ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ù†Ø§Ø²Ù„ Ø¢Ø¨ Ù¾Ø§Ø´</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: Arial, sans-serif;
            touch-action: none;
        }
        #canvas-container {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        /* Sidebar styles */
        #sidebar {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100%;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: -2px 0 15px rgba(0, 0, 0, 0.2);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 15px;
            box-sizing: border-box;
        }
        
        #sidebar.show {
            right: 0;
        }
        
        #toggle-sidebar {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #sidebar-content {
            height: calc(100% - 40px);
            overflow-y: auto;
        }
        
        .close-sidebar {
            position: absolute;
            left: 15px;
            top: 15px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        /* Responsive sidebar */
        @media (max-width: 768px) {
            #sidebar {
                width: 300px;
                right: -300px;
            }
        }
        
        @media (max-width: 480px) {
            #sidebar {
                width: 280px;
                right: -280px;
            }
            
            #toggle-sidebar {
                width: 40px;
                height: 40px;
                font-size: 16px;
                right: 10px;
                top: 10px;
            }
        }

        /* Control styles */
        .control-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .control-group-column {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        label {
            font-weight: bold;
            min-width: 120px;
            font-size: 14px;
        }
        
        input[type="range"], input[type="color"], select {
            width: 60%;
            min-width: 150px;
            max-width: 200px;
        }
        
        input[type="checkbox"] {
            transform: scale(1.2);
        }
        
        button {
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px 0;
            width: 100%;
        }
        
        button:active {
            background: #3e8e41;
        }
        
        .value-display {
            min-width: 40px;
            text-align: center;
            font-size: 14px;
        }
        
        .section-title {
            font-weight: bold;
            margin-top: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #4CAF50;
            color: #333;
            font-size: 16px;
        }
        
        /* Nozzle info panel */
        #nozzle-info {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            max-width: 200px;
            z-index: 100;
        }
        
        /* Collapsible sections */
        .collapsible {
            cursor: pointer;
            position: relative;
        }
        
        .collapsible:after {
            content: '\25BC';
            font-size: 12px;
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
        }
        
        .collapsible.active:after {
            content: '\25B2';
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.2s ease-out;
        }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    
    <button id="toggle-sidebar">â˜° ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button>
    
    <div id="sidebar">
        <button class="close-sidebar">Ã—</button>
        <div id="sidebar-content">
            <div class="section-title collapsible active">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø§Ø´Ø´</div>
            <div class="collapsible-content" style="max-height: 500px;">
                <div class="control-group">
                    <label for="intensity">Ø´Ø¯Øª Ù¾Ø§Ø´Ø´:</label>
                    <input type="range" id="intensity" min="1" max="30" value="10">
                    <span id="intensity-value" class="value-display">10</span>
                </div>
                <div class="control-group">
                    <label for="distance">ÙØ§ØµÙ„Ù‡ Ù¾Ø§Ø´Ø´:</label>
                    <input type="range" id="distance" min="1" max="15" value="7" step="0.1">
                    <span id="distance-value" class="value-display">7</span>
                </div>
                <div class="control-group">
                    <label for="angle">Ø²Ø§ÙˆÛŒÙ‡ Ù¾Ø§Ø´Ø´:</label>
                    <input type="range" id="angle" min="15" max="75" value="45">
                    <span id="angle-value" class="value-display">45Â°</span>
                </div>
            </div>
            
            <div class="section-title collapsible active">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø±Ø§Øª</div>
            <div class="collapsible-content" style="max-height: 500px;">
                <div class="control-group">
                    <label for="particle-type">Ù†ÙˆØ¹ Ø°Ø±Ù‡:</label>
                    <select id="particle-type">
                        <option value="random">ØªØµØ§Ø¯ÙÛŒ</option>
                        <option value="sphere">Ú©Ø±Ù‡</option>
                        <option value="cube">Ù…Ú©Ø¹Ø¨</option>
                        <option value="pyramid">Ù‡Ø±Ù…</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="size-variation">ØªÙ†ÙˆØ¹ Ø§Ù†Ø¯Ø§Ø²Ù‡:</label>
                    <input type="range" id="size-variation" min="0" max="100" value="50">
                    <span id="size-variation-value" class="value-display">50%</span>
                </div>
                <div class="control-group">
                    <label for="opacity-variation">ØªÙ†ÙˆØ¹ Ø´ÙØ§ÙÛŒØª:</label>
                    <input type="range" id="opacity-variation" min="0" max="100" value="30">
                    <span id="opacity-variation-value" class="value-display">30%</span>
                </div>
                <div class="control-group">
                    <label for="particle-color">Ø±Ù†Ú¯ Ø°Ø±Ø§Øª:</label>
                    <input type="color" id="particle-color" value="#0095DD">
                </div>
                <div class="control-group">
                    <label for="gravity">Ù†ÛŒØ±ÙˆÛŒ Ú¯Ø±Ø§Ù†Ø´:</label>
                    <input type="range" id="gravity" min="0" max="200" value="100">
                    <span id="gravity-value" class="value-display">100%</span>
                </div>
            </div>
            
            <div class="section-title collapsible active">ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­ÛŒØ·</div>
            <div class="collapsible-content" style="max-height: 500px;">
                <div class="control-group">
                    <label for="bg-color">Ø±Ù†Ú¯ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡:</label>
                    <input type="color" id="bg-color" value="#f0f0f0">
                </div>
                <div class="control-group">
                    <label for="light-color">Ø±Ù†Ú¯ Ù†ÙˆØ±:</label>
                    <input type="color" id="light-color" value="#ffffff">
                </div>
                <div class="control-group">
                    <label for="show-ground">Ù†Ù…Ø§ÛŒØ´ Ø²Ù…ÛŒÙ†:</label>
                    <input type="checkbox" id="show-ground" checked>
                </div>
            </div>
            
            <div class="section-title">Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§</div>
            <div class="control-group-column">
                <button id="spray-btn">ğŸš¿ Ø´Ø±ÙˆØ¹ Ù¾Ø§Ø´Ø´</button>
                <button id="stop-btn">â¹ ØªÙˆÙ‚Ù Ù¾Ø§Ø´Ø´</button>
                <button id="clear-btn">ğŸ§¹ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø°Ø±Ø§Øª</button>
            </div>
        </div>
    </div>

    <div id="nozzle-info">
        <div>ğŸ”º Ø°Ø±Ø§Øª: <span id="particle-count">0</span></div>
        <div>ğŸ”¹ Ø´Ú©Ù„ ÙØ¹Ù„ÛŒ: <span id="particle-shape">Ú©Ø±Ù‡</span></div>
        <div>ğŸŒˆ Ø±Ù†Ú¯: <span id="particle-color-name">Ø¢Ø¨ÛŒ</span></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.min.js"></script>
    <script>
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡
        let scene, camera, renderer, nozzle, particles = [];
        let isSpraying = false;
        let sprayInterval;
        let particleSystem;
        let particleObjects = [];
        let particlePool = [];
        let maxParticles = 300;
        
        // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±
        let settings = {
            intensity: 10,
            sprayDistance: 7,
            sprayAngle: 45,
            particleType: 'random',
            sizeVariation: 50,
            opacityVariation: 30,
            particleColor: '#0095DD',
            gravity: 100,
            bgColor: '#f0f0f0',
            lightColor: '#ffffff',
            showGround: true
        };
        
        // Ø±Ù†Ú¯â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
        const colorNames = {
            '#0095DD': 'Ø¢Ø¨ÛŒ',
            '#FF0000': 'Ù‚Ø±Ù…Ø²',
            '#00FF00': 'Ø³Ø¨Ø²',
            '#FFFF00': 'Ø²Ø±Ø¯',
            '#FF00FF': 'Ø¨Ù†ÙØ´',
            '#00FFFF': 'ÙÛŒØ±ÙˆØ²Ù‡â€ŒØ§ÛŒ',
            '#FFFFFF': 'Ø³ÙÛŒØ¯',
            '#000000': 'Ø³ÛŒØ§Ù‡'
        };
        
        // Ø§Ø´Ú©Ø§Ù„ Ø°Ø±Ø§Øª
        const particleShapes = {
            sphere: createSphereGeometry,
            cube: createCubeGeometry,
            pyramid: createPyramidGeometry
        };
        
        // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
        function init() {
            // Ø§ÛŒØ¬Ø§Ø¯ ØµØ­Ù†Ù‡
            scene = new THREE.Scene();
            scene.background = new THREE.Color(settings.bgColor);
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø¯ÙˆØ±Ø¨ÛŒÙ†
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 2, 5);
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø±Ù†Ø¯Ø±Ø±
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            
            // Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†
            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            
            // Ù†ÙˆØ±Ù¾Ø±Ø¯Ø§Ø²ÛŒ
            const ambientLight = new THREE.AmbientLight(settings.lightColor, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(settings.lightColor, 0.8);
            directionalLight.position.set(1, 1, 1);
            scene.add(directionalLight);
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø²Ù…ÛŒÙ†
            createGround();
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø§Ø²Ù„ Ø¢Ø¨ Ù¾Ø§Ø´
            createNozzle();
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø³ØªØ®Ø± Ø°Ø±Ø§Øª
            createParticlePool();
            
            // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§
            setupControls();
            
            // Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù¾Ù†Ø¬Ø±Ù‡
            window.addEventListener('resize', onWindowResize);
            
            // Ù…Ø¯ÛŒØ±ÛŒØª Ù†ÙˆØ§Ø± Ú©Ù†Ø§Ø±ÛŒ
            setupSidebar();
            
            // Ø´Ø±ÙˆØ¹ Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
            animate();
        }
        
        // Ù…Ø¯ÛŒØ±ÛŒØª Ù†ÙˆØ§Ø± Ú©Ù†Ø§Ø±ÛŒ
        function setupSidebar() {
            const toggleBtn = document.getElementById('toggle-sidebar');
            const sidebar = document.getElementById('sidebar');
            const closeBtn = document.querySelector('.close-sidebar');
            
            toggleBtn.addEventListener('click', function() {
                sidebar.classList.toggle('show');
            });
            
            closeBtn.addEventListener('click', function() {
                sidebar.classList.remove('show');
            });
            
            // Collapsible sections
            const collapsibles = document.querySelectorAll('.collapsible');
            collapsibles.forEach(item => {
                item.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const content = this.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    }
                });
            });
        }
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ø²Ù…ÛŒÙ†
        function createGround() {
            if (settings.showGround) {
                // Ø­Ø°Ù Ø²Ù…ÛŒÙ† Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
                const oldGround = scene.getObjectByName('ground');
                if (oldGround) scene.remove(oldGround);
                
                const groundGeometry = new THREE.PlaneGeometry(20, 20);
                const groundMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xcccccc,
                    roughness: 0.8,
                    metalness: 0.2
                });
                const ground = new THREE.Mesh(groundGeometry, groundMaterial);
                ground.name = 'ground';
                ground.rotation.x = -Math.PI / 2;
                ground.receiveShadow = true;
                scene.add(ground);
                
                // Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¨Ú©Ù‡
                const gridHelper = new THREE.GridHelper(20, 20, 0x888888, 0x888888);
                gridHelper.name = 'grid';
                scene.add(gridHelper);
            } else {
                const ground = scene.getObjectByName('ground');
                if (ground) scene.remove(ground);
                const grid = scene.getObjectByName('grid');
                if (grid) scene.remove(grid);
            }
        }
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ù†Ø§Ø²Ù„ Ø¢Ø¨ Ù¾Ø§Ø´
        function createNozzle() {
            // Ø­Ø°Ù Ù†Ø§Ø²Ù„ Ù‚Ø¨Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
            const oldNozzle = scene.getObjectByName('nozzle');
            if (oldNozzle) scene.remove(oldNozzle);
            
            const nozzleGroup = new THREE.Group();
            nozzleGroup.name = 'nozzle';
            
            // Ù¾Ø§ÛŒÙ‡ Ù†Ø§Ø²Ù„
            const baseGeometry = new THREE.CylinderGeometry(0.1, 0.2, 0.2, 32);
            const baseMaterial = new THREE.MeshStandardMaterial({ color: 0x333333, metalness: 0.7, roughness: 0.3 });
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            base.position.y = 0.1;
            nozzleGroup.add(base);
            
            // Ø¨Ø¯Ù†Ù‡ Ù†Ø§Ø²Ù„
            const bodyGeometry = new THREE.CylinderGeometry(0.05, 0.05, 0.5, 32);
            const bodyMaterial = new THREE.MeshStandardMaterial({ color: 0x555555, metalness: 0.7, roughness: 0.3 });
            const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
            body.position.y = 0.35;
            nozzleGroup.add(body);
            
            // Ø³Ø± Ù†Ø§Ø²Ù„
            const headGeometry = new THREE.CylinderGeometry(0.03, 0.06, 0.2, 32);
            const headMaterial = new THREE.MeshStandardMaterial({ color: 0x777777, metalness: 0.7, roughness: 0.3 });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.position.y = 0.6;
            head.rotation.z = THREE.MathUtils.degToRad(settings.sprayAngle);
            nozzleGroup.add(head);
            
            // Ù†Ø´Ø§Ù†Ú¯Ø± Ø¬Ù‡Øª Ù¾Ø§Ø´Ø´
            const sprayIndicator = new THREE.ArrowHelper(
                new THREE.Vector3(0, Math.sin(THREE.MathUtils.degToRad(settings.sprayAngle)), -Math.cos(THREE.MathUtils.degToRad(settings.sprayAngle))),
                new THREE.Vector3(0, 0.7, 0),
                1,
                0x0095DD,
                0.1,
                0.05
            );
            nozzleGroup.add(sprayIndicator);
            
            nozzle = nozzleGroup;
            nozzle.position.y = 0;
            scene.add(nozzle);
        }
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø³ØªØ®Ø± Ø°Ø±Ø§Øª
        function createParticlePool() {
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø°Ø±Ø§Øª Ù‚Ø¨Ù„ÛŒ
            particleObjects.forEach(obj => scene.remove(obj));
            particleObjects = [];
            particlePool = [];
            particles = [];
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø°Ø±Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø¯Ø± Ø§Ø³ØªØ®Ø±
            for (let i = 0; i < maxParticles; i++) {
                const particle = createParticleMesh();
                particle.visible = false;
                scene.add(particle);
                particlePool.push(particle);
            }
        }
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ù…Ø´ Ø°Ø±Ù‡
        function createParticleMesh() {
            let shapeType = settings.particleType;
            if (shapeType === 'random') {
                const shapes = ['sphere', 'cube', 'pyramid'];
                shapeType = shapes[Math.floor(Math.random() * shapes.length)];
            }
            
            const geometry = particleShapes[shapeType]();
            const material = new THREE.MeshStandardMaterial({
                color: new THREE.Color(settings.particleColor),
                transparent: true,
                opacity: 0.8,
                metalness: 0.1,
                roughness: 0.5
            });
            
            return new THREE.Mesh(geometry, material);
        }
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ù†Ø¯Ø³Ù‡ Ú©Ø±Ù‡
        function createSphereGeometry() {
            const size = 0.05 * (1 + (Math.random() * settings.sizeVariation / 100));
            return new THREE.SphereGeometry(size, 8, 8);
        }
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ù†Ø¯Ø³Ù‡ Ù…Ú©Ø¹Ø¨
        function createCubeGeometry() {
            const size = 0.05 * (1 + (Math.random() * settings.sizeVariation / 100));
            return new THREE.BoxGeometry(size, size, size);
        }
        
        // Ø§ÛŒØ¬Ø§Ø¯ Ù‡Ù†Ø¯Ø³Ù‡ Ù‡Ø±Ù…
        function createPyramidGeometry() {
            const size = 0.05 * (1 + (Math.random() * settings.sizeVariation / 100));
            const geometry = new THREE.ConeGeometry(size, size * 2, 4);
            geometry.rotateY(Math.PI / 4); // Ú†Ø±Ø®Ø´ Ø¨Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù‡Ø±Ù…
            return geometry;
        }
        
        // Ú¯Ø±ÙØªÙ† Ø°Ø±Ù‡ Ø§Ø² Ø§Ø³ØªØ®Ø±
        function getParticleFromPool() {
            for (let i = 0; i < particlePool.length; i++) {
                if (!particlePool[i].visible) {
                    return particlePool[i];
                }
            }
            return null; // Ø§Ú¯Ø± Ø°Ø±Ù‡ Ø®Ø§Ù„ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯
        }
        
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø°Ø±Ù‡ Ø¬Ø¯ÛŒØ¯
        function addParticle() {
            if (!isSpraying) return;
            
            const particle = getParticleFromPool();
            if (!particle) return; // Ø§Ú¯Ø± Ø°Ø±Ù‡â€ŒØ§ÛŒ Ø¯Ø± Ø§Ø³ØªØ®Ø± Ù†Ø¨ÙˆØ¯
            
            // Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ø±ÙˆØ¹ (Ø³Ø± Ù†Ø§Ø²Ù„)
            const startX = 0;
            const startY = 0.7;
            const startZ = 0;
            
            // Ø¬Ù‡Øª Ù¾Ø§Ø´Ø´ Ø¨Ø§ Ø²Ø§ÙˆÛŒÙ‡ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡
            const angleRad = THREE.MathUtils.degToRad(settings.sprayAngle);
            const dirX = 0;
            const dirY = Math.sin(angleRad);
            const dirZ = -Math.cos(angleRad);
            
            // Ú©Ù…ÛŒ ØªØºÛŒÛŒØ±Ø§Øª ØªØµØ§Ø¯ÙÛŒ Ø¯Ø± Ø¬Ù‡Øª
            const spreadAngle = Math.PI / 16; // Â±11.25 Ø¯Ø±Ø¬Ù‡
            const randomY = Math.random() * spreadAngle * 2 - spreadAngle;
            const randomZ = Math.random() * spreadAngle * 2 - spreadAngle;
            
            const finalDirY = dirY + randomY;
            const finalDirZ = dirZ + randomZ;
            
            // Ù†Ø±Ù…Ø§Ù„ Ú©Ø±Ø¯Ù† Ø¬Ù‡Øª
            const length = Math.sqrt(dirX*dirX + finalDirY*finalDirY + finalDirZ*finalDirZ);
            const normX = dirX / length;
            const normY = finalDirY / length;
            const normZ = finalDirZ / length;
            
            // Ø³Ø±Ø¹Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ Ø´Ø¯Øª Ù¾Ø§Ø´Ø´
            const speed = 0.05 + Math.random() * 0.02 * settings.intensity;
            
            // ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø°Ø±Ù‡
            particle.position.set(startX, startY, startZ);
            
            // Ø§Ù†Ø¯Ø§Ø²Ù‡ Ùˆ Ø´ÙØ§ÙÛŒØª ØªØµØ§Ø¯ÙÛŒ
            const sizeScale = 0.8 + Math.random() * (settings.sizeVariation / 100);
            particle.scale.set(sizeScale, sizeScale, sizeScale);
            
            const opacity = 0.6 + Math.random() * (settings.opacityVariation / 100) * 0.4;
            particle.material.opacity = opacity;
            
            // Ø±Ù†Ú¯ Ø°Ø±Ù‡
            particle.material.color.set(settings.particleColor);
            particle.material.needsUpdate = true;
            
            particle.visible = true;
            
            // Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø°Ø±Ù‡
            const particleData = {
                mesh: particle,
                vx: normX * speed,
                vy: normY * speed,
                vz: normZ * speed,
                life: 100 + Math.random() * 50,
                maxLife: 150,
                active: true
            };
            
            particles.push(particleData);
            updateParticleCount();
            updateParticleShapeDisplay();
            updateParticleColorDisplay();
        }
        
        // Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ø°Ø±Ø§Øª
        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                
                if (!p.active) continue;
                
                // Ø§Ø¹Ù…Ø§Ù„ Ú¯Ø±Ø§Ù†Ø´ (Ø¨Ø§ ØªÙˆØ¬Ù‡ Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª)
                p.vy -= 0.001 * (settings.gravity / 100);
                
                // Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚Ø¹ÛŒØª
                p.mesh.position.x += p.vx;
                p.mesh.position.y += p.vy;
                p.mesh.position.z += p.vz;
                
                // Ú©Ø§Ù‡Ø´ Ø·ÙˆÙ„ Ø¹Ù…Ø±
                p.life--;
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø¨Ø±Ø®ÙˆØ±Ø¯ Ø¨Ø§ Ø²Ù…ÛŒÙ†
                if (p.mesh.position.y <= 0 && settings.showGround) {
                    p.mesh.position.y = 0;
                    p.vy = -p.vy * 0.3; // Ú©Ù…ÛŒ Ø¨Ø±Ú¯Ø´Øª
                    p.vx *= 0.5;
                    p.vz *= 0.5;
                }
                
                // ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø°Ø±Ø§Øª Ù¾ÛŒØ± ÛŒØ§ Ø¯ÙˆØ±
                const distance = p.mesh.position.length();
                if (p.life <= 0 || distance > settings.sprayDistance * 2) {
                    p.active = false;
                    p.mesh.visible = false;
                    particles.splice(i, 1);
                }
            }
            
            updateParticleCount();
        }
        
        // Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ø´Ù…Ø§Ø±Ù†Ø¯Ù‡ Ø°Ø±Ø§Øª
        function updateParticleCount() {
            document.getElementById('particle-count').textContent = particles.length;
        }
        
        // Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø´Ú©Ù„ Ø°Ø±Ø§Øª
        function updateParticleShapeDisplay() {
            let shapeName = 'ØªØµØ§Ø¯ÙÛŒ';
            if (settings.particleType !== 'random') {
                const shapeNames = {
                    'sphere': 'Ú©Ø±Ù‡',
                    'cube': 'Ù…Ú©Ø¹Ø¨',
                    'pyramid': 'Ù‡Ø±Ù…'
                };
                shapeName = shapeNames[settings.particleType];
            }
            document.getElementById('particle-shape').textContent = shapeName;
        }
        
        // Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø±Ù†Ú¯ Ø°Ø±Ø§Øª
        function updateParticleColorDisplay() {
            const colorHex = settings.particleColor.toUpperCase();
            document.getElementById('particle-color-name').textContent = colorNames[colorHex] || colorHex;
        }
        
        // ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§
        function setupControls() {
            // Ø¹Ù†Ø§ØµØ± Ú©Ù†ØªØ±Ù„
            const intensitySlider = document.getElementById('intensity');
            const intensityValue = document.getElementById('intensity-value');
            const distanceSlider = document.getElementById('distance');
            const distanceValue = document.getElementById('distance-value');
            const angleSlider = document.getElementById('angle');
            const angleValue = document.getElementById('angle-value');
            const particleTypeSelect = document.getElementById('particle-type');
            const sizeVariationSlider = document.getElementById('size-variation');
            const sizeVariationValue = document.getElementById('size-variation-value');
            const opacityVariationSlider = document.getElementById('opacity-variation');
            const opacityVariationValue = document.getElementById('opacity-variation-value');
            const particleColorInput = document.getElementById('particle-color');
            const gravitySlider = document.getElementById('gravity');
            const gravityValue = document.getElementById('gravity-value');
            const bgColorInput = document.getElementById('bg-color');
            const lightColorInput = document.getElementById('light-color');
            const showGroundCheckbox = document.getElementById('show-ground');
            const sprayBtn = document.getElementById('spray-btn');
            const stopBtn = document.getElementById('stop-btn');
            const clearBtn = document.getElementById('clear-btn');
            
            // Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§
            intensitySlider.value = settings.intensity;
            intensityValue.textContent = settings.intensity;
            distanceSlider.value = settings.sprayDistance;
            distanceValue.textContent = settings.sprayDistance;
            angleSlider.value = settings.sprayAngle;
            angleValue.textContent = settings.sprayAngle + 'Â°';
            particleTypeSelect.value = settings.particleType;
            sizeVariationSlider.value = settings.sizeVariation;
            sizeVariationValue.textContent = settings.sizeVariation + '%';
            opacityVariationSlider.value = settings.opacityVariation;
            opacityVariationValue.textContent = settings.opacityVariation + '%';
            particleColorInput.value = settings.particleColor;
            gravitySlider.value = settings.gravity;
            gravityValue.textContent = settings.gravity + '%';
            bgColorInput.value = settings.bgColor;
            lightColorInput.value = settings.lightColor;
            showGroundCheckbox.checked = settings.showGround;
            
            // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§
            intensitySlider.addEventListener('input', function() {
                settings.intensity = parseInt(this.value);
                intensityValue.textContent = settings.intensity;
            });
            
            distanceSlider.addEventListener('input', function() {
                settings.sprayDistance = parseFloat(this.value);
                distanceValue.textContent = settings.sprayDistance;
            });
            
            angleSlider.addEventListener('input', function() {
                settings.sprayAngle = parseInt(this.value);
                angleValue.textContent = settings.sprayAngle + 'Â°';
                createNozzle(); // Ù†Ø§Ø²Ù„ Ø±Ø§ Ø¨Ø§ Ø²Ø§ÙˆÛŒÙ‡ Ø¬Ø¯ÛŒØ¯ Ø¨Ø³Ø§Ø²
            });
            
            particleTypeSelect.addEventListener('change', function() {
                settings.particleType = this.value;
                updateParticleShapeDisplay();
            });
            
            sizeVariationSlider.addEventListener('input', function() {
                settings.sizeVariation = parseInt(this.value);
                sizeVariationValue.textContent = settings.sizeVariation + '%';
            });
            
            opacityVariationSlider.addEventListener('input', function() {
                settings.opacityVariation = parseInt(this.value);
                opacityVariationValue.textContent = settings.opacityVariation + '%';
            });
            
            particleColorInput.addEventListener('input', function() {
                settings.particleColor = this.value;
                updateParticleColorDisplay();
            });
            
            gravitySlider.addEventListener('input', function() {
                settings.gravity = parseInt(this.value);
                gravityValue.textContent = settings.gravity + '%';
            });
            
            bgColorInput.addEventListener('input', function() {
                settings.bgColor = this.value;
                scene.background = new THREE.Color(settings.bgColor);
            });
            
            lightColorInput.addEventListener('input', function() {
                settings.lightColor = this.value;
                scene.traverse(obj => {
                    if (obj.isLight) {
                        obj.color = new THREE.Color(settings.lightColor);
                    }
                });
            });
            
            showGroundCheckbox.addEventListener('change', function() {
                settings.showGround = this.checked;
                createGround();
            });
            
            sprayBtn.addEventListener('click', startSpraying);
            stopBtn.addEventListener('click', stopSpraying);
            clearBtn.addEventListener('click', clearParticles);
            
            // Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ù„Ù…Ø³ÛŒ Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„
            sprayBtn.addEventListener('touchstart', startSpraying);
            stopBtn.addEventListener('touchstart', stopSpraying);
            clearBtn.addEventListener('touchstart', clearParticles);
        }
        
        // Ø´Ø±ÙˆØ¹ Ù¾Ø§Ø´Ø´
        function startSpraying() {
            if (isSpraying) return;
            
            isSpraying = true;
            sprayInterval = setInterval(addParticle, 100 / settings.intensity);
        }
        
        // ØªÙˆÙ‚Ù Ù¾Ø§Ø´Ø´
        function stopSpraying() {
            isSpraying = false;
            clearInterval(sprayInterval);
        }
        
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø°Ø±Ø§Øª
        function clearParticles() {
            particles.forEach(p => {
                p.mesh.visible = false;
            });
            particles = [];
            updateParticleCount();
        }
        
        // ØªØºÛŒÛŒØ± Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù¾Ù†Ø¬Ø±Ù‡
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // Ø§Ù†ÛŒÙ…ÛŒØ´Ù†
        function animate() {
            requestAnimationFrame(animate);
            
            // Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ Ø°Ø±Ø§Øª
            updateParticles();
            
            // Ø±Ù†Ø¯Ø± ØµØ­Ù†Ù‡
            renderer.render(scene, camera);
        }
        
        // Ø´Ø±ÙˆØ¹ Ø¨Ø±Ù†Ø§Ù…Ù‡
        init();
    </script>
</body>
</html>