<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>طراحی تابلو برق PLC - ایستگاه تهویه تبخیری نساجی</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #1a73e8;
            --primary-dark: #0d47a1;
            --secondary: #34a853;
            --secondary-dark: #2e7d32;
            --danger: #ea4335;
            --warning: #fbbc05;
            --light: #f8f9fa;
            --dark: #202124;
            --gray: #5f6368;
            --light-gray: #dadce0;
            --border-radius: 8px;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            padding: 0;
            margin: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        
        header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        header h1 i {
            font-size: 32px;
        }
        
        header p {
            font-size: 16px;
            opacity: 0.9;
            max-width: 800px;
        }
        
        .app-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: var(--transition);
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
        }
        
        .btn-secondary {
            background-color: var(--secondary);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: var(--secondary-dark);
        }
        
        .btn-warning {
            background-color: var(--warning);
            color: var(--dark);
        }
        
        .btn-warning:hover {
            background-color: #e6a800;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .btn-light {
            background-color: var(--light);
            color: var(--dark);
            border: 1px solid var(--light-gray);
        }
        
        .btn-light:hover {
            background-color: #e8eaed;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 1100px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: var(--transition);
        }
        
        .card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .card-header {
            background-color: var(--light);
            padding: 15px 20px;
            border-bottom: 1px solid var(--light-gray);
            font-weight: 700;
            font-size: 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header i {
            color: var(--primary);
        }
        
        .card-body {
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .section-title {
            font-size: 20px;
            color: var(--primary-dark);
            margin: 20px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light-gray);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .component-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .component-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            background-color: #f9f9f9;
            transition: var(--transition);
        }
        
        .component-item:hover {
            background-color: #f0f7ff;
            border-color: var(--primary);
        }
        
        .component-info {
            flex-grow: 1;
        }
        
        .component-name {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .component-spec {
            font-size: 14px;
            color: var(--gray);
        }
        
        .component-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .counter {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .counter-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 1px solid var(--light-gray);
            background-color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: var(--transition);
        }
        
        .counter-btn:hover {
            background-color: var(--light);
        }
        
        .counter-value {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
        }
        
        .input-field {
            padding: 8px 12px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            width: 100px;
            font-size: 14px;
        }
        
        .checkbox-field {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .layout-container {
            min-height: 600px;
            display: flex;
            flex-direction: column;
        }
        
        .layout-grid {
            flex-grow: 1;
            background-color: #f0f0f0;
            border: 2px dashed var(--light-gray);
            border-radius: var(--border-radius);
            position: relative;
            overflow: auto;
            padding: 20px;
        }
        
        .layout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .grid-cell {
            position: absolute;
            border: 1px solid #ccc;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 12px;
            overflow: hidden;
            padding: 5px;
            transition: var(--transition);
            cursor: pointer;
        }
        
        .grid-cell:hover {
            transform: scale(1.05);
            z-index: 10;
        }
        
        .grid-cell.breaker { background-color: #ffcdd2; }
        .grid-cell.contactor { background-color: #c8e6c9; }
        .grid-cell.relay { background-color: #bbdefb; }
        .grid-cell.plc { background-color: #e1bee7; }
        .grid-cell.psu { background-color: #fff9c4; }
        .grid-cell.vfd { background-color: #d7ccc8; }
        .grid-cell.soft-starter { background-color: #f8bbd0; }
        .grid-cell.hmi { background-color: #b3e5fc; }
        .grid-cell.terminal { background-color: #ffecb3; }
        
        .results-container {
            grid-column: 1 / -1;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--light-gray);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }
        
        .tab:hover {
            background-color: #f5f5f5;
        }
        
        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .bom-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .bom-table th {
            background-color: var(--light);
            padding: 12px 15px;
            text-align: right;
            border-bottom: 2px solid var(--light-gray);
            font-weight: 700;
        }
        
        .bom-table td {
            padding: 10px 15px;
            border-bottom: 1px solid var(--light-gray);
        }
        
        .bom-table tr:hover {
            background-color: #f9f9f9;
        }
        
        .tag-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .tag {
            background-color: #e8f0fe;
            color: var(--primary-dark);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .tag i {
            font-size: 12px;
        }
        
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 13px;
            padding: 4px 10px;
            border-radius: 20px;
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        .status-indicator.warning {
            background-color: #fff8e1;
            color: #f57c00;
        }
        
        .status-indicator.danger {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .price-estimate {
            font-size: 24px;
            font-weight: 700;
            color: var(--secondary-dark);
            text-align: center;
            padding: 20px;
            background-color: #f1f8e9;
            border-radius: var(--border-radius);
            margin: 20px 0;
        }
        
        .export-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .control-logic {
            background-color: #f5f5f5;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            border-right: 4px solid var(--primary);
        }
        
        .control-logic h4 {
            margin-bottom: 15px;
            color: var(--primary-dark);
        }
        
        .control-logic p {
            margin-bottom: 10px;
            line-height: 1.8;
        }
        
        .control-variables {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .variable-item {
            background-color: white;
            padding: 10px;
            border-radius: var(--border-radius);
            border: 1px solid var(--light-gray);
        }
        
        .variable-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .variable-desc {
            font-size: 13px;
            color: var(--gray);
        }
        
        footer {
            text-align: center;
            padding: 30px 0;
            color: var(--gray);
            border-top: 1px solid var(--light-gray);
            margin-top: 30px;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--light-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--dark);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }
        
        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid var(--light-gray);
            border-radius: var(--border-radius);
            font-size: 16px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--light-gray);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .content-grid {
                gap: 20px;
            }
            
            .card-body {
                padding: 15px;
                max-height: 400px;
            }
            
            .component-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .component-controls {
                width: 100%;
                justify-content: space-between;
            }
            
            .app-controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body x-data="plcDesigner()" x-init="init()">
    <div class="container">
        <header>
            <h1><i class="fas fa-industry"></i> طراحی تابلو برق PLC - ایستگاه تهویه تبخیری نساجی</h1>
            <p>طراحی، محاسبات و تهیه لیست قطعات (BOM) برای تابلو برق کنترل ایستگاه تهویه تبخیری</p>
        </header>
        
        <div class="app-controls">
            <button class="btn btn-primary" @click="saveProject()">
                <i class="fas fa-save"></i> ذخیره پروژه
            </button>
            <button class="btn btn-secondary" @click="loadProject()">
                <i class="fas fa-folder-open"></i> بارگذاری پروژه
            </button>
            <button class="btn btn-warning" @click="exportBOM()">
                <i class="fas fa-file-export"></i> خروجی BOM
            </button>
            <button class="btn btn-light" @click="resetProject()">
                <i class="fas fa-redo"></i> بازنشانی
            </button>
            <button class="btn btn-danger" @click="showPrintModal()">
                <i class="fas fa-print"></i> چاپ و خروجی
            </button>
        </div>
        
        <div class="content-grid">
            <div class="card">
                <div class="card-header">
                    <span><i class="fas fa-cogs"></i> موتورهای سه فاز</span>
                    <span class="status-indicator" x-text="`مجموع توان: ${totalMotorPower} کیلووات`"></span>
                </div>
                <div class="card-body">
                    <div class="component-list">
                        <template x-for="(motor, index) in motors" :key="motor.id">
                            <div class="component-item">
                                <div class="component-info">
                                    <div class="component-name">
                                        <i class="fas fa-tachometer-alt"></i>
                                        <span x-text="motor.name"></span>
                                    </div>
                                    <div class="component-spec">
                                        پیشفرض: <span x-text="motor.defaultCount"></span> عدد، 
                                        توان: <span x-text="motor.defaultPower"></span> کیلووات
                                    </div>
                                </div>
                                <div class="component-controls">
                                    <div class="counter">
                                        <button class="counter-btn" @click="decrementCount(motor)">-</button>
                                        <span class="counter-value" x-text="motor.count"></span>
                                        <button class="counter-btn" @click="incrementCount(motor)">+</button>
                                    </div>
                                    <input type="text" class="input-field" placeholder="توان (kW)" x-model="motor.power">
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span><i class="fas fa-sliders-h"></i> عملگرها (Actuators)</span>
                    <span class="status-indicator" x-text="`تعداد: ${totalActuators}`"></span>
                </div>
                <div class="card-body">
                    <div class="component-list">
                        <template x-for="(actuator, index) in actuators" :key="actuator.id">
                            <div class="component-item">
                                <div class="component-info">
                                    <div class="component-name">
                                        <i class="fas fa-compress-arrows-alt"></i>
                                        <span x-text="actuator.name"></span>
                                    </div>
                                    <div class="component-spec">
                                        پیشفرض: <span x-text="actuator.defaultCount"></span> عدد، 
                                        ولتاژ: <span x-text="actuator.defaultVoltage"></span>
                                    </div>
                                </div>
                                <div class="component-controls">
                                    <div class="counter">
                                        <button class="counter-btn" @click="decrementCount(actuator)">-</button>
                                        <span class="counter-value" x-text="actuator.count"></span>
                                        <button class="counter-btn" @click="incrementCount(actuator)">+</button>
                                    </div>
                                    <div>
                                        <label>
                                            <input type="checkbox" class="checkbox-field" x-model="actuator.hasPositioner">
                                            پوزیشنر
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span><i class="fas fa-thermometer-half"></i> سنسورها</span>
                    <span class="status-indicator" x-text="`تعداد: ${totalSensors}`"></span>
                </div>
                <div class="card-body">
                    <div class="component-list">
                        <template x-for="(sensor, index) in sensors" :key="sensor.id">
                            <div class="component-item">
                                <div class="component-info">
                                    <div class="component-name">
                                        <i class="fas fa-microchip"></i>
                                        <span x-text="sensor.name"></span>
                                    </div>
                                    <div class="component-spec">
                                        پیشفرض: <span x-text="sensor.defaultCount"></span> عدد، 
                                        نوع: <span x-text="sensor.type"></span>
                                    </div>
                                </div>
                                <div class="component-controls">
                                    <div class="counter">
                                        <button class="counter-btn" @click="decrementCount(sensor)">-</button>
                                        <span class="counter-value" x-text="sensor.count"></span>
                                        <button class="counter-btn" @click="incrementCount(sensor)">+</button>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <span><i class="fas fa-tools"></i> تجهیزات اختیاری</span>
                </div>
                <div class="card-body">
                    <div class="component-list">
                        <template x-for="(option, index) in optionalItems" :key="option.id">
                            <div class="component-item">
                                <div class="component-info">
                                    <div class="component-name">
                                        <i class="fas fa-plus-circle"></i>
                                        <span x-text="option.name"></span>
                                    </div>
                                    <div class="component-spec">
                                        پیشفرض: <span x-text="option.defaultCount"></span> عدد، 
                                        <span x-text="option.spec"></span>
                                    </div>
                                </div>
                                <div class="component-controls">
                                    <div class="counter">
                                        <button class="counter-btn" @click="decrementCount(option)">-</button>
                                        <span class="counter-value" x-text="option.count"></span>
                                        <button class="counter-btn" @click="incrementCount(option)">+</button>
                                    </div>
                                    <div x-show="option.id === 'inverter' || option.id === 'softStarter'">
                                        <input type="text" class="input-field" placeholder="توان (kW)" x-model="option.power">
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <div class="control-logic">
                        <h4><i class="fas fa-brain"></i> منطق کنترل</h4>
                        <p>هوای برگشتی از سالن با دمای RT و رطوبت RH وارد سیستم می‌شود.</p>
                        <p>هوای خروجی از سالن با دمای OT و رطوبت OH به بیرون هدایت می‌شود.</p>
                        <p>دمپرها و شیر بخار توسط حلقه بسته کنترل می‌شوند.</p>
                        
                        <div class="control-variables">
                            <div class="variable-item">
                                <div class="variable-name">RT - دمای سالن</div>
                                <div class="variable-desc">دمای هوای برگشتی از سالن</div>
                            </div>
                            <div class="variable-item">
                                <div class="variable-name">RH - رطوبت سالن</div>
                                <div class="variable-desc">رطوبت هوای برگشتی از سالن</div>
                            </div>
                            <div class="variable-item">
                                <div class="variable-name">OT - دمای بیرون</div>
                                <div class="variable-desc">دمای هوای بیرون</div>
                            </div>
                            <div class="variable-item">
                                <div class="variable-name">OH - رطوبت بیرون</div>
                                <div class="variable-desc">رطوبت هوای بیرون</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card layout-container">
                <div class="card-header">
                    <span><i class="fas fa-th"></i> چینش تابلو (Layout)</span>
                    <span class="status-indicator" x-text="`ابعاد: ${cabinetWidth} × ${cabinetHeight} سانتی‌متر`"></span>
                </div>
                <div class="layout-header">
                    <div>
                        <span>مقیاس: 1 واحد = 2 سانتی‌متر</span>
                    </div>
                    <div>
                        <button class="btn btn-light btn-sm" @click="autoLayout()">
                            <i class="fas fa-magic"></i> چینش خودکار
                        </button>
                    </div>
                </div>
                <div class="layout-grid" id="layoutGrid">
                    <!-- Grid cells will be dynamically added here -->
                    <template x-for="component in layoutComponents" :key="component.id">
                        <div class="grid-cell"
                             :class="component.type"
                             :style="getComponentStyle(component)"
                             :title="component.name">
                            <div style="font-weight: bold;" x-text="component.tag"></div>
                            <div style="font-size: 10px;" x-text="component.name"></div>
                        </div>
                    </template>
                </div>
            </div>
            
            <div class="card results-container">
                <div class="card-header">
                    <span><i class="fas fa-clipboard-list"></i> نتایج محاسبات و BOM</span>
                    <span class="status-indicator warning" x-text="`تعداد قطعات: ${totalComponents}`"></span>
                </div>
                <div class="card-body">
                    <div class="tabs">
                        <div class="tab active" @click="switchTab('bom')" :class="{active: activeTab === 'bom'}">لیست قطعات (BOM)</div>
                        <div class="tab" @click="switchTab('tags')" :class="{active: activeTab === 'tags'}">تگ‌ها و کانکشن‌ها</div>
                        <div class="tab" @click="switchTab('calculations')" :class="{active: activeTab === 'calculations'}">محاسبات فنی</div>
                    </div>
                    
                    <div class="tab-content active" x-show="activeTab === 'bom'">
                        <div class="price-estimate">
                            برآورد هزینه: ≈ <span x-text="totalCost.toLocaleString()"></span> یورو
                        </div>
                        
                        <table class="bom-table">
                            <thead>
                                <tr>
                                    <th>ردیف</th>
                                    <th>قطعه</th>
                                    <th>تعداد</th>
                                    <th>مشخصات</th>
                                    <th>استاندارد</th>
                                    <th>فضای مورد نیاز</th>
                                    <th>توضیحات</th>
                                </tr>
                            </thead>
                            <tbody>
                                <template x-for="(item, index) in bomList" :key="item.id">
                                    <tr>
                                        <td x-text="index + 1"></td>
                                        <td x-text="item.name"></td>
                                        <td x-text="item.quantity"></td>
                                        <td x-text="item.specs"></td>
                                        <td x-text="item.standard"></td>
                                        <td x-text="item.space"></td>
                                        <td x-text="item.notes"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="tab-content" x-show="activeTab === 'tags'">
                        <h3 class="section-title"><i class="fas fa-tags"></i> تگ‌های اتصالات</h3>
                        <div class="tag-list">
                            <template x-for="tag in connectionTags" :key="tag.id">
                                <div class="tag">
                                    <i class="fas fa-bolt"></i>
                                    <span x-text="tag.code"></span>: 
                                    <span x-text="tag.description"></span>
                                </div>
                            </template>
                        </div>
                        
                        <h3 class="section-title" style="margin-top: 30px;"><i class="fas fa-project-diagram"></i> اتصالات سیم‌کشی</h3>
                        <div class="control-logic">
                            <p><strong>PLC:</strong> Siemens S7-1200 CPU 1214C DC/DC/DC</p>
                            <p><strong>ماژول دیجیتال ورودی:</strong> 16DI 24V DC (مورد نیاز: <span x-text="digitalInputs"></span> ورودی)</p>
                            <p><strong>ماژول دیجیتال خروجی:</strong> 16DO 24V DC (مورد نیاز: <span x-text="digitalOutputs"></span> خروجی)</p>
                            <p><strong>ماژول آنالوگ ورودی:</strong> 4AI 4-20mA (مورد نیاز: <span x-text="analogInputs"></span> ورودی)</p>
                            <p><strong>تعداد رله:</strong> <span x-text="totalRelays"></span> عدد</p>
                            <p><strong>تعداد ترمینال:</strong> <span x-text="totalTerminals"></span> ردیف</p>
                            <p><strong>سیم‌کشی:</strong> <span x-text="totalWiring"></span> متر سیم مسی 1.5mm² و 2.5mm²</p>
                        </div>
                    </div>
                    
                    <div class="tab-content" x-show="activeTab === 'calculations'">
                        <h3 class="section-title"><i class="fas fa-calculator"></i> محاسبات فنی</h3>
                        <div class="control-logic">
                            <p><strong>توان کل موتورها:</strong> <span x-text="totalMotorPower"></span> کیلووات</p>
                            <p><strong>جریان کل (با ضریب 2):</strong> <span x-text="totalCurrent"></span> آمپر</p>
                            <p><strong>بریکر اصلی:</strong> <span x-text="mainBreaker"></span> آمپر</p>
                            <p><strong>کنتاکتورهای مورد نیاز:</strong> <span x-text="totalContactors"></span> عدد</p>
                            <p><strong>کنتاکتورهای اضافه برای موتورهای بالای 5kW:</strong> <span x-text="additionalContactors"></span> عدد</p>
                            <p><strong>سافت استارتر/اینورتر:</strong> <span x-text="softStarterInverterInfo"></span></p>
                            <p><strong>PSU مورد نیاز:</strong> 24V DC, <span x-text="psuPower"></span> آمپر</p>
                            <p><strong>ابعاد تابلو:</strong> <span x-text="cabinetWidth"></span> × <span x-text="cabinetHeight"></span> × 20 سانتی‌متر</p>
                        </div>
                        
                        <h3 class="section-title" style="margin-top: 30px;"><i class="fas fa-fire"></i> محاسبات حرارتی</h3>
                        <div class="control-logic">
                            <p>تلفات حرارتی تابلو: ≈ <span x-text="heatLoss"></span> وات</p>
                            <p>دمپرفن خنک‌کننده تابلو: <span x-text="cabinetFan"></span></p>
                            <p>سنسور دمای داخلی تابلو: <span x-text="cabinetTempSensors"></span> عدد</p>
                        </div>
                    </div>
                </div>
                
                <div class="export-controls">
                    <button class="btn btn-primary" @click="exportJSON()">
                        <i class="fas fa-file-code"></i> ذخیره به صورت JSON
                    </button>
                    <button class="btn btn-secondary" @click="exportCSV()">
                        <i class="fas fa-file-csv"></i> خروجی CSV
                    </button>
                    <button class="btn btn-warning" @click="takeScreenshot()">
                        <i class="fas fa-camera"></i> تصویر Layout
                    </button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>برنامه طراحی تابلو برق PLC - ایستگاه تهویه تبخیری نساجی</p>
            <p>استفاده از Alpine.js - طراحی شده برای صنعت نساجی</p>
        </footer>
    </div>
    
    <!-- Modal برای بارگذاری/ذخیره پروژه -->
    <div class="modal" :class="{active: modalActive}" x-show="modalActive">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" x-text="modalTitle"></div>
                <button class="modal-close" @click="modalActive = false">&times;</button>
            </div>
            <div class="modal-body">
                <div x-show="modalType === 'save'">
                    <div class="form-group">
                        <label class="form-label">نام پروژه</label>
                        <input type="text" class="form-control" x-model="projectName" placeholder="نام پروژه">
                    </div>
                    <div class="form-group">
                        <label class="form-label">توضیحات</label>
                        <textarea class="form-control" x-model="projectDescription" rows="3" placeholder="توضیحات پروژه"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">داده‌های پروژه (JSON)</label>
                        <textarea class="form-control" rows="6" x-model="projectJSON" readonly style="font-family: monospace;"></textarea>
                    </div>
                </div>
                
                <div x-show="modalType === 'load'">
                    <div class="form-group">
                        <label class="form-label">انتخاب فایل JSON</label>
                        <input type="file" class="form-control" id="jsonFileInput" @change="loadFromFile($event)" accept=".json">
                    </div>
                    <div class="form-group">
                        <p>یا داده‌های JSON را مستقیماً وارد کنید:</p>
                        <textarea class="form-control" rows="6" x-model="importJSON" placeholder='{"motors": [...], "actuators": [...]}' style="font-family: monospace;"></textarea>
                    </div>
                </div>
                
                <div x-show="modalType === 'print'">
                    <div class="form-group">
                        <label class="form-label">نوع خروجی</label>
                        <select class="form-control" x-model="exportType">
                            <option value="bom">لیست قطعات (BOM)</option>
                            <option value="layout">چینش تابلو</option>
                            <option value="tags">تگ‌ها و اتصالات</option>
                            <option value="full">گزارش کامل</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">قالب خروجی</label>
                        <div style="display: flex; gap: 15px; margin-top: 10px;">
                            <label><input type="radio" name="format" value="pdf" x-model="exportFormat"> PDF</label>
                            <label><input type="radio" name="format" value="html" x-model="exportFormat"> HTML</label>
                            <label><input type="radio" name="format" value="text" x-model="exportFormat"> متن</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">گزینه‌های اضافی</label>
                        <div style="margin-top: 10px;">
                            <label><input type="checkbox" x-model="includePrices"> شامل قیمت‌ها</label><br>
                            <label><input type="checkbox" x-model="includeLayout"> شامل چینش تابلو</label><br>
                            <label><input type="checkbox" x-model="includeCalculations"> شامل محاسبات فنی</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-light" @click="modalActive = false">لغو</button>
                <button class="btn btn-primary" @click="processModalAction()" x-text="modalActionText"></button>
            </div>
        </div>
    </div>
    
    <script>
        function plcDesigner() {
            return {
                // وضعیت برنامه
                activeTab: 'bom',
                modalActive: false,
                modalType: 'save',
                modalTitle: 'ذخیره پروژه',
                modalActionText: 'ذخیره',
                projectName: 'ایستگاه تهویه تبخیری نساجی',
                projectDescription: 'طراحی تابلو برق PLC برای ایستگاه تهویه',
                projectJSON: '',
                importJSON: '',
                exportType: 'full',
                exportFormat: 'pdf',
                includePrices: true,
                includeLayout: true,
                includeCalculations: true,
                
                // داده‌های موتورها
                motors: [
                    { id: 1, name: 'فن رفت (Fan feed)', defaultCount: 2, count: 2, defaultPower: '22', power: '22', maxPower: 60 },
                    { id: 2, name: 'فن برگشت (Fan return)', defaultCount: 2, count: 2, defaultPower: '30', power: '30', maxPower: 60 },
                    { id: 3, name: 'فن غبار (Dust Fan)', defaultCount: 4, count: 4, defaultPower: '3.3', power: '3.3', maxPower: 10 },
                    { id: 4, name: 'موتور روتاری (Rotary motor)', defaultCount: 2, count: 2, defaultPower: '1', power: '1', maxPower: 5 },
                    { id: 5, name: 'موتور مکانیزم (Mechanism motor)', defaultCount: 2, count: 2, defaultPower: '0.25', power: '0.25', maxPower: 1 },
                    { id: 6, name: 'پمپ آب (Pump water motor)', defaultCount: 1, count: 1, defaultPower: '30', power: '30', maxPower: 50 }
                ],
                
                // داده‌های عملگرها
                actuators: [
                    { id: 1, name: 'دمپر هوای تازه (Damper fresh)', defaultCount: 2, count: 2, defaultVoltage: '24V DC', voltage: '24V DC', hasPositioner: true },
                    { id: 2, name: 'دمپر هوای خروجی (Damper exhaust)', defaultCount: 2, count: 2, defaultVoltage: '24V DC', voltage: '24V DC', hasPositioner: true },
                    { id: 3, name: 'دمپر هوای برگشتی (Damper return)', defaultCount: 2, count: 2, defaultVoltage: '24V DC', voltage: '24V DC', hasPositioner: false },
                    { id: 4, name: 'شیر بخار (Steam valve)', defaultCount: 1, count: 1, defaultVoltage: '24V DC', voltage: '24V DC', hasPositioner: true }
                ],
                
                // داده‌های سنسورها
                sensors: [
                    { id: 1, name: 'سنسور دما (Temperature)', defaultCount: 2, count: 2, type: 'آنالوگ 4-20mA' },
                    { id: 2, name: 'سنسور رطوبت (Humidity)', defaultCount: 2, count: 2, type: 'آنالوگ 4-20mA' },
                    { id: 3, name: 'میکروسوییچ (Micro switch)', defaultCount: 5, count: 5, type: 'دیجیتال ON/OFF' }
                ],
                
                // داده‌های تجهیزات اختیاری
                optionalItems: [
                    { id: 'inverter', name: 'اینورتر (VFD)', defaultCount: 0, count: 0, spec: 'تا 30 کیلووات', power: '30' },
                    { id: 'softStarter', name: 'سافت استارتر', defaultCount: 0, count: 1, spec: 'تا 30 کیلووات', power: '30' },
                    { id: 'hmi', name: 'HMI', defaultCount: 1, count: 1, spec: '7 اینچ' },
                    { id: 'cabinetTempSensor', name: 'سنسور دمای داخل تابلو', defaultCount: 0, count: 0, spec: 'دماسنج دیجیتال' }
                ],
                
                // لیست چینش تابلو
                layoutComponents: [],
                
                // لیست قطعات BOM
                bomList: [],
                
                // تگ‌های اتصالات
                connectionTags: [],
                
                // توابع اولیه
                init() {
                    this.calculateBOM();
                    this.generateConnectionTags();
                    this.autoLayout();
                    this.updateProjectJSON();
                },
                
                // توابع کنترل کننده
                incrementCount(item) {
                    item.count++;
                    this.calculateBOM();
                    this.autoLayout();
                    this.updateProjectJSON();
                },
                
                decrementCount(item) {
                    if (item.count > 0) {
                        item.count--;
                        this.calculateBOM();
                        this.autoLayout();
                        this.updateProjectJSON();
                    }
                },
                
                switchTab(tabName) {
                    this.activeTab = tabName;
                },
                
                // محاسبات
                get totalMotorPower() {
                    let total = 0;
                    this.motors.forEach(motor => {
                        total += motor.count * parseFloat(motor.power || motor.defaultPower);
                    });
                    return total.toFixed(1);
                },
                
                get totalActuators() {
                    return this.actuators.reduce((sum, actuator) => sum + actuator.count, 0);
                },
                
                get totalSensors() {
                    return this.sensors.reduce((sum, sensor) => sum + sensor.count, 0);
                },
                
                get totalComponents() {
                    return this.bomList.reduce((sum, item) => sum + item.quantity, 0);
                },
                
                get totalCost() {
                    // محاسبه تقریبی هزینه بر اساس قطعات
                    let cost = 0;
                    
                    // هزینه موتورها (تقریبی 500 یورو به ازای هر کیلووات)
                    cost += parseFloat(this.totalMotorPower) * 0*500;
                    
                    // هزینه عملگرها (تقریبی 150 یورو به ازای هر عدد)
                    cost += this.totalActuators * 150;
                    
                    // هزینه سنسورها (تقریبی 80 یورو به ازای هر عدد)
                    cost += this.totalSensors * 80;
                    
                    // هزینه PLC و ماژول‌ها
                    cost += 400; // PLC
                    cost += 40 * Math.ceil(this.digitalInputs / 16); // ماژول DI
                    cost += 50 * Math.ceil(this.digitalOutputs / 16); // ماژول DO
                    cost += 50 * Math.ceil(this.analogInputs / 4); // ماژول AI
                    
                    // هزینه اینورتر/سافت استارتر
                    const inverter = this.optionalItems.find(item => item.id === 'inverter');
                    const softStarter = this.optionalItems.find(item => item.id === 'softStarter');
                    
                    if (inverter && inverter.count > 0) {
                        cost += parseFloat(inverter.power || 30) * 13;
                    }
                    
                    if (softStarter && softStarter.count > 0) {
                        cost += parseFloat(softStarter.power ) * 2+20;
                    }
                    
                    // هزینه تابلو و تجهیزات جانبی
                    cost += 280; // تابلو
                    cost += this.totalContactors * 180; // کنتاکتور
                    cost += this.totalRelays * 35; // رله
                    cost += 280; // PSU
                    cost += 150; // بریکرها و فیوزها
                    cost += 35; // ترمینال‌ها
                    cost += 500; // سیم‌کشی و اتصالات
                    
                    return Math.round(cost);
                },
                
                get digitalInputs() {
                    // میکروسوییچ‌ها + سایر ورودی‌های دیجیتال
                    const microSwitches = this.sensors.find(s => s.name.includes('میکروسوییچ'));
                    const microSwitchCount = microSwitches ? microSwitches.count : 0;
                    
                    // اگر دمپرها پوزیشنر داشته باشند، ورودی دیجیتال برای آنها نیز لازم است
                    let actuatorInputs = 0;
                    this.actuators.forEach(actuator => {
                        if (actuator.hasPositioner) {
                            actuatorInputs += actuator.count * 2; // دو ورودی برای هر پوزیشنر (باز و بسته)
                        }
                    });
                    
                    return microSwitchCount + actuatorInputs + 5; // 5 ورودی اضافی برای سایر سیگنال‌ها
                },
                
                get digitalOutputs() {
                    // خروجی برای موتورها، عملگرها، روشنایی تابلو، آلارم‌ها
                    let outputs = 0;
                    
                    // موتورها (هر موتور حداقل یک خروجی)
                    this.motors.forEach(motor => {
                        outputs += motor.count;
                    });
                    
                    // عملگرها (هر عملگر یک خروجی)
                    outputs += this.totalActuators;
                    
                    // چراغ‌های سیگنال و آلارم
                    outputs += 8;
                    
                    return outputs;
                },
                
                get analogInputs() {
                    // سنسورهای دما و رطوبت
                    let analogCount = 0;
                    
                    this.sensors.forEach(sensor => {
                        if (sensor.type.includes('آنالوگ')) {
                            analogCount += sensor.count;
                        }
                    });
                    
                    // اگر دمپرها پوزیشنر داشته باشند، ورودی آنالوگ برای آنها نیز لازم است
                    this.actuators.forEach(actuator => {
                        if (actuator.hasPositioner) {
                            analogCount += actuator.count; // یک ورودی آنالوگ برای هر پوزیشنر
                        }
                    });
                    
                    return analogCount;
                },
                
                get totalRelays() {
                    // رله برای کنترل کنتاکتورها و مدارهای فرعی
                    let relays = 0;
                    
                    // هر موتور یک رله برای کنترل کنتاکتور
                    this.motors.forEach(motor => {
                        relays += motor.count;
                    });
                    
                    // رله برای مدارهای فرعی و کنترل
                    relays += 10;
                    
                    return relays;
                },
                
                get totalTerminals() {
                    // ترمینال برای اتصالات
                    return Math.ceil((this.digitalInputs + this.digitalOutputs + this.analogInputs + this.totalRelays * 2) / 12);
                },
                
                get totalWiring() {
                    // طول سیم‌کشی تقریبی
                    return Math.ceil((this.digitalInputs + this.digitalOutputs + this.analogInputs) * 5 + this.totalRelays * 3);
                },
                
                get totalContactors() {
                    let contactors = 0;
                    
                    // هر موتور یک کنتاکتور
                    this.motors.forEach(motor => {
                        contactors += motor.count;
                    });
                    
                    // اگر موتور بالای 5kW داشته باشیم و سافت استارتر/اینورتر داشته باشیم، کنتاکتور اضافی نیاز است
                    const hasLargeMotor = this.motors.some(motor => parseFloat(motor.power || motor.defaultPower) > 5);
                    const hasSoftStarterOrInverter = this.optionalItems.some(item => 
                        (item.id === 'inverter' || item.id === 'softStarter') && item.count > 0);
                    
                    if (hasLargeMotor && hasSoftStarterOrInverter) {
                        this.motors.forEach(motor => {
                            if (parseFloat(motor.power || motor.defaultPower) > 5) {
                                contactors += motor.count; // یک کنتاکتور اضافی برای هر موتور بزرگ
                            }
                        });
                    }
                    
                    return contactors;
                },
                
                get additionalContactors() {
                    let additional = 0;
                    const hasSoftStarterOrInverter = this.optionalItems.some(item => 
                        (item.id === 'inverter' || item.id === 'softStarter') && item.count > 0);
                    
                    if (hasSoftStarterOrInverter) {
                        this.motors.forEach(motor => {
                            if (parseFloat(motor.power || motor.defaultPower) > 5) {
                                additional += motor.count;
                            }
                        });
                    }
                    
                    return additional;
                },
                
                get totalCurrent() {
                    // جریان کل با ضریب 2 برای اطمینان
                    return Math.ceil(parseFloat(this.totalMotorPower) * 2 * 1000 / (380 * 1.732 * 0.8));
                },
                
                get mainBreaker() {
                    // بریکر اصلی با 25% حاشیه اطمینان
                    return Math.ceil(this.totalCurrent * 1.25 / 10) * 10;
                },
                
                get psuPower() {
                    // محاسبه توان منبع تغذیه 24V DC
                    let power = 0;
                    
                    // مصرف عملگرها
                    this.actuators.forEach(actuator => {
                        power += actuator.count * 0.5; // هر عملگر حدود 0.5A
                    });
                    
                    // مصرف سنسورها
                    power += this.totalSensors * 0.02; // هر سنسور حدود 20mA
                    
                    // مصرف PLC و ماژول‌ها
                    power += 2; // PLC
                    power += 0.5 * Math.ceil(this.digitalInputs / 16); // ماژول DI
                    power += 0.5 * Math.ceil(this.digitalOutputs / 16); // ماژول DO
                    power += 0.3 * Math.ceil(this.analogInputs / 4); // ماژول AI
                    
                    // مصرف رله‌ها
                    power += this.totalRelays * 0.1;
                    
                    // 50% حاشیه اطمینان
                    return Math.ceil(power * 1.5);
                },
                
                get softStarterInverterInfo() {
                    const inverter = this.optionalItems.find(item => item.id === 'inverter');
                    const softStarter = this.optionalItems.find(item => item.id === 'softStarter');
                    
                    if (inverter && inverter.count > 0) {
                        return `اینورتر ${inverter.power || 30} کیلووات`;
                    } else if (softStarter && softStarter.count > 0) {
                        return `سافت استارتر ${softStarter.power || 30} کیلووات`;
                    } else {
                        return 'ندارد';
                    }
                },
                
                get cabinetWidth() {
                    // محاسبه عرض تابلو بر اساس چینش
                    let maxX = 0;
                    this.layoutComponents.forEach(comp => {
                        maxX = Math.max(maxX, comp.x + comp.width);
                    });
                    return maxX * 2; // تبدیل به سانتی‌متر
                },
                
                get cabinetHeight() {
                    // محاسبه ارتفاع تابلو بر اساس چینش
                    let maxY = 0;
                    this.layoutComponents.forEach(comp => {
                        maxY = Math.max(maxY, comp.y + comp.height);
                    });
                    return maxY * 2; // تبدیل به سانتی‌متر
                },
                
                get heatLoss() {
                    // محاسبه تلفات حرارتی تابلو
                    return Math.ceil(parseFloat(this.totalMotorPower) * 100 + this.totalContactors * 10 + this.totalRelays * 5);
                },
                
                get cabinetFan() {
                    // مشخصات فن خنک‌کننده تابلو
                    if (this.heatLoss > 500) {
                        return 'دمپرفن 24V DC با دبی 200 CFM';
                    } else {
                        return 'دمپرفن 24V DC با دبی 100 CFM';
                    }
                },
                
                get cabinetTempSensors() {
                    const tempSensor = this.optionalItems.find(item => item.id === 'cabinetTempSensor');
                    return tempSensor ? tempSensor.count : 0;
                },
                
                // تابع برای تولید لیست BOM
                calculateBOM() {
                    this.bomList = [];
                    
                    // PLC و ماژول‌ها
                    this.bomList.push({
                        id: 'plc',
                        name: 'PLC Siemens S7-1200 CPU 1214C DC/DC/DC',
                        quantity: 1,
                        specs: 'CPU 1214C DC/DC/DC',
                        standard: 'IEC 61131',
                        space: '16×20 cm',
                        notes: 'پردازنده مرکزی'
                    });
                    
                    // ماژول‌های دیجیتال ورودی
                    const diModules = Math.ceil(this.digitalInputs / 16);
                    this.bomList.push({
                        id: 'di_module',
                        name: 'ماژول دیجیتال ورودی 16DI 24V DC',
                        quantity: diModules,
                        specs: '16DI 24V DC',
                        standard: 'IEC 61131',
                        space: '4×20 cm',
                        notes: 'ورودی دیجیتال'
                    });
                    
                    // ماژول‌های دیجیتال خروجی
                    const doModules = Math.ceil(this.digitalOutputs / 16);
                    this.bomList.push({
                        id: 'do_module',
                        name: 'ماژول دیجیتال خروجی 16DO 24V DC',
                        quantity: doModules,
                        specs: '16DO 24V DC',
                        standard: 'IEC 61131',
                        space: '4×20 cm',
                        notes: 'خروجی دیجیتال'
                    });
                    
                    // ماژول‌های آنالوگ ورودی
                    const aiModules = Math.ceil(this.analogInputs / 4);
                    this.bomList.push({
                        id: 'ai_module',
                        name: 'ماژول آنالوگ ورودی 4AI 4-20mA',
                        quantity: aiModules,
                        specs: '4AI 4-20mA',
                        standard: 'IEC 61131',
                        space: '4×20 cm',
                        notes: 'ورودی آنالوگ'
                    });
                    
                    // HMI
                    const hmi = this.optionalItems.find(item => item.id === 'hmi');
                    if (hmi && hmi.count > 0) {
                        this.bomList.push({
                            id: 'hmi',
                            name: 'HMI صفحه لمسی 7 اینچ',
                            quantity: hmi.count,
                            specs: '7 اینچ، رزولوشن 800×480',
                            standard: 'IP65',
                            space: '16×20 cm',
                            notes: 'رابط کاربری'
                        });
                    }
                    
                    // بریکر اصلی
                    this.bomList.push({
                        id: 'main_breaker',
                        name: 'بریکر اصلی 3 فاز',
                        quantity: 1,
                        specs: `${this.mainBreaker}A, 3P`,
                        standard: 'IEC 60947-2',
                        space: '20×20 cm',
                        notes: 'حفاظت اصلی تابلو'
                    });
                    
                    // کنتاکتورها
                    this.bomList.push({
                        id: 'contactors',
                        name: 'کنتاکتور 3 فاز',
                        quantity: this.totalContactors,
                        specs: `${this.mainBreaker}A, Coil 24V DC`,
                        standard: 'IEC 60947-4-1',
                        space: '16×20 cm',
                        notes: 'کنترل موتورها'
                    });
                    
                    // رله‌ها
                    this.bomList.push({
                        id: 'relays',
                        name: 'رله کمکی',
                        quantity: this.totalRelays,
                        specs: '24V DC, 2CO',
                        standard: 'IEC 61810',
                        space: '2×10 cm',
                        notes: 'کنترل مدارهای فرعی'
                    });
                    
                    // منبع تغذیه
                    this.bomList.push({
                        id: 'psu',
                        name: 'منبع تغذیه سوئیچینگ',
                        quantity: 1,
                        specs: `24V DC, ${this.psuPower}A`,
                        standard: 'IEC 62368',
                        space: '20×20 cm',
                        notes: 'تغذیه مدارهای کنترل'
                    });
                    
                    // سافت استارتر/اینورتر
                    const inverter = this.optionalItems.find(item => item.id === 'inverter');
                    const softStarter = this.optionalItems.find(item => item.id === 'softStarter');
                    
                    if (inverter && inverter.count > 0) {
                        this.bomList.push({
                            id: 'inverter',
                            name: 'اینورتر (VFD)',
                            quantity: inverter.count,
                            specs: `${inverter.power || 30}kW, 3PH 380V`,
                            standard: 'IEC 61800',
                            space: '40×40 cm',
                            notes: 'کنترل سرعت موتور'
                        });
                    } else if (softStarter && softStarter.count > 0) {
                        this.bomList.push({
                            id: 'soft_starter',
                            name: 'سافت استارتر',
                            quantity: softStarter.count,
                            specs: `${softStarter.power || 30}kW, 3PH 380V`,
                            standard: 'IEC 60947-4-2',
                            space: '40×20 cm',
                            notes: 'راه‌اندازی نرم موتور'
                        });
                    }
                    
                    // ترمینال‌ها
                    this.bomList.push({
                        id: 'terminals',
                        name: 'ترمینال مینیاتوری',
                        quantity: this.totalTerminals,
                        specs: '12 پل، Screw Clamp',
                        standard: 'IEC 60947',
                        space: '4×10 cm',
                        notes: 'اتصالات سیم‌ها'
                    });
                    
                    // سیم و کابل
                    this.bomList.push({
                        id: 'wiring',
                        name: 'سیم مسی عایق',
                        quantity: this.totalWiring,
                        specs: '1.5mm² و 2.5mm²',
                        standard: 'IEC 60228',
                        space: '-',
                        notes: 'سیم‌کشی داخلی تابلو'
                    });
                    
                    // شینه زمین و نول
                    this.bomList.push({
                        id: 'busbar',
                        name: 'شینه مسی',
                        quantity: 2,
                        specs: 'Earth & Neutral Busbar',
                        standard: 'IEC 60439',
                        space: '4×40 cm',
                        notes: 'اتصال زمین و نول'
                    });
                    
                    // تابلو
                    this.bomList.push({
                        id: 'cabinet',
                        name: 'تابلو برق ایستاده',
                        quantity: 1,
                        specs: `${this.cabinetWidth}×${this.cabinetHeight}×20 cm, IP54`,
                        standard: 'IEC 61439',
                        space: '-',
                        notes: 'بدنه اصلی تابلو'
                    });
                    
                    // دمپرفن خنک‌کننده
                    this.bomList.push({
                        id: 'cabinet_fan',
                        name: 'دمپرفن خنک‌کننده تابلو',
                        quantity: 1,
                        specs: this.cabinetFan,
                        standard: 'IP54',
                        space: '10×10 cm',
                        notes: 'کنترل دمای داخلی تابلو'
                    });
                    
                    // سنسور دمای تابلو
                    if (this.cabinetTempSensors > 0) {
                        this.bomList.push({
                            id: 'cabinet_temp_sensor',
                            name: 'سنسور دمای داخل تابلو',
                            quantity: this.cabinetTempSensors,
                            specs: 'دماسنج دیجیتال با خروجی 4-20mA',
                            standard: 'IEC 60751',
                            space: '2×4 cm',
                            notes: 'نظارت بر دمای داخلی تابلو'
                        });
                    }
                },
                
                // تابع برای تولید تگ‌های اتصالات
                generateConnectionTags() {
                    this.connectionTags = [];
                    let tagCounter = 1;
                    
                    // تگ‌های موتورها
                    this.motors.forEach(motor => {
                        for (let i = 1; i <= motor.count; i++) {
                            this.connectionTags.push({
                                id: tagCounter++,
                                code: `M${motor.id}.${i}`,
                                description: `${motor.name} #${i}`
                            });
                        }
                    });
                    
                    // تگ‌های عملگرها
                    this.actuators.forEach(actuator => {
                        for (let i = 1; i <= actuator.count; i++) {
                            this.connectionTags.push({
                                id: tagCounter++,
                                code: `A${actuator.id}.${i}`,
                                description: `${actuator.name} #${i}`
                            });
                        }
                    });
                    
                    // تگ‌های سنسورها
                    this.sensors.forEach(sensor => {
                        for (let i = 1; i <= sensor.count; i++) {
                            this.connectionTags.push({
                                id: tagCounter++,
                                code: `S${sensor.id}.${i}`,
                                description: `${sensor.name} #${i}`
                            });
                        }
                    });
                    
                    // تگ‌های عمومی
                    const generalTags = [
                        { code: 'L1, L2, L3', description: 'ورودی برق سه فاز' },
                        { code: 'N', description: 'نول' },
                        { code: 'PE', description: 'زمین حفاظتی' },
                        { code: '24VDC+', description: 'منبع تغذیه 24V مثبت' },
                        { code: '24VDC-', description: 'منبع تغذیه 24V منفی' },
                        { code: 'DI_COM', description: 'کامون ورودی دیجیتال' },
                        { code: 'DO_COM', description: 'کامون خروجی دیجیتال' },
                        { code: 'AI_COM', description: 'کامون ورودی آنالوگ' }
                    ];
                    
                    generalTags.forEach(tag => {
                        this.connectionTags.push({
                            id: tagCounter++,
                            code: tag.code,
                            description: tag.description
                        });
                    });
                },
                
                // تابع برای چینش خودکار تابلو
                autoLayout() {
                    this.layoutComponents = [];
                    let x = 1, y = 1;
                    
                    // افزودن بریکر اصلی
                    this.layoutComponents.push({
                        id: 'main_breaker',
                        type: 'breaker',
                        name: 'بریکر اصلی',
                        tag: 'Q1',
                        x: x,
                        y: y,
                        width: 10, // واحدهای گرید (هر واحد = 2cm)
                        height: 10
                    });
                    x += 12;
                    
                    // افزودن کنتاکتورها
                    for (let i = 1; i <= this.totalContactors; i++) {
                        if (x > 35) { // رفتن به ردیف بعدی
                            x = 1;
                            y += 12;
                        }
                        
                        this.layoutComponents.push({
                            id: `contactor_${i}`,
                            type: 'contactor',
                            name: 'کنتاکتور',
                            tag: `KM${i}`,
                            x: x,
                            y: y,
                            width: 8,
                            height: 10
                        });
                        x += 10;
                    }
                    
                    // رفتن به بخش بعدی تابلو
                    x = 1;
                    y += 12;
                    
                    // افزودن PLC
                    this.layoutComponents.push({
                        id: 'plc',
                        type: 'plc',
                        name: 'PLC',
                        tag: 'PLC1',
                        x: x,
                        y: y,
                        width: 8,
                        height: 10
                    });
                    x += 10;
                    
                    // افزودن ماژول‌های PLC
                    const diModules = Math.ceil(this.digitalInputs / 16);
                    const doModules = Math.ceil(this.digitalOutputs / 16);
                    const aiModules = Math.ceil(this.analogInputs / 4);
                    
                    for (let i = 1; i <= diModules; i++) {
                        this.layoutComponents.push({
                            id: `di_module_${i}`,
                            type: 'terminal',
                            name: 'ماژول DI',
                            tag: `DI${i}`,
                            x: x,
                            y: y,
                            width: 2,
                            height: 10
                        });
                        x += 4;
                    }
                    
                    for (let i = 1; i <= doModules; i++) {
                        this.layoutComponents.push({
                            id: `do_module_${i}`,
                            type: 'terminal',
                            name: 'ماژول DO',
                            tag: `DO${i}`,
                            x: x,
                            y: y,
                            width: 2,
                            height: 10
                        });
                        x += 4;
                    }
                    
                    for (let i = 1; i <= aiModules; i++) {
                        this.layoutComponents.push({
                            id: `ai_module_${i}`,
                            type: 'terminal',
                            name: 'ماژول AI',
                            tag: `AI${i}`,
                            x: x,
                            y: y,
                            width: 2,
                            height: 10
                        });
                        x += 4;
                    }
                    
                    // رفتن به بخش بعدی تابلو
                    x = 1;
                    y += 12;
                    
                    // افزودن PSU
                    this.layoutComponents.push({
                        id: 'psu',
                        type: 'psu',
                        name: 'منبع تغذیه',
                        tag: 'PS1',
                        x: x,
                        y: y,
                        width: 10,
                        height: 10
                    });
                    x += 12;
                    
                    // افزودن رله‌ها
                    const relayRows = Math.ceil(this.totalRelays / 5);
                    for (let row = 0; row < relayRows; row++) {
                        for (let col = 0; col < 5 && (row * 5 + col) < this.totalRelays; col++) {
                            this.layoutComponents.push({
                                id: `relay_${row * 5 + col + 1}`,
                                type: 'relay',
                                name: 'رله',
                                tag: `K${row * 5 + col + 1}`,
                                x: x + col * 3,
                                y: y + row * 6,
                                width: 1,
                                height: 5
                            });
                        }
                    }
                    
                    // رفتن به بخش بعدی تابلو
                    x = 1;
                    y += 20;
                    
                    // افزودن اینورتر/سافت استارتر
                    const inverter = this.optionalItems.find(item => item.id === 'inverter');
                    const softStarter = this.optionalItems.find(item => item.id === 'softStarter');
                    
                    if (inverter && inverter.count > 0) {
                        this.layoutComponents.push({
                            id: 'inverter',
                            type: 'vfd',
                            name: 'اینورتر',
                            tag: 'VFD1',
                            x: x,
                            y: y,
                            width: 20,
                            height: 20
                        });
                        x += 22;
                    } else if (softStarter && softStarter.count > 0) {
                        this.layoutComponents.push({
                            id: 'soft_starter',
                            type: 'soft-starter',
                            name: 'سافت استارتر',
                            tag: 'SS1',
                            x: x,
                            y: y,
                            width: 20,
                            height: 10
                        });
                        x += 22;
                    }
                    
                    // افزودن HMI
                    const hmi = this.optionalItems.find(item => item.id === 'hmi');
                    if (hmi && hmi.count > 0) {
                        this.layoutComponents.push({
                            id: 'hmi',
                            type: 'hmi',
                            name: 'HMI',
                            tag: 'HMI1',
                            x: x,
                            y: y,
                            width: 8,
                            height: 10
                        });
                    }
                    
                    // افزودن ترمینال‌ها
                    x = 1;
                    y += 25;
                    
                    const terminalRows = Math.ceil(this.totalTerminals / 3);
                    for (let row = 0; row < terminalRows; row++) {
                        for (let col = 0; col < 3 && (row * 3 + col) < this.totalTerminals; col++) {
                            this.layoutComponents.push({
                                id: `terminal_${row * 3 + col + 1}`,
                                type: 'terminal',
                                name: 'ترمینال',
                                tag: `XT${row * 3 + col + 1}`,
                                x: x + col * 8,
                                y: y + row * 6,
                                width: 4,
                                height: 5
                            });
                        }
                    }
                },
                
                // تابع برای دریافت استایل هر قطعه در چینش
                getComponentStyle(component) {
                    const scale = 2; // هر واحد = 2cm
                    return {
                        left: `${component.x * scale}%`,
                        top: `${component.y * scale}%`,
                        width: `${component.width * scale}%`,
                        height: `${component.height * scale}%`
                    };
                },
                
                // توابع مربوط به modal
                saveProject() {
                    this.modalType = 'save';
                    this.modalTitle = 'ذخیره پروژه';
                    this.modalActionText = 'ذخیره';
                    this.updateProjectJSON();
                    this.modalActive = true;
                },
                
                loadProject() {
                    this.modalType = 'load';
                    this.modalTitle = 'بارگذاری پروژه';
                    this.modalActionText = 'بارگذاری';
                    this.modalActive = true;
                },
                
                showPrintModal() {
                    this.modalType = 'print';
                    this.modalTitle = 'چاپ و خروجی';
                    this.modalActionText = 'تولید خروجی';
                    this.modalActive = true;
                },
                
                updateProjectJSON() {
                    const projectData = {
                        name: this.projectName,
                        description: this.projectDescription,
                        motors: this.motors,
                        actuators: this.actuators,
                        sensors: this.sensors,
                        optionalItems: this.optionalItems,
                        bomList: this.bomList,
                        layoutComponents: this.layoutComponents,
                        connectionTags: this.connectionTags,
                        totalCost: this.totalCost,
                        totalMotorPower: this.totalMotorPower,
                        totalCurrent: this.totalCurrent,
                        mainBreaker: this.mainBreaker,
                        digitalInputs: this.digitalInputs,
                        digitalOutputs: this.digitalOutputs,
                        analogInputs: this.analogInputs,
                        totalContactors: this.totalContactors,
                        totalRelays: this.totalRelays,
                        psuPower: this.psuPower,
                        cabinetWidth: this.cabinetWidth,
                        cabinetHeight: this.cabinetHeight,
                        heatLoss: this.heatLoss,
                        createdAt: new Date().toISOString()
                    };
                    
                    this.projectJSON = JSON.stringify(projectData, null, 2);
                },
                
                processModalAction() {
                    if (this.modalType === 'save') {
                        this.downloadJSON();
                        this.modalActive = false;
                    } else if (this.modalType === 'load') {
                        this.loadFromJSON();
                        this.modalActive = false;
                    } else if (this.modalType === 'print') {
                        this.exportReport();
                        this.modalActive = false;
                    }
                },
                
                // توابع مربوط به ذخیره و بارگذاری
                downloadJSON() {
                    const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(this.projectJSON);
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", `plc-project-${Date.now()}.json`);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                    
                    alert('پروژه با موفقیت ذخیره شد.');
                },
                
                loadFromFile(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            this.loadProjectData(data);
                            alert('پروژه با موفقیت بارگذاری شد.');
                        } catch (error) {
                            alert('خطا در بارگذاری فایل: فرمت JSON نامعتبر است.');
                        }
                    };
                    reader.readAsText(file);
                },
                
                loadFromJSON() {
                    try {
                        const data = JSON.parse(this.importJSON);
                        this.loadProjectData(data);
                        alert('پروژه با موفقیت بارگذاری شد.');
                    } catch (error) {
                        alert('خطا در بارگذاری داده‌ها: فرمت JSON نامعتبر است.');
                    }
                },
                
                loadProjectData(data) {
                    if (data.motors) this.motors = data.motors;
                    if (data.actuators) this.actuators = data.actuators;
                    if (data.sensors) this.sensors = data.sensors;
                    if (data.optionalItems) this.optionalItems = data.optionalItems;
                    if (data.projectName) this.projectName = data.projectName;
                    if (data.projectDescription) this.projectDescription = data.projectDescription;
                    
                    this.calculateBOM();
                    this.generateConnectionTags();
                    this.autoLayout();
                    this.updateProjectJSON();
                },
                
                // توابع مربوط به خروجی‌ها
                exportBOM() {
                    let bomText = "لیست قطعات (BOM) - طراحی تابلو برق PLC\n";
                    bomText += "===========================================\n\n";
                    
                    this.bomList.forEach((item, index) => {
                        bomText += `${index + 1}. ${item.name} - تعداد: ${item.quantity} - مشخصات: ${item.specs}\n`;
                    });
                    
                    bomText += `\nبرآورد هزینه: ${this.totalCost.toLocaleString()} یورو\n`;
                    bomText += `تاریخ تولید گزارش: ${new Date().toLocaleDateString('fa-IR')}\n`;
                    
                    this.downloadTextFile(bomText, 'bom-list.txt');
                },
                
                exportJSON() {
                    this.updateProjectJSON();
                    this.downloadJSON();
                },
                
                exportCSV() {
                    let csv = "نام قطعه,تعداد,مشخصات,استاندارد,فضای مورد نیاز,توضیحات\n";
                    
                    this.bomList.forEach(item => {
                        csv += `"${item.name}","${item.quantity}","${item.specs}","${item.standard}","${item.space}","${item.notes}"\n`;
                    });
                    
                    this.downloadTextFile(csv, 'bom-list.csv');
                },
                
                exportReport() {
                    let report = `گزارش کامل طراحی تابلو برق PLC\n`;
                    report += `================================\n\n`;
                    report += `نام پروژه: ${this.projectName}\n`;
                    report += `توضیحات: ${this.projectDescription}\n`;
                    report += `تاریخ تولید: ${new Date().toLocaleDateString('fa-IR')}\n\n`;
                    
                    report += `مشخصات فنی:\n`;
                    report += `- توان کل موتورها: ${this.totalMotorPower} کیلووات\n`;
                    report += `- جریان کل: ${this.totalCurrent} آمپر\n`;
                    report += `- بریکر اصلی: ${this.mainBreaker} آمپر\n`;
                    report += `- کنتاکتورهای مورد نیاز: ${this.totalContactors} عدد\n`;
                    report += `- رله‌های مورد نیاز: ${this.totalRelays} عدد\n`;
                    report += `- منبع تغذیه: 24V DC, ${this.psuPower} آمپر\n`;
                    report += `- ابعاد تابلو: ${this.cabinetWidth} × ${this.cabinetHeight} × 20 سانتی‌متر\n\n`;
                    
                    report += `لیست قطعات (BOM):\n`;
                    report += `------------------\n`;
                    
                    this.bomList.forEach((item, index) => {
                        report += `${index + 1}. ${item.name} - تعداد: ${item.quantity}\n`;
                        report += `   مشخصات: ${item.specs}\n`;
                        report += `   استاندارد: ${item.standard}\n`;
                        report += `   فضای مورد نیاز: ${item.space}\n`;
                        report += `   توضیحات: ${item.notes}\n\n`;
                    });
                    
                    report += `برآورد هزینه: ${this.totalCost.toLocaleString()} یورو\n`;
                    
                    this.downloadTextFile(report, 'plc-project-report.txt');
                },
                
                downloadTextFile(text, filename) {
                    const dataStr = "data:text/plain;charset=utf-8," + encodeURIComponent(text);
                    const downloadAnchorNode = document.createElement('a');
                    downloadAnchorNode.setAttribute("href", dataStr);
                    downloadAnchorNode.setAttribute("download", filename);
                    document.body.appendChild(downloadAnchorNode);
                    downloadAnchorNode.click();
                    downloadAnchorNode.remove();
                },
                
                takeScreenshot() {
                    alert('در این نمونه، امکان گرفتن عکس از Layout فراهم شده است. در نسخه کامل می‌توان از کتابخانه‌هایی مانند html2canvas استفاده کرد.');
                },
                
                resetProject() {
                    if (confirm('آیا از بازنشانی پروژه اطمینان دارید؟ تمام تغییرات از بین خواهند رفت.')) {
                        // بازگرداندن به مقادیر پیش‌فرض
                        this.motors.forEach(motor => {
                            motor.count = motor.defaultCount;
                            motor.power = motor.defaultPower;
                        });
                        
                        this.actuators.forEach(actuator => {
                            actuator.count = actuator.defaultCount;
                            actuator.hasPositioner = actuator.id !== 3; // دمپر برگشتی بدون پوزیشنر
                        });
                        
                        this.sensors.forEach(sensor => {
                            sensor.count = sensor.defaultCount;
                        });
                        
                        this.optionalItems.forEach(option => {
                            if (option.id === 'hmi') {
                                option.count = 1;
                            } else {
                                option.count = 0;
                            }
                            if (option.id === 'inverter' || option.id === 'softStarter') {
                                option.power = '30';
                            }
                        });
                        
                        this.calculateBOM();
                        this.generateConnectionTags();
                        this.autoLayout();
                        this.updateProjectJSON();
                        
                        alert('پروژه با موفقیت بازنشانی شد.');
                    }
                }
            };
        }
    </script>
</body>
</html>